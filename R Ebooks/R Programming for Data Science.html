<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>R Programming for Data Science</title></head><body><div dir="ltr" class="calibre" id="calibre_link-176">
  <h2 class="calibre1">R Programming for Data Science</h2>

  <p class="calibre2">&nbsp;</p>

  <h4 class="calibre3">Roger D. Peng</h4>
  <p class="calibre2">&nbsp;</p>
  <p class="calibre2">This book is for sale at <a href="http://leanpub.com/rprogramming">http://leanpub.com/rprogramming</a></p>
  <p class="calibre2">This version was published on 2020-09-03</p>
  <p class="calibre2"><img src="images/000024.png" id="calibre_link-181" alt="publisher&apos;s logo" class="calibre4" /></p>
    <p class="calibre2">*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*</p>
  <p class="calibre2">This is a <a href="http://leanpub.com">Leanpub</a> book. Leanpub empowers authors and publishers with the Lean Publishing process. <a href="http://leanpub.com/manifesto">Lean Publishing</a> is the act of publishing an in-progress ebook using lightweight tools and many iterations to get reader feedback, pivot until you have the right book and build traction once you do.</p>
  <p class="calibre2">*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;*</p>

  <p class="calibre2"></p>
<div class="calibre5">Â© 2014 - 2020 Roger D. Peng</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-17">
      <section type="frontmatter toc">
        <h2 id="calibre_link-182" class="calibre6">Table of Contents</h2>

         <nav type="toc">
           <ol class="toc">
  <li class="calibre7">
    <a href="#calibre_link-18" class="calibre8"><span class="section-number">1. </span>Stay in Touch!</a>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-19" class="calibre8"><span class="section-number">2. </span>Preface</a>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-20" class="calibre8"><span class="section-number">3. </span>History and Overview of R</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-21" class="calibre8"><span class="section-number">3.1 </span>What is R?</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-22" class="calibre8"><span class="section-number">3.2 </span>What is S?</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-23" class="calibre8"><span class="section-number">3.3 </span>The S Philosophy</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-24" class="calibre8"><span class="section-number">3.4 </span>Back to R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-25" class="calibre8"><span class="section-number">3.5 </span>Basic Features of R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-26" class="calibre8"><span class="section-number">3.6 </span>Free Software</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-27" class="calibre8"><span class="section-number">3.7 </span>Design of the R System</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-28" class="calibre8"><span class="section-number">3.8 </span>Limitations of R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-29" class="calibre8"><span class="section-number">3.9 </span>R Resources</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-30" class="calibre8"><span class="section-number">4. </span>Getting Started with R</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-31" class="calibre8"><span class="section-number">4.1 </span>Installation</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-32" class="calibre8"><span class="section-number">4.2 </span>Getting started with the R interface</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-33" class="calibre8"><span class="section-number">5. </span>R Nuts and Bolts</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-34" class="calibre8"><span class="section-number">5.1 </span>Entering Input</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-35" class="calibre8"><span class="section-number">5.2 </span>Evaluation</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-36" class="calibre8"><span class="section-number">5.3 </span>R Objects</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-37" class="calibre8"><span class="section-number">5.4 </span>Numbers</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-38" class="calibre8"><span class="section-number">5.5 </span>Attributes</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-39" class="calibre8"><span class="section-number">5.6 </span>Creating Vectors</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-40" class="calibre8"><span class="section-number">5.7 </span>Mixing Objects</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-41" class="calibre8"><span class="section-number">5.8 </span>Explicit Coercion</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-42" class="calibre8"><span class="section-number">5.9 </span>Matrices</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-43" class="calibre8"><span class="section-number">5.10 </span>Lists</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-44" class="calibre8"><span class="section-number">5.11 </span>Factors</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-45" class="calibre8"><span class="section-number">5.12 </span>Missing Values</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-46" class="calibre8"><span class="section-number">5.13 </span>Data Frames</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-47" class="calibre8"><span class="section-number">5.14 </span>Names</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-48" class="calibre8"><span class="section-number">5.15 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-49" class="calibre8"><span class="section-number">6. </span>Getting Data In and Out of R</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-50" class="calibre8"><span class="section-number">6.1 </span>Reading and Writing Data</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-51" class="calibre8"><span class="section-number">6.2 </span>Reading Data Files with <code class="calibre11">read.table()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-52" class="calibre8"><span class="section-number">6.3 </span>Reading in Larger Datasets with read.table</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-53" class="calibre8"><span class="section-number">6.4 </span>Calculating Memory Requirements for R Objects</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-54" class="calibre8"><span class="section-number">7. </span>Using the <code class="calibre11">readr</code> Package</a>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-55" class="calibre8"><span class="section-number">8. </span>Using Textual and Binary Formats for Storing Data</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-56" class="calibre8"><span class="section-number">8.1 </span>Using <code class="calibre11">dput()</code> and <code class="calibre11">dump()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-57" class="calibre8"><span class="section-number">8.2 </span>Binary Formats</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-58" class="calibre8"><span class="section-number">9. </span>Interfaces to the Outside World</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-59" class="calibre8"><span class="section-number">9.1 </span>File Connections</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-60" class="calibre8"><span class="section-number">9.2 </span>Reading Lines of a Text File</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-61" class="calibre8"><span class="section-number">9.3 </span>Reading From a URL Connection</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-62" class="calibre8"><span class="section-number">10. </span>Subsetting R Objects</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-63" class="calibre8"><span class="section-number">10.1 </span>Subsetting a Vector</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-64" class="calibre8"><span class="section-number">10.2 </span>Subsetting a Matrix</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-65" class="calibre8"><span class="section-number">10.3 </span>Subsetting Lists</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-66" class="calibre8"><span class="section-number">10.4 </span>Subsetting Nested Elements of a List</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-67" class="calibre8"><span class="section-number">10.5 </span>Extracting Multiple Elements of a List</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-68" class="calibre8"><span class="section-number">10.6 </span>Partial Matching</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-69" class="calibre8"><span class="section-number">10.7 </span>Removing NA Values</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-70" class="calibre8"><span class="section-number">11. </span>Vectorized Operations</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-71" class="calibre8"><span class="section-number">11.1 </span>Vectorized Matrix Operations</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-72" class="calibre8"><span class="section-number">12. </span>Dates and Times</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-73" class="calibre8"><span class="section-number">12.1 </span>Dates in R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-74" class="calibre8"><span class="section-number">12.2 </span>Times in R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-75" class="calibre8"><span class="section-number">12.3 </span>Operations on Dates and Times</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-76" class="calibre8"><span class="section-number">12.4 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-77" class="calibre8"><span class="section-number">13. </span>Managing Data Frames with the <code class="calibre11">dplyr</code> package</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-78" class="calibre8"><span class="section-number">13.1 </span>Data Frames</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-79" class="calibre8"><span class="section-number">13.2 </span>The <code class="calibre11">dplyr</code> Package</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-80" class="calibre8"><span class="section-number">13.3 </span><code class="calibre11">dplyr</code> Grammar</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-81" class="calibre8"><span class="section-number">13.4 </span>Installing the <code class="calibre11">dplyr</code> package</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-82" class="calibre8"><span class="section-number">13.5 </span><code class="calibre11">select()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-83" class="calibre8"><span class="section-number">13.6 </span><code class="calibre11">filter()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-84" class="calibre8"><span class="section-number">13.7 </span><code class="calibre11">arrange()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-85" class="calibre8"><span class="section-number">13.8 </span><code class="calibre11">rename()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-86" class="calibre8"><span class="section-number">13.9 </span><code class="calibre11">mutate()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-87" class="calibre8"><span class="section-number">13.10 </span><code class="calibre11">group_by()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-88" class="calibre8"><span class="section-number">13.11 </span><code class="calibre11">%&gt;%</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-89" class="calibre8"><span class="section-number">13.12 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-90" class="calibre8"><span class="section-number">14. </span>Control Structures</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-91" class="calibre8"><span class="section-number">14.1 </span><code class="calibre11">if</code>-<code class="calibre11">else</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-92" class="calibre8"><span class="section-number">14.2 </span><code class="calibre11">for</code> Loops</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-93" class="calibre8"><span class="section-number">14.3 </span>Nested <code class="calibre11">for</code> loops</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-94" class="calibre8"><span class="section-number">14.4 </span><code class="calibre11">while</code> Loops</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-95" class="calibre8"><span class="section-number">14.5 </span><code class="calibre11">repeat</code> Loops</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-96" class="calibre8"><span class="section-number">14.6 </span><code class="calibre11">next</code>, <code class="calibre11">break</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-97" class="calibre8"><span class="section-number">14.7 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-98" class="calibre8"><span class="section-number">15. </span>Functions</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-99" class="calibre8"><span class="section-number">15.1 </span>Functions in R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-100" class="calibre8"><span class="section-number">15.2 </span>Your First Function</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-101" class="calibre8"><span class="section-number">15.3 </span>Argument Matching</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-102" class="calibre8"><span class="section-number">15.4 </span>Lazy Evaluation</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-103" class="calibre8"><span class="section-number">15.5 </span>The <code class="calibre11">...</code> Argument</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-104" class="calibre8"><span class="section-number">15.6 </span>Arguments Coming After the <code class="calibre11">...</code> Argument</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-105" class="calibre8"><span class="section-number">15.7 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-106" class="calibre8"><span class="section-number">16. </span>Scoping Rules of R</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-107" class="calibre8"><span class="section-number">16.1 </span>A Diversion on Binding Values to Symbol</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-108" class="calibre8"><span class="section-number">16.2 </span>Scoping Rules</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-109" class="calibre8"><span class="section-number">16.3 </span>Lexical Scoping: Why Does It Matter?</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-110" class="calibre8"><span class="section-number">16.4 </span>Lexical vs. Dynamic Scoping</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-111" class="calibre8"><span class="section-number">16.5 </span>Application: Optimization</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-112" class="calibre8"><span class="section-number">16.6 </span>Plotting the Likelihood</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-113" class="calibre8"><span class="section-number">16.7 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-114" class="calibre8"><span class="section-number">17. </span>Coding Standards for R</a>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-3" class="calibre8"><span class="section-number">18. </span>Loop Functions</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-115" class="calibre8"><span class="section-number">18.1 </span>Looping on the Command Line</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-116" class="calibre8"><span class="section-number">18.2 </span><code class="calibre11">lapply()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-117" class="calibre8"><span class="section-number">18.3 </span><code class="calibre11">sapply()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-118" class="calibre8"><span class="section-number">18.4 </span><code class="calibre11">split()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-119" class="calibre8"><span class="section-number">18.5 </span>Splitting a Data Frame</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-120" class="calibre8"><span class="section-number">18.6 </span>tapply</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-121" class="calibre8"><span class="section-number">18.7 </span><code class="calibre11">apply()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-122" class="calibre8"><span class="section-number">18.8 </span>Col/Row Sums and Means</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-123" class="calibre8"><span class="section-number">18.9 </span>Other Ways to Apply</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-124" class="calibre8"><span class="section-number">18.10 </span><code class="calibre11">mapply()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-125" class="calibre8"><span class="section-number">18.11 </span>Vectorizing a Function</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-126" class="calibre8"><span class="section-number">18.12 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-127" class="calibre8"><span class="section-number">19. </span>Regular Expressions</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-128" class="calibre8"><span class="section-number">19.1 </span>Before You Begin</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-129" class="calibre8"><span class="section-number">19.2 </span>Primary R Functions</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-130" class="calibre8"><span class="section-number">19.3 </span><code class="calibre11">grep()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-131" class="calibre8"><span class="section-number">19.4 </span><code class="calibre11">grepl()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-132" class="calibre8"><span class="section-number">19.5 </span><code class="calibre11">regexpr()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-133" class="calibre8"><span class="section-number">19.6 </span><code class="calibre11">sub()</code> and <code class="calibre11">gsub()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-134" class="calibre8"><span class="section-number">19.7 </span><code class="calibre11">regexec()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-135" class="calibre8"><span class="section-number">19.8 </span>The <code class="calibre11">stringr</code> Package</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-136" class="calibre8"><span class="section-number">19.9 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-137" class="calibre8"><span class="section-number">20. </span>Debugging</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-138" class="calibre8"><span class="section-number">20.1 </span>Somethingâs Wrong!</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-139" class="calibre8"><span class="section-number">20.2 </span>Figuring Out Whatâs Wrong</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-140" class="calibre8"><span class="section-number">20.3 </span>Debugging Tools in R</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-141" class="calibre8"><span class="section-number">20.4 </span>Using <code class="calibre11">traceback()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-142" class="calibre8"><span class="section-number">20.5 </span>Using <code class="calibre11">debug()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-143" class="calibre8"><span class="section-number">20.6 </span>Using <code class="calibre11">recover()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-144" class="calibre8"><span class="section-number">20.7 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-145" class="calibre8"><span class="section-number">21. </span>Profiling R Code</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-146" class="calibre8"><span class="section-number">21.1 </span>Using <code class="calibre11">system.time()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-147" class="calibre8"><span class="section-number">21.2 </span>Timing Longer Expressions</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-148" class="calibre8"><span class="section-number">21.3 </span>The R Profiler</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-149" class="calibre8"><span class="section-number">21.4 </span>Using <code class="calibre11">summaryRprof()</code></a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-150" class="calibre8"><span class="section-number">21.5 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-151" class="calibre8"><span class="section-number">22. </span>Simulation</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-152" class="calibre8"><span class="section-number">22.1 </span>Generating Random Numbers</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-153" class="calibre8"><span class="section-number">22.2 </span>Setting the random number seed</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-154" class="calibre8"><span class="section-number">22.3 </span>Simulating a Linear Model</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-155" class="calibre8"><span class="section-number">22.4 </span>Random Sampling</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-156" class="calibre8"><span class="section-number">22.5 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-157" class="calibre8"><span class="section-number">23. </span>Data Analysis Case Study: Changes in Fine Particle Air Pollution in the U.S.</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-158" class="calibre8"><span class="section-number">23.1 </span>Synopsis</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-159" class="calibre8"><span class="section-number">23.2 </span>Loading and Processing the Raw Data</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-160" class="calibre8"><span class="section-number">23.3 </span>Results</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-161" class="calibre8"><span class="section-number">24. </span>Parallel Computation</a>
    <ol class="calibre9">
      <li class="calibre10">
        <a href="#calibre_link-162" class="calibre8"><span class="section-number">24.1 </span>Hidden Parallelism</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-163" class="calibre8"><span class="section-number">24.2 </span>Embarrassing Parallelism</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-164" class="calibre8"><span class="section-number">24.3 </span>The Parallel Package</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-165" class="calibre8"><span class="section-number">24.4 </span>Example: Bootstrapping a Statistic</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-166" class="calibre8"><span class="section-number">24.5 </span>Building a Socket Cluster</a>
      </li>
      <li class="calibre10">
        <a href="#calibre_link-167" class="calibre8"><span class="section-number">24.6 </span>Summary</a>
      </li>
    </ol>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-168" class="calibre8"><span class="section-number">25. </span>Why I Indent My Code 8 Spaces</a>
  </li>
  <li class="calibre7">
    <a href="#calibre_link-169" class="calibre8"><span class="section-number">26. </span>About the Author</a>
  </li>
</ol>

         </nav>

         <nav type="landmarks" id="calibre_link-183" class="calibre12">
            <h2 class="calibre1">Guide</h2>
            <ol class="calibre13">
               <li class="calibre14">
                  <a type="bodymatter" href="#calibre_link-12">Begin Reading</a>
               </li>
            </ol>
         </nav>
</section>
</div>


<div dir="ltr" class="calibre" id="calibre_link-12">
<div class="calibre5">
<h2 id="calibre_link-18" class="calibre15">
<span class="section-number">1. </span>Stay in Touch!</h2>

<p class="calibre2">Thanks for purchasing this book. If you are interested in
hearing more from me about things that Iâm working on (books, data
science courses, podcast, etc.), I have a regular podcast called <a href="http://nssdeviations.com">Not So Standard Deviations</a> that I co-host with Dr. Hilary Parker, a Data Scientist at Stitch Fix. On this podcast, Hilary and I talk about the craft of data science and discuss common issues and problems in analyzing data. Weâll also compare how data science is approached in both academia and industry contexts and discuss the latest industry trends.  You can listen to recent episodes on our web page or you can subscribe to it in <a href="https://itunes.apple.com/us/podcast/not-so-standard-deviations/id1040614570">iTunes</a> or your favorite podcasting app.</p>

<p class="calibre2">For those of you who purchased a <strong class="calibre16">printed copy</strong> of this book, I encourage you to go to the Leanpub web site and <a href="https://leanpub.com/rprogramming">obtain the e-book version</a>, which is available for free. The reason is that I will occasionally update the book with new material and readers who purchase the e-book version are entitled to free updates (this is unfortunately not yet possible with printed books).</p>

<p class="calibre2">Thanks again for purchasing this book and please do stay in touch!</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-177">
<div class="calibre5">
<h2 id="calibre_link-19" class="calibre15">
<span class="section-number">2. </span>Preface</h2>

<p class="calibre2">I started using R in 1998 when I was a college undergraduate working
on my senior thesis. The version was 0.63. I was an applied
mathematics major with a statistics concentration and I was working
with Dr. Nicolas Hengartner on an analysis of word frequencies in
classic texts (Shakespeare, Milton, etc.). The idea was to see if we
could identify the authorship of each of the texts based on how
frequently they used certain words. We downloaded the data from
Project Gutenberg and used some basic linear discriminant analysis for
the modeling. The work was <a href="http://amstat.tandfonline.com/doi/abs/10.1198/000313002100#.VQGiSELpagE">eventually
published</a>
and was my first ever peer-reviewed publication. I guess you could
argue it was my first real âdata scienceâ experience.</p>

<p class="calibre2">Back then, no one was using R. Most of my classes were taught with
Minitab, SPSS, Stata, or Microsoft Excel. The cool people on the
cutting edge of statistical methodology used S-PLUS. I was working on
my thesis late one night and I had a problem. I didnât have a copy of
any of those software packages because they were expensive and I was a
student. I didnât feel like trekking over to the computer lab to use
the software because it was late at night.</p>

<p class="calibre2">But I had the Internet! After a couple of Yahoo! searches I found a
web page for something called R, which I figured was just a play on
the name of the S-PLUS package. From what I could tell, R was a
âcloneâ of S-PLUS that was free. I had already written some S-PLUS
code for my thesis so I figured I would try to download R and see if I
could just run the S-PLUS code.</p>

<p class="calibre2">It didnât work. At least not at first. It turns out that R is not
exactly a clone of S-PLUS and quite a few modifications needed to be
made before the code would run in R. In particular, R was missing a
lot of statistical functionality that had existed in S-PLUS for a long
time already. Luckily, Râs programming language was pretty much there
and I was able to more or less re-implement the features that were
missing in R.</p>

<p class="calibre2">After college, I enrolled in a PhD program in statistics at the
University of California, Los Angeles. At the time the department was
brand new and they didnât have a lot of policies or rules (or classes,
for that matter!). So you could kind of do what you wanted, which was
good for some students and not so good for others. The Chair of the
department, Jan de Leeuw, was a big fan of XLisp-Stat and so all of
the departmentâs classes were taught using XLisp-Stat. I diligently
bought my copy of <a href="http://www.amazon.com/LISP-STAT-Object-Oriented-Environment-Statistical-Probability/dp/0471509167/">Luke Tierneyâs
book</a>
and learned to really love XLisp-Stat. It had a number of features
that R didnât have at all, most notably dynamic graphics.</p>

<p class="calibre2">But ultimately, there were only so many parentheses that I could type,
and still all of the research-level statistics was being done in
S-PLUS. The department didnât really have a lot of copies of S-PLUS
lying around so I turned back to R. When I looked around at my fellow
students, I realized that I was basically the only one who had any
experience using R. Since there was a budding interest in R around the
department, I decided to start a âbrown bagâ series where every week
for about an hour I would talk about something you could do in R
(which wasnât much, really). People seemed to like it, if only because
there wasnât really anyone to turn to if you wanted to learn about R. </p>

<p class="calibre2">By the time I left grad school in 2003, the department had essentially
switched over from XLisp-Stat to R for all its work (although there
were a few hold outs). Jan discusses the rationale for the transition
in a <a href="http://www.jstatsoft.org/v13/i07">paper</a> in the <em class="calibre17">Journal of
Statistical Software</em>.</p>

<p class="calibre2">In the next step of my career, I went to the <a href="http://www.biostat.jhsph.edu">Department of
Biostatistics</a> at the Johns Hopkins
Bloomberg School of Public Health, where I have been for the past 16
years. When I got to Johns Hopkins people already seemed into R. Most
people had abandoned S-PLUS a while ago and were committed to using R
for their research. Of all the available statistical packages, R had
the most powerful and expressive programming language, which was
perfect for someone developing <em class="calibre17">new</em> statistical methods.</p>

<p class="calibre2">However, we didnât really have a class that taught students how to use
R. This was a problem because most of our grad students were coming
into the program having never heard of R. Most likely in their
undergraduate programs, they used some other software package. So along
with Rafael Irizarry, Brian Caffo, Ingo Ruczinski, and Karl Broman, I
started a new class to teach our graduate students R and a number of
other skills theyâd need in grad school.</p>

<p class="calibre2">The class was basically a weekly seminar where one of us talked about
a computing topic of interest. I gave some of the R lectures in that
class and when I asked people who had heard of R before, almost no one
raised their hand. And no one had actually used it before.  The main
selling point at the time was âItâs just like S-PLUS but itâs free!â
A lot of people had experience with SAS or Stata or SPSS. A number of
people had used something like Java or C/C++ before and so I often
used that as a reference frame. No one had ever used a functional-style
of programming language like Scheme or Lisp.</p>

<p class="calibre2">To this day, I still teach the class, known a Biostatistics 140.776
(âStatistical Computingâ). However, the nature of the class has
changed quite a bit over the years. The population of students
(mostly first-year graduate students) has shifted to the point where
many of them have been introduced to R as undergraduates. This trend
mirrors the overall trend with statistics where we are seeing more and
more students do undergraduate majors in statistics (as opposed to,
say, mathematics). Eventually, by 2008&ndash;2009, when Iâd asked how many
people had heard of or used R before, everyone raised their
hand. However, even at that late date, I still felt the need to
convince people that R was a ârealâ language that could be used for
real tasks.</p>

<p class="calibre2">R has grown a lot in recent years, and is being used in so many places
now, that I think itâs essentially impossible for a person to keep
track of everything that is going on. Thatâs fine, but it makes
âintroducingâ people to R an interesting experience. Nowadays in
class, students are often teaching me something new about R that Iâve
never seen or heard of before (they are quite good at Googling around
for themselves). I feel no need to âbring people overâ to R. In fact
itâs quite the opposite&ndash;people might start asking questions if I
<em class="calibre17">werenât</em> teaching R.</p>

<p class="calibre2">This book comes from my experience teaching R in a variety of settings
and through different stages of its (and my) development. Much of the
material has been taken from by Statistical Computing class as well
as the <a href="https://www.coursera.org/course/rprog">R Programming</a> class I
teach through Coursera.</p>

<p class="calibre2">Iâm looking forward to teaching R to people as long as people will let
me, and Iâm interested in seeing how the next generation of students
will approach it (and how my approach to them will change). Overall,
itâs been just an amazing experience to see the widespread adoption of
R over the past decade. Iâm sure the next decade will be just as
amazing.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-4">
<div class="calibre5">
<h2 id="calibre_link-20" class="calibre15">
<span class="section-number">3. </span>History and Overview of R</h2>

<blockquote class="calibre18">
  <p class="calibre2">There are only two kinds of languages: the ones people complain
about and the ones nobody uses &mdash;<em class="calibre17">Bjarne Stroustrup</em></p>
</blockquote>

<p class="calibre2">
  <a href="https://youtu.be/STihTnVSZnI">Watch a video of this chapter</a>
</p>

<h3 id="calibre_link-21" class="calibre19">
<span class="section-number">3.1 </span>What is R?</h3>

<p class="calibre2">This is an easy question to answer. R is a dialect of S. </p>

<h3 id="calibre_link-22" class="calibre19">
<span class="section-number">3.2 </span>What is S?</h3>

<p class="calibre2">S is a language that was developed by John Chambers and others at the
old Bell Telephone Laboratories, originally part of AT&amp;T Corp. S was
<a href="http://cm.bell-labs.com/stat/doc/94.11.ps">initiated in 1976</a> as an
internal statistical analysis environment&mdash;originally implemented as
Fortran libraries. Early versions of the language did not even contain
functions for statistical modeling.</p>

<p class="calibre2">In 1988 the system was rewritten in C and began to resemble the system
that we have today (this was Version 3 of the language). The book
<em class="calibre17">Statistical Models in S</em> by Chambers and Hastie (the white book)
documents the statistical analysis functionality. Version 4 of the S
language was released in 1998 and is the version we use today. The
book <em class="calibre17">Programming with Data</em> by John Chambers (the green book)
documents this version of the language.</p>

<p class="calibre2">Since the early 90âs the life of the S language has gone down a rather
winding path. In 1993 Bell Labs gave StatSci (later Insightful Corp.)
an exclusive license to develop and sell the S language. In 2004
Insightful purchased the S language from Lucent for $2 million. In
2006, Alcatel purchased Lucent Technologies and is now called
Alcatel-Lucent. </p>

<p class="calibre2">Insightful sold its implementation of the S language under the product
name S-PLUS and built a number of fancy features (GUIs, mostly) on top
of it&mdash;hence the âPLUSâ. In 2008 Insightful was acquired by TIBCO for
$25 million. As of this writing TIBCO is the current owner of the S
language and is its exclusive developer.</p>

<p class="calibre2">The fundamentals of the S language itself has not changed dramatically
since the publication of the Green Book by John Chambers in 1998. In
1998, S won the Association for Computing Machineryâs Software System
Award, a highly prestigious award in the computer science field.</p>

<h3 id="calibre_link-23" class="calibre19">
<span class="section-number">3.3 </span>The S Philosophy</h3>

<p class="calibre2">The general S philosophy is important to understand for users of S and
R because it sets the stage for the design of the language itself,
which many programming veterans find a bit odd and confusing. In
particular, itâs important to realize that the S language had its
roots in data analysis, and did not come from a traditional
programming language background. Its inventors were focused on
figuring out how to make data analysis easier, first for themselves,
and then eventually for others.</p>

<p class="calibre2">In <a href="http://www.stat.bell-labs.com/S/history.html">Stages in the Evolution of
S</a>, John Chambers
writes:</p>

<blockquote class="calibre18">
  <p class="calibre2">â[W]e wanted users to be able to begin in an interactive environment,
where they did not consciously think of themselves as programming.
Then as their needs became clearer and their sophistication increased,
they should be able to slide gradually into programming, when the
language and system aspects would become more important.â</p>
</blockquote>

<p class="calibre2">The key part here was the transition from <em class="calibre17">user</em> to <em class="calibre17">developer</em>. They
wanted to build a language that could easily service both
âpeopleâ. More technically, they needed to build language that would
be suitable for interactive data analysis (more command-line based) as
well as for writing longer programs (more traditional programming
language-like).</p>

<h3 id="calibre_link-24" class="calibre19">
<span class="section-number">3.4 </span>Back to R</h3>

<p class="calibre2">The R language came to use quite a bit after S had been developed. One
key limitation of the S language was that it was only available in a
commericial package, S-PLUS. In 1991, R was created by Ross Ihaka and
Robert Gentleman in the Department of Statistics at the University of
Auckland. In 1993 the first announcement of R was made to the public.
Rossâs and Robertâs experience developing R is documented in a 1996
paper in the <em class="calibre17">Journal of Computational and Graphical Statistics</em>:</p>

<blockquote class="calibre18">
  <p class="calibre2">Ross Ihaka and Robert Gentleman. R: A language for data analysis and graphics. Journal of Computational and Graphical Statistics, 5(3):299&ndash;314, 1996</p>
</blockquote>

<p class="calibre2">In 1995, Martin MÃ¤chler made an important contribution by convincing
Ross and Robert to use the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GNU General Public
License</a> to make R free
software. This was critical because it allowed for the source code for
the entire R system to be accessible to anyone who wanted to tinker
with it (more on free software later).</p>

<p class="calibre2">In 1996, a public mailing list was created (the R-help and R-devel
lists) and in 1997 the R Core Group was formed, containing some people
associated with S and S-PLUS. Currently, the core group controls the
source code for R and is solely able to check in changes to the main R
source tree. Finally, in 2000 R version 1.0.0 was released to the
public.</p>

<h3 id="calibre_link-25" class="calibre19">
<span class="section-number">3.5 </span>Basic Features of R</h3>

<p class="calibre2">In the early days, a key feature of R was that its syntax is very
similar to S, making it easy for S-PLUS users to switch over. While
the Râs syntax is nearly identical to that of Sâs, Râs semantics,
while superficially similar to S, are quite different. In fact, R is
technically much closer to the Scheme language than it is to the
original S language when it comes to how R works under the hood.</p>

<p class="calibre2">Today R runs on almost any standard computing platform and operating
system. Its open source nature means that anyone is free to adapt the
software to whatever platform they choose. Indeed, R has been reported
to be running on modern tablets, phones, PDAs, and game consoles.</p>

<p class="calibre2">One nice feature that R shares with many popular open source projects
is frequent releases. These days there is a major annual release,
typically in October, where major new features are incorporated and
released to the public. Throughout the year, smaller-scale bugfix
releases will be made as needed. The frequent releases and regular
release cycle indicates active development of the software and ensures
that bugs will be addressed in a timely manner. Of course, while the
core developers control the primary source tree for R, many people
around the world make contributions in the form of new feature, bug
fixes, or both.</p>

<p class="calibre2">Another key advantage that R has over many other statistical packages
(even today) is its sophisticated graphics capabilities. Râs ability
to create âpublication qualityâ graphics has existed since the very
beginning and has generally been better than competing
packages. Today, with many more visualization packages available than
before, that trend continues. Râs base graphics system allows for very
fine control over essentially every aspect of a plot or graph. Other
newer graphics systems, like lattice and ggplot2 allow for complex and
sophisticated visualizations of high-dimensional data.</p>

<p class="calibre2">R has maintained the original S philosophy, which is that it provides a
language that is both useful for interactive work, but contains a
powerful programming language for developing new tools. This allows
the user, who takes existing tools and applies them to data, to slowly
but surely become a developer who is creating new tools.</p>

<p class="calibre2">Finally, one of the joys of using R has nothing to do with the
language itself, but rather with the active and vibrant user
community. In many ways, a language is successful inasmuch as it
creates a platform with which many people can create new things. R is
that platform and thousands of people around the world have come
together to make contributions to R, to develop packages, and help
each other use R for all kinds of applications. The R-help and R-devel
mailing lists have been highly active for over a decade now and there
is considerable activity on web sites like Stack Overflow. </p>

<h3 id="calibre_link-26" class="calibre19">
<span class="section-number">3.6 </span>Free Software</h3>

<p class="calibre2">A major advantage that R has over many other statistical packages and
is that itâs free in the sense of free software (itâs also free in the
sense of free beer). The copyright for the primary source code for R
is held by the <a href="http://www.r-project.org/foundation/">R Foundation</a>
and is published under the <a href="http://www.gnu.org/licenses/gpl-2.0.html">GNU General Public License version
2.0</a>.</p>

<p class="calibre2">According to the Free Software Foundation, with <em class="calibre17">free software</em>, you
are granted the following <a href="http://www.gnu.org/philosophy/free-sw.html">four
freedoms</a></p>

<ul class="calibre20">
  <li class="calibre14">The freedom to run the program, for any purpose (freedom 0).</li>
  <li class="calibre14">The freedom to study how the program works, and adapt it to your
needs (freedom 1). Access to the source code is a precondition for
this.</li>
  <li class="calibre14">The freedom to redistribute copies so you can help your neighbor
(freedom 2).</li>
  <li class="calibre14">The freedom to improve the program, and release your improvements to
the public, so that the whole community benefits (freedom 3). Access
to the source code is a precondition for this.</li>
</ul>

<p class="calibre2">You can visit the <a href="http://www.fsf.org">Free Software Foundationâs web
site</a> to learn a lot more about free software. The
Free Software Foundation was founded by Richard Stallman in 1985 and
<a href="https://stallman.org">Stallmanâs personal web site</a> is an interesting
read if you happen to have some spare time.</p>

<h3 id="calibre_link-27" class="calibre19">
<span class="section-number">3.7 </span>Design of the R System</h3>

<p class="calibre2">The primary R system is available from the <a href="http://cran.r-project.org">Comprehensive R Archive
Network</a>, also known as CRAN. CRAN also
hosts many add-on packages that can be used to extend the
functionality of R. </p>

<p class="calibre2">The R system is divided into 2 conceptual parts:</p>

<ol class="calibre13">
  <li class="calibre14">The âbaseâ R system that you download from CRAN: 
<a href="http://cran.r-project.org/bin/linux/">Linux</a>
<a href="http://cran.r-project.org/bin/windows/">Windows</a>
<a href="http://cran.r-project.org/bin/macosx/">Mac</a> <a href="http://cran.r-project.org/src/base/R-3/R-3.1.3.tar.gz">Source
Code</a>
</li>
  <li class="calibre14">Everything else.</li>
</ol>

<p class="calibre2">R functionality is divided into a number of <em class="calibre17">packages</em>.</p>

<ul class="calibre20">
  <li class="calibre14">The âbaseâ R system contains, among other things, the <code class="calibre21">base</code> package
  which is required to run R and contains the most fundamental
  functions.</li>
  <li class="calibre14">The other packages contained in the âbaseâ system include <code class="calibre21">utils</code>,
  <code class="calibre21">stats</code>, <code class="calibre21">datasets</code>, <code class="calibre21">graphics</code>, <code class="calibre21">grDevices</code>, <code class="calibre21">grid</code>, <code class="calibre21">methods</code>,
  <code class="calibre21">tools</code>, <code class="calibre21">parallel</code>, <code class="calibre21">compiler</code>, <code class="calibre21">splines</code>, <code class="calibre21">tcltk</code>, <code class="calibre21">stats4</code>.</li>
  <li class="calibre14">There are also âRecommendedâ packages: <code class="calibre21">boot</code>, <code class="calibre21">class</code>, <code class="calibre21">cluster</code>,
  <code class="calibre21">codetools</code>, <code class="calibre21">foreign</code>, <code class="calibre21">KernSmooth</code>, <code class="calibre21">lattice</code>, <code class="calibre21">mgcv</code>, <code class="calibre21">nlme</code>,
  <code class="calibre21">rpart</code>, <code class="calibre21">survival</code>, <code class="calibre21">MASS</code>, <code class="calibre21">spatial</code>, <code class="calibre21">nnet</code>, <code class="calibre21">Matrix</code>.</li>
</ul>

<p class="calibre2">When you download a fresh installation of R from CRAN, you get all of
the above, which represents a substantial amount of
functionality. However, there are many other packages available:</p>

<ul class="calibre20">
  <li class="calibre14">There are over 4000 packages on CRAN that have been developed by
users and programmers around the world.</li>
  <li class="calibre14">There are also many packages associated with the <a href="http://bioconductor.org">Bioconductor
project</a>.</li>
  <li class="calibre14">People often make packages available on their personal websites;
there is no reliable way to keep track of how many packages are
available in this fashion.</li>
  <li class="calibre14">There are a number of packages being developed on repositories like
GitHub and BitBucket but there is no reliable listing of all these
packages.</li>
</ul>

<h3 id="calibre_link-28" class="calibre19">
<span class="section-number">3.8 </span>Limitations of R</h3>

<p class="calibre2">No programming language or statistical analysis system is perfect. R
certainly has a number of drawbacks. For starters, R is essentially
based on almost 50 year old technology, going back to the original S
system developed at Bell Labs. There was originally little built in
support for dynamic or 3-D graphics (but things have improved greatly
since the âold daysâ).</p>

<p class="calibre2">Another commonly cited limitation of R is that objects must generally
be stored in physical memory. This is in part due to the scoping rules
of the language, but R generally is more of a memory hog than other
statistical packages. However, there have been a number of
advancements to deal with this, both in the R core and also in a
number of packages developed by contributors. Also, computing power
and capacity has continued to grow over time and amount of physical
memory that can be installed on even a consumer-level laptop is
substantial. While we will likely never have enough physical memory on
a computer to handle the increasingly large datasets that are being
generated, the situation has gotten quite a bit easier over time.</p>

<p class="calibre2">At a higher level one âlimitationâ of R is that its functionality is
based on consumer demand and (voluntary) user contributions. If no one
feels like implementing your favorite method, then itâs <em class="calibre17">your</em> job to
implement it (or you need to pay someone to do it). The capabilities
of the R system generally reflect the interests of the R user
community. As the community has ballooned in size over the past 10
years, the capabilities have similarly increased. When I first started
using R, there was very little in the way of functionality for the
physical sciences (physics, astronomy, etc.). However, now some of
those communities have adopted R and we are seeing more code being
written for those kinds of applications.</p>

<p class="calibre2">If you want to know my general views on the usefulness of R, you can
see them here in the following exchange on the R-help mailing list
with Douglas Bates and Brian Ripley in June 2004:</p>

<blockquote class="calibre18">
  <p class="calibre2"><strong class="calibre16">Roger D. Peng</strong>: I donât think anyone actually believes that R is
designed to make <em class="calibre17">everyone</em> happy. For me, R does about 99% of the
things I need to do, but sadly, when I need to order a pizza, I still
have to pick up the telephone.  </p>
</blockquote>

<blockquote class="calibre18">
  <p class="calibre2"><strong class="calibre16">Douglas Bates</strong>: There are several chains of pizzerias in the U.S. that provide for Internet-based ordering (e.g. www.papajohnsonline.com) so, with the Internet modules in R, itâs only a matter of time before you will have a pizza-ordering function available.  </p>
</blockquote>

<blockquote class="calibre18">
  <p class="calibre2"><strong class="calibre16">Brian D. Ripley</strong>: Indeed, the GraphApp toolkit (used for the RGui interface under R for Windows, but Guido forgot to include it) provides one (for use in Sydney, Australia, we presume as that is where the GraphApp author hails from).  Alternatively, a Padovian has no need of ordering pizzas with both home and neighbourhood restaurants â¦.</p>
</blockquote>

<p class="calibre2">At this point in time, I think it would be fairly straightforward to
build a pizza ordering R package using something like the <code class="calibre21">RCurl</code> or
<code class="calibre21">httr</code> packages. Any takers?</p>

<h3 id="calibre_link-29" class="calibre19">
<span class="section-number">3.9 </span>R Resources</h3>

<h4 id="calibre_link-184" class="calibre19">Official Manuals</h4>

<p class="calibre2">As far as getting started with R by reading stuff, there is of course
this book. Also, available from <a href="http://cran.r-project.org">CRAN</a> are</p>

<ul class="calibre20">
  <li class="calibre14"><a href="http://cran.r-project.org/doc/manuals/r-release/R-intro.html">An Introduction to R</a></li>
  <li class="calibre14"><a href="http://cran.r-project.org/doc/manuals/r-release/R-data.html">R Data Import/Export</a></li>
  <li class="calibre14">
<a href="http://cran.r-project.org/doc/manuals/r-release/R-exts.html">Writing R
  Extensions</a>:
  Discusses how to write and organize R packages</li>
  <li class="calibre14">
<a href="http://cran.r-project.org/doc/manuals/r-release/R-admin.html">R Installation and
  Administration</a>:
  This is mostly for building R from the source code)</li>
  <li class="calibre14">
<a href="http://cran.r-project.org/doc/manuals/r-release/R-ints.html">R
  Internals</a>:
  This manual describes the low level structure of R and is
  primarily for developers and R core members</li>
  <li class="calibre14">
<a href="http://cran.r-project.org/doc/manuals/r-release/R-lang.html">R Language
Definition</a>:
This documents the R language and, again, is primarily for
developers</li>
</ul>

<h4 id="calibre_link-185" class="calibre19">Useful Standard Texts on S and R</h4>

<ul class="calibre20">
  <li class="calibre14">Chambers (2008). <em class="calibre17">Software for Data Analysis</em>, Springer</li>
  <li class="calibre14">Chambers (1998). <em class="calibre17">Programming with Data</em>, Springer: This book is
  <em class="calibre17">not</em> about R, but it describes the organization and philosophy of
  the current version of the S language, and is a useful reference.</li>
  <li class="calibre14">Venables &amp; Ripley (2002). <em class="calibre17">Modern Applied Statistics with S</em>,
  Springer: This is a standard textbook in statistics and describes
  how to use many statistical methods in R. This book has an
  associated R package (the <code class="calibre21">MASS</code> package) that comes with every
  installation of R.</li>
  <li class="calibre14">Venables &amp; Ripley (2000). <em class="calibre17">S Programming</em>, Springer: This book is a
  little old but is still relevant and accurate. Despite its title,
  this book is useful for R also.</li>
  <li class="calibre14">Murrell (2005). <em class="calibre17">R Graphics</em>, Chapman &amp; Hall/CRC Press: Paul Murrell
  wrote and designed much of the graphics system in R and this book
  essentially documents the underlying details. This is not so much
  a âuser-levelâ book as a developer-level book. But it is an
  important book for anyone interested in designing new types of
  graphics or visualizations.</li>
  <li class="calibre14">Wickham (2014). <em class="calibre17">Advanced R</em>, Chapman &amp; Hall/CRC Press: This book by
Hadley Wickham covers a number of areas including object-oriented
programming, functional programming, profiling and other advanced
topics.</li>
</ul>

<h4 id="calibre_link-186" class="calibre19">Other Resources</h4>

<ul class="calibre20">
  <li class="calibre14">Major technical publishers like Springer, Chapman &amp; Hall/CRC have
  entire series of books dedicated to using R in various
  applications. For example, Springer has a series of books called
  <em class="calibre17">Use R!</em>.</li>
  <li class="calibre14">A longer list of books can be found on the <a href="http://www.r-project.org/doc/bib/R-books.html">CRAN web
  site</a>.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-170">
<div class="calibre5">
<h2 id="calibre_link-30" class="calibre15">
<span class="section-number">4. </span>Getting Started with R</h2>

<h3 id="calibre_link-31" class="calibre19">
<span class="section-number">4.1 </span>Installation</h3>

<p class="calibre2">The first thing you need to do to get started with R is to install it
on your computer. R works on pretty much every platform available,
including the widely available Windows, Mac OS X, and Linux
systems. If you want to watch a step-by-step tutorial on how to install
R for Mac or Windows, you can watch these videos:</p>

<ul class="calibre20">
  <li class="calibre14"><a href="http://youtu.be/Ohnk9hcxf9M">Installing R on Windows</a></li>
  <li class="calibre14"><a href="https://youtu.be/uxuuWXU-7UQ">Installing R on the Mac</a></li>
</ul>

<p class="calibre2">There is also an integrated development environment available for R
that is built by RStudio. I really like this IDE&mdash;it has a nice
editor with syntax highlighting, there is an R object viewer, and
there are a number of other nice features that are integrated. You can
see how to install RStudio here</p>

<ul class="calibre20">
  <li class="calibre14"><a href="https://youtu.be/bM7Sfz-LADM">Installing RStudio</a></li>
</ul>

<p class="calibre2">The RStudio IDE is available from <a href="http://rstudio.com">RStudioâs web
site</a>.</p>

<h3 id="calibre_link-32" class="calibre19">
<span class="section-number">4.2 </span>Getting started with the R interface</h3>

<p class="calibre2">After you install R you will need to launch it and start writing R
code. Before we get to exactly how to write R code, itâs useful to get
a sense of how the system is organized. In these two videos I talk
about where to write code and how set your working directory, which
letâs R know where to find all of your files.</p>

<ul class="calibre20">
  <li class="calibre14"><a href="https://youtu.be/8xT3hmJQskU">Writing code and setting your working directory on the Mac</a></li>
  <li class="calibre14"><a href="https://youtu.be/XBcvH1BpIBo">Writing code and setting your working directory on Windows</a></li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-0">
<div class="calibre5">
<h2 id="calibre_link-33" class="calibre15">
<span class="section-number">5. </span>R Nuts and Bolts</h2>

<h3 id="calibre_link-34" class="calibre19">
<span class="section-number">5.1 </span>Entering Input</h3>

<p class="calibre2">
  <a href="https://youtu.be/vGY5i_J2c-c?t=4m43s">Watch a video of this section</a>
</p>

<p class="calibre2">At the R prompt we type expressions. The <code class="calibre21">&lt;-</code> symbol is the assignment
operator.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>
<code class="o">&gt;</code> msg <code class="o">&lt;-</code> <code class="s">"hello"</code>
</pre></div>

</figure>

<p class="calibre2">The grammar of the language determines whether an expression is
complete or not.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>x <code class="o">&lt;-</code>  <code class="c">## Incomplete expression</code>
</pre></div>

</figure>

<p class="calibre2">The # character indicates a comment. Anything to the right of the #
(including the # itself) is ignored. This is the only comment
character in R. Unlike some other languages, R does not support
multi-line comments or comment blocks.</p>

<h3 id="calibre_link-35" class="calibre19">
<span class="section-number">5.2 </span>Evaluation</h3>

<p class="calibre2">When a complete expression is entered at the prompt, it is evaluated
and the result of the evaluated expression is returned. The result may
be <em class="calibre17">auto-printed</em>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">5</code>  <code class="c">## nothing printed</code>
<code class="o">&gt;</code> x       <code class="c">## auto-printing occurs</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">5</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">)</code>  <code class="c">## explicit printing</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">5</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">[1]</code> shown in the output indicates that <code class="calibre21">x</code> is a vector and <code class="calibre21">5</code>
is its first element. </p>

<p class="calibre2">Typically with interactive work, we do not explicitly print objects
with the <code class="calibre21">print</code> function; it is much easier to just auto-print them
by typing the name of the object and hitting return/enter. However,
when writing scripts, functions, or longer programs, there is
sometimes a need to explicitly print objects because auto-printing
does not work in those settings.</p>

<p class="calibre2">When an R vector is printed you will notice that an index for the
vector is printed in square brackets <code class="calibre21">[]</code> on the side. For example,
see this integer sequence of length 20.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">11</code><code class="o">:</code><code class="o">30</code>
<code class="o">&gt;</code> x
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">11</code> <code class="o">12</code> <code class="o">13</code> <code class="o">14</code> <code class="o">15</code> <code class="o">16</code> <code class="o">17</code> <code class="o">18</code> <code class="o">19</code> <code class="o">20</code> <code class="o">21</code> <code class="o">22</code>
<code class="calibre21">[</code><code class="o">13</code><code class="calibre21">]</code> <code class="o">23</code> <code class="o">24</code> <code class="o">25</code> <code class="o">26</code> <code class="o">27</code> <code class="o">28</code> <code class="o">29</code> <code class="o">30</code>
</pre></div>

</figure>

<p class="calibre2">The numbers in the square brackets are not part of the vector itself,
they are merely part of the <em class="calibre17">printed output</em>. </p>

<p class="calibre2">With R, itâs important that one understand that there is a difference
between the actual R object and the manner in which that R object is
printed to the console. Often, the printed output may have additional
bells and whistles to make the output more friendly to the
users. However, these bells and whistles are not inherently part of
the object.</p>

<p class="calibre2">Note that the <code class="calibre21">:</code> operator is used to create integer sequences.</p>

<h3 id="calibre_link-36" class="calibre19">
<span class="section-number">5.3 </span>R Objects</h3>

<p class="calibre2">
  <a href="https://youtu.be/vGY5i_J2c-c">Watch a video of this section</a>
</p>

<p class="calibre2">R has five basic or âatomicâ classes of objects:</p>

<ul class="calibre20">
  <li class="calibre14">character</li>
  <li class="calibre14">numeric (real numbers)</li>
  <li class="calibre14">integer</li>
  <li class="calibre14">complex</li>
  <li class="calibre14">logical (True/False)</li>
</ul>

<p class="calibre2">The most basic type of R object is a vector. Empty vectors can be
created with the <code class="calibre21">vector()</code> function.  There is really only one rule
about vectors in R, which is that <strong class="calibre16">A vector can only contain objects
of the same class</strong>.</p>

<p class="calibre2">But of course, like any good rule, there is an exception, which is a
<em class="calibre17">list</em>, which we will get to a bit later. A list is represented as a
vector but can contain objects of different classes. Indeed, thatâs
usually why we use them.</p>

<p class="calibre2">There is also a class for ârawâ objects, but they are not commonly
used directly in data analysis and I wonât cover them here.</p>

<h3 id="calibre_link-37" class="calibre19">
<span class="section-number">5.4 </span>Numbers</h3>

<p class="calibre2">Numbers in R are generally treated as numeric objects (i.e. double
precision real numbers). This means that even if you see a number like
â1â or â2â in R, which you might think of as integers, they are likely
represented behind the scenes as numeric objects (so something like
â1.00â or â2.00â). This isnât important most of the timeâ¦except when
it is.</p>

<p class="calibre2">If you explicitly want an integer, you need to specify the <code class="calibre21">L</code>
suffix. So entering <code class="calibre21">1</code> in R gives you a numeric object; entering <code class="calibre21">1L</code>
explicitly gives you an integer object.</p>

<p class="calibre2">There is also a special number <code class="calibre21">Inf</code> which represents infinity. This
allows us to represent entities like <code class="calibre21">1 / 0</code>. This way, <code class="calibre21">Inf</code> can be
used in ordinary calculations; e.g. <code class="calibre21">1 / Inf</code> is 0.</p>

<p class="calibre2">The value <code class="calibre21">NaN</code> represents an undefined value (ânot a numberâ); e.g. 0
/ 0; <code class="calibre21">NaN</code> can also be thought of as a missing value (more on that
later)</p>

<h3 id="calibre_link-38" class="calibre19">
<span class="section-number">5.5 </span>Attributes</h3>

<p class="calibre2">R objects can have attributes, which are like metadata for the
object. These metadata can be very useful in that they help to
describe the object. For example, column names on a data frame help to
tell us what data are contained in each of the columns. Some examples
of R object attributes are</p>

<ul class="calibre20">
  <li class="calibre14">names, dimnames</li>
  <li class="calibre14">dimensions (e.g. matrices, arrays)</li>
  <li class="calibre14">class (e.g. integer, numeric)</li>
  <li class="calibre14">length</li>
  <li class="calibre14">other user-defined attributes/metadata</li>
</ul>

<p class="calibre2">Attributes of an object (if any) can be accessed using the
<code class="calibre21">attributes()</code> function. Not all R objects contain attributes, in
which case the <code class="calibre21">attributes()</code> function returns <code class="calibre21">NULL</code>.</p>

<h3 id="calibre_link-39" class="calibre19">
<span class="section-number">5.6 </span>Creating Vectors</h3>

<p class="calibre2">
  <a href="https://youtu.be/w8_XdYI3reU">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">c()</code> function can be used to create vectors of objects by
concatenating things together.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">0.5</code><code class="calibre21">,</code> <code class="o">0.6</code><code class="calibre21">)</code>       <code class="c">## numeric</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">TRUE</code><code class="calibre21">,</code> <code class="kc">FALSE</code><code class="calibre21">)</code>    <code class="c">## logical</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kp">T</code><code class="calibre21">,</code> <code class="kp">F</code><code class="calibre21">)</code>           <code class="c">## logical</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> <code class="s">"c"</code><code class="calibre21">)</code>  <code class="c">## character</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">9</code><code class="o">:</code><code class="o">29</code>              <code class="c">## integer</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1+0i</code><code class="calibre21">,</code> <code class="o">2+4i</code><code class="calibre21">)</code>     <code class="c">## complex</code>
</pre></div>

</figure>

<p class="calibre2">Note that in the above example, <code class="calibre21">T</code> and <code class="calibre21">F</code> are short-hand ways to
specify <code class="calibre21">TRUE</code> and <code class="calibre21">FALSE</code>. However, in general one should try to use
the explicit <code class="calibre21">TRUE</code> and <code class="calibre21">FALSE</code> values when indicating logical
values. The <code class="calibre21">T</code> and <code class="calibre21">F</code> values are primarily there for when youâre
feeling lazy.</p>

<p class="calibre2">You can also use the <code class="calibre21">vector()</code> function to initialize vectors.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">vector</code><code class="calibre21">(</code><code class="s">"numeric"</code><code class="calibre21">,</code> length <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code>
</pre></div>

</figure>

<h3 id="calibre_link-40" class="calibre19">
<span class="section-number">5.7 </span>Mixing Objects</h3>

<p class="calibre2">There are occasions when different classes of R objects get mixed
together. Sometimes this happens by accident but it can also happen on
purpose. So what happens with the following code?</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1.7</code><code class="calibre21">,</code> <code class="s">"a"</code><code class="calibre21">)</code>   <code class="c">## character</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">TRUE</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>    <code class="c">## numeric</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="kc">TRUE</code><code class="calibre21">)</code>  <code class="c">## character</code>
</pre></div>

</figure>

<p class="calibre2">In each case above, we are mixing objects of two different classes in
a vector. But remember that the only rule about vectors says this is
not allowed. When different objects are mixed in a vector, <em class="calibre17">coercion</em>
occurs so that every element in the vector is of the same class.</p>

<p class="calibre2">In the example above, we see the effect of <em class="calibre17">implicit coercion</em>. What R
tries to do is find a way to represent all of the objects in the
vector in a reasonable fashion. Sometimes this does exactly what you
want andâ¦sometimes not. For example, combining a numeric object with
a character object will create a character vector, because numbers can
usually be easily represented as strings.</p>

<h3 id="calibre_link-41" class="calibre19">
<span class="section-number">5.8 </span>Explicit Coercion</h3>

<p class="calibre2">Objects can be explicitly coerced from one class to another using the
<code class="calibre21">as.*</code> functions, if available.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">0</code><code class="o">:</code><code class="o">6</code>
<code class="o">&gt;</code> <code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"integer"</code>
<code class="o">&gt;</code> <code class="kp">as.numeric</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code>
<code class="o">&gt;</code> <code class="kp">as.logical</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>
<code class="o">&gt;</code> <code class="kp">as.character</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"0"</code> <code class="s">"1"</code> <code class="s">"2"</code> <code class="s">"3"</code> <code class="s">"4"</code> <code class="s">"5"</code> <code class="s">"6"</code>
</pre></div>

</figure>

<p class="calibre2">Sometimes, R canât figure out how to coerce an object and this can
result in <code class="calibre21">NA</code>s being produced.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> <code class="s">"c"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">as.numeric</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
Warning<code class="o">:</code> NAs introduced by coercion
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code>
<code class="o">&gt;</code> <code class="kp">as.logical</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code>
<code class="o">&gt;</code> <code class="kp">as.complex</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
Warning<code class="o">:</code> NAs introduced by coercion
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code>
</pre></div>

</figure>

<p class="calibre2">When nonsensical coercion takes place, you will usually get a warning
from R.</p>

<h3 id="calibre_link-42" class="calibre19">
<span class="section-number">5.9 </span>Matrices</h3>

<p class="calibre2">Matrices are vectors with a <em class="calibre17">dimension</em> attribute. The dimension
attribute is itself an integer vector of length 2 (number of rows,
number of columns)</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code>nrow <code class="o">=</code> <code class="o">2</code><code class="calibre21">,</code> ncol <code class="o">=</code> <code class="o">3</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> m
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>   <code class="kc">NA</code>   <code class="kc">NA</code>   <code class="kc">NA</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>   <code class="kc">NA</code>   <code class="kc">NA</code>   <code class="kc">NA</code>
<code class="o">&gt;</code> <code class="kp">dim</code><code class="calibre21">(</code>m<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code> <code class="o">3</code>
<code class="o">&gt;</code> <code class="kp">attributes</code><code class="calibre21">(</code>m<code class="calibre21">)</code>
<code class="o">$</code><code class="kp">dim</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code> <code class="o">3</code>
</pre></div>

</figure>

<p class="calibre2">Matrices are constructed <em class="calibre17">column-wise</em>, so entries can be thought of
starting in the âupper leftâ corner and running down the columns.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> nrow <code class="o">=</code> <code class="o">2</code><code class="calibre21">,</code> ncol <code class="o">=</code> <code class="o">3</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> m
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">3</code>    <code class="o">5</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>    <code class="o">2</code>    <code class="o">4</code>    <code class="o">6</code>
</pre></div>

</figure>

<p class="calibre2">Matrices can also be created directly from vectors by adding a
dimension attribute.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code> 
<code class="o">&gt;</code> m
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">1</code>  <code class="o">2</code>  <code class="o">3</code>  <code class="o">4</code>  <code class="o">5</code>  <code class="o">6</code>  <code class="o">7</code>  <code class="o">8</code>  <code class="o">9</code> <code class="o">10</code>
<code class="o">&gt;</code> <code class="kp">dim</code><code class="calibre21">(</code>m<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> m
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">4</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">5</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">3</code>    <code class="o">5</code>    <code class="o">7</code>    <code class="o">9</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>    <code class="o">2</code>    <code class="o">4</code>    <code class="o">6</code>    <code class="o">8</code>   <code class="o">10</code>
</pre></div>

</figure>

<p class="calibre2">Matrices can be created by <em class="calibre17">column-binding</em> or <em class="calibre17">row-binding</em> with the
<code class="calibre21">cbind()</code> and <code class="calibre21">rbind()</code> functions.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">3</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">10</code><code class="o">:</code><code class="o">12</code>
<code class="o">&gt;</code> <code class="kp">cbind</code><code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
     x  y
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code> <code class="o">1</code> <code class="o">10</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code> <code class="o">2</code> <code class="o">11</code>
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">,]</code> <code class="o">3</code> <code class="o">12</code>
<code class="o">&gt;</code> <code class="kp">rbind</code><code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code> 
  <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>
x    <code class="o">1</code>    <code class="o">2</code>    <code class="o">3</code>
y   <code class="o">10</code>   <code class="o">11</code>   <code class="o">12</code>
</pre></div>

</figure>

<h3 id="calibre_link-43" class="calibre19">
<span class="section-number">5.10 </span>Lists</h3>

<p class="calibre2">Lists are a special type of vector that can contain elements of
different classes. Lists are a very important data type in R and you
should get to know them well. Lists, in combination with the various
âapplyâ functions discussed later, make for a powerful combination.</p>

<p class="calibre2">Lists can be explicitly created using the <code class="calibre21">list()</code> function, which
takes an arbitrary number of arguments.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="s">"a"</code><code class="calibre21">,</code> <code class="kc">TRUE</code><code class="calibre21">,</code> <code class="o">1</code> <code class="o">+</code> <code class="o">4i</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1+4i</code>
</pre></div>

</figure>

<p class="calibre2">We can also create an empty list of a prespecified length with the
<code class="calibre21">vector()</code> function</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">vector</code><code class="calibre21">(</code><code class="s">"list"</code><code class="calibre21">,</code> length <code class="o">=</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>

<code class="calibre21">[[</code><code class="o">5</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>
</pre></div>

</figure>

<h3 id="calibre_link-44" class="calibre19">
<span class="section-number">5.11 </span>Factors</h3>

<p class="calibre2">
  <a href="https://youtu.be/NuY6jY4qE7I">Watch a video of this section</a>
</p>

<p class="calibre2">Factors are used to represent categorical data and can be unordered or
ordered. One can think of a factor as an integer vector where each
integer has a <em class="calibre17">label</em>. Factors are important in statistical modeling
and are treated specially by modelling functions like <code class="calibre21">lm()</code> and
<code class="calibre21">glm()</code>.</p>

<p class="calibre2">Using factors with labels is <em class="calibre17">better</em> than using integers because
factors are self-describing. Having a variable that has values âMaleâ
and âFemaleâ is better than a variable that has values 1 and 2.</p>

<p class="calibre2">Factor objects can be created with the <code class="calibre21">factor()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">factor</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">))</code> 
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> yes yes no  yes no 
Levels<code class="o">:</code> no yes
<code class="o">&gt;</code> <code class="kp">table</code><code class="calibre21">(</code>x<code class="calibre21">)</code> 
x
 no yes 
  <code class="o">2</code>   <code class="o">3</code> 
<code class="o">&gt;</code> <code class="c">## See the underlying representation of factor</code>
<code class="o">&gt;</code> <code class="kp">unclass</code><code class="calibre21">(</code>x<code class="calibre21">)</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code> <code class="o">2</code> <code class="o">1</code> <code class="o">2</code> <code class="o">1</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"levels"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"no"</code>  <code class="s">"yes"</code>
</pre></div>

</figure>

<p class="calibre2">Often factors will be automatically created for you when you read a
dataset in using a function like <code class="calibre21">read.table()</code>. Those functions often
default to creating factors when they encounter data that look like
characters or strings.</p>

<p class="calibre2">The order of the levels of a factor can be set using the <code class="calibre21">levels</code>
argument to <code class="calibre21">factor()</code>. This can be important in linear modelling
because the first level is used as the baseline level.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">factor</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> x  <code class="c">## Levels are put in alphabetical order</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> yes yes no  yes no 
Levels<code class="o">:</code> no yes
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">factor</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">,</code> <code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">),</code>
<code class="o">+</code>             levels <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"yes"</code><code class="calibre21">,</code> <code class="s">"no"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> yes yes no  yes no 
Levels<code class="o">:</code> yes no
</pre></div>

</figure>

<h3 id="calibre_link-45" class="calibre19">
<span class="section-number">5.12 </span>Missing Values</h3>

<p class="calibre2">Missing values are denoted by <code class="calibre21">NA</code> or <code class="calibre21">NaN</code> for q undefined
mathematical operations.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">is.na()</code> is used to test objects if they are <code class="calibre21">NA</code>
</li>
  <li class="calibre14">
<code class="calibre21">is.nan()</code> is used to test for <code class="calibre21">NaN</code>
</li>
  <li class="calibre14">
<code class="calibre21">NA</code> values have a class also, so there are integer <code class="calibre21">NA</code>, character
<code class="calibre21">NA</code>, etc.</li>
  <li class="calibre14">A <code class="calibre21">NaN</code> value is also <code class="calibre21">NA</code> but the converse is not true</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Create a vector with NAs in it</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>  
<code class="o">&gt;</code> <code class="c">## Return a logical vector indicating which elements are NA</code>
<code class="o">&gt;</code> <code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">)</code>    
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> <code class="c">## Return a logical vector indicating which elements are NaN</code>
<code class="o">&gt;</code> <code class="kp">is.nan</code><code class="calibre21">(</code>x<code class="calibre21">)</code>   
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
</pre></div>

</figure>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Now create a vector with both NA and NaN values</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kc">NaN</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> <code class="kp">is.nan</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
</pre></div>

</figure>

<h3 id="calibre_link-46" class="calibre19">
<span class="section-number">5.13 </span>Data Frames</h3>

<p class="calibre2">Data frames are used to store tabular data in R. They are an important
type of object in R and are used in a variety of statistical modeling
applications. Hadley Wickhamâs package
<a href="https://github.com/hadley/dplyr">dplyr</a> has an optimized set of
functions designed to work efficiently with data frames.</p>

<p class="calibre2">Data frames are represented as a special type of list where every
element of the list has to have the same length. Each element of the
list can be thought of as a column and the length of each element of
the list is the number of rows.</p>

<p class="calibre2">Unlike matrices, data frames can store different classes of objects in
each column. Matrices must have every element be the same class
(e.g. all integers or all numeric).</p>

<p class="calibre2">In addition to column names, indicating the names of the variables or
predictors, data frames have a special attribute called <code class="calibre21">row.names</code>
which indicate information about each row of the data frame.</p>

<p class="calibre2">Data frames are usually created by reading in a dataset using the
<code class="calibre21">read.table()</code> or <code class="calibre21">read.csv()</code>. However, data frames can also be
created explicitly with the <code class="calibre21">data.frame()</code> function or they can be
coerced from other types of objects like lists.</p>

<p class="calibre2">Data frames can be converted to a matrix by calling
<code class="calibre21">data.matrix()</code>. While it might seem that the <code class="calibre21">as.matrix()</code> function
should be used to coerce a data frame to a matrix, almost always, what
you want is the result of <code class="calibre21">data.matrix()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>foo <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> bar <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kp">T</code><code class="calibre21">,</code> <code class="kp">T</code><code class="calibre21">,</code> <code class="kp">F</code><code class="calibre21">,</code> <code class="kp">F</code><code class="calibre21">))</code> 
<code class="o">&gt;</code> x
  foo   bar
<code class="o">1</code>   <code class="o">1</code>  <code class="kc">TRUE</code>
<code class="o">2</code>   <code class="o">2</code>  <code class="kc">TRUE</code>
<code class="o">3</code>   <code class="o">3</code> <code class="kc">FALSE</code>
<code class="o">4</code>   <code class="o">4</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> <code class="kp">nrow</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
<code class="o">&gt;</code> <code class="kp">ncol</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
</pre></div>

</figure>

<h3 id="calibre_link-47" class="calibre19">
<span class="section-number">5.14 </span>Names</h3>

<p class="calibre2">R objects can have names, which is very useful for writing readable
code and self-describing objects. Here is an example of assigning
names to an integer vector.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">3</code>
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="kc">NULL</code>
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"New York"</code><code class="calibre21">,</code> <code class="s">"Seattle"</code><code class="calibre21">,</code> <code class="s">"Los Angeles"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
   New York     Seattle Los Angeles 
          <code class="o">1</code>           <code class="o">2</code>           <code class="o">3</code> 
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"New York"</code>    <code class="s">"Seattle"</code>     <code class="s">"Los Angeles"</code>
</pre></div>

</figure>

<p class="calibre2">Lists can also have names, which is often very useful.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code><code class="s">"Los Angeles"</code> <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> Boston <code class="o">=</code> <code class="o">2</code><code class="calibre21">,</code> London <code class="o">=</code> <code class="o">3</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
<code class="o">$</code><code class="s">`Los Angeles`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>

<code class="o">$</code>Boston
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>

<code class="o">$</code>London
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"Los Angeles"</code> <code class="s">"Boston"</code>      <code class="s">"London"</code>     
</pre></div>

</figure>

<p class="calibre2">Matrices can have both column and row names.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> nrow <code class="o">=</code> <code class="o">2</code><code class="calibre21">,</code> ncol <code class="o">=</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">dimnames</code><code class="calibre21">(</code>m<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">),</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"c"</code><code class="calibre21">,</code> <code class="s">"d"</code><code class="calibre21">))</code> 
<code class="o">&gt;</code> m
  <code class="kt">c</code> d
a <code class="o">1</code> <code class="o">3</code>
b <code class="o">2</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">Column names and row names can be set separately using the
<code class="calibre21">colnames()</code> and <code class="calibre21">rownames()</code> functions.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">colnames</code><code class="calibre21">(</code>m<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"h"</code><code class="calibre21">,</code> <code class="s">"f"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">rownames</code><code class="calibre21">(</code>m<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"x"</code><code class="calibre21">,</code> <code class="s">"z"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> m
  h f
x <code class="o">1</code> <code class="o">3</code>
z <code class="o">2</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">Note that for data frames, there is a separate function for setting
the row names, the <code class="calibre21">row.names()</code> function. Also, data frames do not
have column names, they just have names (like lists). So to set the
column names of a data frame just use the <code class="calibre21">names()</code> function. Yes, I
know its confusing. Hereâs a quick summary:</p>

<table class="calibre23">
  <thead class="calibre24">
    <tr class="calibre25">
      <th class="calibre26">Object</th>
      <th class="calibre26">Set column names</th>
      <th class="calibre26">Set row names</th>
    </tr>
  </thead>
  <tbody class="calibre27">
    <tr class="calibre25">
      <td class="calibre28">data frame</td>
      <td class="calibre28"><code class="calibre21">names()</code></td>
      <td class="calibre28"><code class="calibre21">row.names()</code></td>
    </tr>
    <tr class="calibre25">
      <td class="calibre28">matrix</td>
      <td class="calibre28"><code class="calibre21">colnames()</code></td>
      <td class="calibre28"><code class="calibre21">rownames()</code></td>
    </tr>
  </tbody>

</table>

<h3 id="calibre_link-48" class="calibre19">
<span class="section-number">5.15 </span>Summary</h3>

<p class="calibre2">There are a variety of different builtin-data types in R. In this
chapter we have reviewed the following</p>

<ul class="calibre20">
  <li class="calibre14">atomic classes: numeric, logical, character, integer, complex</li>
  <li class="calibre14">vectors, lists</li>
  <li class="calibre14">factors</li>
  <li class="calibre14">missing values</li>
  <li class="calibre14">data frames and matrices</li>
</ul>

<p class="calibre2">All R objects can have attributes that help to describe what is in the
object. Perhaps the most useful attribute is names, such as column and
row names in a data frame, or simply names in a vector or
list. Attributes like dimensions are also important as they can modify
the behavior of objects, like turning a vector into a matrix.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-9">
<div class="calibre5">
<h2 id="calibre_link-49" class="calibre15">
<span class="section-number">6. </span>Getting Data In and Out of R</h2>

<h3 id="calibre_link-50" class="calibre19">
<span class="section-number">6.1 </span>Reading and Writing Data</h3>

<p class="calibre2">
  <a href="https://youtu.be/Z_dc_FADyi4">Watch a video of this section</a>
</p>

<p class="calibre2">There are a few principal functions reading data into R. </p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">read.table</code>, <code class="calibre21">read.csv</code>, for reading tabular data </li>
  <li class="calibre14">
<code class="calibre21">readLines</code>, for reading lines of a text file</li>
  <li class="calibre14">
<code class="calibre21">source</code>, for reading in R code files (<code class="calibre21">inverse</code> of <code class="calibre21">dump</code>) </li>
  <li class="calibre14">
<code class="calibre21">dget</code>, for reading in R code files (<code class="calibre21">inverse</code> of <code class="calibre21">dput</code>)</li>
  <li class="calibre14">
<code class="calibre21">load</code>, for reading in saved workspaces</li>
  <li class="calibre14">
<code class="calibre21">unserialize</code>, for reading single R objects in binary form</li>
</ul>

<p class="calibre2">There are of course, many R packages that have been developed to read
in all kinds of other datasets, and you may need to resort to one of
these packages if you are working in a specific area.</p>

<p class="calibre2">There are analogous functions for writing data to files</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">write.table</code>, for writing tabular data to text files (i.e. CSV) or
connections</li>
  <li class="calibre14">
<code class="calibre21">writeLines</code>, for writing character data line-by-line to a file or
connection</li>
  <li class="calibre14">
<code class="calibre21">dump</code>, for dumping a textual representation of multiple R objects</li>
  <li class="calibre14">
<code class="calibre21">dput</code>, for outputting a textual representation of an R object</li>
  <li class="calibre14">
<code class="calibre21">save</code>, for saving an arbitrary number of R objects in binary format
(possibly compressed) to a file.</li>
  <li class="calibre14">
<code class="calibre21">serialize</code>, for converting an R object into a binary format for
outputting to a connection (or file).</li>
</ul>

<h3 id="calibre_link-51" class="calibre19">
<span class="section-number">6.2 </span>Reading Data Files with <code class="calibre11">read.table()</code>
</h3>

<p class="calibre2">The <code class="calibre21">read.table()</code> function is one of the most commonly used functions
for reading data. The help file for <code class="calibre21">read.table()</code> is worth reading in
its entirety if only because the function gets used a lot (run
<code class="calibre21">?read.table</code> in R). I know, I know, everyone always says to read the
help file, but this one is actually worth reading.</p>

<p class="calibre2">The <code class="calibre21">read.table()</code> function has a few important arguments:</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">file</code>, the name of a file, or a connection</li>
  <li class="calibre14">
<code class="calibre21">header</code>, logical indicating if the file has a header line</li>
  <li class="calibre14">
<code class="calibre21">sep</code>, a string indicating how the columns are separated</li>
  <li class="calibre14">
<code class="calibre21">colClasses</code>, a character vector indicating the class of each column
in the dataset</li>
  <li class="calibre14">
<code class="calibre21">nrows</code>, the number of rows in the dataset. By default
<code class="calibre21">read.table()</code> reads an entire file.</li>
  <li class="calibre14">
<code class="calibre21">comment.char</code>, a character string indicating the comment
character. This defalts to <code class="calibre21">"#"</code>. If there are no commented lines in
your file, itâs worth setting this to be the empty string <code class="calibre21">""</code>.</li>
  <li class="calibre14">
<code class="calibre21">skip</code>, the number of lines to skip from the beginning</li>
  <li class="calibre14">
<code class="calibre21">stringsAsFactors</code>, should character variables be coded as factors?
This defaults to <code class="calibre21">TRUE</code> because back in the old days, if you had
data that were stored as strings, it was because those strings
represented levels of a categorical variable. Now we have lots of
data that is text data and they donât always represent categorical
variables. So you may want to set this to be <code class="calibre21">FALSE</code> in those
cases. If you <em class="calibre17">always</em> want this to be <code class="calibre21">FALSE</code>, you can set a global
option via <code class="calibre21">options(stringsAsFactors = FALSE)</code>. Iâve never seen so
much heat generated on discussion forums about an R function
argument than the <code class="calibre21">stringsAsFactors</code> argument. Seriously.</li>
</ul>

<p class="calibre2">For small to moderately sized datasets, you can usually call
read.table without specifying any other arguments</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> data <code class="o">&lt;-</code> read.table<code class="calibre21">(</code><code class="s">"foo.txt"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">In this case, R will automatically</p>

<ul class="calibre20">
  <li class="calibre14">skip lines that begin with a #</li>
  <li class="calibre14">figure out how many rows there are (and how much memory needs to be
allocated)</li>
  <li class="calibre14">figure what type of variable is in each column of the table. </li>
</ul>

<p class="calibre2">Telling R all these things directly makes R run faster and more
efficiently. The <code class="calibre21">read.csv()</code> function is identical to read.table
except that some of the defaults are set differently (like the <code class="calibre21">sep</code>
argument).</p>

<h3 id="calibre_link-52" class="calibre19">
<span class="section-number">6.3 </span>Reading in Larger Datasets with read.table</h3>

<p class="calibre2">
  <a href="https://youtu.be/BJYYIJO3UFI">Watch a video of this section</a>
</p>

<p class="calibre2">With much larger datasets, there are a few things that you can do that
will make your life easier and will prevent R from choking.</p>

<ul class="calibre20">
  <li class="calibre14">Read the help page for read.table, which contains many hints</li>
  <li class="calibre14">Make a rough calculation of the memory required to store your
dataset (see the next section for an example of how to do this). If
the dataset is larger than the amount of RAM on your computer, you
can probably stop right here.</li>
  <li class="calibre14">Set <code class="calibre21">comment.char = ""</code> if there are no commented lines in your file.</li>
  <li class="calibre14">Use the <code class="calibre21">colClasses</code> argument. Specifying this option instead of
using the default can make âread.tableâ run MUCH faster, often twice
as fast. In order to use this option, you have to know the class of
each column in your data frame. If all of the columns are ânumericâ,
for example, then you can just set <code class="calibre21">colClasses = "numeric"</code>. A quick
an dirty way to figure out the classes of each column is the
following:</li>
</ul>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> initial <code class="o">&lt;-</code> read.table<code class="calibre21">(</code><code class="s">"datatable.txt"</code><code class="calibre21">,</code> nrows <code class="o">=</code> <code class="o">100</code><code class="calibre21">)</code>
<code class="o">&gt;</code> classes <code class="o">&lt;-</code> <code class="kp">sapply</code><code class="calibre21">(</code>initial<code class="calibre21">,</code> <code class="kp">class</code><code class="calibre21">)</code>
<code class="o">&gt;</code> tabAll <code class="o">&lt;-</code> read.table<code class="calibre21">(</code><code class="s">"datatable.txt"</code><code class="calibre21">,</code> colClasses <code class="o">=</code> classes<code class="calibre21">)</code>
</pre></div>

</figure>

<ul class="calibre20">
  <li class="calibre14">Set <code class="calibre21">nrows</code>. This doesnât make R run faster but it helps with memory
usage. A mild overestimate is okay. You can use the Unix tool <code class="calibre21">wc</code>
to calculate the number of lines in a file.</li>
</ul>

<p class="calibre2">In general, when using R with larger datasets, itâs also useful to
know a few things about your system.</p>

<ul class="calibre20">
  <li class="calibre14">How much memory is available on your system?</li>
  <li class="calibre14">What other applications are in use? Can you close any of them?</li>
  <li class="calibre14">Are there other users logged into the same system? </li>
  <li class="calibre14">What operating system ar you using? Some operating systems can limit
the amount of memory a single process can access</li>
</ul>

<h3 id="calibre_link-53" class="calibre19">
<span class="section-number">6.4 </span>Calculating Memory Requirements for R Objects</h3>

<p class="calibre2">Because R stores all of its objects physical memory, it is important
to be cognizant of how much memory is being used up by all of the data
objects residing in your workspace. One situation where itâs
particularly important to understand memory requirements is when you
are reading in a new dataset into R. Fortunately, itâs easy to make a
back of the envelope calculation of how much memory will be required
by a new dataset.</p>

<p class="calibre2">For example, suppose I have a data frame with 1,500,000 rows and 120
columns, all of which are numeric data. Roughly, how much memory is
required to store this data frame? Well, on most modern computers
<a href="http://en.wikipedia.org/wiki/Double-precision_floating-point_format">double precision floating point
numbers</a>
are stored using 64 bits of memory, or 8 bytes. Given that
information, you can do the following calculation</p>

<table class="calibre23">
  <tbody class="calibre27">
    <tr class="calibre25">
      <td class="calibre28">1,500,000 Ã 120 Ã 8 bytes/numeric</td>
      <td class="calibre28">= 1,440,000,000 bytes</td>
    </tr>
    <tr class="calibre25">
      <td class="calibre28">&nbsp;</td>
      <td class="calibre28">= 1,440,000,000 / 2<sup class="calibre29">20</sup> bytes/MB</td>
    </tr>
    <tr class="calibre25">
      <td class="calibre28">&nbsp;</td>
      <td class="calibre28">= 1,373.29 MB</td>
    </tr>
    <tr class="calibre25">
      <td class="calibre28">&nbsp;</td>
      <td class="calibre28">= 1.34 GB</td>
    </tr>
  </tbody>

</table>

<p class="calibre2">So the dataset would require about 1.34 GB of RAM. Most computers
these days have at least that much RAM. However, you need to be aware
of</p>

<ul class="calibre20">
  <li class="calibre14">what other programs might be running on your computer, using up RAM</li>
  <li class="calibre14">what other R objects might already be taking up RAM in your workspace</li>
</ul>

<p class="calibre2">Reading in a large dataset for which you do not have enough RAM is one
easy way to freeze up your computer (or at least your R session). This
is usually an unpleasant experience that usually requires you to kill
the R process, in the best case scenario, or reboot your computer, in
the worst case. So make sure to do a rough calculation of memeory
requirements before reading in a large dataset. Youâll thank me later.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-171">
<div class="calibre5">
<h2 id="calibre_link-54" class="calibre15">
<span class="section-number">7. </span>Using the <code class="calibre11">readr</code> Package</h2>

<p class="calibre2">The <code class="calibre21">readr</code> package is recently developed by Hadley Wickham to deal
with reading in large flat files quickly. The package provides
replacements for functions like <code class="calibre21">read.table()</code> and <code class="calibre21">read.csv()</code>. The
analogous functions in <code class="calibre21">readr</code> are <code class="calibre21">read_table()</code> and
<code class="calibre21">read_csv()</code>. These functions are often <em class="calibre17">much</em> faster than their base
R analogues and provide a few other nice features such as progress
meters.</p>

<p class="calibre2">For the most part, you can read use <code class="calibre21">read_table()</code> and <code class="calibre21">read_csv()</code>
pretty much anywhere you might use <code class="calibre21">read.table()</code> and <code class="calibre21">read.csv()</code>. In
addition, if there are non-fatal problems that occur while reading in
the data, you will get a warning and the returned data frame will have
some information about which rows/observations triggered the
warning. This can be very helpful for âdebuggingâ problems with your
data before you get neck deep in data analysis.</p>

<p class="calibre2">The importance of the <code class="calibre21">read_csv</code> function is perhaps better understood
from an historical perspective. Râs built in <code class="calibre21">read.csv</code> function
similarly reads CSV files, but the <code class="calibre21">read_csv</code> function in <code class="calibre21">readr</code>
builds on that by removing some of the quirks and âgotchasâ of
<code class="calibre21">read.csv</code> as well as dramatically optimizing the speed with which it
can read data into R. The <code class="calibre21">read_csv</code> function also adds some nice
user-oriented features like a progress meter and a compact method for
specifying column types.</p>

<p class="calibre2">A typical call to <code class="calibre21">read_csv</code> will look as follows.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>readr<code class="calibre21">)</code>
<code class="o">&gt;</code> teams <code class="o">&lt;-</code> read_csv<code class="calibre21">(</code><code class="s">"data/team_standings.csv"</code><code class="calibre21">)</code>
Parsed with column specification<code class="o">:</code>
cols<code class="calibre21">(</code>
  Standing <code class="o">=</code> col_double<code class="calibre21">(),</code>
  Team <code class="o">=</code> col_character<code class="calibre21">()</code>
<code class="calibre21">)</code>
<code class="o">&gt;</code> teams
<code class="c"># A tibble: 32 x 2</code>
   Standing Team       
      <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>chr<code class="o">&gt;</code>      
 <code class="o">1</code>        <code class="o">1</code> Spain      
 <code class="o">2</code>        <code class="o">2</code> Netherlands
 <code class="o">3</code>        <code class="o">3</code> Germany    
 <code class="o">4</code>        <code class="o">4</code> Uruguay    
 <code class="o">5</code>        <code class="o">5</code> Argentina  
 <code class="o">6</code>        <code class="o">6</code> Brazil     
 <code class="o">7</code>        <code class="o">7</code> Ghana      
 <code class="o">8</code>        <code class="o">8</code> Paraguay   
 <code class="o">9</code>        <code class="o">9</code> Japan      
<code class="o">10</code>       <code class="o">10</code> Chile      
<code class="c"># â¦ with 22 more rows</code>
</pre></div>

</figure>

<p class="calibre2">By default, <code class="calibre21">read_csv</code> will open a CSV file and read it in line-by-line. It will also (by default), read in the first few rows of the table in order to figure out the type of each column (i.e. integer, character, etc.). From the <code class="calibre21">read_csv</code> help page:</p>

<blockquote class="calibre18">
  <p class="calibre2">If âNULLâ, all column types will be imputed from the first 1000 rows on the input. This is convenient (and fast), but not robust. If the imputation fails, youâll need to supply the correct types yourself.</p>
</blockquote>

<p class="calibre2">You can specify the type of each column with the <code class="calibre21">col_types</code> argument.</p>

<p class="calibre2">In general, itâs a good idea to specify the column types explicitly. This rules out any possible guessing errors on the part of <code class="calibre21">read_csv</code>. Also, specifying the column types explicitly provides a useful safety check in case anything about the dataset should change without you knowing about it.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> teams <code class="o">&lt;-</code> read_csv<code class="calibre21">(</code><code class="s">"data/team_standings.csv"</code><code class="calibre21">,</code> col_types <code class="o">=</code> <code class="s">"cc"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Note that the <code class="calibre21">col_types</code> argument accepts a compact representation. Here <code class="calibre21">"cc"</code> indicates that the first column is <code class="calibre21">character</code> and the second column is <code class="calibre21">character</code> (there are only two columns). Using the <code class="calibre21">col_types</code> argument is useful because often it is not easy to automatically figure out the type of a column by looking at a few rows (especially if a column has many missing values).</p>

<p class="calibre2">The <code class="calibre21">read_csv</code> function will also read compressed files automatically. There is no need to decompress the file first or use the <code class="calibre21">gzfile</code> connection function. The following call reads a gzip-compressed CSV file containing download logs from the RStudio CRAN mirror.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> logs <code class="o">&lt;-</code> read_csv<code class="calibre21">(</code><code class="s">"data/2016-07-19.csv.bz2"</code><code class="calibre21">,</code> n_max <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code>
Parsed with column specification<code class="o">:</code>
cols<code class="calibre21">(</code>
  date <code class="o">=</code> col_date<code class="calibre21">(</code>format <code class="o">=</code> <code class="s">""</code><code class="calibre21">),</code>
  time <code class="o">=</code> col_time<code class="calibre21">(</code>format <code class="o">=</code> <code class="s">""</code><code class="calibre21">),</code>
  size <code class="o">=</code> col_double<code class="calibre21">(),</code>
  r_version <code class="o">=</code> col_character<code class="calibre21">(),</code>
  r_arch <code class="o">=</code> col_character<code class="calibre21">(),</code>
  r_os <code class="o">=</code> col_character<code class="calibre21">(),</code>
  package <code class="o">=</code> col_character<code class="calibre21">(),</code>
  version <code class="o">=</code> col_character<code class="calibre21">(),</code>
  country <code class="o">=</code> col_character<code class="calibre21">(),</code>
  ip_id <code class="o">=</code> col_double<code class="calibre21">()</code>
<code class="calibre21">)</code>
</pre></div>

</figure>
<p class="calibre2">Note that the warnings indicate that <code class="calibre21">read_csv</code> may have had some difficulty identifying the type of each column. This can be solved by using the <code class="calibre21">col_types</code> argument.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> logs <code class="o">&lt;-</code> read_csv<code class="calibre21">(</code><code class="s">"data/2016-07-19.csv.bz2"</code><code class="calibre21">,</code> col_types <code class="o">=</code> <code class="s">"ccicccccci"</code><code class="calibre21">,</code> n_max <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> logs
<code class="c"># A tibble: 10 x 10</code>
   date    time      size r_version r_arch r_os    package version country ip_id
   <code class="o">&lt;</code>chr<code class="o">&gt;</code>   <code class="o">&lt;</code>chr<code class="o">&gt;</code>    <code class="o">&lt;</code>int<code class="o">&gt;</code> <code class="o">&lt;</code>chr<code class="o">&gt;</code>     <code class="o">&lt;</code>chr<code class="o">&gt;</code>  <code class="o">&lt;</code>chr<code class="o">&gt;</code>   <code class="o">&lt;</code>chr<code class="o">&gt;</code>   <code class="o">&lt;</code>chr<code class="o">&gt;</code>   <code class="o">&lt;</code>chr<code class="o">&gt;</code>   <code class="o">&lt;</code>int<code class="o">&gt;</code>
 <code class="o">1</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">1.89e6</code> <code class="o">3.3.0</code>     x86_64 mingw32 data.tâ¦ <code class="o">1.9.6</code>   US          <code class="o">1</code>
 <code class="o">2</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">4.54e4</code> <code class="o">3.3.1</code>     x86_64 mingw32 assertâ¦ <code class="o">0.1</code>     US          <code class="o">2</code>
 <code class="o">3</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">1.43e7</code> <code class="o">3.3.1</code>     x86_64 mingw32 stringi <code class="o">1.1.1</code>   DE          <code class="o">3</code>
 <code class="o">4</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">1.89e6</code> <code class="o">3.3.1</code>     x86_64 mingw32 data.tâ¦ <code class="o">1.9.6</code>   US          <code class="o">4</code>
 <code class="o">5</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">3.90e5</code> <code class="o">3.3.1</code>     x86_64 mingw32 foreach <code class="o">1.4.3</code>   US          <code class="o">4</code>
 <code class="o">6</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">4.88e4</code> <code class="o">3.3.1</code>     x86_64 linux<code class="o">-</code>â¦ tree    <code class="o">1.0-37</code>  CO          <code class="o">5</code>
 <code class="o">7</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">5.25e2</code> <code class="o">3.3.1</code>     x86_64 darwinâ¦ survivâ¦ <code class="o">2.39-5</code>  US          <code class="o">6</code>
 <code class="o">8</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">3.23e6</code> <code class="o">3.3.1</code>     x86_64 mingw32 Rcpp    <code class="o">0.12.5</code>  US          <code class="o">2</code>
 <code class="o">9</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">5.56e5</code> <code class="o">3.3.1</code>     x86_64 mingw32 tibble  <code class="o">1.1</code>     US          <code class="o">2</code>
<code class="o">10</code> <code class="o">2016-0</code>â¦ <code class="o">22</code><code class="o">:</code><code class="o">00</code>â¦  <code class="o">1.52e5</code> <code class="o">3.3.1</code>     x86_64 mingw32 magritâ¦ <code class="o">1.5</code>     US          <code class="o">2</code>
</pre></div>

</figure>

<p class="calibre2">You can specify the column type in a more detailed fashion by using the various <code class="calibre21">col_*</code> functions. For example, in the log data above, the first column is actually a date, so it might make more sense to read it in as a Date variable. If we wanted to just read in that first column, we could do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> logdates <code class="o">&lt;-</code> read_csv<code class="calibre21">(</code><code class="s">"data/2016-07-19.csv.bz2"</code><code class="calibre21">,</code> 
<code class="o">+</code>                      col_types <code class="o">=</code> cols_only<code class="calibre21">(</code>date <code class="o">=</code> col_date<code class="calibre21">()),</code>
<code class="o">+</code>                      n_max <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> logdates
<code class="c"># A tibble: 10 x 1</code>
   date      
   <code class="o">&lt;</code><code class="kp">date</code><code class="o">&gt;</code>    
 <code class="o">1</code> <code class="o">2016-07-19</code>
 <code class="o">2</code> <code class="o">2016-07-19</code>
 <code class="o">3</code> <code class="o">2016-07-19</code>
 <code class="o">4</code> <code class="o">2016-07-19</code>
 <code class="o">5</code> <code class="o">2016-07-19</code>
 <code class="o">6</code> <code class="o">2016-07-19</code>
 <code class="o">7</code> <code class="o">2016-07-19</code>
 <code class="o">8</code> <code class="o">2016-07-19</code>
 <code class="o">9</code> <code class="o">2016-07-19</code>
<code class="o">10</code> <code class="o">2016-07-19</code>
</pre></div>

</figure>

<p class="calibre2">Now the <code class="calibre21">date</code> column is stored as a <code class="calibre21">Date</code> object which can be used for relevant date-related computations (for example, see the <code class="calibre21">lubridate</code> package).</p>

<aside class="calibre30">
  <p class="calibre2">The <code class="calibre21">read_csv</code> function has a <code class="calibre21">progress</code> option that defaults to TRUE. This options provides a nice progress meter while the CSV file is being read. However, if you are using <code class="calibre21">read_csv</code> in a function, or perhaps embedding it in a loop, itâs probably best to set <code class="calibre21">progress = FALSE</code>.</p>

</aside>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-13">
<div class="calibre5">
<h2 id="calibre_link-55" class="calibre15">
<span class="section-number">8. </span>Using Textual and Binary Formats for Storing Data</h2>

<p class="calibre2">
  <a href="https://youtu.be/5mIPigbNDfk">Watch a video of this chapter</a>
</p>

<p class="calibre2">There are a variety of ways that data can be stored, including
structured text files like CSV or tab-delimited, or more complex
binary formats. However, there is an intermediate format that is
textual, but not as simple as something like CSV. The format is native
to R and is somewhat readable because of its textual nature.</p>

<p class="calibre2">One can create a more descriptive representation of an R object by
using the <code class="calibre21">dput()</code> or <code class="calibre21">dump()</code> functions. The <code class="calibre21">dump()</code> and <code class="calibre21">dput()</code>
functions are useful because the resulting textual format is
edit-able, and in the case of corruption, potentially
recoverable. Unlike writing out a table or CSV file, <code class="calibre21">dump()</code> and
<code class="calibre21">dput()</code> preserve the <em class="calibre17">metadata</em> (sacrificing some readability), so
that another user doesnât have to specify it all over again. For
example, we can preserve the class of each column of a table or the
levels of a factor variable.</p>

<p class="calibre2">Textual formats can work much better with version control programs
like subversion or git which can only track changes meaningfully in
text files. In addition, textual formats can be longer-lived; if there
is corruption somewhere in the file, it can be easier to fix the
problem because one can just open the file in an editor and look at it
(although this would probably only be done in a worst case
scenario!). Finally, textual formats adhere to the <a href="http://www.catb.org/esr/writings/taoup/">Unix
philosophy</a>, if that means
anything to you.</p>

<p class="calibre2">There are a few downsides to using these intermediate textual formats.
The format is not very space-efficient, because all of the metadata is
specified. Also, it is really only partially readable. In some
instances it might be preferable to have data stored in a CSV file and
then have a separate code file that specifies the metadata.</p>

<h3 id="calibre_link-56" class="calibre19">
<span class="section-number">8.1 </span>Using <code class="calibre11">dput()</code> and <code class="calibre11">dump()</code>
</h3>

<p class="calibre2">One way to pass data around is by deparsing the R object with <code class="calibre21">dput()</code>
and reading it back in (parsing it) using <code class="calibre21">dget()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Create a data frame</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> b <code class="o">=</code> <code class="s">"a"</code><code class="calibre21">)</code>  
<code class="o">&gt;</code> <code class="c">## Print 'dput' output to console</code>
<code class="o">&gt;</code> <code class="kp">dput</code><code class="calibre21">(</code>y<code class="calibre21">)</code>                          
<code class="kp">structure</code><code class="calibre21">(</code><code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> b <code class="o">=</code> <code class="s">"a"</code><code class="calibre21">),</code> class <code class="o">=</code> <code class="s">"data.frame"</code><code class="calibre21">,</code> row.names <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">NA</code><code class="calibre21">,</code> 
<code class="o">-1L</code><code class="calibre21">))</code>
</pre></div>

</figure>

<p class="calibre2">Notice that the <code class="calibre21">dput()</code> output is in the form of R code and that it
preserves metadata like the class of the object, the row names, and
the column names.</p>

<p class="calibre2">The output of <code class="calibre21">dput()</code> can also be saved directly to a file.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Send 'dput' output to a file</code>
<code class="o">&gt;</code> <code class="kp">dput</code><code class="calibre21">(</code>y<code class="calibre21">,</code> file <code class="o">=</code> <code class="s">"y.R"</code><code class="calibre21">)</code>            
<code class="o">&gt;</code> <code class="c">## Read in 'dput' output from a file</code>
<code class="o">&gt;</code> new.y <code class="o">&lt;-</code> <code class="kp">dget</code><code class="calibre21">(</code><code class="s">"y.R"</code><code class="calibre21">)</code>             
<code class="o">&gt;</code> new.y
  a b
<code class="o">1</code> <code class="o">1</code> a
</pre></div>

</figure>

<p class="calibre2">Multiple objects can be deparsed at once using the dump function and
read back in using <code class="calibre21">source</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="s">"foo"</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1L</code><code class="calibre21">,</code> b <code class="o">=</code> <code class="s">"a"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">We can <code class="calibre21">dump()</code> R objects to a file by passing a character vector of
their names.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">dump</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"x"</code><code class="calibre21">,</code> <code class="s">"y"</code><code class="calibre21">),</code> file <code class="o">=</code> <code class="s">"data.R"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> <code class="kp">rm</code><code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">The inverse of <code class="calibre21">dump()</code> is <code class="calibre21">source()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">source</code><code class="calibre21">(</code><code class="s">"data.R"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>y<code class="calibre21">)</code>
<code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">1</code> obs. of  <code class="o">2</code> variables<code class="o">:</code>
 <code class="o">$</code> a<code class="o">:</code> int <code class="o">1</code>
 <code class="o">$</code> b<code class="o">:</code> chr <code class="s">"a"</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"foo"</code>
</pre></div>

</figure>

<h3 id="calibre_link-57" class="calibre19">
<span class="section-number">8.2 </span>Binary Formats</h3>

<p class="calibre2">The complement to the textual format is the binary format, which is
sometimes necessary to use for efficiency purposes, or because thereâs
just no useful way to represent data in a textual manner. Also, with
numeric data, one can often lose precision when converting to and from
a textual format, so itâs better to stick with a binary format. </p>

<p class="calibre2">The key functions for converting R objects into a binary format are
<code class="calibre21">save()</code>, <code class="calibre21">save.image()</code>, and <code class="calibre21">serialize()</code>. Individual R objects can
be saved to a file using the <code class="calibre21">save()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> a <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>x <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">),</code> y <code class="o">=</code> runif<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">))</code>
<code class="o">&gt;</code> b <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">3</code><code class="calibre21">,</code> <code class="o">4.4</code><code class="calibre21">,</code> <code class="o">1</code> <code class="o">/</code> <code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Save 'a' and 'b' to a file</code>
<code class="o">&gt;</code> <code class="kp">save</code><code class="calibre21">(</code>a<code class="calibre21">,</code> b<code class="calibre21">,</code> file <code class="o">=</code> <code class="s">"mydata.rda"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Load 'a' and 'b' into your workspace</code>
<code class="o">&gt;</code> <code class="kp">load</code><code class="calibre21">(</code><code class="s">"mydata.rda"</code><code class="calibre21">)</code>              
</pre></div>

</figure>

<p class="calibre2">If you have a lot of objects that you want to save to a file, you can
save all objects in your workspace using the <code class="calibre21">save.image()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Save everything to a file</code>
<code class="o">&gt;</code> <code class="kp">save.image</code><code class="calibre21">(</code>file <code class="o">=</code> <code class="s">"mydata.RData"</code><code class="calibre21">)</code>   
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## load all objects in this file</code>
<code class="o">&gt;</code> <code class="kp">load</code><code class="calibre21">(</code><code class="s">"mydata.RData"</code><code class="calibre21">)</code>                
</pre></div>

</figure>

<p class="calibre2">Notice that Iâve used the <code class="calibre21">.rda</code> extension when using <code class="calibre21">save()</code> and the
<code class="calibre21">.RData</code> extension when using <code class="calibre21">save.image()</code>. This is just my personal
preference; you can use whatever file extension you want. The <code class="calibre21">save()</code>
and <code class="calibre21">save.image()</code> functions do not care. However, <code class="calibre21">.rda</code> and <code class="calibre21">.RData</code>
are fairly common extensions and you may want to use them because they
are recognized by other software.</p>

<p class="calibre2">The <code class="calibre21">serialize()</code> function is used to convert individual R objects
into a binary format that can be communicated across an arbitrary
connection. This may get sent to a file, but it could get sent over a
network or other connection.</p>

<p class="calibre2">When you call <code class="calibre21">serialize()</code> on an R object, the output will be a raw
vector coded in hexadecimal format.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">serialize</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kc">NULL</code><code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">58</code> <code class="o">0</code>a <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">03</code> <code class="o">00</code> <code class="o">04</code> <code class="o">00</code> <code class="o">02</code> <code class="o">00</code> <code class="o">03</code> <code class="o">05</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">05</code> <code class="o">55</code> <code class="o">54</code> <code class="o">46</code> <code class="o">2</code>d <code class="o">38</code> <code class="o">00</code> <code class="o">00</code>
<code class="calibre21">[</code><code class="o">26</code><code class="calibre21">]</code> <code class="o">00</code> <code class="o">13</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">03</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">0</code>e <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">01</code> <code class="o">3</code>f f0 <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code>
<code class="calibre21">[</code><code class="o">51</code><code class="calibre21">]</code> <code class="o">0</code>e <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">01</code> <code class="o">40</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">0</code>e <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">01</code> <code class="o">40</code> <code class="o">08</code> <code class="o">00</code> <code class="o">00</code>
<code class="calibre21">[</code><code class="o">76</code><code class="calibre21">]</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code> <code class="o">00</code>
</pre></div>

</figure>

<p class="calibre2">If you want, this can be sent to a file, but in that case you are
better off using something like <code class="calibre21">save()</code>. </p>

<p class="calibre2">The benefit of the <code class="calibre21">serialize()</code> function is that it is the only way
to perfectly represent an R object in an exportable format, without
losing precision or any metadata. If that is what you need, then
<code class="calibre21">serialize()</code> is the function for you.</p>


</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-5">
<div class="calibre5">
<h2 id="calibre_link-58" class="calibre15">
<span class="section-number">9. </span>Interfaces to the Outside World</h2>

<p class="calibre2">
  <a href="https://youtu.be/Pb01WoJRUtY">Watch a video of this chapter</a>
</p>

<p class="calibre2">Data are read in using <em class="calibre17">connection</em> interfaces. Connections can be
made to files (most common) or to other more exotic things.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">file</code>, opens a connection to a file</li>
  <li class="calibre14">
<code class="calibre21">gzfile</code>, opens a connection to a file compressed with gzip</li>
  <li class="calibre14">
<code class="calibre21">bzfile</code>, opens a connection to a file compressed with bzip2 </li>
  <li class="calibre14">
<code class="calibre21">url</code>, opens a connection to a webpage</li>
</ul>

<p class="calibre2">In general, connections are powerful tools that let you navigate files
or other external objects. Connections can be thought of as a
translator that lets you talk to objects that are outside of R. Those
outside objects could be anything from a data base, a simple text
file, or a a web service API. Connections allow R functions to talk to
all these different external objects without you having to write
custom code for each object.</p>

<h3 id="calibre_link-59" class="calibre19">
<span class="section-number">9.1 </span>File Connections</h3>

<p class="calibre2">Connections to text files can be created with the <code class="calibre21">file()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">file</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>description <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> open <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> blocking <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> encoding <code class="o">=</code> <code class="kp">getOption</code><code class="calibre21">(</code><code class="s">"encoding"</code><code class="calibre21">),</code> 
    raw <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> method <code class="o">=</code> <code class="kp">getOption</code><code class="calibre21">(</code><code class="s">"url.method"</code><code class="calibre21">,</code> <code class="s">"default"</code><code class="calibre21">))</code>  
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">file()</code> function has a number of arguments that are common to
many other connection functions so itâs worth going into a little
detail here.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">description</code> is the name of the file </li>
  <li class="calibre14">
<code class="calibre21">open</code> is a code indicating what mode the file should be opened in</li>
</ul>

<p class="calibre2">The <code class="calibre21">open</code> argument allows for the following options:</p>

<ul class="calibre20">
  <li class="calibre14">ârâ open file in read only mode</li>
  <li class="calibre14">âwâ open a file for writing (and initializing a new file)</li>
  <li class="calibre14">âaâ open a file for appending</li>
  <li class="calibre14">ârbâ, âwbâ, âabâ reading, writing, or appending in binary mode (Windows)</li>
</ul>

<p class="calibre2">In practice, we often donât need to deal with the connection interface
directly as many functions for reading and writing data just deal with
it in the background.</p>

<p class="calibre2">For example, if one were to explicitly use connections to read a CSV
file in to R, it might look like this,</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Create a connection to 'foo.txt'</code>
<code class="o">&gt;</code> con <code class="o">&lt;-</code> <code class="kp">file</code><code class="calibre21">(</code><code class="s">"foo.txt"</code><code class="calibre21">)</code>       
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Open connection to 'foo.txt' in read-only mode</code>
<code class="o">&gt;</code> <code class="kp">open</code><code class="calibre21">(</code>con<code class="calibre21">,</code> <code class="s">"r"</code><code class="calibre21">)</code>               
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Read from the connection</code>
<code class="o">&gt;</code> data <code class="o">&lt;-</code> read.csv<code class="calibre21">(</code>con<code class="calibre21">)</code>        
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Close the connection</code>
<code class="o">&gt;</code> <code class="kp">close</code><code class="calibre21">(</code>con<code class="calibre21">)</code>                   
</pre></div>

</figure>

<p class="calibre2">which is the same as</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> data <code class="o">&lt;-</code> read.csv<code class="calibre21">(</code><code class="s">"foo.txt"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">In the background, <code class="calibre21">read.csv()</code> opens a connection to the file
<code class="calibre21">foo.txt</code>, reads from it, and closes the connection when itâs done.</p>

<p class="calibre2">The above example shows the basic approach to using
connections. Connections must be opened, then the are read from or
written to, and then they are closed.</p>

<h3 id="calibre_link-60" class="calibre19">
<span class="section-number">9.2 </span>Reading Lines of a Text File</h3>

<p class="calibre2">Text files can be read line by line using the <code class="calibre21">readLines()</code>
function. This function is useful for reading text files that may be
unstructured or contain non-standard data. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Open connection to gz-compressed text file</code>
<code class="o">&gt;</code> con <code class="o">&lt;-</code> <code class="kp">gzfile</code><code class="calibre21">(</code><code class="s">"words.gz"</code><code class="calibre21">)</code>   
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">readLines</code><code class="calibre21">(</code>con<code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"1080"</code>     <code class="s">"10-point"</code> <code class="s">"10th"</code>     <code class="s">"11-point"</code> <code class="s">"12-point"</code> <code class="s">"16-point"</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="s">"18-point"</code> <code class="s">"1st"</code>      <code class="s">"2"</code>        <code class="s">"20-point"</code>
</pre></div>

</figure>

<p class="calibre2">For more structured text data like CSV files or tab-delimited files,
there are other functions like <code class="calibre21">read.csv()</code> or <code class="calibre21">read.table()</code>.</p>

<p class="calibre2">The above example used the <code class="calibre21">gzfile()</code> function which is used to create
a connection to files compressed using the gzip algorithm. This
approach is useful because it allows you to read from a file without
having to uncompress the file first, which would be a waste of space
and time.</p>

<p class="calibre2">There is a complementary function <code class="calibre21">writeLines()</code> that takes a
character vector and writes each element of the vector one line at a
time to a text file.</p>

<h3 id="calibre_link-61" class="calibre19">
<span class="section-number">9.3 </span>Reading From a URL Connection</h3>

<p class="calibre2">The <code class="calibre21">readLines()</code> function can be useful for reading in lines of
webpages. Since web pages are basically text files that are stored on
a remote server, there is conceptually not much difference between a
web page and a local text file. However, we need R to negotiate the
communication between your computer and the web server. This is what
the <code class="calibre21">url()</code> function can do for you, by creating a <code class="calibre21">url</code> connection to
a web server.</p>

<p class="calibre2">This code might take time depending on your connection speed.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Open a URL connection for reading</code>
<code class="o">&gt;</code> con <code class="o">&lt;-</code> <code class="kp">url</code><code class="calibre21">(</code><code class="s">"http://www.jhsph.edu"</code><code class="calibre21">,</code> <code class="s">"r"</code><code class="calibre21">)</code>  
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Read the web page</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">readLines</code><code class="calibre21">(</code>con<code class="calibre21">)</code>                      
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Print out the first few lines</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>x<code class="calibre21">)</code>                                  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;!DOCTYPE html&gt;"</code>                                               
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code> <code class="s">"&lt;html lang=\"en\"&gt;"</code>                                            
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">]</code> <code class="s">""</code>                                                              
<code class="calibre21">[</code><code class="o">4</code><code class="calibre21">]</code> <code class="s">"&lt;head&gt;"</code>                                                        
<code class="calibre21">[</code><code class="o">5</code><code class="calibre21">]</code> <code class="s">"&lt;meta charset=\"utf-8\" /&gt;"</code>                                    
<code class="calibre21">[</code><code class="o">6</code><code class="calibre21">]</code> <code class="s">"&lt;title&gt;Johns Hopkins Bloomberg School of Public Health&lt;/title&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">While reading in a simple web page is sometimes useful, particularly
if data are embedded in the web page somewhere. However, more commonly
we can use URL connection to read in specific data files that are
stored on web servers. </p>

<p class="calibre2">Using URL connections can be useful for producing a reproducible
analysis, because the code essentially documents where the data came
from and how they were obtained. This is approach is preferable to
opening a web browser and downloading a dataset by hand. Of course,
the code you write with connections may not be executable at a later
date if things on the server side are changed or reorganized.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-10">
<div class="calibre5">
<h2 id="calibre_link-62" class="calibre15">
<span class="section-number">10. </span>Subsetting R Objects</h2>

<p class="calibre2">
  <a href="https://youtu.be/VfZUZGUgHqg">Watch a video of this section</a>
</p>

<p class="calibre2">There are three operators that can be used to extract subsets of R
objects.</p>

<ul class="calibre20">
  <li class="calibre14">The <code class="calibre21">[</code> operator always returns an object of the same class as the
original. It can be used to select multiple elements of an object</li>
  <li class="calibre14">The <code class="calibre21">[[</code> operator is used to extract elements of a list or a data
frame. It can only be used to extract a single element and the class
of the returned object will not necessarily be a list or data frame.</li>
  <li class="calibre14">The <code class="calibre21">$</code> operator is used to extract elements of a list or data frame
by literal name. Its semantics are similar to that of <code class="calibre21">[[</code>.</li>
</ul>

<h3 id="calibre_link-63" class="calibre19">
<span class="section-number">10.1 </span>Subsetting a Vector</h3>

<p class="calibre2">Vectors are basic objects in R and they can be subsetted using the <code class="calibre21">[</code>
operator.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> <code class="s">"c"</code><code class="calibre21">,</code> <code class="s">"c"</code><code class="calibre21">,</code> <code class="s">"d"</code><code class="calibre21">,</code> <code class="s">"a"</code><code class="calibre21">)</code>  
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>    <code class="c">## Extract the first element</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code>    <code class="c">## Extract the second element</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">[</code> operator can be used to extract multiple elements of a vector
by passing the operator an integer sequence. Here we extract the first
four elements of the vector.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code> <code class="s">"b"</code> <code class="s">"c"</code> <code class="s">"c"</code>
</pre></div>

</figure>

<p class="calibre2">The sequence does not have to be in order; you can specify any
arbitrary integer vector.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">)]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code> <code class="s">"c"</code> <code class="s">"c"</code>
</pre></div>

</figure>

<p class="calibre2">We can also pass a logical sequence to the <code class="calibre21">[</code> operator to extract
elements of a vector that satisfy a given condition. For example, here
we want the elements of <code class="calibre21">x</code> that come lexicographically <em class="calibre17">after</em> the
letter âaâ.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> u <code class="o">&lt;-</code> x <code class="o">&gt;</code> <code class="s">"a"</code>
<code class="o">&gt;</code> u
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code>u<code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code> <code class="s">"c"</code> <code class="s">"c"</code> <code class="s">"d"</code>
</pre></div>

</figure>

<p class="calibre2">Another, more compact, way to do this would be to skip the creation of
a logical vector and just subset the vector directly with the logical
expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[</code>x <code class="o">&gt;</code> <code class="s">"a"</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code> <code class="s">"c"</code> <code class="s">"c"</code> <code class="s">"d"</code>
</pre></div>

</figure>

<h3 id="calibre_link-64" class="calibre19">
<span class="section-number">10.2 </span>Subsetting a Matrix</h3>

<p class="calibre2">
  <a href="https://youtu.be/FzjXesh9tRw">Watch a video of this section</a>
</p>

<p class="calibre2">Matrices can be subsetted in the usual way with (<em class="calibre17">i,j</em>) type
indices. Here, we create simple <img src="images/000015.png" alt="2\times3" class="inline-equation" width="39" /> matrix with the <code class="calibre21">matrix</code>
function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">3</code>    <code class="o">5</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>    <code class="o">2</code>    <code class="o">4</code>    <code class="o">6</code>
</pre></div>

</figure>

<p class="calibre2">We can access the <img src="images/000027.png" alt="(1,2)" class="inline-equation" width="37" /> or the <img src="images/000005.png" alt="(2,1)" class="inline-equation" width="37" /> element of this matrix
using the appropriate indices.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
</pre></div>

</figure>

<p class="calibre2">Indices can also be missing. This behavior is used to access entire
rows or columns of a matrix.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="calibre21">]</code>  <code class="c">## Extract the first row</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">3</code> <code class="o">5</code>
<code class="o">&gt;</code> x<code class="calibre21">[,</code> <code class="o">2</code><code class="calibre21">]</code>  <code class="c">## Extract the second column</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code> <code class="o">4</code>
</pre></div>

</figure>

<h4 id="calibre_link-187" class="calibre19">Dropping matrix dimensions</h4>

<p class="calibre2">By default, when a single element of a matrix is retrieved, it is
returned as a vector of length 1 rather than a <img src="images/000018.png" alt="1\times1" class="inline-equation" width="38" />
matrix. Often, this is exactly what we want, but this behavior can be
turned off by setting <code class="calibre21">drop = FALSE</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> drop <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">]</code>
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">3</code>
</pre></div>

</figure>

<p class="calibre2">Similarly, when we extract a single row or column of a matrix, R by
default drops the dimension of length 1, so instead of getting a
<img src="images/000032.png" alt="1\times3" class="inline-equation" width="38" /> matrix after extracting the first row, we get a vector of
length 3. This behavior can similarly be turned off with the <code class="calibre21">drop =
FALSE</code> option.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">3</code> <code class="o">5</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,</code> <code class="calibre21">,</code> drop <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">]</code>
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">3</code>    <code class="o">5</code>
</pre></div>

</figure>

<p class="calibre2"><strong class="calibre16">Be careful of Râs automatic dropping of dimensions</strong>. This is a
feature that is often quite useful during interactive work, but can
later come back to bite you when you are writing longer programs or
functions.</p>

<h3 id="calibre_link-65" class="calibre19">
<span class="section-number">10.3 </span>Subsetting Lists</h3>

<p class="calibre2">
  <a href="https://youtu.be/DStKguVpuDI">Watch a video of this section</a>
</p>

<p class="calibre2">Lists in R can be subsetted using all three of the operators mentioned
above, and all three are used for different purposes.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>foo <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> bar <code class="o">=</code> <code class="o">0.6</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x
<code class="o">$</code>foo
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>

<code class="o">$</code>bar
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.6</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">[[</code> operator can be used to extract <em class="calibre17">single</em> elements from a
list. Here we extract the first element of the list.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">[[</code> operator can also use named indices so that you donât have to
remember the exact ordering of every element of the list. You can also
use the <code class="calibre21">$</code> operator to extract elements by name.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="s">"bar"</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.6</code>
<code class="o">&gt;</code> x<code class="o">$</code>bar
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.6</code>
</pre></div>

</figure>

<p class="calibre2">Notice you donât need the quotes when you use the <code class="calibre21">$</code> operator.</p>

<p class="calibre2">One thing that differentiates the <code class="calibre21">[[</code> operator from the <code class="calibre21">$</code> is that
the <code class="calibre21">[[</code> operator can be used with <em class="calibre17">computed</em> indices. The <code class="calibre21">$</code>
operator can only be used with literal names.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>foo <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> bar <code class="o">=</code> <code class="o">0.6</code><code class="calibre21">,</code> baz <code class="o">=</code> <code class="s">"hello"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> name <code class="o">&lt;-</code> <code class="s">"foo"</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## computed index for "foo"</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code>name<code class="calibre21">]]</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## element "name" doesnÃ¢â¬â¢t exist! (but no error here)</code>
<code class="o">&gt;</code> x<code class="o">$</code>name     
<code class="kc">NULL</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## element "foo" does exist</code>
<code class="o">&gt;</code> x<code class="o">$</code>foo      
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>
</pre></div>

</figure>

<h3 id="calibre_link-66" class="calibre19">
<span class="section-number">10.4 </span>Subsetting Nested Elements of a List</h3>

<p class="calibre2">The <code class="calibre21">[[</code> operator can take an integer sequence if you want to extract
a nested element of a list.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="kt">list</code><code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">12</code><code class="calibre21">,</code> <code class="o">14</code><code class="calibre21">),</code> b <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">3.14</code><code class="calibre21">,</code> <code class="o">2.81</code><code class="calibre21">))</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Get the 3rd element of the 1st element</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)]]</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">14</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Same as above</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]][[</code><code class="o">3</code><code class="calibre21">]]</code>   
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">14</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## 1st element of the 2nd element</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">)]]</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3.14</code>
</pre></div>

</figure>

<h3 id="calibre_link-67" class="calibre19">
<span class="section-number">10.5 </span>Extracting Multiple Elements of a List</h3>

<p class="calibre2">The <code class="calibre21">[</code> operator can be used to extract <em class="calibre17">multiple</em> elements from a
list. For example, if you wanted to extract the first and third
elements of a list, you would do the following</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>foo <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> bar <code class="o">=</code> <code class="o">0.6</code><code class="calibre21">,</code> baz <code class="o">=</code> <code class="s">"hello"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)]</code>
<code class="o">$</code>foo
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>

<code class="o">$</code>baz
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"hello"</code>
</pre></div>

</figure>

<p class="calibre2">Note that <code class="calibre21">x[c(1, 3)]</code> is NOT the same as <code class="calibre21">x[[c(1, 3)]]</code>.</p>

<p class="calibre2">Remember that the <code class="calibre21">[</code> operator always returns an object of the same
class as the original. Since the original object was a list, the <code class="calibre21">[</code>
operator returns a list. In the above code, we returned a list with
two elements (the first and the third).</p>

<h3 id="calibre_link-68" class="calibre19">
<span class="section-number">10.6 </span>Partial Matching</h3>

<p class="calibre2">
  <a href="https://youtu.be/q3BNhHHVCu4">Watch a video of this section</a>
</p>

<p class="calibre2">Partial matching of names is allowed with <code class="calibre21">[[</code> and <code class="calibre21">$</code>. This is often
very useful during interactive work if the object youâre working with
has very long element names. You can just abbreviate those names and R
will figure out what element youâre referring to.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>aardvark <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="s">"a"</code><code class="calibre21">]]</code>
<code class="kc">NULL</code>
<code class="o">&gt;</code> x<code class="calibre21">[[</code><code class="s">"a"</code><code class="calibre21">,</code> exact <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code>
</pre></div>

</figure>

<p class="calibre2">In general, this is fine for interactive work, but you shouldnât
resort to partial matching if you are writing longer scripts,
functions, or programs. In those cases, you should refer to the full
element name if possible. That way thereâs no ambiguity in your code.</p>

<h3 id="calibre_link-69" class="calibre19">
<span class="section-number">10.7 </span>Removing NA Values</h3>

<p class="calibre2">
  <a href="https://youtu.be/TtJxmwXbwo0">Watch a video of this section</a>
</p>

<p class="calibre2">A common task in data analysis is removing missing values (<code class="calibre21">NA</code>s).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> bad <code class="o">&lt;-</code> <code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>bad<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code><code class="o">!</code>bad<code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">4</code> <code class="o">5</code>
</pre></div>

</figure>

<p class="calibre2">What if there are multiple R objects and you want to take the subset with
no missing values in any of those objects?</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="s">"d"</code><code class="calibre21">,</code> <code class="kc">NA</code><code class="calibre21">,</code> <code class="s">"f"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> good <code class="o">&lt;-</code> complete.cases<code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
<code class="o">&gt;</code> good
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>
<code class="o">&gt;</code> x<code class="calibre21">[</code>good<code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">4</code> <code class="o">5</code>
<code class="o">&gt;</code> y<code class="calibre21">[</code>good<code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code> <code class="s">"b"</code> <code class="s">"d"</code> <code class="s">"f"</code>
</pre></div>

</figure>

<p class="calibre2">You can use <code class="calibre21">complete.cases</code> on data frames too.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>airquality<code class="calibre21">)</code>
  Ozone Solar.R Wind Temp Month Day
<code class="o">1</code>    <code class="o">41</code>     <code class="o">190</code>  <code class="o">7.4</code>   <code class="o">67</code>     <code class="o">5</code>   <code class="o">1</code>
<code class="o">2</code>    <code class="o">36</code>     <code class="o">118</code>  <code class="o">8.0</code>   <code class="o">72</code>     <code class="o">5</code>   <code class="o">2</code>
<code class="o">3</code>    <code class="o">12</code>     <code class="o">149</code> <code class="o">12.6</code>   <code class="o">74</code>     <code class="o">5</code>   <code class="o">3</code>
<code class="o">4</code>    <code class="o">18</code>     <code class="o">313</code> <code class="o">11.5</code>   <code class="o">62</code>     <code class="o">5</code>   <code class="o">4</code>
<code class="o">5</code>    <code class="kc">NA</code>      <code class="kc">NA</code> <code class="o">14.3</code>   <code class="o">56</code>     <code class="o">5</code>   <code class="o">5</code>
<code class="o">6</code>    <code class="o">28</code>      <code class="kc">NA</code> <code class="o">14.9</code>   <code class="o">66</code>     <code class="o">5</code>   <code class="o">6</code>
<code class="o">&gt;</code> good <code class="o">&lt;-</code> complete.cases<code class="calibre21">(</code>airquality<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>airquality<code class="calibre21">[</code>good<code class="calibre21">,</code> <code class="calibre21">])</code>
  Ozone Solar.R Wind Temp Month Day
<code class="o">1</code>    <code class="o">41</code>     <code class="o">190</code>  <code class="o">7.4</code>   <code class="o">67</code>     <code class="o">5</code>   <code class="o">1</code>
<code class="o">2</code>    <code class="o">36</code>     <code class="o">118</code>  <code class="o">8.0</code>   <code class="o">72</code>     <code class="o">5</code>   <code class="o">2</code>
<code class="o">3</code>    <code class="o">12</code>     <code class="o">149</code> <code class="o">12.6</code>   <code class="o">74</code>     <code class="o">5</code>   <code class="o">3</code>
<code class="o">4</code>    <code class="o">18</code>     <code class="o">313</code> <code class="o">11.5</code>   <code class="o">62</code>     <code class="o">5</code>   <code class="o">4</code>
<code class="o">7</code>    <code class="o">23</code>     <code class="o">299</code>  <code class="o">8.6</code>   <code class="o">65</code>     <code class="o">5</code>   <code class="o">7</code>
<code class="o">8</code>    <code class="o">19</code>      <code class="o">99</code> <code class="o">13.8</code>   <code class="o">59</code>     <code class="o">5</code>   <code class="o">8</code>
</pre></div>

</figure>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-6">
<div class="calibre5">
<h2 id="calibre_link-70" class="calibre15">
<span class="section-number">11. </span>Vectorized Operations</h2>

<p class="calibre2">
  <a href="https://youtu.be/YH3qtw7mTyA">Watch a video of this chapter</a>
</p>

<p class="calibre2">Many operations in R are <em class="calibre17">vectorized</em>, meaning that operations occur
in parallel in certain R objects. This allows you to write code that
is efficient, concise, and easier to read than in non-vectorized
languages.</p>

<p class="calibre2">The simplest example is when adding two vectors together.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">6</code><code class="o">:</code><code class="o">9</code> 
<code class="o">&gt;</code> z <code class="o">&lt;-</code> x <code class="o">+</code> y
<code class="o">&gt;</code> z
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">7</code>  <code class="o">9</code> <code class="o">11</code> <code class="o">13</code>
</pre></div>

</figure>

<p class="calibre2">Natural, right? Without vectorization, youâd have to do something like</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>z <code class="o">&lt;-</code> <code class="kt">numeric</code><code class="calibre21">(</code><code class="kp">length</code><code class="calibre21">(</code>x<code class="calibre21">))</code>
<code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_along</code><code class="calibre21">(</code>x<code class="calibre21">))</code> <code class="calibre21">{</code>
      z<code class="calibre21">[</code>i<code class="calibre21">]</code> <code class="o">&lt;-</code> x<code class="calibre21">[</code>i<code class="calibre21">]</code> <code class="o">+</code> y<code class="calibre21">[</code>i<code class="calibre21">]</code>
<code class="calibre21">}</code>
z
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">7</code>  <code class="o">9</code> <code class="o">11</code> <code class="o">13</code>
</pre></div>

</figure>

<p class="calibre2">If you had to do that every time you wanted to add two vectors, your
hands would get very tired from all the typing.</p>

<p class="calibre2">Another operation you can do in a vectorized manner is logical
comparisons. So suppose you wanted to know which elements of a vector
were greater than 2. You could do he following.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code>
<code class="o">&gt;</code> x <code class="o">&gt;</code> <code class="o">2</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">Here are other vectorized logical operations.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&gt;=</code> <code class="o">2</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>
<code class="o">&gt;</code> x <code class="o">&lt;</code> <code class="o">3</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> y <code class="o">==</code> <code class="o">8</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code>
</pre></div>

</figure>

<p class="calibre2">Notice that these logical operations return a logical vector of <code class="calibre21">TRUE</code>
and <code class="calibre21">FALSE</code>.</p>

<p class="calibre2">Of course, subtraction, multiplication and division are also vectorized.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">-</code> y
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-5</code> <code class="o">-5</code> <code class="o">-5</code> <code class="o">-5</code>
<code class="o">&gt;</code> x <code class="o">*</code> y
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">6</code> <code class="o">14</code> <code class="o">24</code> <code class="o">36</code>
<code class="o">&gt;</code> x <code class="o">/</code> y
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.1666667</code> <code class="o">0.2857143</code> <code class="o">0.3750000</code> <code class="o">0.4444444</code>
</pre></div>

</figure>

<h3 id="calibre_link-71" class="calibre19">
<span class="section-number">11.1 </span>Vectorized Matrix Operations</h3>

<p class="calibre2">Matrix operations are also vectorized, making for nicly compact
notation. This way, we can do element-by-element operations on
matrices without having to loop over every element.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="kp">rep</code><code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">),</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## element-wise multiplication</code>
<code class="o">&gt;</code> x <code class="o">*</code> y       
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>   <code class="o">10</code>   <code class="o">30</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>   <code class="o">20</code>   <code class="o">40</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## element-wise division</code>
<code class="o">&gt;</code> x <code class="o">/</code> y       
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>  <code class="o">0.1</code>  <code class="o">0.3</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>  <code class="o">0.2</code>  <code class="o">0.4</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## true matrix multiplication</code>
<code class="o">&gt;</code> x <code class="o">%*%</code> y     
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>   <code class="o">40</code>   <code class="o">40</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>   <code class="o">60</code>   <code class="o">60</code>
</pre></div>

</figure>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-1">
<div class="calibre5">
<h2 id="calibre_link-72" class="calibre15">
<span class="section-number">12. </span>Dates and Times</h2>

<p class="calibre2">R has developed a special representation for dates and times. Dates are represented by the <code class="calibre21">Date</code> class and times are represented by the <code class="calibre21">POSIXct</code> or the <code class="calibre21">POSIXlt</code> class. Dates are stored internally as the number of days since 1970-01-01 while times are stored internally as the number of seconds since 1970-01-01. </p>

<p class="calibre2">Itâs not important to know the internal representation of dates and times in order to use them in R. I just thought those were fun facts.</p>

<h3 id="calibre_link-73" class="calibre19">
<span class="section-number">12.1 </span>Dates in R</h3>

<p class="calibre2">
  <a href="https://youtu.be/opYexVgjwkE">Watch a video of this section</a>
</p>

<p class="calibre2">Dates are represented by the <code class="calibre21">Date</code> class and can be coerced from a character string using the <code class="calibre21">as.Date()</code> function. This is a common way to end up with a <code class="calibre21">Date</code> object in R.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Coerce a 'Date' object from character</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="s">"1970-01-01"</code><code class="calibre21">)</code>   
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"1970-01-01"</code>
</pre></div>

</figure>

<p class="calibre2">You can see the internal representation of a <code class="calibre21">Date</code> object by using the <code class="calibre21">unclass()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">unclass</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0</code>
<code class="o">&gt;</code> <code class="kp">unclass</code><code class="calibre21">(</code><code class="kp">as.Date</code><code class="calibre21">(</code><code class="s">"1970-01-02"</code><code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>
</pre></div>

</figure>

<h3 id="calibre_link-74" class="calibre19">
<span class="section-number">12.2 </span>Times in R</h3>

<p class="calibre2">
  <a href="https://youtu.be/8HENCYXwZoU">Watch a video of this section</a>
</p>

<p class="calibre2">Times are represented by the <code class="calibre21">POSIXct</code> or the <code class="calibre21">POSIXlt</code> class. <code class="calibre21">POSIXct</code> is just a very large integer under the hood. It use a useful class when you want to store times in something like a data frame. <code class="calibre21">POSIXlt</code> is a list underneath and it stores a bunch of other useful information like the day of the week, day of the year, month, day of the month. This is useful when you need that kind of information.</p>

<p class="calibre2">There are a number of generic functions that work on dates and times to help you extract pieces of dates and/or times.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">weekdays</code>: give the day of the week</li>
  <li class="calibre14">
<code class="calibre21">months</code>: give the month name</li>
  <li class="calibre14">
<code class="calibre21">quarters</code>: give the quarter number (âQ1â, âQ2â, âQ3â, or âQ4â)</li>
</ul>

<p class="calibre2">Times can be coerced from a character string using the <code class="calibre21">as.POSIXlt</code> or <code class="calibre21">as.POSIXct</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">Sys.time</code><code class="calibre21">()</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"2020-09-03 17:18:31 EDT"</code>
<code class="o">&gt;</code> <code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)</code>   <code class="c">## 'POSIXct' object</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"POSIXct"</code> <code class="s">"POSIXt"</code> 
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">POSIXlt</code> object contains some useful metadata.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> p <code class="o">&lt;-</code> <code class="kp">as.POSIXlt</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code><code class="kp">unclass</code><code class="calibre21">(</code>p<code class="calibre21">))</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"sec"</code>    <code class="s">"min"</code>    <code class="s">"hour"</code>   <code class="s">"mday"</code>   <code class="s">"mon"</code>    <code class="s">"year"</code>   <code class="s">"wday"</code>   <code class="s">"yday"</code>  
 <code class="calibre21">[</code><code class="o">9</code><code class="calibre21">]</code> <code class="s">"isdst"</code>  <code class="s">"zone"</code>   <code class="s">"gmtoff"</code>
<code class="o">&gt;</code> p<code class="o">$</code>wday     <code class="c">## day of the week</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">You can also use the <code class="calibre21">POSIXct</code> format.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">Sys.time</code><code class="calibre21">()</code>
<code class="o">&gt;</code> x             <code class="c">## Already in âPOSIXctâ format</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"2020-09-03 17:18:31 EDT"</code>
<code class="o">&gt;</code> <code class="kp">unclass</code><code class="calibre21">(</code>x<code class="calibre21">)</code>    <code class="c">## Internal representation</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1599167912</code>
<code class="o">&gt;</code> x<code class="o">$</code>sec         <code class="c">## Can't do this with 'POSIXct'!</code>
Error <code class="kc">in</code> x<code class="o">$</code>sec<code class="o">:</code> <code class="o">$</code> operator is invalid <code class="kc">for</code> atomic vectors
<code class="o">&gt;</code> p <code class="o">&lt;-</code> <code class="kp">as.POSIXlt</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">&gt;</code> p<code class="o">$</code>sec         <code class="c">## That's better</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">31.6434</code>
</pre></div>

</figure>

<p class="calibre2">Finally, there is the <code class="calibre21">strptime()</code> function in case your dates are
written in a different format. <code class="calibre21">strptime()</code> takes a character vector that has dates and times and converts them into to a <code class="calibre21">POSIXlt</code> object.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> datestring <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"January 10, 2012 10:40"</code><code class="calibre21">,</code> <code class="s">"December 9, 2011 9:10"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">strptime</code><code class="calibre21">(</code>datestring<code class="calibre21">,</code> <code class="s">"%B %d, %Y %H:%M"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"2012-01-10 10:40:00 EST"</code> <code class="s">"2011-12-09 09:10:00 EST"</code>
<code class="o">&gt;</code> <code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"POSIXlt"</code> <code class="s">"POSIXt"</code> 
</pre></div>

</figure>

<p class="calibre2">The weird-looking symbols that start with the <code class="calibre21">%</code> symbol are the formatting strings for dates and times. I can <em class="calibre17">never</em> remember the formatting strings. Check <code class="calibre21">?strptime</code> for details. Itâs probably not worth memorizing this stuff.</p>

<h3 id="calibre_link-75" class="calibre19">
<span class="section-number">12.3 </span>Operations on Dates and Times</h3>

<p class="calibre2">
  <a href="https://youtu.be/vEmWJrpP1KM">Watch a video of this section</a>
</p>

<p class="calibre2">You can use mathematical operations on dates and times. Well, really just + and -. You can do comparisons too (i.e. ==, &lt;=)</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="s">"2012-01-01"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">strptime</code><code class="calibre21">(</code><code class="s">"9 Jan 2011 11:34:21"</code><code class="calibre21">,</code> <code class="s">"%d %b %Y %H:%M:%S"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x<code class="o">-</code>y
Warning<code class="o">:</code> Incompatible methods <code class="calibre21">(</code><code class="s">"-.Date"</code><code class="calibre21">,</code> <code class="s">"-.POSIXt"</code><code class="calibre21">)</code> <code class="kc">for</code> <code class="s">"-"</code>
Error <code class="kc">in</code> x <code class="o">-</code> y<code class="o">:</code> non<code class="o">-</code><code class="kt">numeric</code> argument to binary operator
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">as.POSIXlt</code><code class="calibre21">(</code>x<code class="calibre21">)</code> 
<code class="o">&gt;</code> x<code class="o">-</code>y
Time difference of <code class="o">356.3095</code> days
</pre></div>

</figure>

<p class="calibre2">The nice thing about the date/time classes is that they keep track of all the annoying things about dates and times, like leap years, leap seconds, daylight savings, and time zones.</p>

<p class="calibre2">Hereâs an example where a leap year gets involved.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="s">"2012-03-01"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="s">"2012-02-28"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x<code class="o">-</code>y
Time difference of <code class="o">2</code> days
</pre></div>

</figure>

<p class="calibre2">Hereâs an example where two different time zones are in play (unless you live in GMT timezone, in which case they will be the same!).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## My local time zone</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">as.POSIXct</code><code class="calibre21">(</code><code class="s">"2012-10-25 01:00:00"</code><code class="calibre21">)</code>     
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">as.POSIXct</code><code class="calibre21">(</code><code class="s">"2012-10-25 06:00:00"</code><code class="calibre21">,</code> tz <code class="o">=</code> <code class="s">"GMT"</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> y<code class="o">-</code>x
Time difference of <code class="o">1</code> hours
</pre></div>

</figure>

<h3 id="calibre_link-76" class="calibre19">
<span class="section-number">12.4 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">Dates and times have special classes in R that allow for numerical and statistical calculations</li>
  <li class="calibre14">Dates use the <code class="calibre21">Date</code> class</li>
  <li class="calibre14">Times use the <code class="calibre21">POSIXct</code> and <code class="calibre21">POSIXlt</code> class</li>
  <li class="calibre14">Character strings can be coerced to Date/Time classes using the <code class="calibre21">strptime</code> function or the <code class="calibre21">as.Date</code>, <code class="calibre21">as.POSIXlt</code>, or <code class="calibre21">as.POSIXct</code>
</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-11">
<div class="calibre5">
<h2 id="calibre_link-77" class="calibre15">
<span class="section-number">13. </span>Managing Data Frames with the <code class="calibre11">dplyr</code> package</h2>

<p class="calibre2">
  <a href="https://youtu.be/aywFompr1F4">Watch a video of this chapter</a>
</p>

<h3 id="calibre_link-78" class="calibre19">
<span class="section-number">13.1 </span>Data Frames</h3>

<p class="calibre2">The <em class="calibre17">data frame</em> is a key data structure in statistics and in R. The basic structure of a data frame is that there is one observation per row and each column represents a variable, a measure, feature, or characteristic of that observation. R has an internal implementation of data frames that is likely the one you will use most often. However, there are packages on CRAN that implement data frames via things like relational databases that allow you to operate on very very large data frames (but we wonât discuss them here).</p>

<p class="calibre2">Given the importance of managing data frames, itâs important that we have good tools for dealing with them. In previous chapters we have already discussed some tools like the <code class="calibre21">subset()</code> function and the use of <code class="calibre21">[</code> and <code class="calibre21">$</code> operators to extract subsets of data frames. However, other operations, like filtering, re-ordering, and collapsing, can often be tedious operations in R whose syntax is not very intuitive. The <code class="calibre21">dplyr</code> package is designed to mitigate a lot of these problems and to provide a highly optimized set of routines specifically for dealing with data frames.</p>

<h3 id="calibre_link-79" class="calibre19">
<span class="section-number">13.2 </span>The <code class="calibre11">dplyr</code> Package</h3>

<p class="calibre2">The <code class="calibre21">dplyr</code> package was developed by Hadley Wickham of RStudio and is an optimized and distilled version of his <code class="calibre21">plyr</code> package. The <code class="calibre21">dplyr</code> package does not provide any ânewâ functionality to R per se, in the sense that everything <code class="calibre21">dplyr</code> does could already be done with base R, but it <em class="calibre17">greatly</em> simplifies existing functionality in R. </p>

<p class="calibre2">One important contribution of the <code class="calibre21">dplyr</code> package is that it provides a âgrammarâ (in particular, verbs) for data manipulation and for operating on data frames. With this grammar, you can sensibly communicate what it is that you are doing to a data frame that other people can understand (assuming they also know the grammar).  This is useful because it provides an abstraction for data manipulation that previously did not exist. Another useful contribution is that the <code class="calibre21">dplyr</code> functions are <strong class="calibre16">very</strong> fast, as many key operations are coded in C++.</p>

<h3 id="calibre_link-80" class="calibre19">
<span class="section-number">13.3 </span><code class="calibre11">dplyr</code> Grammar</h3>

<p class="calibre2">Some of the key âverbsâ provided by the <code class="calibre21">dplyr</code> package are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">select</code>: return a subset of the columns of a data frame, using a flexible notation</li>
  <li class="calibre14">
<code class="calibre21">filter</code>: extract a subset of rows from a data frame based on logical conditions</li>
  <li class="calibre14">
<code class="calibre21">arrange</code>: reorder rows of a data frame</li>
  <li class="calibre14">
<code class="calibre21">rename</code>: rename variables in a data frame</li>
  <li class="calibre14">
<code class="calibre21">mutate</code>: add new variables/columns or transform existing variables</li>
  <li class="calibre14">
<code class="calibre21">summarise</code> / <code class="calibre21">summarize</code>: generate summary statistics of different
variables in the data frame, possibly within strata</li>
  <li class="calibre14">
<code class="calibre21">%&gt;%</code>: the âpipeâ operator is used to connect multiple verb actions together into a pipeline</li>
</ul>

<p class="calibre2">The <code class="calibre21">dplyr</code> package as a number of its own data types that it takes advantage of. For example, there is a handy <code class="calibre21">print</code> method that prevents you from printing a lot of data to the console. Most of the time, these additional data types are transparent to the user and do not need to be worried about.</p>

<h4 id="calibre_link-188" class="calibre19">Common <code class="calibre11">dplyr</code> Function Properties</h4>

<p class="calibre2">All of the functions that we will discuss in this Chapter will have a few common characteristics. In particular, </p>

<ol class="calibre13">
  <li class="calibre14">The first argument is a data frame.</li>
  <li class="calibre14">The subsequent arguments describe what to do with the data frame specified in the first argument, and you can refer to columns in the data frame directly without using the $ operator (just use the column names).</li>
  <li class="calibre14">The return result of a function is a new data frame</li>
  <li class="calibre14">Data frames must be properly formatted and annotated for this to all be useful. In particular, the data must be <a href="http://www.jstatsoft.org/v59/i10/paper">tidy</a>. In short, there should be one observation per row, and each column should represent a feature or characteristic of that observation.</li>
</ol>

<h3 id="calibre_link-81" class="calibre19">
<span class="section-number">13.4 </span>Installing the <code class="calibre11">dplyr</code> package</h3>

<p class="calibre2">The <code class="calibre21">dplyr</code> package can be installed from CRAN or from GitHub using the <code class="calibre21">devtools</code> package and the <code class="calibre21">install_github()</code> function. The GitHub repository will usually contain the latest updates to the package and the development version.</p>

<p class="calibre2">To install from CRAN, just run</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> install.packages<code class="calibre21">(</code><code class="s">"dplyr"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">To install from GitHub you can run</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> install_github<code class="calibre21">(</code><code class="s">"hadley/dplyr"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">After installing the package it is important that you load it into your R session with the <code class="calibre21">library()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>dplyr<code class="calibre21">)</code>

Attaching package<code class="o">:</code> <code class="s">'dplyr'</code>
The following objects are masked from <code class="s">'package:stats'</code><code class="o">:</code>

    filter<code class="calibre21">,</code> lag
The following objects are masked from <code class="s">'package:base'</code><code class="o">:</code>

    <code class="kp">intersect</code><code class="calibre21">,</code> <code class="kp">setdiff</code><code class="calibre21">,</code> <code class="kp">setequal</code><code class="calibre21">,</code> <code class="kp">union</code>
</pre></div>

</figure>

<p class="calibre2">You may get some warnings when the package is loaded because there are functions in the <code class="calibre21">dplyr</code> package that have the same name as functions in other packages. For now you can ignore the warnings.</p>

<h3 id="calibre_link-82" class="calibre19">
<span class="section-number">13.5 </span><code class="calibre11">select()</code>
</h3>

<p class="calibre2">For the examples in this chapter we will be using a dataset containing air pollution and temperature data for the <a href="http://www.biostat.jhsph.edu/~rpeng/leanpub/rprog/chicago_data.zip">city of Chicago</a> in the U.S. The dataset is available from my web site.     </p>

<p class="calibre2">After unzipping the archive, you can load the data into R using the <code class="calibre21">readRDS()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> <code class="kp">readRDS</code><code class="calibre21">(</code><code class="s">"chicago.rds"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">You can see some basic characteristics of the dataset with the <code class="calibre21">dim()</code> and <code class="calibre21">str()</code> functions.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">dim</code><code class="calibre21">(</code>chicago<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">6940</code>    <code class="o">8</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>chicago<code class="calibre21">)</code>
<code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">6940</code> obs. of  <code class="o">8</code> variables<code class="o">:</code>
 <code class="o">$</code> city      <code class="o">:</code> chr  <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="kc">...</code>
 <code class="o">$</code> tmpd      <code class="o">:</code> num  <code class="o">31.5</code> <code class="o">33</code> <code class="o">33</code> <code class="o">29</code> <code class="o">32</code> <code class="o">40</code> <code class="o">34.5</code> <code class="o">29</code> <code class="o">26.5</code> <code class="o">32.5</code> <code class="kc">...</code>
 <code class="o">$</code> dptp      <code class="o">:</code> num  <code class="o">31.5</code> <code class="o">29.9</code> <code class="o">27.4</code> <code class="o">28.6</code> <code class="o">28.9</code> <code class="kc">...</code>
 <code class="o">$</code> date      <code class="o">:</code> Date<code class="calibre21">,</code> <code class="kp">format</code><code class="o">:</code> <code class="s">"1987-01-01"</code> <code class="s">"1987-01-02"</code> <code class="kc">...</code>
 <code class="o">$</code> pm25tmean2<code class="o">:</code> num  <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">...</code>
 <code class="o">$</code> pm10tmean2<code class="o">:</code> num  <code class="o">34</code> <code class="kc">NA</code> <code class="o">34.2</code> <code class="o">47</code> <code class="kc">NA</code> <code class="kc">...</code>
 <code class="o">$</code> o3tmean2  <code class="o">:</code> num  <code class="o">4.25</code> <code class="o">3.3</code> <code class="o">3.33</code> <code class="o">4.38</code> <code class="o">4.75</code> <code class="kc">...</code>
 <code class="o">$</code> no2tmean2 <code class="o">:</code> num  <code class="o">20</code> <code class="o">23.2</code> <code class="o">23.8</code> <code class="o">30.4</code> <code class="o">30.3</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">select()</code> function can be used to select columns of a data frame that you want to focus on. Often youâll have a large data frame containing âallâ of the data, but any <em class="calibre17">given</em> analysis might only use a subset of variables or observations. The <code class="calibre21">select()</code> function allows you to get the few columns you might need.</p>

<p class="calibre2">Suppose we wanted to take the first 3 columns only. There are a few ways to do this. We could for example use numerical indices. But we can also use the names directly.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>chicago<code class="calibre21">)[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"city"</code> <code class="s">"tmpd"</code> <code class="s">"dptp"</code>
<code class="o">&gt;</code> subset <code class="o">&lt;-</code> select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> city<code class="o">:</code>dptp<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code><code class="kp">subset</code><code class="calibre21">)</code>
  city tmpd   dptp
<code class="o">1</code> chic <code class="o">31.5</code> <code class="o">31.500</code>
<code class="o">2</code> chic <code class="o">33.0</code> <code class="o">29.875</code>
<code class="o">3</code> chic <code class="o">33.0</code> <code class="o">27.375</code>
<code class="o">4</code> chic <code class="o">29.0</code> <code class="o">28.625</code>
<code class="o">5</code> chic <code class="o">32.0</code> <code class="o">28.875</code>
<code class="o">6</code> chic <code class="o">40.0</code> <code class="o">35.125</code>
</pre></div>

</figure>

<p class="calibre2">Note that the <code class="calibre21">:</code> normally cannot be used with names or strings, but inside the <code class="calibre21">select()</code> function you can use it to specify a range of variable names. </p>

<p class="calibre2">You can also <em class="calibre17">omit</em> variables using the <code class="calibre21">select()</code> function by using the negative sign. With <code class="calibre21">select()</code> you can do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="o">-</code><code class="calibre21">(</code>city<code class="o">:</code>dptp<code class="calibre21">))</code>
</pre></div>

</figure>

<p class="calibre2">which indicates that we should include every variable <em class="calibre17">except</em> the variables <code class="calibre21">city</code> through <code class="calibre21">dptp</code>.
The equivalent code in base R would be</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> i <code class="o">&lt;-</code> <code class="kp">match</code><code class="calibre21">(</code><code class="s">"city"</code><code class="calibre21">,</code> <code class="kp">names</code><code class="calibre21">(</code>chicago<code class="calibre21">))</code>
<code class="o">&gt;</code> j <code class="o">&lt;-</code> <code class="kp">match</code><code class="calibre21">(</code><code class="s">"dptp"</code><code class="calibre21">,</code> <code class="kp">names</code><code class="calibre21">(</code>chicago<code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>chicago<code class="calibre21">[,</code> <code class="o">-</code><code class="calibre21">(</code>i<code class="o">:</code>j<code class="calibre21">)])</code>
</pre></div>

</figure>

<p class="calibre2">Not super intuitive, right?</p>

<p class="calibre2">The <code class="calibre21">select()</code> function also allows a special syntax that allows you to specify variable names based on patterns. So, for example, if you wanted to keep every variable that ends with a â2â, we could do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> subset <code class="o">&lt;-</code> select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> ends_with<code class="calibre21">(</code><code class="s">"2"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">subset</code><code class="calibre21">)</code>
<code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">6940</code> obs. of  <code class="o">4</code> variables<code class="o">:</code>
 <code class="o">$</code> pm25tmean2<code class="o">:</code> num  <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">...</code>
 <code class="o">$</code> pm10tmean2<code class="o">:</code> num  <code class="o">34</code> <code class="kc">NA</code> <code class="o">34.2</code> <code class="o">47</code> <code class="kc">NA</code> <code class="kc">...</code>
 <code class="o">$</code> o3tmean2  <code class="o">:</code> num  <code class="o">4.25</code> <code class="o">3.3</code> <code class="o">3.33</code> <code class="o">4.38</code> <code class="o">4.75</code> <code class="kc">...</code>
 <code class="o">$</code> no2tmean2 <code class="o">:</code> num  <code class="o">20</code> <code class="o">23.2</code> <code class="o">23.8</code> <code class="o">30.4</code> <code class="o">30.3</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Or if we wanted to keep every variable that starts with a âdâ, we could do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> subset <code class="o">&lt;-</code> select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> starts_with<code class="calibre21">(</code><code class="s">"d"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">subset</code><code class="calibre21">)</code>
<code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">6940</code> obs. of  <code class="o">2</code> variables<code class="o">:</code>
 <code class="o">$</code> dptp<code class="o">:</code> num  <code class="o">31.5</code> <code class="o">29.9</code> <code class="o">27.4</code> <code class="o">28.6</code> <code class="o">28.9</code> <code class="kc">...</code>
 <code class="o">$</code> <code class="kp">date</code><code class="o">:</code> Date<code class="calibre21">,</code> <code class="kp">format</code><code class="o">:</code> <code class="s">"1987-01-01"</code> <code class="s">"1987-01-02"</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">You can also use more general regular expressions if necessary. See the help page (<code class="calibre21">?select</code>) for more details.</p>

<h3 id="calibre_link-83" class="calibre19">
<span class="section-number">13.6 </span><code class="calibre11">filter()</code>
</h3>

<p class="calibre2">The <code class="calibre21">filter()</code> function is used to extract subsets of rows from a data frame. This function is similar to the existing <code class="calibre21">subset()</code> function in R but is quite a bit faster in my experience.</p>

<p class="calibre2">Suppose we wanted to extract the rows of the <code class="calibre21">chicago</code> data frame where the levels of PM2.5 are greater than 30 (which is a reasonably high level), we could do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chic.f <code class="o">&lt;-</code> filter<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25tmean2 <code class="o">&gt;</code> <code class="o">30</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>chic.f<code class="calibre21">)</code>
<code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">194</code> obs. of  <code class="o">8</code> variables<code class="o">:</code>
 <code class="o">$</code> city      <code class="o">:</code> chr  <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="s">"chic"</code> <code class="kc">...</code>
 <code class="o">$</code> tmpd      <code class="o">:</code> num  <code class="o">23</code> <code class="o">28</code> <code class="o">55</code> <code class="o">59</code> <code class="o">57</code> <code class="o">57</code> <code class="o">75</code> <code class="o">61</code> <code class="o">73</code> <code class="o">78</code> <code class="kc">...</code>
 <code class="o">$</code> dptp      <code class="o">:</code> num  <code class="o">21.9</code> <code class="o">25.8</code> <code class="o">51.3</code> <code class="o">53.7</code> <code class="o">52</code> <code class="o">56</code> <code class="o">65.8</code> <code class="o">59</code> <code class="o">60.3</code> <code class="o">67.1</code> <code class="kc">...</code>
 <code class="o">$</code> date      <code class="o">:</code> Date<code class="calibre21">,</code> <code class="kp">format</code><code class="o">:</code> <code class="s">"1998-01-17"</code> <code class="s">"1998-01-23"</code> <code class="kc">...</code>
 <code class="o">$</code> pm25tmean2<code class="o">:</code> num  <code class="o">38.1</code> <code class="o">34</code> <code class="o">39.4</code> <code class="o">35.4</code> <code class="o">33.3</code> <code class="kc">...</code>
 <code class="o">$</code> pm10tmean2<code class="o">:</code> num  <code class="o">32.5</code> <code class="o">38.7</code> <code class="o">34</code> <code class="o">28.5</code> <code class="o">35</code> <code class="kc">...</code>
 <code class="o">$</code> o3tmean2  <code class="o">:</code> num  <code class="o">3.18</code> <code class="o">1.75</code> <code class="o">10.79</code> <code class="o">14.3</code> <code class="o">20.66</code> <code class="kc">...</code>
 <code class="o">$</code> no2tmean2 <code class="o">:</code> num  <code class="o">25.3</code> <code class="o">29.4</code> <code class="o">25.3</code> <code class="o">31.4</code> <code class="o">26.8</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">You can see that there are now only 194 rows in the data frame and the distribution of the <code class="calibre21">pm25tmean2</code> values is.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>chic.f<code class="o">$</code>pm25tmean2<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max. 
  <code class="o">30.05</code>   <code class="o">32.12</code>   <code class="o">35.04</code>   <code class="o">36.63</code>   <code class="o">39.53</code>   <code class="o">61.50</code> 
</pre></div>

</figure>

<p class="calibre2">We can place an arbitrarily complex logical sequence inside of <code class="calibre21">filter()</code>, so we could for example extract the rows where PM2.5 is greater than 30 <em class="calibre17">and</em> temperature is greater than 80 degrees Fahrenheit.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chic.f <code class="o">&lt;-</code> filter<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25tmean2 <code class="o">&gt;</code> <code class="o">30</code> <code class="o">&amp;</code> tmpd <code class="o">&gt;</code> <code class="o">80</code><code class="calibre21">)</code>
<code class="o">&gt;</code> select<code class="calibre21">(</code>chic.f<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">,</code> tmpd<code class="calibre21">,</code> pm25tmean2<code class="calibre21">)</code>
         date tmpd pm25tmean2
<code class="o">1</code>  <code class="o">1998-08-23</code>   <code class="o">81</code>   <code class="o">39.60000</code>
<code class="o">2</code>  <code class="o">1998-09-06</code>   <code class="o">81</code>   <code class="o">31.50000</code>
<code class="o">3</code>  <code class="o">2001-07-20</code>   <code class="o">82</code>   <code class="o">32.30000</code>
<code class="o">4</code>  <code class="o">2001-08-01</code>   <code class="o">84</code>   <code class="o">43.70000</code>
<code class="o">5</code>  <code class="o">2001-08-08</code>   <code class="o">85</code>   <code class="o">38.83750</code>
<code class="o">6</code>  <code class="o">2001-08-09</code>   <code class="o">84</code>   <code class="o">38.20000</code>
<code class="o">7</code>  <code class="o">2002-06-20</code>   <code class="o">82</code>   <code class="o">33.00000</code>
<code class="o">8</code>  <code class="o">2002-06-23</code>   <code class="o">82</code>   <code class="o">42.50000</code>
<code class="o">9</code>  <code class="o">2002-07-08</code>   <code class="o">81</code>   <code class="o">33.10000</code>
<code class="o">10</code> <code class="o">2002-07-18</code>   <code class="o">82</code>   <code class="o">38.85000</code>
<code class="o">11</code> <code class="o">2003-06-25</code>   <code class="o">82</code>   <code class="o">33.90000</code>
<code class="o">12</code> <code class="o">2003-07-04</code>   <code class="o">84</code>   <code class="o">32.90000</code>
<code class="o">13</code> <code class="o">2005-06-24</code>   <code class="o">86</code>   <code class="o">31.85714</code>
<code class="o">14</code> <code class="o">2005-06-27</code>   <code class="o">82</code>   <code class="o">51.53750</code>
<code class="o">15</code> <code class="o">2005-06-28</code>   <code class="o">85</code>   <code class="o">31.20000</code>
<code class="o">16</code> <code class="o">2005-07-17</code>   <code class="o">84</code>   <code class="o">32.70000</code>
<code class="o">17</code> <code class="o">2005-08-03</code>   <code class="o">84</code>   <code class="o">37.90000</code>
</pre></div>

</figure>

<p class="calibre2">Now there are only 17 observations where both of those conditions are met.</p>

<h3 id="calibre_link-84" class="calibre19">
<span class="section-number">13.7 </span><code class="calibre11">arrange()</code>
</h3>

<p class="calibre2">The <code class="calibre21">arrange()</code> function is used to reorder rows of a data frame according to one of the variables/columns. Reordering rows of a data frame (while preserving corresponding order
of other columns) is normally a pain to do in R. The <code class="calibre21">arrange()</code> function simplifies the process quite a bit.</p>

<p class="calibre2">Here we can order the rows of the data frame by date, so that the first row is the earliest (oldest) observation and the last row is the latest (most recent) observation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> arrange<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">We can now check the first few rows</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">,</code> pm25tmean2<code class="calibre21">),</code> <code class="o">3</code><code class="calibre21">)</code>
        date pm25tmean2
<code class="o">1</code> <code class="o">1987-01-01</code>         <code class="kc">NA</code>
<code class="o">2</code> <code class="o">1987-01-02</code>         <code class="kc">NA</code>
<code class="o">3</code> <code class="o">1987-01-03</code>         <code class="kc">NA</code>
</pre></div>

</figure>

<p class="calibre2">and the last few rows.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">tail</code><code class="calibre21">(</code>select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">,</code> pm25tmean2<code class="calibre21">),</code> <code class="o">3</code><code class="calibre21">)</code>
           date pm25tmean2
<code class="o">6938</code> <code class="o">2005-12-29</code>    <code class="o">7.45000</code>
<code class="o">6939</code> <code class="o">2005-12-30</code>   <code class="o">15.05714</code>
<code class="o">6940</code> <code class="o">2005-12-31</code>   <code class="o">15.00000</code>
</pre></div>

</figure>

<p class="calibre2">Columns can be arranged in descending order too by useing the special <code class="calibre21">desc()</code> operator.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> arrange<code class="calibre21">(</code>chicago<code class="calibre21">,</code> desc<code class="calibre21">(</code><code class="kp">date</code><code class="calibre21">))</code>
</pre></div>

</figure>

<p class="calibre2">Looking at the first three and last three rows shows the dates in descending order.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">,</code> pm25tmean2<code class="calibre21">),</code> <code class="o">3</code><code class="calibre21">)</code>
        date pm25tmean2
<code class="o">1</code> <code class="o">2005-12-31</code>   <code class="o">15.00000</code>
<code class="o">2</code> <code class="o">2005-12-30</code>   <code class="o">15.05714</code>
<code class="o">3</code> <code class="o">2005-12-29</code>    <code class="o">7.45000</code>
<code class="o">&gt;</code> <code class="kp">tail</code><code class="calibre21">(</code>select<code class="calibre21">(</code>chicago<code class="calibre21">,</code> <code class="kp">date</code><code class="calibre21">,</code> pm25tmean2<code class="calibre21">),</code> <code class="o">3</code><code class="calibre21">)</code>
           date pm25tmean2
<code class="o">6938</code> <code class="o">1987-01-03</code>         <code class="kc">NA</code>
<code class="o">6939</code> <code class="o">1987-01-02</code>         <code class="kc">NA</code>
<code class="o">6940</code> <code class="o">1987-01-01</code>         <code class="kc">NA</code>
</pre></div>

</figure>

<h3 id="calibre_link-85" class="calibre19">
<span class="section-number">13.8 </span><code class="calibre11">rename()</code>
</h3>

<p class="calibre2">Renaming a variable in a data frame in R is surprisingly hard to do! The <code class="calibre21">rename()</code> function is designed to make this process easier.</p>

<p class="calibre2">Here you can see the names of the first five variables in the <code class="calibre21">chicago</code> data frame.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>chicago<code class="calibre21">[,</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">],</code> <code class="o">3</code><code class="calibre21">)</code>
  city tmpd dptp       date pm25tmean2
<code class="o">1</code> chic   <code class="o">35</code> <code class="o">30.1</code> <code class="o">2005-12-31</code>   <code class="o">15.00000</code>
<code class="o">2</code> chic   <code class="o">36</code> <code class="o">31.0</code> <code class="o">2005-12-30</code>   <code class="o">15.05714</code>
<code class="o">3</code> chic   <code class="o">35</code> <code class="o">29.4</code> <code class="o">2005-12-29</code>    <code class="o">7.45000</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">dptp</code> column is supposed to represent the dew point temperature adn the <code class="calibre21">pm25tmean2</code> column provides the PM2.5 data. However, these names are pretty obscure or awkward and probably be renamed to something more sensible.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> rename<code class="calibre21">(</code>chicago<code class="calibre21">,</code> dewpoint <code class="o">=</code> dptp<code class="calibre21">,</code> pm25 <code class="o">=</code> pm25tmean2<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>chicago<code class="calibre21">[,</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">],</code> <code class="o">3</code><code class="calibre21">)</code>
  city tmpd dewpoint       date     pm25
<code class="o">1</code> chic   <code class="o">35</code>     <code class="o">30.1</code> <code class="o">2005-12-31</code> <code class="o">15.00000</code>
<code class="o">2</code> chic   <code class="o">36</code>     <code class="o">31.0</code> <code class="o">2005-12-30</code> <code class="o">15.05714</code>
<code class="o">3</code> chic   <code class="o">35</code>     <code class="o">29.4</code> <code class="o">2005-12-29</code>  <code class="o">7.45000</code>
</pre></div>

</figure>

<p class="calibre2">The syntax inside the <code class="calibre21">rename()</code> function is to have the new name on the left-hand side of the <code class="calibre21">=</code> sign and the old name on the right-hand side.</p>

<p class="calibre2">I leave it as an exercise for the reader to figure how you do this in base R without <code class="calibre21">dplyr</code>.</p>

<h3 id="calibre_link-86" class="calibre19">
<span class="section-number">13.9 </span><code class="calibre11">mutate()</code>
</h3>

<p class="calibre2">The <code class="calibre21">mutate()</code> function exists to compute transformations of variables in a data frame. Often, you want to create new variables that are derived from existing variables and <code class="calibre21">mutate()</code> provides a clean interface for doing that.</p>

<p class="calibre2">For example, with air pollution data, we often want to <em class="calibre17">detrend</em> the data by subtracting the mean from the data. That way we can look at whether a given dayâs air pollution level is higher than or less than average (as opposed to looking at its absolute level).</p>

<p class="calibre2">Here we create a <code class="calibre21">pm25detrend</code> variable that subtracts the mean from the <code class="calibre21">pm25</code> variable.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> mutate<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25detrend <code class="o">=</code> pm25 <code class="o">-</code> <code class="kp">mean</code><code class="calibre21">(</code>pm25<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>chicago<code class="calibre21">)</code>
  city tmpd dewpoint       date     pm25 pm10tmean2  o3tmean2 no2tmean2
<code class="o">1</code> chic   <code class="o">35</code>     <code class="o">30.1</code> <code class="o">2005-12-31</code> <code class="o">15.00000</code>       <code class="o">23.5</code>  <code class="o">2.531250</code>  <code class="o">13.25000</code>
<code class="o">2</code> chic   <code class="o">36</code>     <code class="o">31.0</code> <code class="o">2005-12-30</code> <code class="o">15.05714</code>       <code class="o">19.2</code>  <code class="o">3.034420</code>  <code class="o">22.80556</code>
<code class="o">3</code> chic   <code class="o">35</code>     <code class="o">29.4</code> <code class="o">2005-12-29</code>  <code class="o">7.45000</code>       <code class="o">23.5</code>  <code class="o">6.794837</code>  <code class="o">19.97222</code>
<code class="o">4</code> chic   <code class="o">37</code>     <code class="o">34.5</code> <code class="o">2005-12-28</code> <code class="o">17.75000</code>       <code class="o">27.5</code>  <code class="o">3.260417</code>  <code class="o">19.28563</code>
<code class="o">5</code> chic   <code class="o">40</code>     <code class="o">33.6</code> <code class="o">2005-12-27</code> <code class="o">23.56000</code>       <code class="o">27.0</code>  <code class="o">4.468750</code>  <code class="o">23.50000</code>
<code class="o">6</code> chic   <code class="o">35</code>     <code class="o">29.6</code> <code class="o">2005-12-26</code>  <code class="o">8.40000</code>        <code class="o">8.5</code> <code class="o">14.041667</code>  <code class="o">16.81944</code>
  pm25detrend
<code class="o">1</code>   <code class="o">-1.230958</code>
<code class="o">2</code>   <code class="o">-1.173815</code>
<code class="o">3</code>   <code class="o">-8.780958</code>
<code class="o">4</code>    <code class="o">1.519042</code>
<code class="o">5</code>    <code class="o">7.329042</code>
<code class="o">6</code>   <code class="o">-7.830958</code>
</pre></div>

</figure>

<p class="calibre2">There is also the related <code class="calibre21">transmute()</code> function, which does the same thing as <code class="calibre21">mutate()</code> but then <em class="calibre17">drops all non-transformed variables</em>. </p>

<p class="calibre2">Here we detrend the PM10 and ozone (O3) variables.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>transmute<code class="calibre21">(</code>chicago<code class="calibre21">,</code> 
<code class="o">+</code>                pm10detrend <code class="o">=</code> pm10tmean2 <code class="o">-</code> <code class="kp">mean</code><code class="calibre21">(</code>pm10tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code>
<code class="o">+</code>                o3detrend <code class="o">=</code> o3tmean2 <code class="o">-</code> <code class="kp">mean</code><code class="calibre21">(</code>o3tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)))</code>
  pm10detrend  o3detrend
<code class="o">1</code>  <code class="o">-10.395206</code> <code class="o">-16.904263</code>
<code class="o">2</code>  <code class="o">-14.695206</code> <code class="o">-16.401093</code>
<code class="o">3</code>  <code class="o">-10.395206</code> <code class="o">-12.640676</code>
<code class="o">4</code>   <code class="o">-6.395206</code> <code class="o">-16.175096</code>
<code class="o">5</code>   <code class="o">-6.895206</code> <code class="o">-14.966763</code>
<code class="o">6</code>  <code class="o">-25.395206</code>  <code class="o">-5.393846</code>
</pre></div>

</figure>

<p class="calibre2">Note that there are only two columns in the transmuted data frame.</p>

<h3 id="calibre_link-87" class="calibre19">
<span class="section-number">13.10 </span><code class="calibre11">group_by()</code>
</h3>

<p class="calibre2">The <code class="calibre21">group_by()</code> function is used to generate summary statistics from the data frame within strata defined by a variable. For example, in this air pollution dataset, you might want to know what the average annual level of PM2.5 is. So the stratum is the year, and that is something we can derive from the <code class="calibre21">date</code> variable. In conjunction with the <code class="calibre21">group_by()</code> function we often use the <code class="calibre21">summarize()</code> function (or <code class="calibre21">summarise()</code> for some parts of the world).</p>

<p class="calibre2">The general operation here is a combination of splitting a data frame into separate pieces defined by a variable or group of variables (<code class="calibre21">group_by()</code>), and then applying a summary function across those subsets (<code class="calibre21">summarize()</code>).</p>

<p class="calibre2">First, we can create a <code class="calibre21">year</code> varible using <code class="calibre21">as.POSIXlt()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> chicago <code class="o">&lt;-</code> mutate<code class="calibre21">(</code>chicago<code class="calibre21">,</code> year <code class="o">=</code> <code class="kp">as.POSIXlt</code><code class="calibre21">(</code><code class="kp">date</code><code class="calibre21">)</code><code class="o">$</code>year <code class="o">+</code> <code class="o">1900</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Now we can create a separate data frame that splits the original data frame by year.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> years <code class="o">&lt;-</code> group_by<code class="calibre21">(</code>chicago<code class="calibre21">,</code> year<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Finally, we compute summary statistics for each year in the data frame with the <code class="calibre21">summarize()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> summarize<code class="calibre21">(</code>years<code class="calibre21">,</code> pm25 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>pm25<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>           o3 <code class="o">=</code> <code class="kp">max</code><code class="calibre21">(</code>o3tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>           no2 <code class="o">=</code> median<code class="calibre21">(</code>no2tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code>
<code class="o">+</code>           <code class="o">.</code>groups <code class="o">=</code> <code class="s">"drop"</code><code class="calibre21">)</code>
<code class="c"># A tibble: 19 x 4</code>
    year  pm25    o3   no2
   <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code>
 <code class="o">1</code>  <code class="o">1987</code> <code class="kc">NaN</code>    <code class="o">63.0</code>  <code class="o">23.5</code>
 <code class="o">2</code>  <code class="o">1988</code> <code class="kc">NaN</code>    <code class="o">61.7</code>  <code class="o">24.5</code>
 <code class="o">3</code>  <code class="o">1989</code> <code class="kc">NaN</code>    <code class="o">59.7</code>  <code class="o">26.1</code>
 <code class="o">4</code>  <code class="o">1990</code> <code class="kc">NaN</code>    <code class="o">52.2</code>  <code class="o">22.6</code>
 <code class="o">5</code>  <code class="o">1991</code> <code class="kc">NaN</code>    <code class="o">63.1</code>  <code class="o">21.4</code>
 <code class="o">6</code>  <code class="o">1992</code> <code class="kc">NaN</code>    <code class="o">50.8</code>  <code class="o">24.8</code>
 <code class="o">7</code>  <code class="o">1993</code> <code class="kc">NaN</code>    <code class="o">44.3</code>  <code class="o">25.8</code>
 <code class="o">8</code>  <code class="o">1994</code> <code class="kc">NaN</code>    <code class="o">52.2</code>  <code class="o">28.5</code>
 <code class="o">9</code>  <code class="o">1995</code> <code class="kc">NaN</code>    <code class="o">66.6</code>  <code class="o">27.3</code>
<code class="o">10</code>  <code class="o">1996</code> <code class="kc">NaN</code>    <code class="o">58.4</code>  <code class="o">26.4</code>
<code class="o">11</code>  <code class="o">1997</code> <code class="kc">NaN</code>    <code class="o">56.5</code>  <code class="o">25.5</code>
<code class="o">12</code>  <code class="o">1998</code>  <code class="o">18.3</code>  <code class="o">50.7</code>  <code class="o">24.6</code>
<code class="o">13</code>  <code class="o">1999</code>  <code class="o">18.5</code>  <code class="o">57.5</code>  <code class="o">24.7</code>
<code class="o">14</code>  <code class="o">2000</code>  <code class="o">16.9</code>  <code class="o">55.8</code>  <code class="o">23.5</code>
<code class="o">15</code>  <code class="o">2001</code>  <code class="o">16.9</code>  <code class="o">51.8</code>  <code class="o">25.1</code>
<code class="o">16</code>  <code class="o">2002</code>  <code class="o">15.3</code>  <code class="o">54.9</code>  <code class="o">22.7</code>
<code class="o">17</code>  <code class="o">2003</code>  <code class="o">15.2</code>  <code class="o">56.2</code>  <code class="o">24.6</code>
<code class="o">18</code>  <code class="o">2004</code>  <code class="o">14.6</code>  <code class="o">44.5</code>  <code class="o">23.4</code>
<code class="o">19</code>  <code class="o">2005</code>  <code class="o">16.2</code>  <code class="o">58.8</code>  <code class="o">22.6</code>
</pre></div>

</figure>

<p class="calibre2"><code class="calibre21">summarize()</code> returns a data frame with <code class="calibre21">year</code> as the first column, and then the annual averages of <code class="calibre21">pm25</code>, <code class="calibre21">o3</code>, and <code class="calibre21">no2</code>.</p>

<p class="calibre2">In a slightly more complicated example, we might want to know what are the average levels of ozone (<code class="calibre21">o3</code>) and nitrogen dioxide (<code class="calibre21">no2</code>) within quintiles of <code class="calibre21">pm25</code>. A slicker way to do this would be through a regression model, but we can actually do this quickly with <code class="calibre21">group_by()</code> and <code class="calibre21">summarize()</code>.</p>

<p class="calibre2">First, we can create a categorical variable of <code class="calibre21">pm25</code> divided into quintiles.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> qq <code class="o">&lt;-</code> quantile<code class="calibre21">(</code>chicago<code class="o">$</code>pm25<code class="calibre21">,</code> <code class="kp">seq</code><code class="calibre21">(</code><code class="o">0</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">0.2</code><code class="calibre21">),</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">&gt;</code> chicago <code class="o">&lt;-</code> mutate<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25.quint <code class="o">=</code> <code class="kp">cut</code><code class="calibre21">(</code>pm25<code class="calibre21">,</code> qq<code class="calibre21">))</code>
</pre></div>

</figure>

<p class="calibre2">Now we can group the data frame by the <code class="calibre21">pm25.quint</code> variable.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> quint <code class="o">&lt;-</code> group_by<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25.quint<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Finally, we can compute the mean of <code class="calibre21">o3</code> and <code class="calibre21">no2</code> within quintiles of <code class="calibre21">pm25</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> summarize<code class="calibre21">(</code>quint<code class="calibre21">,</code> o3 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>o3tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>           no2 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>no2tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code>
<code class="o">+</code>           <code class="o">.</code>groups <code class="o">=</code> <code class="s">"drop"</code><code class="calibre21">)</code>
<code class="c"># A tibble: 6 x 3</code>
  pm25.quint     o3   no2
  <code class="o">&lt;</code>fct<code class="o">&gt;</code>       <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code>
<code class="o">1</code> <code class="calibre21">(</code><code class="o">1.7</code><code class="calibre21">,</code><code class="o">8.7</code><code class="calibre21">]</code>    <code class="o">21.7</code>  <code class="o">18.0</code>
<code class="o">2</code> <code class="calibre21">(</code><code class="o">8.7</code><code class="calibre21">,</code><code class="o">12.4</code><code class="calibre21">]</code>   <code class="o">20.4</code>  <code class="o">22.1</code>
<code class="o">3</code> <code class="calibre21">(</code><code class="o">12.4</code><code class="calibre21">,</code><code class="o">16.7</code><code class="calibre21">]</code>  <code class="o">20.7</code>  <code class="o">24.4</code>
<code class="o">4</code> <code class="calibre21">(</code><code class="o">16.7</code><code class="calibre21">,</code><code class="o">22.6</code><code class="calibre21">]</code>  <code class="o">19.9</code>  <code class="o">27.3</code>
<code class="o">5</code> <code class="calibre21">(</code><code class="o">22.6</code><code class="calibre21">,</code><code class="o">61.5</code><code class="calibre21">]</code>  <code class="o">20.3</code>  <code class="o">29.6</code>
<code class="o">6</code> <code class="o">&lt;</code><code class="kc">NA</code><code class="o">&gt;</code>         <code class="o">18.8</code>  <code class="o">25.8</code>
</pre></div>

</figure>

<p class="calibre2">From the table, it seems there isnât a strong relationship between <code class="calibre21">pm25</code> and <code class="calibre21">o3</code>, but there appears to be a positive correlation between <code class="calibre21">pm25</code> and <code class="calibre21">no2</code>. More sophisticated statistical modeling can help to provide precise answers to these questions, but a simple application of <code class="calibre21">dplyr</code> functions can often get you most of the way there.</p>

<h3 id="calibre_link-88" class="calibre19">
<span class="section-number">13.11 </span><code class="calibre11">%&gt;%</code>
</h3>

<p class="calibre2">The pipeline operater <code class="calibre21">%&gt;%</code> is very handy for stringing together multiple <code class="calibre21">dplyr</code> functions in a sequence of operations. Notice above that every time we wanted to apply more than one function, the sequence gets buried in a sequence of nested function calls that is difficult to read, i.e.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> third<code class="calibre21">(</code>second<code class="calibre21">(</code>first<code class="calibre21">(</code>x<code class="calibre21">)))</code>
</pre></div>

</figure>

<p class="calibre2">This nesting is not a natural way to think about a sequence of operations. The <code class="calibre21">%&gt;%</code> operator allows you to string operations in a left-to-right fashion, i.e.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> first<code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="o">%&gt;%</code> second <code class="o">%&gt;%</code> third
</pre></div>

</figure>

<p class="calibre2">Take the example that we just did in the last section where we computed the mean of <code class="calibre21">o3</code> and <code class="calibre21">no2</code> within quintiles of <code class="calibre21">pm25</code>. There we had to </p>

<ol class="calibre13">
  <li class="calibre14">create a new variable <code class="calibre21">pm25.quint</code>
</li>
  <li class="calibre14">split the data frame by that new variable</li>
  <li class="calibre14">compute the mean of <code class="calibre21">o3</code> and <code class="calibre21">no2</code> in the sub-groups defined by <code class="calibre21">pm25.quint</code>
</li>
</ol>

<p class="calibre2">That can be done with the following sequence in a single R expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> mutate<code class="calibre21">(</code>chicago<code class="calibre21">,</code> pm25.quint <code class="o">=</code> <code class="kp">cut</code><code class="calibre21">(</code>pm25<code class="calibre21">,</code> qq<code class="calibre21">))</code> <code class="o">%&gt;%</code>    
<code class="o">+</code>         group_by<code class="calibre21">(</code>pm25.quint<code class="calibre21">)</code> <code class="o">%&gt;%</code> 
<code class="o">+</code>         summarize<code class="calibre21">(</code>o3 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>o3tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>                   no2 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>no2tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code>
<code class="o">+</code>                   <code class="o">.</code>groups <code class="o">=</code> <code class="s">"drop"</code><code class="calibre21">)</code>
<code class="c"># A tibble: 6 x 3</code>
  pm25.quint     o3   no2
  <code class="o">&lt;</code>fct<code class="o">&gt;</code>       <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code>
<code class="o">1</code> <code class="calibre21">(</code><code class="o">1.7</code><code class="calibre21">,</code><code class="o">8.7</code><code class="calibre21">]</code>    <code class="o">21.7</code>  <code class="o">18.0</code>
<code class="o">2</code> <code class="calibre21">(</code><code class="o">8.7</code><code class="calibre21">,</code><code class="o">12.4</code><code class="calibre21">]</code>   <code class="o">20.4</code>  <code class="o">22.1</code>
<code class="o">3</code> <code class="calibre21">(</code><code class="o">12.4</code><code class="calibre21">,</code><code class="o">16.7</code><code class="calibre21">]</code>  <code class="o">20.7</code>  <code class="o">24.4</code>
<code class="o">4</code> <code class="calibre21">(</code><code class="o">16.7</code><code class="calibre21">,</code><code class="o">22.6</code><code class="calibre21">]</code>  <code class="o">19.9</code>  <code class="o">27.3</code>
<code class="o">5</code> <code class="calibre21">(</code><code class="o">22.6</code><code class="calibre21">,</code><code class="o">61.5</code><code class="calibre21">]</code>  <code class="o">20.3</code>  <code class="o">29.6</code>
<code class="o">6</code> <code class="o">&lt;</code><code class="kc">NA</code><code class="o">&gt;</code>         <code class="o">18.8</code>  <code class="o">25.8</code>
</pre></div>

</figure>

<p class="calibre2">This way we donât have to create a set of temporary variables along the way or create a massive nested sequence of function calls.</p>

<p class="calibre2">Notice in the above code that I pass the <code class="calibre21">chicago</code> data frame to the first call to <code class="calibre21">mutate()</code>, but then afterwards I do not have to pass the first argument to <code class="calibre21">group_by()</code> or <code class="calibre21">summarize()</code>. Once you travel down the pipeline with <code class="calibre21">%&gt;%</code>, the first argument is taken to be the output of the previous element in the pipeline.</p>

<p class="calibre2">Another example might be computing the average pollutant level by month. This could be useful to see if there are any seasonal trends in the data. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> mutate<code class="calibre21">(</code>chicago<code class="calibre21">,</code> month <code class="o">=</code> <code class="kp">as.POSIXlt</code><code class="calibre21">(</code><code class="kp">date</code><code class="calibre21">)</code><code class="o">$</code>mon <code class="o">+</code> <code class="o">1</code><code class="calibre21">)</code> <code class="o">%&gt;%</code> 
<code class="o">+</code>         group_by<code class="calibre21">(</code>month<code class="calibre21">)</code> <code class="o">%&gt;%</code> 
<code class="o">+</code>         summarize<code class="calibre21">(</code>pm25 <code class="o">=</code> <code class="kp">mean</code><code class="calibre21">(</code>pm25<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>                   o3 <code class="o">=</code> <code class="kp">max</code><code class="calibre21">(</code>o3tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code> 
<code class="o">+</code>                   no2 <code class="o">=</code> median<code class="calibre21">(</code>no2tmean2<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">),</code>
<code class="o">+</code>                   <code class="o">.</code>groups <code class="o">=</code> <code class="s">"drop"</code><code class="calibre21">)</code>
<code class="c"># A tibble: 12 x 4</code>
   month  pm25    o3   no2
   <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code> <code class="o">&lt;</code>dbl<code class="o">&gt;</code>
 <code class="o">1</code>     <code class="o">1</code>  <code class="o">17.8</code>  <code class="o">28.2</code>  <code class="o">25.4</code>
 <code class="o">2</code>     <code class="o">2</code>  <code class="o">20.4</code>  <code class="o">37.4</code>  <code class="o">26.8</code>
 <code class="o">3</code>     <code class="o">3</code>  <code class="o">17.4</code>  <code class="o">39.0</code>  <code class="o">26.8</code>
 <code class="o">4</code>     <code class="o">4</code>  <code class="o">13.9</code>  <code class="o">47.9</code>  <code class="o">25.0</code>
 <code class="o">5</code>     <code class="o">5</code>  <code class="o">14.1</code>  <code class="o">52.8</code>  <code class="o">24.2</code>
 <code class="o">6</code>     <code class="o">6</code>  <code class="o">15.9</code>  <code class="o">66.6</code>  <code class="o">25.0</code>
 <code class="o">7</code>     <code class="o">7</code>  <code class="o">16.6</code>  <code class="o">59.5</code>  <code class="o">22.4</code>
 <code class="o">8</code>     <code class="o">8</code>  <code class="o">16.9</code>  <code class="o">54.0</code>  <code class="o">23.0</code>
 <code class="o">9</code>     <code class="o">9</code>  <code class="o">15.9</code>  <code class="o">57.5</code>  <code class="o">24.5</code>
<code class="o">10</code>    <code class="o">10</code>  <code class="o">14.2</code>  <code class="o">47.1</code>  <code class="o">24.2</code>
<code class="o">11</code>    <code class="o">11</code>  <code class="o">15.2</code>  <code class="o">29.5</code>  <code class="o">23.6</code>
<code class="o">12</code>    <code class="o">12</code>  <code class="o">17.5</code>  <code class="o">27.7</code>  <code class="o">24.5</code>
</pre></div>

</figure>

<p class="calibre2">Here we can see that <code class="calibre21">o3</code> tends to be low in the winter months and high in the summer while <code class="calibre21">no2</code> is higher in the winter and lower in the summer.</p>

<h3 id="calibre_link-89" class="calibre19">
<span class="section-number">13.12 </span>Summary</h3>

<p class="calibre2">The <code class="calibre21">dplyr</code> package provides a concise set of operations for managing data frames. With these functions we can do a number of complex operations in just a few lines of code. In particular, we can often conduct the beginnings of an exploratory analysis with the powerful combination of <code class="calibre21">group_by()</code> and <code class="calibre21">summarize()</code>. </p>

<p class="calibre2">Once you learn the <code class="calibre21">dplyr</code> grammar there are a few additional benefits</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">dplyr</code> can work with other data frame âbackendsâ such as SQL databases. There is an SQL interface for relational databases via the DBI package</li>
  <li class="calibre14">
<code class="calibre21">dplyr</code> can be integrated with the <code class="calibre21">data.table</code> package for large fast tables</li>
</ul>

<p class="calibre2">The <code class="calibre21">dplyr</code> package is handy way to both simplify and speed up your data frame management code. Itâs rare that you get such a combination at the same time!</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-7">
<div class="calibre5">
<h2 id="calibre_link-90" class="calibre15">
<span class="section-number">14. </span>Control Structures</h2>

<p class="calibre2">
  <a href="https://youtu.be/BPNLjUDZ8_o">Watch a video of this section</a>
</p>

<p class="calibre2">Control structures in R allow you to control the flow of execution of
a series of R expressions. Basically, control structures allow you to
put some âlogicâ into your R code, rather than just always executing
the same R code every time. Control structures allow you to respond to
inputs or to features of the data and execute different R expressions
accordingly.</p>

<p class="calibre2">Commonly used control structures are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">if</code> and <code class="calibre21">else</code>: testing a condition and acting on it</li>
  <li class="calibre14">
<code class="calibre21">for</code>: execute a loop a fixed number of times </li>
  <li class="calibre14">
<code class="calibre21">while</code>: execute a loop <em class="calibre17">while</em> a condition is true </li>
  <li class="calibre14">
<code class="calibre21">repeat</code>: execute an infinite loop (must <code class="calibre21">break</code> out of it to stop)</li>
  <li class="calibre14">
<code class="calibre21">break</code>: break the execution of a loop</li>
  <li class="calibre14">
<code class="calibre21">next</code>: skip an interation of a loop</li>
</ul>

<p class="calibre2">Most control structures are not used in interactive sessions, but
rather when writing functions or longer expresisons. However, these
constructs do not have to be used in functions and itâs a good idea to
become familiar with them before we delve into functions.</p>

<h3 id="calibre_link-91" class="calibre19">
<span class="section-number">14.1 </span><code class="calibre11">if</code>-<code class="calibre11">else</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/ZaBtJPYYGwg">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">if</code>-<code class="calibre21">else</code> combination is probably the most commonly used control
structure in R (or perhaps any language). This structure allows you to
test a condition and act on it depending on whether itâs true or
false. </p>

<p class="calibre2">For starters, you can just use the <code class="calibre21">if</code> statement.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition<code class="o">&gt;</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="c">## do something</code>
<code class="calibre21">}</code> 
<code class="c">## Continue with rest of code</code>
</pre></div>

</figure>

<p class="calibre2">The above code does nothing if the condition is false. If you have an
action you want to execute when the condition is false, then you need
an <code class="calibre21">else</code> clause.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition<code class="o">&gt;</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="c">## do something</code>
<code class="calibre21">}</code> 
<code class="kc">else</code> <code class="calibre21">{</code>
        <code class="c">## do something else</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">You can have a series of tests by following the initial <code class="calibre21">if</code> with any
number of <code class="calibre21">else if</code>s.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition1<code class="o">&gt;</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="c">## do something</code>
<code class="calibre21">}</code> <code class="kc">else</code> <code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition2<code class="o">&gt;</code><code class="calibre21">)</code>  <code class="calibre21">{</code>
        <code class="c">## do something different</code>
<code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
        <code class="c">## do something different</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Here is an example of a valid if/else structure.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="c">## Generate a uniform random number</code>
x <code class="o">&lt;-</code> runif<code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">0</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code>  
<code class="kc">if</code><code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">3</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        y <code class="o">&lt;-</code> <code class="o">10</code>
<code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
        y <code class="o">&lt;-</code> <code class="o">0</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">The value of <code class="calibre21">y</code> is set depending on whether <code class="calibre21">x &gt; 3</code> or not. This
expression can also be written a different, but equivalent, way in R.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>y <code class="o">&lt;-</code> <code class="kc">if</code><code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">3</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="o">10</code>
<code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code> 
        <code class="o">0</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Neither way of writing this expression is more correct than the
other. Which one you use will depend on your preference and perhaps
those of the team you may be working with.</p>

<p class="calibre2">Of course, the <code class="calibre21">else</code> clause is not necessary. You could have a series
of if clauses that always get executed if their respective conditions
are true.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition1<code class="o">&gt;</code><code class="calibre21">)</code> <code class="calibre21">{</code>

<code class="calibre21">}</code>

<code class="kc">if</code><code class="calibre21">(</code><code class="o">&lt;</code>condition2<code class="o">&gt;</code><code class="calibre21">)</code> <code class="calibre21">{</code>

<code class="calibre21">}</code>
</pre></div>

</figure>

<h3 id="calibre_link-92" class="calibre19">
<span class="section-number">14.2 </span><code class="calibre11">for</code> Loops</h3>

<p class="calibre2">
  <a href="https://youtu.be/FbT1dGXCCxU">Watch a video of this section</a>
</p>

<p class="calibre2">For loops are pretty much the only looping construct that you will
need in R. While you may occasionally find a need for other types of
loops, in my experience doing data analysis, Iâve found very few
situations where a for loop wasnât sufficient. </p>

<p class="calibre2">In R, for loops take an interator variable and assign it successive
values from a sequence or vector. For loops are most commonly used for
iterating over the elements of an object (list, vector, etc.)</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>i<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">5</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">6</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">7</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">8</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">9</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">10</code>
</pre></div>

</figure>

<p class="calibre2">This loop takes the <code class="calibre21">i</code> variable and in each iteration of the loop
gives it values 1, 2, 3, â¦, 10, executes the code within the curly
braces, and then the loop exits.</p>

<p class="calibre2">The following three loops all have the same behavior.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> <code class="s">"c"</code><code class="calibre21">,</code> <code class="s">"d"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="c">## Print out each element of 'x'</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">[</code>i<code class="calibre21">])</code>  
<code class="o">+</code> <code class="calibre21">}</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"c"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"d"</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">seq_along()</code> function is commonly used in conjunction with for
loops in order to generate an integer sequence based on the length of
an object (in this case, the object <code class="calibre21">x</code>).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Generate a sequence based on length of 'x'</code>
<code class="o">&gt;</code> <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_along</code><code class="calibre21">(</code>x<code class="calibre21">))</code> <code class="calibre21">{</code>   
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">[</code>i<code class="calibre21">])</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"c"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"d"</code>
</pre></div>

</figure>

<p class="calibre2">It is not necessary to use an index-type variable. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">for</code><code class="calibre21">(</code>letter <code class="kc">in</code> x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>letter<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"c"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"d"</code>
</pre></div>

</figure>

<p class="calibre2">For one line loops, the curly braces are not strictly necessary.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">)</code> <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">[</code>i<code class="calibre21">])</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"b"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"c"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"d"</code>
</pre></div>

</figure>

<p class="calibre2">However, I like to use curly braces even for one-line loops, because
that way if you decide to expand the loop to multiple lines, you wonât
be burned because you forgot to add curly braces (and you <em class="calibre17">will</em> be
burned by this).</p>

<h3 id="calibre_link-93" class="calibre19">
<span class="section-number">14.3 </span>Nested <code class="calibre11">for</code> loops</h3>

<p class="calibre2"><code class="calibre21">for</code> loops can be nested inside of each other.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">)</code>

<code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_len</code><code class="calibre21">(</code><code class="kp">nrow</code><code class="calibre21">(</code>x<code class="calibre21">)))</code> <code class="calibre21">{</code>
        <code class="kc">for</code><code class="calibre21">(</code>j <code class="kc">in</code> <code class="kp">seq_len</code><code class="calibre21">(</code><code class="kp">ncol</code><code class="calibre21">(</code>x<code class="calibre21">)))</code> <code class="calibre21">{</code>
                <code class="kp">print</code><code class="calibre21">(</code>x<code class="calibre21">[</code>i<code class="calibre21">,</code> j<code class="calibre21">])</code>
        <code class="calibre21">}</code>   
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Nested loops are commonly needed for multidimensional or hierarchical
data structures (e.g. matrices, lists). Be careful with nesting
though. Nesting beyond 2 to 3 levels often makes it difficult to
read/understand the code. If you find yourself in need of a large
number of nested loops, you may want to break up the loops by using
functions (discussed later).</p>

<h3 id="calibre_link-94" class="calibre19">
<span class="section-number">14.4 </span><code class="calibre11">while</code> Loops</h3>

<p class="calibre2">
  <a href="https://youtu.be/VqrS1Wghq1c">Watch a video of this section</a>
</p>

<p class="calibre2">While loops begin by testing a condition. If it is true, then they
execute the loop body. Once the loop body is executed, the condition
is tested again, and so forth, until the condition is false, after
which the loop exits.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> count <code class="o">&lt;-</code> <code class="o">0</code>
<code class="o">&gt;</code> <code class="kc">while</code><code class="calibre21">(</code>count <code class="o">&lt;</code> <code class="o">10</code><code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>count<code class="calibre21">)</code>
<code class="o">+</code>         count <code class="o">&lt;-</code> count <code class="o">+</code> <code class="o">1</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">5</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">6</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">7</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">8</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">9</code>
</pre></div>

</figure>

<p class="calibre2">While loops can potentially result in infinite loops if not written
properly. Use with care!</p>

<p class="calibre2">Sometimes there will be more than one condition in the test.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> z <code class="o">&lt;-</code> <code class="o">5</code>
<code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="kc">while</code><code class="calibre21">(</code>z <code class="o">&gt;=</code> <code class="o">3</code> <code class="o">&amp;&amp;</code> z <code class="o">&lt;=</code> <code class="o">10</code><code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         coin <code class="o">&lt;-</code> rbinom<code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">0.5</code><code class="calibre21">)</code>
<code class="o">+</code>         
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code>coin <code class="o">==</code> <code class="o">1</code><code class="calibre21">)</code> <code class="calibre21">{</code>  <code class="c">## random walk</code>
<code class="o">+</code>                 z <code class="o">&lt;-</code> z <code class="o">+</code> <code class="o">1</code>
<code class="o">+</code>         <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
<code class="o">+</code>                 z <code class="o">&lt;-</code> z <code class="o">-</code> <code class="o">1</code>
<code class="o">+</code>         <code class="calibre21">}</code> 
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>z<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
</pre></div>

</figure>

<p class="calibre2">Conditions are always evaluated from left to right. For example, in
the above code, if <code class="calibre21">z</code> were less than 3, the second test would not
have been evaluated.</p>

<h3 id="calibre_link-95" class="calibre19">
<span class="section-number">14.5 </span><code class="calibre11">repeat</code> Loops</h3>

<p class="calibre2">
  <a href="https://youtu.be/SajmdYr30SY">Watch a video of this section</a>
</p>

<p class="calibre2"><code class="calibre21">repeat</code> initiates an infinite loop right from the start. These are
not commonly used in statistical or data analysis applications but
they do have their uses. The only way to exit a <code class="calibre21">repeat</code> loop is to
call <code class="calibre21">break</code>.</p>

<p class="calibre2">One possible paradigm might be in an iterative algorith where you may
be searching for a solution and you donât want to stop until youâre
close enough to the solution. In this kind of situation, you often
donât know in advance how many iterations itâs going to take to get
âclose enoughâ to the solution.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>x0 <code class="o">&lt;-</code> <code class="o">1</code>
tol <code class="o">&lt;-</code> <code class="o">1e-8</code>

<code class="kc">repeat</code> <code class="calibre21">{</code>
        x1 <code class="o">&lt;-</code> computeEstimate<code class="calibre21">()</code>
        
        <code class="kc">if</code><code class="calibre21">(</code><code class="kp">abs</code><code class="calibre21">(</code>x1 <code class="o">-</code> x0<code class="calibre21">)</code> <code class="o">&lt;</code> tol<code class="calibre21">)</code> <code class="calibre21">{</code>  <code class="c">## Close enough?</code>
                <code class="kc">break</code>
        <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
                x0 <code class="o">&lt;-</code> x1
        <code class="calibre21">}</code> 
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Note that the above code will not run if the <code class="calibre21">computeEstimate()</code>
function is not defined (I just made it up for the purposes of this
demonstration).</p>

<p class="calibre2">The loop above is a bit dangerous because thereâs no guarantee it will
stop. You could get in a situation where the values of <code class="calibre21">x0</code> and <code class="calibre21">x1</code>
oscillate back and forth and never converge. Better to set a hard
limit on the number of iterations by using a <code class="calibre21">for</code> loop and then
report whether convergence was achieved or not.</p>

<h3 id="calibre_link-96" class="calibre19">
<span class="section-number">14.6 </span><code class="calibre11">next</code>, <code class="calibre11">break</code>
</h3>

<p class="calibre2"><code class="calibre21">next</code> is used to skip an iteration of a loop. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code><code class="o">100</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="kc">if</code><code class="calibre21">(</code>i <code class="o">&lt;=</code> <code class="o">20</code><code class="calibre21">)</code> <code class="calibre21">{</code>
                <code class="c">## Skip the first 20 iterations</code>
                <code class="kc">next</code>                 
        <code class="calibre21">}</code>
        <code class="c">## Do something here</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2"><code class="calibre21">break</code> is used to exit a loop immediately, regardless of what
iteration the loop may be on.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code><code class="o">100</code><code class="calibre21">)</code> <code class="calibre21">{</code>
      <code class="kp">print</code><code class="calibre21">(</code>i<code class="calibre21">)</code>

      <code class="kc">if</code><code class="calibre21">(</code>i <code class="o">&gt;</code> <code class="o">20</code><code class="calibre21">)</code> <code class="calibre21">{</code>
              <code class="c">## Stop loop after 20 iterations</code>
              <code class="kc">break</code>  
      <code class="calibre21">}</code>		
<code class="calibre21">}</code>
</pre></div>

</figure>

<h3 id="calibre_link-97" class="calibre19">
<span class="section-number">14.7 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">Control structures like <code class="calibre21">if</code>, <code class="calibre21">while</code>, and <code class="calibre21">for</code> allow you to
control the flow of an R program</li>
  <li class="calibre14">Infinite loops should generally be avoided, even if (you believe)
they are theoretically correct.</li>
  <li class="calibre14">Control structures mentioned here are primarily useful for writing
programs; for command-line interactive work, the âapplyâ functions
are more useful.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-14">
<div class="calibre5">
<h2 id="calibre_link-98" class="calibre15">
<span class="section-number">15. </span>Functions</h2>

<p class="calibre2">Writing functions is a core activity of an R programmer. It represents
the key step of the transition from a mere âuserâ to a developer who
creates new functionality for R. Functions are often used to
encapsulate a sequence of expressions that need to be executed
numerous times, perhaps under slightly different conditions. Functions
are also often written when code must be shared with others or the
public. </p>

<p class="calibre2">The writing of a function allows a developer to create an interface to
the code, that is explicitly specified with a set of parameters. This
interface provides an abstraction of the code to potential users. This
abstraction simplifies the usersâ lives because it relieves them from
having to know every detail of how the code operates. In addition, the
creation of an interface allows the developer to communicate to the
user the aspects of the code that are important or are most relevant.</p>

<h3 id="calibre_link-99" class="calibre19">
<span class="section-number">15.1 </span>Functions in R</h3>

<p class="calibre2">Functions in R are âfirst class objectsâ, which means that they can be
treated much like any other R object. Importantly,</p>

<ul class="calibre20">
  <li class="calibre14">Functions can be passed as arguments to other functions. This is very handy for the various apply functions, like <code class="calibre21">lapply()</code> and <code class="calibre21">sapply()</code>.</li>
  <li class="calibre14">Functions can be nested, so that you can define a function inside of
another function</li>
</ul>

<p class="calibre2">If youâre familiar with common language like C, these features might appear a bit strange. However, they are really important in R and can be useful for data analysis.</p>

<h3 id="calibre_link-100" class="calibre19">
<span class="section-number">15.2 </span>Your First Function</h3>

<p class="calibre2">Functions are defined using the <code class="calibre21">function()</code> directive and are stored
as R objects just like anything else. In particular, they are R
objects of class âfunctionâ.</p>

<p class="calibre2">Hereâs a simple function that takes no arguments and does nothing.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">()</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="c">## This is an empty function</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> <code class="c">## Functions have their own class</code>
<code class="o">&gt;</code> <code class="kp">class</code><code class="calibre21">(</code>f<code class="calibre21">)</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"function"</code>
<code class="o">&gt;</code> <code class="c">## Execute this function</code>
<code class="o">&gt;</code> f<code class="calibre21">()</code>       
<code class="kc">NULL</code>
</pre></div>

</figure>

<p class="calibre2">Not very interesting, but itâs a start. The next thing we can do is
create a function that actually has a non-trivial <em class="calibre17">function body</em>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">()</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">cat</code><code class="calibre21">(</code><code class="s">"Hello, world!\n"</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> f<code class="calibre21">()</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
</pre></div>

</figure>

<p class="calibre2">The last aspect of a basic function is the <em class="calibre17">function arguments</em>. These
are the options that you can specify to the user that the user may
explicity set. For this basic function, we can add an argument that
determines how many times âHello, world!â is printed to the console.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>num<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_len</code><code class="calibre21">(</code>num<code class="calibre21">))</code> <code class="calibre21">{</code>
<code class="o">+</code>                 <code class="kp">cat</code><code class="calibre21">(</code><code class="s">"Hello, world!\n"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">}</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> f<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
</pre></div>

</figure>

<p class="calibre2">Obviously, we could have just cut-and-pasted the <code class="calibre21">cat("Hello, world!\n")</code> code three times to achieve the same effect, but then we wouldnât be programming, would we? Also, it would be un-neighborly of you to give your code to someone else and force them to cut-and-paste the code however many times the need to see âHello, world!â.</p>

<blockquote class="calibre18">
  <p class="calibre2">In general, if you find yourself doing a lot of cutting and pasting, thatâs usually a good sign that you might need to write a function.</p>
</blockquote>

<p class="calibre2">Finally, the function above doesnât <em class="calibre17">return</em> anything. It just prints âHello, world!â to the console <code class="calibre21">num</code> number of times and then exits. But often it is useful if a function returns something that perhaps can be fed into another section of code.</p>

<p class="calibre2">This next function returns the total number of characters printed to the console.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>num<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         hello <code class="o">&lt;-</code> <code class="s">"Hello, world!\n"</code>
<code class="o">+</code>         <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_len</code><code class="calibre21">(</code>num<code class="calibre21">))</code> <code class="calibre21">{</code>
<code class="o">+</code>                 <code class="kp">cat</code><code class="calibre21">(</code>hello<code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">}</code>
<code class="o">+</code>         chars <code class="o">&lt;-</code> <code class="kp">nchar</code><code class="calibre21">(</code>hello<code class="calibre21">)</code> <code class="o">*</code> num
<code class="o">+</code>         chars
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> meaningoflife <code class="o">&lt;-</code> f<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>meaningoflife<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">42</code>
</pre></div>

</figure>

<p class="calibre2">In the above function, we didnât have to indicate anything special in order for the function to return the number of characters. In R, the return value of a function is always the very last expression that is evaluated. Because the <code class="calibre21">chars</code> variable is the last expression that is evaluated in this function, that becomes the return value of the function.</p>

<p class="calibre2">Note that there is a <code class="calibre21">return()</code> function that can be used to return an explicity value from a function, but it is rarely used in R (we will discuss it a bit later in this chapter).</p>

<p class="calibre2">Finally, in the above function, the user must specify the value of the argument <code class="calibre21">num</code>. If it is not specified by the user, R will throw an error.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f<code class="calibre21">()</code>
Error <code class="kc">in</code> f<code class="calibre21">()</code><code class="o">:</code> argument <code class="s">"num"</code> is <code class="kp">missing</code><code class="calibre21">,</code> with no default
</pre></div>

</figure>

<p class="calibre2">We can modify this behavior by setting a <em class="calibre17">default value</em> for the argument <code class="calibre21">num</code>. Any function argument can have a default value, if you wish to specify it. Sometimes, argument values are rarely modified (except in special cases) and it makes sense to set a default value for that argument. This relieves the user from having to specify the value of that argument every single time the function is called. </p>

<p class="calibre2">Here, for example, we could set the default value for <code class="calibre21">num</code> to be 1, so that if the function is called without the <code class="calibre21">num</code> argument being explicitly specified, then it will print âHello, world!â to the console once.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>num <code class="o">=</code> <code class="o">1</code><code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         hello <code class="o">&lt;-</code> <code class="s">"Hello, world!\n"</code>
<code class="o">+</code>         <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="kp">seq_len</code><code class="calibre21">(</code>num<code class="calibre21">))</code> <code class="calibre21">{</code>
<code class="o">+</code>                 <code class="kp">cat</code><code class="calibre21">(</code>hello<code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">}</code>
<code class="o">+</code>         chars <code class="o">&lt;-</code> <code class="kp">nchar</code><code class="calibre21">(</code>hello<code class="calibre21">)</code> <code class="o">*</code> num
<code class="o">+</code>         chars
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> f<code class="calibre21">()</code>    <code class="c">## Use default value for 'num'</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">14</code>
<code class="o">&gt;</code> f<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>   <code class="c">## Use user-specified value</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">28</code>
</pre></div>

</figure>

<p class="calibre2">Remember that the function still returns the number of characters printed to the console.</p>

<p class="calibre2">At this point, we have written a function that </p>

<ul class="calibre20">
  <li class="calibre14">has one <em class="calibre17">formal argument</em> named <code class="calibre21">num</code> with a <em class="calibre17">default value</em> of 1. The <em class="calibre17">formal arguments</em> are the arguments included in the function definition. The <code class="calibre21">formals()</code> function returns a list of all the formal arguments of a function </li>
  <li class="calibre14">prints the message âHello, world!â to the console a number of times indicated by the argument <code class="calibre21">num</code>
</li>
  <li class="calibre14">
<em class="calibre17">returns</em> the number of characters printed to the console</li>
</ul>

<p class="calibre2">Functions have <em class="calibre17">named arguments</em> which can optionally have default values. Because all function arguments have names, they can be specified using their name.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f<code class="calibre21">(</code>num <code class="o">=</code> <code class="o">2</code><code class="calibre21">)</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
Hello<code class="calibre21">,</code> world<code class="o">!</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">28</code>
</pre></div>

</figure>

<p class="calibre2">Specifying an argument by its name is sometimes useful if a function has many arguments and it may not always be clear which argument is being specified. Here, our function only has one argument so thereâs no confusion.</p>

<h3 id="calibre_link-101" class="calibre19">
<span class="section-number">15.3 </span>Argument Matching</h3>

<p class="calibre2">Calling an R function with arguments can be done in a variety of ways. This may be confusing at first, but itâs really handing when doing interactive work at the command line. R functions arguments can be matched <em class="calibre17">positionally</em> or by name. Positional matching just means that R assigns the first value to the first argument, the second value to second argument, etc. So in the following call to <code class="calibre21">rnorm()</code></p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code>rnorm<code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>n<code class="calibre21">,</code> mean <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sd <code class="o">=</code> <code class="o">1</code><code class="calibre21">)</code>  
<code class="o">&gt;</code> mydata <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">)</code>              <code class="c">## Generate some data</code>
</pre></div>

</figure>

<p class="calibre2">100 is assigned to the <code class="calibre21">n</code> argument, 2 is assigned to the <code class="calibre21">mean</code> argument, and 1 is assigned to the <code class="calibre21">sd</code> argument, all by positional matching.</p>

<p class="calibre2">The following calls to the <code class="calibre21">sd()</code> function (which computes the empirical standard deviation of a vector of numbers) are all equivalent. Note that <code class="calibre21">sd()</code> has two arguments: <code class="calibre21">x</code> indicates the vector of numbers and <code class="calibre21">na.rm</code> is a logical indicating whether missing values should be removed or not.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Positional match first argument, default for 'na.rm'</code>
<code class="o">&gt;</code> sd<code class="calibre21">(</code>mydata<code class="calibre21">)</code>                     
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9092085</code>
<code class="o">&gt;</code> <code class="c">## Specify 'x' argument by name, default for 'na.rm'</code>
<code class="o">&gt;</code> sd<code class="calibre21">(</code>x <code class="o">=</code> mydata<code class="calibre21">)</code>                 
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9092085</code>
<code class="o">&gt;</code> <code class="c">## Specify both arguments by name</code>
<code class="o">&gt;</code> sd<code class="calibre21">(</code>x <code class="o">=</code> mydata<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>  
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9092085</code>
</pre></div>

</figure>

<p class="calibre2">When specifying the function arguments by name, it doesnât matter in what order you specify them. In the example below, we specify the <code class="calibre21">na.rm</code> argument first, followed by <code class="calibre21">x</code>, even though <code class="calibre21">x</code> is the first argument defined in the function definition.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Specify both arguments by name</code>
<code class="o">&gt;</code> sd<code class="calibre21">(</code>na.rm <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> x <code class="o">=</code> mydata<code class="calibre21">)</code>     
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9092085</code>
</pre></div>

</figure>

<p class="calibre2">You can mix positional matching with matching by name. When an argument is matched by name, it is âtaken outâ of the argument list and the remaining unnamed arguments are matched in the order that they are listed in the function definition.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> sd<code class="calibre21">(</code>na.rm <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> mydata<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9092085</code>
</pre></div>

</figure>

<p class="calibre2">Here, the <code class="calibre21">mydata</code> object is assigned to the <code class="calibre21">x</code> argument, because itâs the only argument not yet specified.</p>

<p class="calibre2">Below is the argument list for the <code class="calibre21">lm()</code> function, which fits linear models to a dataset.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">args</code><code class="calibre21">(</code>lm<code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>formula<code class="calibre21">,</code> data<code class="calibre21">,</code> <code class="kp">subset</code><code class="calibre21">,</code> weights<code class="calibre21">,</code> na.action<code class="calibre21">,</code> method <code class="o">=</code> <code class="s">"qr"</code><code class="calibre21">,</code> 
    model <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> x <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> y <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> qr <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> singular.ok <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> 
    contrasts <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> offset<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code> 
<code class="kc">NULL</code>
</pre></div>

</figure>

<p class="calibre2">The following two calls are equivalent.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>lm<code class="calibre21">(</code>data <code class="o">=</code> mydata<code class="calibre21">,</code> y <code class="o">~</code> x<code class="calibre21">,</code> model <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">100</code><code class="calibre21">)</code>
lm<code class="calibre21">(</code>y <code class="o">~</code> x<code class="calibre21">,</code> mydata<code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">100</code><code class="calibre21">,</code> model <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Even though itâs legal, I donât recommend messing around with the order of the arguments too much, since it can lead to some confusion.</p>

<p class="calibre2">Most of the time, named arguments are useful on the command line when you have a long argument list and you want to use the defaults for everything except for an argument near the end of the list. Named arguments also help if you can remember the name of the argument and not its position on the argument list. For example, plotting functions often have a lot of options to allow for customization, but this makes it difficult to remember exactly the position of every argument on the argument list.</p>

<p class="calibre2">Function arguments can also be <em class="calibre17">partially</em> matched, which is useful for interactive work. The order of operations when given an argument is</p>

<ol class="calibre13">
  <li class="calibre14">Check for exact match for a named argument</li>
  <li class="calibre14">Check for a partial match</li>
  <li class="calibre14">Check for a positional match</li>
</ol>

<p class="calibre2">Partial matching should be avoided when writing longer code or programs, because it may lead to confusion if someone is reading the code. However, partial matching is very useful when calling functions interactively that have very long argument names.</p>

<p class="calibre2">In addition to not specifying a default value, you can also set an argument value to <code class="calibre21">NULL</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>a<code class="calibre21">,</code> b <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> <code class="kt">c</code> <code class="o">=</code> <code class="o">2</code><code class="calibre21">,</code> d <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">)</code> <code class="calibre21">{</code>

<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">You can check to see whether an R object is <code class="calibre21">NULL</code> with the <code class="calibre21">is.null()</code> function. It is sometimes useful to allow an argument to take the <code class="calibre21">NULL</code> value, which might indicate that the function should take some specific action.</p>

<h3 id="calibre_link-102" class="calibre19">
<span class="section-number">15.4 </span>Lazy Evaluation</h3>

<p class="calibre2">Arguments to functions are evaluated <em class="calibre17">lazily</em>, so they are evaluated only as needed in the body of the function.</p>

<p class="calibre2">In this example, the function <code class="calibre21">f()</code> has two arguments: <code class="calibre21">a</code> and <code class="calibre21">b</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>a<code class="calibre21">,</code> b<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         a<code class="o">^</code><code class="o">2</code>
<code class="o">+</code> <code class="calibre21">}</code> 
<code class="o">&gt;</code> f<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">This function never actually uses the argument <code class="calibre21">b</code>, so calling <code class="calibre21">f(2)</code> will not produce an error because the 2 gets positionally matched to <code class="calibre21">a</code>. This behavior can be good or bad. Itâs common to write a function that doesnât use an argument and not notice it simply because R never throws an error.</p>

<p class="calibre2">This example also shows lazy evaluation at work, but does eventually result in an error.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>a<code class="calibre21">,</code> b<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>a<code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">print</code><code class="calibre21">(</code>b<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> f<code class="calibre21">(</code><code class="o">45</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">45</code>
Error <code class="kc">in</code> <code class="kp">print</code><code class="calibre21">(</code>b<code class="calibre21">)</code><code class="o">:</code> argument <code class="s">"b"</code> is <code class="kp">missing</code><code class="calibre21">,</code> with no default
</pre></div>

</figure>

<p class="calibre2">Notice that â45â got printed first before the error was triggered. This is because <code class="calibre21">b</code> did not have to be evaluated until after <code class="calibre21">print(a)</code>. Once the function tried to evaluate <code class="calibre21">print(b)</code> the function had to throw an error.</p>

<h3 id="calibre_link-103" class="calibre19">
<span class="section-number">15.5 </span>The <code class="calibre11">...</code> Argument</h3>

<p class="calibre2">There is a special argument in R known as the <code class="calibre21">...</code> argument, which indicate a variable number of arguments that are usually passed on to other functions. The <code class="calibre21">...</code> argument is often used when extending another function and you donât want to copy the entire argument list of the original function</p>

<p class="calibre2">For example, a custom plotting function may want to make use of the default <code class="calibre21">plot()</code> function along with its entire argument list. The function below changes the default for the <code class="calibre21">type</code> argument to the value <code class="calibre21">type = "l"</code> (the original default was <code class="calibre21">type = "p"</code>).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>myplot <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">,</code> type <code class="o">=</code> <code class="s">"l"</code><code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code> <code class="calibre21">{</code>
        plot<code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">,</code> type <code class="o">=</code> type<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code>         <code class="c">## Pass '...' to 'plot' function</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Generic functions use <code class="calibre21">...</code> so that extra arguments can be passed to methods.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">mean</code>
<code class="kc">function</code> <code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code> 
<code class="kp">UseMethod</code><code class="calibre21">(</code><code class="s">"mean"</code><code class="calibre21">)</code>
<code class="o">&lt;</code>bytecode<code class="o">:</code> <code class="o">0x7fa738cefa40</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="kp">environment</code><code class="o">:</code> namespace<code class="o">:</code>base<code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">...</code> argument is necessary when the number of arguments passed to the function cannot be known in advance. This is clear in functions like <code class="calibre21">paste()</code> and <code class="calibre21">cat()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">args</code><code class="calibre21">(</code><code class="kp">paste</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code><code class="kc">...</code><code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">" "</code><code class="calibre21">,</code> collapse <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> recycle0 <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code> 
<code class="kc">NULL</code>
<code class="o">&gt;</code> <code class="kp">args</code><code class="calibre21">(</code><code class="kp">cat</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code><code class="kc">...</code><code class="calibre21">,</code> file <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">" "</code><code class="calibre21">,</code> fill <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> labels <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> 
    append <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code> 
<code class="kc">NULL</code>
</pre></div>

</figure>

<p class="calibre2">Because both <code class="calibre21">paste()</code> and <code class="calibre21">cat()</code> print out text to the console by combining multiple character vectors together, it is impossible for those functions to know in advance how many character vectors will be passed to the function by the user. So the first argument to either function is <code class="calibre21">...</code>.</p>

<h3 id="calibre_link-104" class="calibre19">
<span class="section-number">15.6 </span>Arguments Coming After the <code class="calibre11">...</code> Argument</h3>

<p class="calibre2">One catch with <code class="calibre21">...</code> is that any arguments that appear <em class="calibre17">after</em> <code class="calibre21">...</code> on the argument list must be named explicitly and cannot be partially matched or matched positionally.</p>

<p class="calibre2">Take a look at the arguments to the <code class="calibre21">paste()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">args</code><code class="calibre21">(</code><code class="kp">paste</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code><code class="kc">...</code><code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">" "</code><code class="calibre21">,</code> collapse <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> recycle0 <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code> 
<code class="kc">NULL</code>
</pre></div>

</figure>

<p class="calibre2">With the <code class="calibre21">paste()</code> function, the arguments <code class="calibre21">sep</code> and <code class="calibre21">collapse</code> must be named explicitly and in full if the default values are not going to be used.</p>

<p class="calibre2">Here I specify that I want âaâ and âbâ to be pasted together and separated by a colon.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">paste</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">":"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a:b"</code>
</pre></div>

</figure>

<p class="calibre2">If I donât specify the <code class="calibre21">sep</code> argument in full and attempt to rely on partial matching, I donât get the expected result.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">paste</code><code class="calibre21">(</code><code class="s">"a"</code><code class="calibre21">,</code> <code class="s">"b"</code><code class="calibre21">,</code> se <code class="o">=</code> <code class="s">":"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"a b :"</code>
</pre></div>

</figure>

<h3 id="calibre_link-105" class="calibre19">
<span class="section-number">15.7 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">Functions can be defined using the <code class="calibre21">function()</code> directive and are assigned to R objects just like any other R object</li>
  <li class="calibre14">Functions have can be defined with named arguments; these function arguments can have default values</li>
  <li class="calibre14">Functions arguments can be specified by name or by position in the argument list</li>
  <li class="calibre14">Functions always return the last expression evaluated in the function body</li>
  <li class="calibre14">A variable number of arguments can be specified using the special <code class="calibre21">...</code> argument in a function definition.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-178">
<div class="calibre5">
<h2 id="calibre_link-106" class="calibre15">
<span class="section-number">16. </span>Scoping Rules of R</h2>

<h3 id="calibre_link-107" class="calibre19">
<span class="section-number">16.1 </span>A Diversion on Binding Values to Symbol</h3>

<p class="calibre2">
  <a href="https://youtu.be/ujdm01Vsrmo">Watch a video of this section</a>
</p>

<p class="calibre2">How does R know which value to assign to which symbol? When I type</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> lm <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code> x <code class="o">*</code> x <code class="calibre21">}</code>
<code class="o">&gt;</code> lm
<code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code> x <code class="o">*</code> x <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">how does R know what value to assign to the symbol <code class="calibre21">lm</code>? Why doesnât it give it the value of <code class="calibre21">lm</code> that is in the <code class="calibre21">stats</code> package?</p>

<p class="calibre2">When R tries to bind a value to a symbol, it searches through a series of <code class="calibre21">environments</code> to find the appropriate value. When you are working on the command line and need to retrieve the value of an R object, the order in which things occur is roughly</p>

<ol class="calibre13">
  <li class="calibre14">Search the global environment (i.e. your workspace) for a symbol name matching the one requested.</li>
  <li class="calibre14">Search the namespaces of each of the packages on the search list</li>
</ol>

<p class="calibre2">The search list can be found by using the <code class="calibre21">search()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">search</code><code class="calibre21">()</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">".GlobalEnv"</code>        <code class="s">"package:stats"</code>     <code class="s">"package:graphics"</code> 
<code class="calibre21">[</code><code class="o">4</code><code class="calibre21">]</code> <code class="s">"package:grDevices"</code> <code class="s">"package:utils"</code>     <code class="s">"package:datasets"</code> 
<code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="s">"package:methods"</code>   <code class="s">"Autoloads"</code>         <code class="s">"package:base"</code>     
</pre></div>

</figure>

<p class="calibre2">The <em class="calibre17">global environment</em> or the userâs workspace is always the first element of the search list and the <code class="calibre21">base</code> package is always the last. For better or for worse, the order of the packages on the search list matters, particularly if there are multiple objects with the same name in different packages. </p>

<p class="calibre2">Users can configure which packages get loaded on startup so if you are writing a function (or a package), you cannot assume that there will be a set list of packages available in a given order. When a user loads a package with <code class="calibre21">library()</code> the namespace of that package gets put in position 2 of the search list (by default) and everything else gets shifted down the list.</p>

<p class="calibre2">Note that R has separate namespaces for functions and non-functions so itâs possible to have an object named <code class="calibre21">c</code> and a function named <code class="calibre21">c()</code>.</p>

<h3 id="calibre_link-108" class="calibre19">
<span class="section-number">16.2 </span>Scoping Rules</h3>

<p class="calibre2">The scoping rules for R are the main feature that make it different from the original S language (in case you care about that). This may seem like an esoteric aspect of R, but itâs one of its more interesting and useful features.</p>

<p class="calibre2">The scoping rules of a language determine how a value is associated with a <em class="calibre17">free variable</em> in a function. R uses <a href="http://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scope_vs._dynamic_scope"><em class="calibre17">lexical scoping</em></a> or <em class="calibre17">static scoping</em>. An alternative to lexical scoping is <em class="calibre17">dynamic scoping</em> which is implemented by some languages. Lexical scoping turns out to be particularly useful for simplifying statistical computations</p>

<p class="calibre2">Related to the scoping rules is how R uses the <em class="calibre17">search list</em> to bind a value to a
symbol</p>

<p class="calibre2">Consider the following function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         x<code class="o">^</code><code class="o">2</code> <code class="o">+</code> y <code class="o">/</code> z
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">This function has 2 formal arguments <code class="calibre21">x</code> and <code class="calibre21">y</code>. In the body of the function there is another symbol <code class="calibre21">z</code>. In this case <code class="calibre21">z</code> is called a <em class="calibre17">free variable</em>.</p>

<p class="calibre2">The scoping rules of a language determine how values are assigned to free variables. Free variables are not formal arguments and are not local variables (assigned insided the function body).</p>

<p class="calibre2">Lexical scoping in R means that</p>

<blockquote class="calibre18">
  <p class="calibre2"><em class="calibre17">the values of free variables are searched for in the environment in which the function was defined</em>.</p>
</blockquote>

<p class="calibre2">Okay then, what is an environment?</p>

<p class="calibre2">An <em class="calibre17">environment</em> is a collection of (symbol, value) pairs, i.e. <code class="calibre21">x</code> is a symbol and <code class="calibre21">3.14</code> might be its value. Every environment has a parent environment and it is possible for an environment to have multiple âchildrenâ. The only environment without a parent is the <em class="calibre17">empty environment</em>.</p>

<p class="calibre2">A function, together with an environment, makes up what is called a <em class="calibre17">closure</em> or <em class="calibre17">function closure</em>. Most of the time we donât need to think too much about a function and its associated environment (making up the closure), but occasionally, this setup can be very useful. The function closure model can be used to create functions that âcarry aroundâ data with them.</p>

<p class="calibre2">How do we associate a value to a free variable? There is a search process that occurs that goes as follows:</p>

<ul class="calibre20">
  <li class="calibre14">If the value of a symbol is not found in the environment in which a function was defined, then the search is continued in the <em class="calibre17">parent environment</em>.</li>
  <li class="calibre14">The search continues down the sequence of parent environments until we hit the <em class="calibre17">top-level environment</em>; this usually the global environment (workspace) or the namespace of a package.</li>
  <li class="calibre14">After the top-level environment, the search continues down the search list until we hit the <em class="calibre17">empty environment</em>.</li>
</ul>

<p class="calibre2">If a value for a given symbol cannot be found once the empty environment is arrived at, then an error is thrown.</p>

<p class="calibre2">One implication of this search process is that it can be affected by the number of packages you have attached to the search list. The more packages you have attached, the more symbols R has to sort through in order to assign a value. That said, youâd have to have a pretty large number of packages attached in order to notice a real difference in performance.</p>

<h3 id="calibre_link-109" class="calibre19">
<span class="section-number">16.3 </span>Lexical Scoping: Why Does It Matter?</h3>

<p class="calibre2">
  <a href="https://youtu.be/yYzPhtF6--A">Watch a video of this section</a>
</p>

<p class="calibre2">Typically, a function is defined in the global environment, so that the values of free variables are just found in the userâs workspace. This behavior is logical for most people and is usually the âright thingâ to do. However, in R you can have functions defined <em class="calibre17">inside other functions</em> (languages like C donât let you do this). Now things get interesting&mdash;in this case the environment in which a function is defined is the body of another function!</p>

<p class="calibre2">Here is an example of a function that returns another function as its return value. Remember, in R functions are treated like any other object and so this is perfectly valid.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> make.power <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>n<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         pow <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>                 x<code class="o">^</code>n 
<code class="o">+</code>         <code class="calibre21">}</code>
<code class="o">+</code>         pow 
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">make.power()</code> function is a kind of âconstructor functionâ that can be used to construct other functions.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> cube <code class="o">&lt;-</code> make.power<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
<code class="o">&gt;</code> square <code class="o">&lt;-</code> make.power<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> cube<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">27</code>
<code class="o">&gt;</code> square<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">9</code>
</pre></div>

</figure>

<p class="calibre2">Letâs take a look at the <code class="calibre21">cube()</code> functionâs code.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> cube
<code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
                x<code class="o">^</code>n 
        <code class="calibre21">}</code>
<code class="o">&lt;</code><code class="kp">environment</code><code class="o">:</code> <code class="o">0x7f8f9cac6030</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre2">Notice that <code class="calibre21">cube()</code> has a free variable <code class="calibre21">n</code>. What is the value of <code class="calibre21">n</code> here? Well, its value is taken from the environment where the function was defined. When I defined the <code class="calibre21">cube()</code> function it was when I called <code class="calibre21">make.power(3)</code>, so the value of <code class="calibre21">n</code> at that time was 3.</p>

<p class="calibre2">We can explore the environment of a function to see what objects are there and their values.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">ls</code><code class="calibre21">(</code><code class="kp">environment</code><code class="calibre21">(</code>cube<code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"n"</code>   <code class="s">"pow"</code>
<code class="o">&gt;</code> <code class="kp">get</code><code class="calibre21">(</code><code class="s">"n"</code><code class="calibre21">,</code> <code class="kp">environment</code><code class="calibre21">(</code>cube<code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>
</pre></div>

</figure>

<p class="calibre2">We can also take a look at the <code class="calibre21">square()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">ls</code><code class="calibre21">(</code><code class="kp">environment</code><code class="calibre21">(</code>square<code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"n"</code>   <code class="s">"pow"</code>
<code class="o">&gt;</code> <code class="kp">get</code><code class="calibre21">(</code><code class="s">"n"</code><code class="calibre21">,</code> <code class="kp">environment</code><code class="calibre21">(</code>square<code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code>
</pre></div>

</figure>

<h3 id="calibre_link-110" class="calibre19">
<span class="section-number">16.4 </span>Lexical vs. Dynamic Scoping</h3>

<p class="calibre2">We can use the following example to demonstrate the difference between lexical and dynamic scoping rules.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">10</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         y <code class="o">&lt;-</code> <code class="o">2</code>
<code class="o">+</code>         y<code class="o">^</code><code class="o">2</code> <code class="o">+</code> g<code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code> 
<code class="o">+</code>         x<code class="o">*</code>y
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">What is the value of the following expression?</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>f<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">With lexical scoping the value of <code class="calibre21">y</code> in the function <code class="calibre21">g</code> is looked up in the environment in which the function was defined, in this case the global environment, so the value of <code class="calibre21">y</code> is 10. With dynamic scoping, the value of <code class="calibre21">y</code> is looked up in the environment from which the function was <em class="calibre17">called</em> (sometimes referred to as the <em class="calibre17">calling environment</em>). In R the calling environment is known as the <em class="calibre17">parent frame</em>. In this case, the value of <code class="calibre21">y</code> would be 2.</p>

<p class="calibre2">When a function is <em class="calibre17">defined</em> in the global environment and is subsequently <em class="calibre17">called</em> from the global environment, then the defining environment and the calling environment are the same. This can sometimes give the appearance of dynamic scoping.</p>

<p class="calibre2">Consider this example.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code> 
<code class="o">+</code>         a <code class="o">&lt;-</code> <code class="o">3</code>
<code class="o">+</code>         x<code class="o">+</code>a<code class="o">+</code>y   
<code class="o">+</code>         <code class="c">## 'y' is a free variable</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> g<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>
Error <code class="kc">in</code> g<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code><code class="o">:</code> object <code class="s">'y'</code> not found
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">3</code>
<code class="o">&gt;</code> g<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">8</code>
</pre></div>

</figure>

<p class="calibre2">Here, <code class="calibre21">y</code> is defined in the global environment, which also happens to be where the function <code class="calibre21">g()</code> is defined.</p>

<p class="calibre2">There are numerous other languages that support lexical scoping, including</p>

<ul class="calibre20">
  <li class="calibre14">Scheme</li>
  <li class="calibre14">Perl</li>
  <li class="calibre14">Python</li>
  <li class="calibre14">Common Lisp (all languages converge to Lisp, right?)</li>
</ul>

<p class="calibre2">Lexical scoping in R has consequences beyond how free variables are looked up. In particular, itâs the reason that all objects must be stored in memory in R. This is because all functions must carry a pointer to their respective defining environments, which could be <em class="calibre17">anywhere</em>.
In the S language (Râs close cousin), free variables are always looked up in the global workspace, so everything can be stored on the disk because the âdefining environmentâ of all functions is the same.</p>

<h3 id="calibre_link-111" class="calibre19">
<span class="section-number">16.5 </span>Application: Optimization</h3>

<p class="calibre2">
  <a href="https://youtu.be/GCNZrffYLFI">Watch a video of this section</a>
</p>

<p class="calibre2"><strong class="calibre16">NOTE</strong>: This section requires some knowledge of statistical inference and modeling. If you do not have such knowledge, feel free to skip this section.</p>

<p class="calibre2">Why is any of this information about lexical scoping useful?</p>

<p class="calibre2">Optimization routines in R like <code class="calibre21">optim()</code>, <code class="calibre21">nlm()</code>, and <code class="calibre21">optimize()</code> require you to pass a function whose argument is a vector of parameters (e.g. a log-likelihood, or a cost function). However, an objective function that needs to be minimized might depend on a host of other things besides its parameters (like data). When writing software which does optimization, it may also be desirable to allow the user to hold certain parameters fixed. The scoping rules of R allow you to abstract away much of the complexity involved in these kinds of problems.</p>

<p class="calibre2">Here is an example of a âconstructorâ function that creates a negative log-likelihood function that can be minimized to find maximum likelihood estimates in a statistical model.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> make.NegLogLik <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>data<code class="calibre21">,</code> fixed <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">FALSE</code><code class="calibre21">,</code> <code class="kc">FALSE</code><code class="calibre21">))</code> <code class="calibre21">{</code>
<code class="o">+</code>         params <code class="o">&lt;-</code> fixed
<code class="o">+</code>         <code class="kc">function</code><code class="calibre21">(</code>p<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>                 params<code class="calibre21">[</code><code class="o">!</code>fixed<code class="calibre21">]</code> <code class="o">&lt;-</code> p
<code class="o">+</code>                 mu <code class="o">&lt;-</code> params<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>
<code class="o">+</code>                 sigma <code class="o">&lt;-</code> params<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code>
<code class="o">+</code>                 
<code class="o">+</code>                 <code class="c">## Calculate the Normal density</code>
<code class="o">+</code>                 a <code class="o">&lt;-</code> <code class="o">-0.5</code><code class="o">*</code><code class="kp">length</code><code class="calibre21">(</code>data<code class="calibre21">)</code><code class="o">*</code><code class="kp">log</code><code class="calibre21">(</code><code class="o">2</code><code class="o">*</code><code class="kc">pi</code><code class="o">*</code>sigma<code class="o">^</code><code class="o">2</code><code class="calibre21">)</code>
<code class="o">+</code>                 b <code class="o">&lt;-</code> <code class="o">-0.5</code><code class="o">*</code><code class="kp">sum</code><code class="calibre21">((</code>data<code class="o">-</code>mu<code class="calibre21">)</code><code class="o">^</code><code class="o">2</code><code class="calibre21">)</code> <code class="o">/</code> <code class="calibre21">(</code>sigma<code class="o">^</code><code class="o">2</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="o">-</code><code class="calibre21">(</code>a <code class="o">+</code> b<code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">}</code> 
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2"><strong class="calibre16">Note</strong>: Optimization functions in R <em class="calibre17">minimize</em> functions, so you need to use the negative log-likelihood.</p>

<p class="calibre2">Now we can generate some data and then construct our negative log-likelihood.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> normals <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> nLL <code class="o">&lt;-</code> make.NegLogLik<code class="calibre21">(</code>normals<code class="calibre21">)</code>
<code class="o">&gt;</code> nLL
<code class="kc">function</code><code class="calibre21">(</code>p<code class="calibre21">)</code> <code class="calibre21">{</code>
                params<code class="calibre21">[</code><code class="o">!</code>fixed<code class="calibre21">]</code> <code class="o">&lt;-</code> p
                mu <code class="o">&lt;-</code> params<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>
                sigma <code class="o">&lt;-</code> params<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code>
                
                <code class="c">## Calculate the Normal density</code>
                a <code class="o">&lt;-</code> <code class="o">-0.5</code><code class="o">*</code><code class="kp">length</code><code class="calibre21">(</code>data<code class="calibre21">)</code><code class="o">*</code><code class="kp">log</code><code class="calibre21">(</code><code class="o">2</code><code class="o">*</code><code class="kc">pi</code><code class="o">*</code>sigma<code class="o">^</code><code class="o">2</code><code class="calibre21">)</code>
                b <code class="o">&lt;-</code> <code class="o">-0.5</code><code class="o">*</code><code class="kp">sum</code><code class="calibre21">((</code>data<code class="o">-</code>mu<code class="calibre21">)</code><code class="o">^</code><code class="o">2</code><code class="calibre21">)</code> <code class="o">/</code> <code class="calibre21">(</code>sigma<code class="o">^</code><code class="o">2</code><code class="calibre21">)</code>
                <code class="o">-</code><code class="calibre21">(</code>a <code class="o">+</code> b<code class="calibre21">)</code>
        <code class="calibre21">}</code>
<code class="o">&lt;</code>bytecode<code class="o">:</code> <code class="o">0x7f8fab50b610</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="kp">environment</code><code class="o">:</code> <code class="o">0x7f8f8bbc3a38</code><code class="o">&gt;</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## What's in the function environment?</code>
<code class="o">&gt;</code> <code class="kp">ls</code><code class="calibre21">(</code><code class="kp">environment</code><code class="calibre21">(</code>nLL<code class="calibre21">))</code>   
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"data"</code>   <code class="s">"fixed"</code>  <code class="s">"params"</code>
</pre></div>

</figure>

<p class="calibre2">Now that we have our <code class="calibre21">nLL()</code> function, we can try to minimize it with <code class="calibre21">optim()</code> to estimate the parameters.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> optim<code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code>mu <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sigma <code class="o">=</code> <code class="o">1</code><code class="calibre21">),</code> nLL<code class="calibre21">)</code><code class="o">$</code>par
      mu    sigma 
<code class="o">1.218239</code> <code class="o">1.787343</code> 
</pre></div>

</figure>

<p class="calibre2">You can see that the algorithm converged and obtained an estimate of <code class="calibre21">mu</code> and <code class="calibre21">sigma</code>.</p>

<p class="calibre2">We can also try to estimate one parameter while holding another parameter fixed. Here we fix <code class="calibre21">sigma</code> to be equal to 2. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> nLL <code class="o">&lt;-</code> make.NegLogLik<code class="calibre21">(</code>normals<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">FALSE</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code>
<code class="o">&gt;</code> optimize<code class="calibre21">(</code>nLL<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">))</code><code class="o">$</code>minimum
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.217775</code>
</pre></div>

</figure>

<p class="calibre2">Because we now have a one-dimensional problem, we can use the simpler <code class="calibre21">optimize()</code> function rather than <code class="calibre21">optim()</code>.</p>

<p class="calibre2">We can also try to estimate <code class="calibre21">sigma</code> while holding <code class="calibre21">mu</code> fixed at 1.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> nLL <code class="o">&lt;-</code> make.NegLogLik<code class="calibre21">(</code>normals<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="kc">FALSE</code><code class="calibre21">))</code>
<code class="o">&gt;</code> optimize<code class="calibre21">(</code>nLL<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1e-6</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">))</code><code class="o">$</code>minimum
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.800596</code>
</pre></div>

</figure>

<h3 id="calibre_link-112" class="calibre19">
<span class="section-number">16.6 </span>Plotting the Likelihood</h3>

<p class="calibre2">Another nice feature that you can take advantage of is plotting the negative log-likelihood to see how peaked or flat it is.</p>

<p class="calibre2">Here is the function when <code class="calibre21">mu</code> is fixed.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Fix 'mu' to be equalt o 1</code>
<code class="o">&gt;</code> nLL <code class="o">&lt;-</code> make.NegLogLik<code class="calibre21">(</code>normals<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="kc">FALSE</code><code class="calibre21">))</code>  
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">seq</code><code class="calibre21">(</code><code class="o">1.7</code><code class="calibre21">,</code> <code class="o">1.9</code><code class="calibre21">,</code> len <code class="o">=</code> <code class="o">100</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Evaluate 'nLL()' at every point in 'x'</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">sapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> nLL<code class="calibre21">)</code>    
<code class="o">&gt;</code> plot<code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">exp</code><code class="calibre21">(</code><code class="o">-</code><code class="calibre21">(</code>y <code class="o">-</code> <code class="kp">min</code><code class="calibre21">(</code>y<code class="calibre21">))),</code> type <code class="o">=</code> <code class="s">"l"</code><code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000026.png" alt="plot of chunk nLLFixMu" class="calibre31" />
    <figcaption class="calibre32">plot of chunk nLLFixMu</figcaption>
  </figure>
</div>


<p class="calibre2">Here is the function when <code class="calibre21">sigma</code> is fixed.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Fix 'sigma' to be equal to 2</code>
<code class="o">&gt;</code> nLL <code class="o">&lt;-</code> make.NegLogLik<code class="calibre21">(</code>normals<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="kc">FALSE</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">seq</code><code class="calibre21">(</code><code class="o">0.5</code><code class="calibre21">,</code> <code class="o">1.5</code><code class="calibre21">,</code> len <code class="o">=</code> <code class="o">100</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Evaluate 'nLL()' at every point in 'x'</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">sapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> nLL<code class="calibre21">)</code>     
<code class="o">&gt;</code> plot<code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">exp</code><code class="calibre21">(</code><code class="o">-</code><code class="calibre21">(</code>y <code class="o">-</code> <code class="kp">min</code><code class="calibre21">(</code>y<code class="calibre21">))),</code> type <code class="o">=</code> <code class="s">"l"</code><code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000012.png" alt="plot of chunk nLLFixSigma" class="calibre31" />
    <figcaption class="calibre32">plot of chunk nLLFixSigma</figcaption>
  </figure>
</div>


<h3 id="calibre_link-113" class="calibre19">
<span class="section-number">16.7 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">Objective functions can be âbuiltâ which contain all of the necessary data for evaluating the function</li>
  <li class="calibre14">No need to carry around long argument lists &mdash; useful for interactive and exploratory work.</li>
  <li class="calibre14">Code can be simplified and cleaned up</li>
  <li class="calibre14">Reference: Robert Gentleman and Ross Ihaka (2000). âLexical Scope and Statistical Computing,â <em class="calibre17">JCGS</em>, 9, 491&ndash;508.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-172">
<div class="calibre5">
<h2 id="calibre_link-114" class="calibre15">
<span class="section-number">17. </span>Coding Standards for R</h2>

<p class="calibre2">
  <a href="http://youtu.be/MSPKE1y3cyQ">Watch a video of this chapter</a>
</p>

<p class="calibre2">Coding standards are by no means universal and are often the subject of irrational flame wars on various language- or project-specific mailing lists. Nevertheless, I will just give you the standards that I use and the rationale behind them.</p>

<p class="calibre2"><strong class="calibre16">Always use text files / text editor</strong>. I think we can all agree on this one. Using text files and a text editor is fundamental to coding. If youâre writing your code in an editor like Microsoft Word, you need to stop. Interactive development environments like RStudio have nice text editors built in, but there are many others out there.</p>

<p class="calibre2"><strong class="calibre16">Indent your code</strong>. Indenting is very important for the readability of your code. Some programming languages actually require it as part of their syntax, but R does not. Nevertheless, indenting is very important. How much you should indent is up for debate, but I think each indent should be a minimum of 4 spaces, and ideally <strong class="calibre16">it should be 8 spaces</strong>.</p>

<p class="calibre2"><strong class="calibre16">Limit the width of your code</strong>. I like to limit the width of my text editor so that the code I write doesnât fly off into the wilderness on the right hand side. This limitation, along with the 8 space indentation, forces you to write code that is clean, readable, and naturally broken down into modular units. In particular, this combination limits your ability to write very long functions with many different levels of nesting.</p>

<p class="calibre2"><strong class="calibre16">Limit the length of individual functions</strong>. If you are writing functions, itâs usually a good idea to not let your functions run for pages and pages. Typically, purpose of a function is to execute one activity or idea. If your function is doing lots of things, it probably needs to be broken into multiple functions. My rule of thumb is that a function should not take up more than one page of your editor (of course, this depends on the size of your monitor).</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-8">
<div class="calibre5">
<h2 id="calibre_link-3" class="calibre15">
<span class="section-number">18. </span>Loop Functions</h2>

<h3 id="calibre_link-115" class="calibre19">
<span class="section-number">18.1 </span>Looping on the Command Line</h3>

<p class="calibre2">Writing <code class="calibre21">for</code> and <code class="calibre21">while</code> loops is useful when programming but not
particularly easy when working interactively on the command
line. Multi-line expressions with curly braces are just not that easy to sort through when working on the command line. R has some functions which implement looping in a compact form to make your life
easier.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">lapply()</code>: Loop over a list and evaluate a function on each element </li>
  <li class="calibre14">
<code class="calibre21">sapply()</code>: Same as <code class="calibre21">lapply</code> but try to simplify the result</li>
  <li class="calibre14">
<code class="calibre21">apply()</code>: Apply a function over the margins of an array</li>
  <li class="calibre14">
<code class="calibre21">tapply()</code>: Apply a function over subsets of a vector</li>
  <li class="calibre14">
<code class="calibre21">mapply()</code>: Multivariate version of <code class="calibre21">lapply</code>
</li>
</ul>

<p class="calibre2">An auxiliary function <code class="calibre21">split</code> is also useful, particularly in conjunction with <code class="calibre21">lapply</code>.</p>

<h3 id="calibre_link-116" class="calibre19">
<span class="section-number">18.2 </span><code class="calibre11">lapply()</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/E1_NlFb0E4g">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">lapply()</code> function does the following simple series of operations:</p>

<ol class="calibre13">
  <li class="calibre14">it loops over a list, iterating over each element in that list</li>
  <li class="calibre14">it applies a <em class="calibre17">function</em> to each element of the list (a function that you specify)</li>
  <li class="calibre14">and returns a list (the <code class="calibre21">l</code> is for âlistâ). </li>
</ol>

<p class="calibre2">This function takes three arguments: (1) a list <code class="calibre21">X</code>; (2) a function (or the name of a function) <code class="calibre21">FUN</code>; (3) other arguments via its <code class="calibre21">...</code> argument. If <code class="calibre21">X</code> is not a list, it will be coerced to a list using <code class="calibre21">as.list()</code>.</p>

<p class="calibre2">The body of the <code class="calibre21">lapply()</code> function can be seen here.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">lapply</code>
<code class="kc">function</code> <code class="calibre21">(</code>X<code class="calibre21">,</code> FUN<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code> 
<code class="calibre21">{</code>
    FUN <code class="o">&lt;-</code> <code class="kp">match.fun</code><code class="calibre21">(</code>FUN<code class="calibre21">)</code>
    <code class="kc">if</code> <code class="calibre21">(</code><code class="o">!</code><code class="kp">is.vector</code><code class="calibre21">(</code>X<code class="calibre21">)</code> <code class="o">||</code> <code class="kp">is.object</code><code class="calibre21">(</code>X<code class="calibre21">))</code> 
        X <code class="o">&lt;-</code> <code class="kp">as.list</code><code class="calibre21">(</code>X<code class="calibre21">)</code>
    <code class="o">.</code>Internal<code class="calibre21">(</code><code class="kp">lapply</code><code class="calibre21">(</code>X<code class="calibre21">,</code> FUN<code class="calibre21">))</code>
<code class="calibre21">}</code>
<code class="o">&lt;</code>bytecode<code class="o">:</code> <code class="o">0x7fc72a0bd5c0</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="kp">environment</code><code class="o">:</code> namespace<code class="o">:</code>base<code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre2">Note that the actual looping is done internally in C code for efficiency reasons. </p>

<p class="calibre2">Itâs important to remember that <code class="calibre21">lapply()</code> always returns a list, regardless of the class of the input.</p>

<p class="calibre2">Hereâs an example of applying the <code class="calibre21">mean()</code> function to all elements of a list. If the original list has names, the the names will be preserved in the output.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> b <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code>

<code class="o">$</code>b
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.1322028</code>
</pre></div>

</figure>

<p class="calibre2">Notice that here we are passing the <code class="calibre21">mean()</code> function as an argument to the <code class="calibre21">lapply()</code> function. Functions in R can be used this way and can be passed back and forth as arguments just like any other object. When you pass a function to another function, you do not need to include the open and closed parentheses <code class="calibre21">()</code> like you do when you are <em class="calibre17">calling</em> a function.</p>

<p class="calibre2">Here is another example of using <code class="calibre21">lapply()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> b <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> <code class="kt">c</code> <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">20</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">),</code> d <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2.5</code>

<code class="o">$</code>b
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.248845</code>

<code class="o">$</code><code class="kt">c</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9935285</code>

<code class="o">$</code>d
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">5.051388</code>
</pre></div>

</figure>

<p class="calibre2">You can use <code class="calibre21">lapply()</code> to evaluate a function multiple times each with a different argument. Below, is an example where I call the <code class="calibre21">runif()</code> function (to generate uniformly distributed random variables) four times, each time generating a different number of random numbers.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> runif<code class="calibre21">)</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.02778712</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.5273108</code> <code class="o">0.8803191</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.37306337</code> <code class="o">0.04795913</code> <code class="o">0.13862825</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.3214921</code> <code class="o">0.1548316</code> <code class="o">0.1322282</code> <code class="o">0.2213059</code>
</pre></div>

</figure>

<p class="calibre2">When you pass a function to <code class="calibre21">lapply()</code>, <code class="calibre21">lapply()</code> takes elements of the list and passes them as the <em class="calibre17">first argument</em> of the function you are applying. In the above example, the first argument of <code class="calibre21">runif()</code> is <code class="calibre21">n</code>, and so the elements of the sequence <code class="calibre21">1:4</code> all got passed to the <code class="calibre21">n</code> argument of <code class="calibre21">runif()</code>.</p>

<p class="calibre2">Functions that you pass to <code class="calibre21">lapply()</code> may have other arguments. For example, the <code class="calibre21">runif()</code> function has a <code class="calibre21">min</code> and <code class="calibre21">max</code> argument too. In the example above I used the default values for <code class="calibre21">min</code> and <code class="calibre21">max</code>. How would you be able to specify different values for that in the context of <code class="calibre21">lapply()</code>?</p>

<p class="calibre2">Here is where the <code class="calibre21">...</code> argument to <code class="calibre21">lapply()</code> comes into play. Any arguments that you place in the <code class="calibre21">...</code> argument will get passed down to the function being applied to the elements of the list.</p>

<p class="calibre2">Here, the <code class="calibre21">min = 0</code> and <code class="calibre21">max = 10</code> arguments are passed down to <code class="calibre21">runif()</code> every time it gets called.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> runif<code class="calibre21">,</code> min <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> max <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2.263808</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.314165</code> <code class="o">9.815635</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3.270137</code> <code class="o">5.069395</code> <code class="o">6.814425</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9916910</code> <code class="o">1.1890256</code> <code class="o">0.5043966</code> <code class="o">9.2925392</code>
</pre></div>

</figure>

<p class="calibre2">So now, instead of the random numbers being between 0 and 1 (the default), the are all between 0 and 10.</p>

<p class="calibre2">The <code class="calibre21">lapply()</code> function and its friends make heavy use of <em class="calibre17">anonymous</em> functions. Anonymous functions are like members of <a href="http://en.wikipedia.org/wiki/Fight_Club">Project Mayhem</a>&mdash;they have no names. These are functions are generated âon the flyâ as you are using <code class="calibre21">lapply()</code>. Once the call to <code class="calibre21">lapply()</code> is finished, the function disappears and does not appear in the workspace.</p>

<p class="calibre2">Here I am creating a list that contains two matrices.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> b <code class="o">=</code> <code class="kt">matrix</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">6</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code> 
<code class="o">&gt;</code> x
<code class="o">$</code>a
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">3</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>    <code class="o">2</code>    <code class="o">4</code>

<code class="o">$</code>b
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code>    <code class="o">1</code>    <code class="o">4</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code>    <code class="o">2</code>    <code class="o">5</code>
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">,]</code>    <code class="o">3</code>    <code class="o">6</code>
</pre></div>

</figure>

<p class="calibre2">Suppose I wanted to extract the first column of each matrix in the list. I could write
an anonymous function for extracting the first column of each matrix.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>elt<code class="calibre21">)</code> <code class="calibre21">{</code> elt<code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code> <code class="calibre21">})</code>
<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code>

<code class="o">$</code>b
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code>
</pre></div>

</figure>

<p class="calibre2">Notice that I put the <code class="calibre21">function()</code> definition right in the call to <code class="calibre21">lapply()</code>. This is perfectly legal and acceptable. You can put an arbitrarily complicated function definition inside <code class="calibre21">lapply()</code>, but if itâs going to be more complicated, itâs probably a better idea to define the function separately. </p>

<p class="calibre2">For example, I could have done the following.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>elt<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         elt<code class="calibre21">[,</code> <code class="o">1</code><code class="calibre21">]</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">)</code>
<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code>

<code class="o">$</code>b
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code>
</pre></div>

</figure>

<p class="calibre2">Now the function is no longer anonymous; itâs name is <code class="calibre21">f</code>. Whether you use an anonymous function or you define a function first depends on your context. If you think the function <code class="calibre21">f</code> is something youâre going to need a lot in other parts of your code, you might want to define it separately. But if youâre just going to use it for this call to <code class="calibre21">lapply()</code>, then itâs probably simpler to use an anonymous function.</p>

<h3 id="calibre_link-117" class="calibre19">
<span class="section-number">18.3 </span><code class="calibre11">sapply()</code>
</h3>

<p class="calibre2">The <code class="calibre21">sapply()</code> function behaves similarly to <code class="calibre21">lapply()</code>; the only real difference is in the return value. <code class="calibre21">sapply()</code> will try to simplify the result of <code class="calibre21">lapply()</code> if possible. Essentially, <code class="calibre21">sapply()</code> calls <code class="calibre21">lapply()</code> on its input and then applies the following algorithm:</p>

<ul class="calibre20">
  <li class="calibre14">If the result is a list where every element is length 1, then a vector is returned</li>
  <li class="calibre14">If the result is a list where every element is a vector of the same length (&gt; 1), a matrix is returned.</li>
  <li class="calibre14">If it canât figure things out, a list is returned</li>
</ul>

<p class="calibre2">Hereâs the result of calling <code class="calibre21">lapply()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">list</code><code class="calibre21">(</code>a <code class="o">=</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> b <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> <code class="kt">c</code> <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">20</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">),</code> d <code class="o">=</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
<code class="o">$</code>a
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2.5</code>

<code class="o">$</code>b
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.251483</code>

<code class="o">$</code><code class="kt">c</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.481246</code>

<code class="o">$</code>d
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4.968715</code>
</pre></div>

</figure>

<p class="calibre2">Notice that <code class="calibre21">lapply()</code> returns a list (as usual), but that each element of the list has length 1.</p>

<p class="calibre2">Hereâs the result of calling <code class="calibre21">sapply()</code> on the same list.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">sapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code> 
        a         b         <code class="kt">c</code>         d 
 <code class="o">2.500000</code> <code class="o">-0.251483</code>  <code class="o">1.481246</code>  <code class="o">4.968715</code> 
</pre></div>

</figure>

<p class="calibre2">Because the result of <code class="calibre21">lapply()</code> was a list where each element had length 1, <code class="calibre21">sapply()</code> collapsed the output into a numeric vector, which is often more useful than a list.</p>

<h3 id="calibre_link-118" class="calibre19">
<span class="section-number">18.4 </span><code class="calibre11">split()</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/TjwE5b0fOcs">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">split()</code> function takes a vector or other objects and splits it into groups determined by a factor or list of factors.</p>

<p class="calibre2">The arguments to <code class="calibre21">split()</code> are</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">,</code> drop <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code>  
</pre></div>

</figure>

<p class="calibre2">where</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">x</code> is a vector (or list) or data frame</li>
  <li class="calibre14">
<code class="calibre21">f</code> is a factor (or coerced to one) or a list of factors</li>
  <li class="calibre14">
<code class="calibre21">drop</code> indicates whether empty factors levels should be dropped</li>
</ul>

<p class="calibre2">The combination of <code class="calibre21">split()</code> and a function like <code class="calibre21">lapply()</code> or <code class="calibre21">sapply()</code> is a common paradigm in R. The basic idea is that you can take a data structure, split it into subsets defined by another variable, and apply a function over those subsets. The results of applying tha function over the subsets are then collated and returned as an object. This sequence of operations is sometimes referred to as âmap-reduceâ in other contexts.</p>

<p class="calibre2">Here we simulate some data and split it according to a factor variable. Note that we use the <code class="calibre21">gl()</code> function to âgenerate levelsâ in a factor variable.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> runif<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">))</code>
<code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kp">gl</code><code class="calibre21">(</code><code class="o">3</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">split</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">)</code>
<code class="o">$</code><code class="s">`1`</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">0.3981302</code> <code class="o">-0.4075286</code>  <code class="o">1.3242586</code> <code class="o">-0.7012317</code> <code class="o">-0.5806143</code> <code class="o">-1.0010722</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="o">-0.6681786</code>  <code class="o">0.9451850</code>  <code class="o">0.4337021</code>  <code class="o">1.0051592</code>

<code class="o">$</code><code class="s">`2`</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.34822440</code> <code class="o">0.94893818</code> <code class="o">0.64667919</code> <code class="o">0.03527777</code> <code class="o">0.59644846</code> <code class="o">0.41531800</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="o">0.07689704</code> <code class="o">0.52804888</code> <code class="o">0.96233331</code> <code class="o">0.70874005</code>

<code class="o">$</code><code class="s">`3`</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">1.13444766</code>  <code class="o">1.76559900</code>  <code class="o">1.95513668</code>  <code class="o">0.94943430</code>  <code class="o">0.69418458</code>  <code class="o">1.89367370</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="o">-0.04729815</code>  <code class="o">2.97133739</code>  <code class="o">0.61636789</code>  <code class="o">2.65414530</code>
</pre></div>

</figure>

<p class="calibre2">A common idiom is <code class="calibre21">split</code> followed by an <code class="calibre21">lapply</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">),</code> <code class="kp">mean</code><code class="calibre21">)</code>
<code class="o">$</code><code class="s">`1`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.07478098</code>

<code class="o">$</code><code class="s">`2`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.5266905</code>

<code class="o">$</code><code class="s">`3`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.458703</code>
</pre></div>

</figure>

<h3 id="calibre_link-119" class="calibre19">
<span class="section-number">18.5 </span>Splitting a Data Frame</h3>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>datasets<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>airquality<code class="calibre21">)</code>
  Ozone Solar.R Wind Temp Month Day
<code class="o">1</code>    <code class="o">41</code>     <code class="o">190</code>  <code class="o">7.4</code>   <code class="o">67</code>     <code class="o">5</code>   <code class="o">1</code>
<code class="o">2</code>    <code class="o">36</code>     <code class="o">118</code>  <code class="o">8.0</code>   <code class="o">72</code>     <code class="o">5</code>   <code class="o">2</code>
<code class="o">3</code>    <code class="o">12</code>     <code class="o">149</code> <code class="o">12.6</code>   <code class="o">74</code>     <code class="o">5</code>   <code class="o">3</code>
<code class="o">4</code>    <code class="o">18</code>     <code class="o">313</code> <code class="o">11.5</code>   <code class="o">62</code>     <code class="o">5</code>   <code class="o">4</code>
<code class="o">5</code>    <code class="kc">NA</code>      <code class="kc">NA</code> <code class="o">14.3</code>   <code class="o">56</code>     <code class="o">5</code>   <code class="o">5</code>
<code class="o">6</code>    <code class="o">28</code>      <code class="kc">NA</code> <code class="o">14.9</code>   <code class="o">66</code>     <code class="o">5</code>   <code class="o">6</code>
</pre></div>

</figure>

<p class="calibre2">We can split the <code class="calibre21">airquality</code> data frame by the <code class="calibre21">Month</code> variable so that we have separate sub-data frames for each month.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> s <code class="o">&lt;-</code> <code class="kp">split</code><code class="calibre21">(</code>airquality<code class="calibre21">,</code> airquality<code class="o">$</code>Month<code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>s<code class="calibre21">)</code>
List of <code class="o">5</code>
 <code class="o">$</code> <code class="o">5</code><code class="o">:</code><code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">31</code> obs. of  <code class="o">6</code> variables<code class="o">:</code>
  <code class="o">..</code><code class="o">$</code> Ozone  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">41</code> <code class="o">36</code> <code class="o">12</code> <code class="o">18</code> <code class="kc">NA</code> <code class="o">28</code> <code class="o">23</code> <code class="o">19</code> <code class="o">8</code> <code class="kc">NA</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Solar.R<code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">190</code> <code class="o">118</code> <code class="o">149</code> <code class="o">313</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="o">299</code> <code class="o">99</code> <code class="o">19</code> <code class="o">194</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Wind   <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">7.4</code> <code class="o">8</code> <code class="o">12.6</code> <code class="o">11.5</code> <code class="o">14.3</code> <code class="o">14.9</code> <code class="o">8.6</code> <code class="o">13.8</code> <code class="o">20.1</code> <code class="o">8.6</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Temp   <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">67</code> <code class="o">72</code> <code class="o">74</code> <code class="o">62</code> <code class="o">56</code> <code class="o">66</code> <code class="o">65</code> <code class="o">59</code> <code class="o">61</code> <code class="o">69</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Month  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="o">5</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Day    <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="kc">...</code>
 <code class="o">$</code> <code class="o">6</code><code class="o">:</code><code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">30</code> obs. of  <code class="o">6</code> variables<code class="o">:</code>
  <code class="o">..</code><code class="o">$</code> Ozone  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="o">29</code> <code class="kc">NA</code> <code class="o">71</code> <code class="o">39</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Solar.R<code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">286</code> <code class="o">287</code> <code class="o">242</code> <code class="o">186</code> <code class="o">220</code> <code class="o">264</code> <code class="o">127</code> <code class="o">273</code> <code class="o">291</code> <code class="o">323</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Wind   <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">8.6</code> <code class="o">9.7</code> <code class="o">16.1</code> <code class="o">9.2</code> <code class="o">8.6</code> <code class="o">14.3</code> <code class="o">9.7</code> <code class="o">6.9</code> <code class="o">13.8</code> <code class="o">11.5</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Temp   <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">78</code> <code class="o">74</code> <code class="o">67</code> <code class="o">84</code> <code class="o">85</code> <code class="o">79</code> <code class="o">82</code> <code class="o">87</code> <code class="o">90</code> <code class="o">87</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Month  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="o">6</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Day    <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="kc">...</code>
 <code class="o">$</code> <code class="o">7</code><code class="o">:</code><code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">31</code> obs. of  <code class="o">6</code> variables<code class="o">:</code>
  <code class="o">..</code><code class="o">$</code> Ozone  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">135</code> <code class="o">49</code> <code class="o">32</code> <code class="kc">NA</code> <code class="o">64</code> <code class="o">40</code> <code class="o">77</code> <code class="o">97</code> <code class="o">97</code> <code class="o">85</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Solar.R<code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">269</code> <code class="o">248</code> <code class="o">236</code> <code class="o">101</code> <code class="o">175</code> <code class="o">314</code> <code class="o">276</code> <code class="o">267</code> <code class="o">272</code> <code class="o">175</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Wind   <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">4.1</code> <code class="o">9.2</code> <code class="o">9.2</code> <code class="o">10.9</code> <code class="o">4.6</code> <code class="o">10.9</code> <code class="o">5.1</code> <code class="o">6.3</code> <code class="o">5.7</code> <code class="o">7.4</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Temp   <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">84</code> <code class="o">85</code> <code class="o">81</code> <code class="o">84</code> <code class="o">83</code> <code class="o">83</code> <code class="o">88</code> <code class="o">92</code> <code class="o">92</code> <code class="o">89</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Month  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="o">7</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Day    <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="kc">...</code>
 <code class="o">$</code> <code class="o">8</code><code class="o">:</code><code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">31</code> obs. of  <code class="o">6</code> variables<code class="o">:</code>
  <code class="o">..</code><code class="o">$</code> Ozone  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">39</code> <code class="o">9</code> <code class="o">16</code> <code class="o">78</code> <code class="o">35</code> <code class="o">66</code> <code class="o">122</code> <code class="o">89</code> <code class="o">110</code> <code class="kc">NA</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Solar.R<code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">83</code> <code class="o">24</code> <code class="o">77</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="kc">NA</code> <code class="o">255</code> <code class="o">229</code> <code class="o">207</code> <code class="o">222</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Wind   <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">6.9</code> <code class="o">13.8</code> <code class="o">7.4</code> <code class="o">6.9</code> <code class="o">7.4</code> <code class="o">4.6</code> <code class="o">4</code> <code class="o">10.3</code> <code class="o">8</code> <code class="o">8.6</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Temp   <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">81</code> <code class="o">81</code> <code class="o">82</code> <code class="o">86</code> <code class="o">85</code> <code class="o">87</code> <code class="o">89</code> <code class="o">90</code> <code class="o">90</code> <code class="o">92</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Month  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="o">8</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Day    <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">31</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="kc">...</code>
 <code class="o">$</code> <code class="o">9</code><code class="o">:</code><code class="s">'data.frame'</code><code class="o">:</code>	<code class="o">30</code> obs. of  <code class="o">6</code> variables<code class="o">:</code>
  <code class="o">..</code><code class="o">$</code> Ozone  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">96</code> <code class="o">78</code> <code class="o">73</code> <code class="o">91</code> <code class="o">47</code> <code class="o">32</code> <code class="o">20</code> <code class="o">23</code> <code class="o">21</code> <code class="o">24</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Solar.R<code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">167</code> <code class="o">197</code> <code class="o">183</code> <code class="o">189</code> <code class="o">95</code> <code class="o">92</code> <code class="o">252</code> <code class="o">220</code> <code class="o">230</code> <code class="o">259</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Wind   <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">6.9</code> <code class="o">5.1</code> <code class="o">2.8</code> <code class="o">4.6</code> <code class="o">7.4</code> <code class="o">15.5</code> <code class="o">10.9</code> <code class="o">10.3</code> <code class="o">10.9</code> <code class="o">9.7</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Temp   <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">91</code> <code class="o">92</code> <code class="o">93</code> <code class="o">93</code> <code class="o">87</code> <code class="o">84</code> <code class="o">80</code> <code class="o">78</code> <code class="o">75</code> <code class="o">73</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Month  <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="o">9</code> <code class="kc">...</code>
  <code class="o">..</code><code class="o">$</code> Day    <code class="o">:</code> int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">30</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Then we can take the column means for <code class="calibre21">Ozone</code>, <code class="calibre21">Solar.R</code>, and <code class="calibre21">Wind</code> for each sub-data frame.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">lapply</code><code class="calibre21">(</code>s<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">colMeans</code><code class="calibre21">(</code>x<code class="calibre21">[,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"Ozone"</code><code class="calibre21">,</code> <code class="s">"Solar.R"</code><code class="calibre21">,</code> <code class="s">"Wind"</code><code class="calibre21">)])</code>
<code class="o">+</code> <code class="calibre21">})</code>
<code class="o">$</code><code class="s">`5`</code>
   Ozone  Solar.R     Wind 
      <code class="kc">NA</code>       <code class="kc">NA</code> <code class="o">11.62258</code> 

<code class="o">$</code><code class="s">`6`</code>
    Ozone   Solar.R      Wind 
       <code class="kc">NA</code> <code class="o">190.16667</code>  <code class="o">10.26667</code> 

<code class="o">$</code><code class="s">`7`</code>
     Ozone    Solar.R       Wind 
        <code class="kc">NA</code> <code class="o">216.483871</code>   <code class="o">8.941935</code> 

<code class="o">$</code><code class="s">`8`</code>
   Ozone  Solar.R     Wind 
      <code class="kc">NA</code>       <code class="kc">NA</code> <code class="o">8.793548</code> 

<code class="o">$</code><code class="s">`9`</code>
   Ozone  Solar.R     Wind 
      <code class="kc">NA</code> <code class="o">167.4333</code>  <code class="o">10.1800</code> 
</pre></div>

</figure>

<p class="calibre2">Using <code class="calibre21">sapply()</code> might be better here for a more readable output.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">sapply</code><code class="calibre21">(</code>s<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">colMeans</code><code class="calibre21">(</code>x<code class="calibre21">[,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"Ozone"</code><code class="calibre21">,</code> <code class="s">"Solar.R"</code><code class="calibre21">,</code> <code class="s">"Wind"</code><code class="calibre21">)])</code>
<code class="o">+</code> <code class="calibre21">})</code>
               <code class="o">5</code>         <code class="o">6</code>          <code class="o">7</code>        <code class="o">8</code>        <code class="o">9</code>
Ozone         <code class="kc">NA</code>        <code class="kc">NA</code>         <code class="kc">NA</code>       <code class="kc">NA</code>       <code class="kc">NA</code>
Solar.R       <code class="kc">NA</code> <code class="o">190.16667</code> <code class="o">216.483871</code>       <code class="kc">NA</code> <code class="o">167.4333</code>
Wind    <code class="o">11.62258</code>  <code class="o">10.26667</code>   <code class="o">8.941935</code> <code class="o">8.793548</code>  <code class="o">10.1800</code>
</pre></div>

</figure>

<p class="calibre2">Unfortunately, there are <code class="calibre21">NA</code>s in the data so we cannot simply take the means of those variables. However, we can tell the <code class="calibre21">colMeans</code> function to remove the <code class="calibre21">NA</code>s before computing the mean.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">sapply</code><code class="calibre21">(</code>s<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">colMeans</code><code class="calibre21">(</code>x<code class="calibre21">[,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"Ozone"</code><code class="calibre21">,</code> <code class="s">"Solar.R"</code><code class="calibre21">,</code> <code class="s">"Wind"</code><code class="calibre21">)],</code> 
<code class="o">+</code>                  na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">})</code>
                <code class="o">5</code>         <code class="o">6</code>          <code class="o">7</code>          <code class="o">8</code>         <code class="o">9</code>
Ozone    <code class="o">23.61538</code>  <code class="o">29.44444</code>  <code class="o">59.115385</code>  <code class="o">59.961538</code>  <code class="o">31.44828</code>
Solar.R <code class="o">181.29630</code> <code class="o">190.16667</code> <code class="o">216.483871</code> <code class="o">171.857143</code> <code class="o">167.43333</code>
Wind     <code class="o">11.62258</code>  <code class="o">10.26667</code>   <code class="o">8.941935</code>   <code class="o">8.793548</code>  <code class="o">10.18000</code>
</pre></div>

</figure>

<p class="calibre2">Occasionally, we may want to split an R object according to levels defined in more than one variable. We can do this by creating an interaction of the variables with the <code class="calibre21">interaction()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> f1 <code class="o">&lt;-</code> <code class="kp">gl</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> f2 <code class="o">&lt;-</code> <code class="kp">gl</code><code class="calibre21">(</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> f1
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code>
Levels<code class="o">:</code> <code class="o">1</code> <code class="o">2</code>
<code class="o">&gt;</code> f2
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">1</code> <code class="o">2</code> <code class="o">2</code> <code class="o">3</code> <code class="o">3</code> <code class="o">4</code> <code class="o">4</code> <code class="o">5</code> <code class="o">5</code>
Levels<code class="o">:</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code> <code class="o">4</code> <code class="o">5</code>
<code class="o">&gt;</code> <code class="c">## Create interaction of two factors</code>
<code class="o">&gt;</code> <code class="kp">interaction</code><code class="calibre21">(</code>f1<code class="calibre21">,</code> f2<code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.1</code> <code class="o">1.1</code> <code class="o">1.2</code> <code class="o">1.2</code> <code class="o">1.3</code> <code class="o">2.3</code> <code class="o">2.4</code> <code class="o">2.4</code> <code class="o">2.5</code> <code class="o">2.5</code>
Levels<code class="o">:</code> <code class="o">1.1</code> <code class="o">2.1</code> <code class="o">1.2</code> <code class="o">2.2</code> <code class="o">1.3</code> <code class="o">2.3</code> <code class="o">1.4</code> <code class="o">2.4</code> <code class="o">1.5</code> <code class="o">2.5</code>
</pre></div>

</figure>

<p class="calibre2">With multiple factors and many levels, creating an interaction can result in many levels that are empty.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kt">list</code><code class="calibre21">(</code>f1<code class="calibre21">,</code> f2<code class="calibre21">)))</code>
List of <code class="o">10</code>
 <code class="o">$</code> <code class="o">1.1</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">1.512</code> <code class="o">0.083</code>
 <code class="o">$</code> <code class="o">2.1</code><code class="o">:</code> num<code class="calibre21">(</code><code class="o">0</code><code class="calibre21">)</code> 
 <code class="o">$</code> <code class="o">1.2</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">0.567</code> <code class="o">-1.025</code>
 <code class="o">$</code> <code class="o">2.2</code><code class="o">:</code> num<code class="calibre21">(</code><code class="o">0</code><code class="calibre21">)</code> 
 <code class="o">$</code> <code class="o">1.3</code><code class="o">:</code> num <code class="o">0.323</code>
 <code class="o">$</code> <code class="o">2.3</code><code class="o">:</code> num <code class="o">1.04</code>
 <code class="o">$</code> <code class="o">1.4</code><code class="o">:</code> num<code class="calibre21">(</code><code class="o">0</code><code class="calibre21">)</code> 
 <code class="o">$</code> <code class="o">2.4</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">0.0991</code> <code class="o">-0.4541</code>
 <code class="o">$</code> <code class="o">1.5</code><code class="o">:</code> num<code class="calibre21">(</code><code class="o">0</code><code class="calibre21">)</code> 
 <code class="o">$</code> <code class="o">2.5</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">-0.6558</code> <code class="o">-0.0359</code>
</pre></div>

</figure>

<p class="calibre2">Notice that there are 4 categories with no data. But we can drop empty levels when we call the <code class="calibre21">split()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="kt">list</code><code class="calibre21">(</code>f1<code class="calibre21">,</code> f2<code class="calibre21">),</code> drop <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">))</code>
List of <code class="o">6</code>
 <code class="o">$</code> <code class="o">1.1</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">1.512</code> <code class="o">0.083</code>
 <code class="o">$</code> <code class="o">1.2</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">0.567</code> <code class="o">-1.025</code>
 <code class="o">$</code> <code class="o">1.3</code><code class="o">:</code> num <code class="o">0.323</code>
 <code class="o">$</code> <code class="o">2.3</code><code class="o">:</code> num <code class="o">1.04</code>
 <code class="o">$</code> <code class="o">2.4</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">0.0991</code> <code class="o">-0.4541</code>
 <code class="o">$</code> <code class="o">2.5</code><code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">]</code> <code class="o">-0.6558</code> <code class="o">-0.0359</code>
</pre></div>

</figure>

<h3 id="calibre_link-120" class="calibre19">
<span class="section-number">18.6 </span>tapply</h3>

<p class="calibre2">
  <a href="https://youtu.be/6YEPWjbk3GA">Watch a video of this section</a>
</p>

<p class="calibre2"><code class="calibre21">tapply()</code> is used to apply a function over subsets of a vector. It can be thought of as a combination of <code class="calibre21">split()</code> and <code class="calibre21">sapply()</code> for vectors only. Iâve been told that the âtâ in <code class="calibre21">tapply()</code> refers to âtableâ, but that is unconfirmed.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">tapply</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>X<code class="calibre21">,</code> INDEX<code class="calibre21">,</code> FUN <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">,</code> default <code class="o">=</code> <code class="kc">NA</code><code class="calibre21">,</code> simplify <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>  
</pre></div>

</figure>

<p class="calibre2">The arguments to <code class="calibre21">tapply()</code> are as follows:</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">X</code> is a vector</li>
  <li class="calibre14">
<code class="calibre21">INDEX</code> is a factor or a list of factors (or else they are coerced to factors) </li>
  <li class="calibre14">
<code class="calibre21">FUN</code> is a function to be applied</li>
  <li class="calibre14">â¦ contains other arguments to be passed <code class="calibre21">FUN</code>
</li>
  <li class="calibre14">
<code class="calibre21">simplify</code>, should we simplify the result?</li>
</ul>

<p class="calibre2">Given a vector of numbers, one simple operation is to take group means.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Simulate some data</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">c</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> runif<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">),</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="c">## Define some groups with a factor variable</code>
<code class="o">&gt;</code> f <code class="o">&lt;-</code> <code class="kp">gl</code><code class="calibre21">(</code><code class="o">3</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code>   
<code class="o">&gt;</code> f
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code> <code class="o">3</code>
Levels<code class="o">:</code> <code class="o">1</code> <code class="o">2</code> <code class="o">3</code>
<code class="o">&gt;</code> <code class="kp">tapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
        <code class="o">1</code>         <code class="o">2</code>         <code class="o">3</code> 
<code class="o">0.1896235</code> <code class="o">0.5336667</code> <code class="o">0.9568236</code> 
</pre></div>

</figure>

<p class="calibre2">We can also take the group means without simplifying the result, which will give us a list. For functions that return a single value, usually, this is not what we want, but it can be done.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">tapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">,</code> simplify <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
<code class="o">$</code><code class="s">`1`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.1896235</code>

<code class="o">$</code><code class="s">`2`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.5336667</code>

<code class="o">$</code><code class="s">`3`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9568236</code>
</pre></div>

</figure>

<p class="calibre2">We can also apply functions that return more than a single value. In this case, <code class="calibre21">tapply()</code> will not simplify the result and will return a list. Hereâs an example of finding the range of each sub-group.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">tapply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> f<code class="calibre21">,</code> <code class="kp">range</code><code class="calibre21">)</code>
<code class="o">$</code><code class="s">`1`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-1.869789</code>  <code class="o">1.497041</code>

<code class="o">$</code><code class="s">`2`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.09515213</code> <code class="o">0.86723879</code>

<code class="o">$</code><code class="s">`3`</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.5690822</code>  <code class="o">2.3644349</code>
</pre></div>

</figure>

<h3 id="calibre_link-121" class="calibre19">
<span class="section-number">18.7 </span><code class="calibre11">apply()</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/F54ixFPq_xQ">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">apply()</code> function is used to a evaluate a function (often an anonymous one) over the margins of an array. It is most often used to apply a function to the rows or columns of a matrix (which is just a 2-dimensional array). However, it can be used with general arrays, for example, to take the average of an array of matrices. Using <code class="calibre21">apply()</code> is not really faster than writing a loop, but it works in one line and is highly compact.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">apply</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>X<code class="calibre21">,</code> MARGIN<code class="calibre21">,</code> FUN<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">)</code>  
</pre></div>

</figure>

<p class="calibre2">The arguments to <code class="calibre21">apply()</code> are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">X</code> is an array</li>
  <li class="calibre14">
<code class="calibre21">MARGIN</code> is an integer vector indicating which margins should be âretainedâ. </li>
  <li class="calibre14">
<code class="calibre21">FUN</code> is a function to be applied</li>
  <li class="calibre14">
<code class="calibre21">...</code> is for other arguments to be passed to <code class="calibre21">FUN</code>
</li>
</ul>

<p class="calibre2">Here I create a 20 by 10 matrix of Normal random numbers. I then compute the mean of each column.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">200</code><code class="calibre21">),</code> <code class="o">20</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>  <code class="c">## Take the mean of each column</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">0.02218266</code> <code class="o">-0.15932850</code>  <code class="o">0.09021391</code>  <code class="o">0.14723035</code> <code class="o">-0.22431309</code> <code class="o">-0.49657847</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code>  <code class="o">0.30095015</code>  <code class="o">0.07703985</code> <code class="o">-0.20818099</code>  <code class="o">0.06809774</code>
</pre></div>

</figure>

<p class="calibre2">I can also compute the sum of each row.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="kp">sum</code><code class="calibre21">)</code>   <code class="c">## Take the mean of each row</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.48483448</code>  <code class="o">5.33222301</code> <code class="o">-3.33862932</code> <code class="o">-1.39998450</code>  <code class="o">2.37859098</code>  <code class="o">0.01082604</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="o">-6.29457190</code> <code class="o">-0.26287700</code>  <code class="o">0.71133578</code> <code class="o">-3.38125293</code> <code class="o">-4.67522818</code>  <code class="o">3.01900232</code>
<code class="calibre21">[</code><code class="o">13</code><code class="calibre21">]</code> <code class="o">-2.39466347</code> <code class="o">-2.16004389</code>  <code class="o">5.33063755</code> <code class="o">-2.92024635</code>  <code class="o">3.52026401</code> <code class="o">-1.84880901</code>
<code class="calibre21">[</code><code class="o">19</code><code class="calibre21">]</code> <code class="o">-4.10213912</code>  <code class="o">5.30667310</code>
</pre></div>

</figure>

<p class="calibre2">Note that in both calls to <code class="calibre21">apply()</code>, the return value was a vector of numbers.</p>

<p class="calibre2">Youâve probably noticed that the second argument is either a 1 or a 2, depending on whether we want row statistics or column statistics. What exactly <em class="calibre17">is</em> the second argument to <code class="calibre21">apply()</code>?</p>

<p class="calibre2">The <code class="calibre21">MARGIN</code> argument essentially indicates to <code class="calibre21">apply()</code> which dimension of the array you want to preserve or retain. So when taking the mean of each column, I specify</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">because I want to collapse the first dimension (the rows) by taking the mean and I want to preserve the number of columns. Similarly, when I want the row sums, I run</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">because I want to collapse the columns (the second dimension) and preserve the number of rows (the first dimension).</p>

<h3 id="calibre_link-122" class="calibre19">
<span class="section-number">18.8 </span>Col/Row Sums and Means</h3>

<p class="calibre2">For the special case of column/row sums and column/row means of matrices, we have some useful shortcuts.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">rowSums</code> = <code class="calibre21">apply(x, 1, sum)</code>
</li>
  <li class="calibre14">
<code class="calibre21">rowMeans</code> = <code class="calibre21">apply(x, 1, mean)</code>
</li>
  <li class="calibre14">
<code class="calibre21">colSums</code> = <code class="calibre21">apply(x, 2, sum)</code>
</li>
  <li class="calibre14">
<code class="calibre21">colMeans</code> = <code class="calibre21">apply(x, 2, mean)</code>
</li>
</ul>

<p class="calibre2">The shortcut functions are heavily optimized and hence are <em class="calibre17">much</em> faster, but you probably wonât notice unless youâre using a large matrix. Another nice aspect of these functions is that they are a bit more descriptive. Itâs arguably more clear to write <code class="calibre21">colMeans(x)</code> in your code than <code class="calibre21">apply(x, 2, mean)</code>.</p>

<h3 id="calibre_link-123" class="calibre19">
<span class="section-number">18.9 </span>Other Ways to Apply</h3>

<p class="calibre2">You can do more than take sums and means with the <code class="calibre21">apply()</code> function. For example, you can compute quantiles of the rows of a matrix using the <code class="calibre21">quantile()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">200</code><code class="calibre21">),</code> <code class="o">20</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="c">## Get row quantiles</code>
<code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>x<code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> quantile<code class="calibre21">,</code> probs <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">0.25</code><code class="calibre21">,</code> <code class="o">0.75</code><code class="calibre21">))</code>    
          <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">4</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">5</code><code class="calibre21">]</code>        <code class="calibre21">[,</code><code class="o">6</code><code class="calibre21">]</code>
<code class="o">25</code><code class="o">% -1.0884151 -0.6693040 0.2908481 -0.4602083 -1.0432010 -1.12773555</code>
<code class="o">75%</code>  <code class="o">0.1843547</code>  <code class="o">0.8210295</code> <code class="o">1.3667301</code>  <code class="o">0.4424153</code>  <code class="o">0.3571219</code>  <code class="o">0.03653687</code>
          <code class="calibre21">[,</code><code class="o">7</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">8</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">9</code><code class="calibre21">]</code>     <code class="calibre21">[,</code><code class="o">10</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">11</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">12</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">13</code><code class="calibre21">]</code>
<code class="o">25</code><code class="o">% -1.4571706 -0.2406991 -0.3226845 -0.329898 -0.8677524 -0.2023664 -0.9796050</code>
<code class="o">75%</code> <code class="o">-0.1705336</code>  <code class="o">0.6504486</code>  <code class="o">1.1460854</code>  <code class="o">1.247092</code>  <code class="o">0.4138139</code>  <code class="o">0.9145331</code>  <code class="o">0.5448777</code>
         <code class="calibre21">[,</code><code class="o">14</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">15</code><code class="calibre21">]</code>        <code class="calibre21">[,</code><code class="o">16</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">17</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">18</code><code class="calibre21">]</code>      <code class="calibre21">[,</code><code class="o">19</code><code class="calibre21">]</code>
<code class="o">25</code><code class="o">% -1.3551031 -0.1823252 -1.260911898 -0.9954289 -0.3767354 -0.8557544</code>
<code class="o">75%</code> <code class="o">-0.5396766</code>  <code class="o">0.7795571</code>  <code class="o">0.002908451</code>  <code class="o">0.4323192</code>  <code class="o">0.7542638</code>  <code class="o">0.5440158</code>
         <code class="calibre21">[,</code><code class="o">20</code><code class="calibre21">]</code>
<code class="o">25</code><code class="o">% -0.7000363</code>
<code class="o">75%</code>  <code class="o">0.5432995</code>
</pre></div>

</figure>

<p class="calibre2">Notice that I had to pass the <code class="calibre21">probs = c(0.25, 0.75)</code> argument to <code class="calibre21">quantile()</code> via the <code class="calibre21">...</code> argument to <code class="calibre21">apply()</code>.</p>

<p class="calibre2">For a higher dimensional example, I can create an array of <img src="images/000009.png" alt="2\times2" class="inline-equation" width="39" /> matrices and the compute the average of the matrices in the array.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> a <code class="o">&lt;-</code> <code class="kt">array</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">2</code> <code class="o">*</code> <code class="o">2</code> <code class="o">*</code> <code class="o">10</code><code class="calibre21">),</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">10</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">apply</code><code class="calibre21">(</code>a<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> <code class="kp">mean</code><code class="calibre21">)</code>
          <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code> <code class="o">0.1681387</code> <code class="o">-0.1039673</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code> <code class="o">0.3519741</code> <code class="o">-0.4029737</code>
</pre></div>

</figure>

<p class="calibre2">In the call to <code class="calibre21">apply()</code> here, I indicated via the <code class="calibre21">MARGIN</code> argument that I wanted to preserve the first and second dimensions and to collapse the third dimension by taking the mean.</p>

<p class="calibre2">There is a faster way to do this specific operation via the <code class="calibre21">colMeans()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">rowMeans</code><code class="calibre21">(</code>a<code class="calibre21">,</code> dims <code class="o">=</code> <code class="o">2</code><code class="calibre21">)</code>    <code class="c">## Faster</code>
          <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code>       <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code> <code class="o">0.1681387</code> <code class="o">-0.1039673</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code> <code class="o">0.3519741</code> <code class="o">-0.4029737</code>
</pre></div>

</figure>

<p class="calibre2">In this situation, I might argue that the use of <code class="calibre21">rowMeans()</code> is less readable, but it is substantially faster with large arrays.</p>

<h3 id="calibre_link-124" class="calibre19">
<span class="section-number">18.10 </span><code class="calibre11">mapply()</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/z8jC_h7S0VE">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">mapply()</code> function is a multivariate apply of sorts which applies a function in parallel over a set of arguments. Recall that <code class="calibre21">lapply()</code> and friends only iterate over a single R object. What if you want to iterate over multiple R objects in parallel? This is what <code class="calibre21">mapply()</code> is for.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code><code class="kp">mapply</code><code class="calibre21">)</code>
<code class="kc">function</code> <code class="calibre21">(</code>FUN<code class="calibre21">,</code> <code class="kc">...</code><code class="calibre21">,</code> MoreArgs <code class="o">=</code> <code class="kc">NULL</code><code class="calibre21">,</code> SIMPLIFY <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> USE.NAMES <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>  
</pre></div>

</figure>

<p class="calibre2">The arguments to <code class="calibre21">mapply()</code> are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">FUN</code> is a function to apply</li>
  <li class="calibre14">
<code class="calibre21">...</code> contains R objects to apply over</li>
  <li class="calibre14">
<code class="calibre21">MoreArgs</code> is a list of other arguments to <code class="calibre21">FUN</code>.</li>
  <li class="calibre14">
<code class="calibre21">SIMPLIFY</code> indicates whether the result should be simplified</li>
</ul>

<p class="calibre2">The <code class="calibre21">mapply()</code> function has a different argument order from <code class="calibre21">lapply()</code> because the function to apply comes first rather than the object to iterate over. The R objects over which we apply the function are given in the <code class="calibre21">...</code> argument because we can apply over an arbitrary number of R objects.</p>

<p class="calibre2">For example, the following is tedious to type</p>

<p class="calibre2">
  <code class="calibre21">list(rep(1, 4), rep(2, 3), rep(3, 2), rep(4, 1))</code>
</p>

<p class="calibre2">With <code class="calibre21">mapply()</code>, instead we can do</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code>  <code class="kp">mapply</code><code class="calibre21">(</code><code class="kp">rep</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">4</code><code class="calibre21">,</code> <code class="o">4</code><code class="o">:</code><code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code> <code class="o">1</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code> <code class="o">2</code> <code class="o">2</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">3</code> <code class="o">3</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code>
</pre></div>

</figure>

<p class="calibre2">This passes the sequence <code class="calibre21">1:4</code> to the first argument of <code class="calibre21">rep()</code> and the sequence <code class="calibre21">4:1</code> to the second argument.</p>

<p class="calibre2">Hereâs another example for simulating randon Normal variables.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> noise <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>n<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">,</code> sd<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>       rnorm<code class="calibre21">(</code>n<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">,</code> sd<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> <code class="c">## Simulate 5 randon numbers</code>
<code class="o">&gt;</code> noise<code class="calibre21">(</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>        
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.5196913</code>  <code class="o">3.2979182</code> <code class="o">-0.6849525</code>  <code class="o">1.7828267</code>  <code class="o">2.7827545</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## This only simulates 1 set of numbers, not 5</code>
<code class="o">&gt;</code> noise<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>    
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-1.670517</code>  <code class="o">2.796247</code>  <code class="o">2.776826</code>  <code class="o">5.351488</code>  <code class="o">3.422804</code>
</pre></div>

</figure>

<p class="calibre2">Here we can use <code class="calibre21">mapply()</code> to pass the sequence <code class="calibre21">1:5</code> separately to the <code class="calibre21">noise()</code> function so that we can get 5 sets of random numbers, each with a different length and mean.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">mapply</code><code class="calibre21">(</code>noise<code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.8260273</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4.764568</code> <code class="o">2.336980</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4.6463819</code> <code class="o">2.5582108</code> <code class="o">0.9412167</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">3.978149</code>  <code class="o">1.550018</code> <code class="o">-1.192223</code>  <code class="o">6.338245</code>

<code class="calibre21">[[</code><code class="o">5</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2.826182</code> <code class="o">1.347834</code> <code class="o">6.990564</code> <code class="o">4.976276</code> <code class="o">3.800743</code>
</pre></div>

</figure>

<p class="calibre2">The above call to <code class="calibre21">mapply()</code> is the same as</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kt">list</code><code class="calibre21">(</code>noise<code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> noise<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code>
<code class="o">+</code>      noise<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">,</code> <code class="o">3</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> noise<code class="calibre21">(</code><code class="o">4</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code>
<code class="o">+</code>      noise<code class="calibre21">(</code><code class="o">5</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.644104</code>

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1.148037</code> <code class="o">3.993318</code>

<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">4.4553214</code> <code class="o">-0.4532612</code>  <code class="o">3.7067970</code>

<code class="calibre21">[[</code><code class="o">4</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">5.4536273</code>  <code class="o">5.3365220</code> <code class="o">-0.8486346</code>  <code class="o">3.5292851</code>

<code class="calibre21">[[</code><code class="o">5</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">8.959267</code> <code class="o">6.593589</code> <code class="o">1.581448</code> <code class="o">1.672663</code> <code class="o">5.982219</code>
</pre></div>

</figure>

<h3 id="calibre_link-125" class="calibre19">
<span class="section-number">18.11 </span>Vectorizing a Function</h3>

<p class="calibre2">The <code class="calibre21">mapply()</code> function can be use to automatically âvectorizeâ a function. What this means is that it can be used to take a function that typically only takes single arguments and create a new function that can take vector arguments. This is often needed when you want to plot functions.</p>

<p class="calibre2">Hereâs an example of a function that computes the sum of squares given some data, a mean parameter and a standard deviation. The formula is <img src="images/000022.png" alt="\sum_{i=1}^n(x_i-\mu)^2/\sigma^2" class="inline-equation" width="123" />.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> sumsq <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>mu<code class="calibre21">,</code> sigma<code class="calibre21">,</code> x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">sum</code><code class="calibre21">(((</code>x <code class="o">-</code> mu<code class="calibre21">)</code> <code class="o">/</code> sigma<code class="calibre21">)</code><code class="o">^</code><code class="o">2</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">This function takes a mean <code class="calibre21">mu</code>, a standard deviation <code class="calibre21">sigma</code>, and some data in a vector <code class="calibre21">x</code>.</p>

<p class="calibre2">In many statistical applications, we want to minimize the sum of squares to find the optimal <code class="calibre21">mu</code> and <code class="calibre21">sigma</code>. Before we do that, we may want to evaluate or plot the function for many different values of <code class="calibre21">mu</code> or <code class="calibre21">sigma</code>. However, passing a vector of <code class="calibre21">mu</code>s or <code class="calibre21">sigma</code>s wonât work with this function because itâs not vectorized.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">)</code>       <code class="c">## Generate some data</code>
<code class="o">&gt;</code> sumsq<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> x<code class="calibre21">)</code>  <code class="c">## This is not what we want</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">110.2594</code>
</pre></div>

</figure>

<p class="calibre2">Note that the call to <code class="calibre21">sumsq()</code> only produced one value instead of 10 values.</p>

<p class="calibre2">However, we can do what we want to do by using <code class="calibre21">mapply()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">mapply</code><code class="calibre21">(</code>sumsq<code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> MoreArgs <code class="o">=</code> <code class="kt">list</code><code class="calibre21">(</code>x <code class="o">=</code> x<code class="calibre21">))</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">196.2289</code> <code class="o">121.4765</code> <code class="o">108.3981</code> <code class="o">104.0788</code> <code class="o">102.1975</code> <code class="o">101.2393</code> <code class="o">100.6998</code> <code class="o">100.3745</code>
 <code class="calibre21">[</code><code class="o">9</code><code class="calibre21">]</code> <code class="o">100.1685</code> <code class="o">100.0332</code>
</pre></div>

</figure>

<p class="calibre2">Thereâs even a function in R called <code class="calibre21">Vectorize()</code> that automatically can create a vectorized version of your function. So we could create a <code class="calibre21">vsumsq()</code> function that is fully vectorized as follows.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> vsumsq <code class="o">&lt;-</code> <code class="kp">Vectorize</code><code class="calibre21">(</code>sumsq<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"mu"</code><code class="calibre21">,</code> <code class="s">"sigma"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> vsumsq<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> x<code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">196.2289</code> <code class="o">121.4765</code> <code class="o">108.3981</code> <code class="o">104.0788</code> <code class="o">102.1975</code> <code class="o">101.2393</code> <code class="o">100.6998</code> <code class="o">100.3745</code>
 <code class="calibre21">[</code><code class="o">9</code><code class="calibre21">]</code> <code class="o">100.1685</code> <code class="o">100.0332</code>
</pre></div>

</figure>

<p class="calibre2">Pretty cool, right?</p>

<h3 id="calibre_link-126" class="calibre19">
<span class="section-number">18.12 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">The loop functions in R are very powerful because they allow you to conduct a series of operations on data using a compact form</li>
  <li class="calibre14">The operation of a loop function involves iterating over an R object (e.g. a list or vector or matrix), applying a function to each element of the object, and the collating the results and returning the collated results.</li>
  <li class="calibre14">Loop functions make heavy use of anonymous functions, which exist for the life of the loop function but are not stored anywhere</li>
  <li class="calibre14">The <code class="calibre21">split()</code> function can be used to divide an R object in to subsets determined by another variable which can subsequently be looped over using loop functions.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-173">
<div class="calibre5">
<h2 id="calibre_link-127" class="calibre15">
<span class="section-number">19. </span>Regular Expressions</h2>

<p class="calibre2">
  <a href="https://www.youtube.com/watch?v=q8SzNKib5-4">Watch a video of this chapter</a>
</p>

<h3 id="calibre_link-128" class="calibre19">
<span class="section-number">19.1 </span>Before You Begin</h3>

<p class="calibre2">If you want a very quick introduction to the general notion of regular expressions and how they can be used to process text (as opposed to how to implement them specifically in R), you should watch <a href="https://www.youtube.com/watch?v=NvHjYOilOf8">this lecture</a> first.</p>

<h3 id="calibre_link-129" class="calibre19">
<span class="section-number">19.2 </span>Primary R Functions</h3>

<p class="calibre2">The primary R functions for dealing with regular expressions are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">grep()</code>, <code class="calibre21">grepl()</code>: These functions search for matches of a regular expression/pattern in a character vector. <code class="calibre21">grep()</code> returns the indices into the character vector that contain a match or the specific strings that happen to have the match. <code class="calibre21">grepl()</code> returns a <code class="calibre21">TRUE</code>/<code class="calibre21">FALSE</code> vector indicating which elements of the character vector contain a match</li>
  <li class="calibre14">
<code class="calibre21">regexpr()</code>, <code class="calibre21">gregexpr()</code>: Search a character vector for regular expression matches and return the indices of the string where the match begins and the length of the match</li>
  <li class="calibre14">
<code class="calibre21">sub()</code>, <code class="calibre21">gsub()</code>: Search a character vector for regular expression matches and replace that match with another string</li>
  <li class="calibre14">
<code class="calibre21">regexec()</code>: This function searches a character vector for a regular expression, much like <code class="calibre21">regexpr()</code>, but it will additionally return the locations of any parenthesized sub-expressions. Probably easier to explain through demonstration.</li>
</ul>

<p class="calibre2">For this chapter, we will use a running example using data from homicides in Baltimore City. The Baltimore Sun newspaper collects information on all homicides that occur in the city (it also reports on many of them). That data is collected and presented in a <a href="http://data.baltimoresun.com/bing-maps/homicides/">map that is publically available</a>. I encourage you to go look at the web site/map to get a sense of what kinds of data are presented there. Unfortunately, the data on the web site are not particularly amenable to analysis, so Iâve scraped the data and put it in a separate file. The data in this file contain data from January 2007 to October 2013.</p>

<p class="calibre2">Here is an excerpt of the Baltimore City homicides dataset:</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> homicides <code class="o">&lt;-</code> <code class="kp">readLines</code><code class="calibre21">(</code><code class="s">"homicides.txt"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Total number of events recorded</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>homicides<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1571</code>
<code class="o">&gt;</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"</code><code class="err">39.311024, -76.674227, iconHomicideShooting, 'p2', '&lt;dl&gt;&lt;dt&gt;Leon Nelson&lt;/dt&gt;&lt;dd class=\</code><code class="s">"</code>a\
ddress\<code class="s">"</code><code class="err">&gt;3400 Clifton Ave.&lt;br /&gt;Baltimore, MD 21216&lt;/dd&gt;&lt;dd&gt;black male, 17 years old&lt;/dd&gt;&lt;dd&gt;F\</code>
ound on January <code class="o">1</code><code class="calibre21">,</code> <code class="o">2007</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Victim died at Shock Trauma<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Cause<code class="o">:</code> shooting<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;/</code>dl<code class="o">&gt;</code><code class="s">'</code><code class="err">\</code><code class="s"></code>
<code class="s">"</code>
<code class="s">&gt; homicides[1000]</code>
<code class="s">[1] "39.33626300000, -76.55553990000, icon_homicide_shooting, '</code>p1200<code class="s">', '</code><code class="o">&lt;</code>dl<code class="o">&gt;&lt;</code>dt<code class="o">&gt;&lt;</code>a href<code class="o">=</code>\<code class="s">"</code><code class="err">http\</code>
<code class="o">://</code>essentials.baltimoresun.com<code class="o">/</code>micro_sun<code class="o">/</code>homicides<code class="o">/</code>victim<code class="o">/</code><code class="o">1200</code><code class="o">/</code>davon<code class="o">-</code>diggs\<code class="s">"</code><code class="err">&gt;Davon Diggs&lt;/a&gt;&lt;/\</code>
dt<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">address\</code><code class="s">"</code><code class="o">&gt;</code><code class="o">4100</code> Parkwood Ave<code class="o">&lt;</code>br <code class="o">/&gt;</code>Baltimore<code class="calibre21">,</code> MD <code class="o">21206</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Race<code class="o">:</code> Black<code class="o">&lt;</code>br <code class="o">/&gt;</code>G\
ender<code class="o">:</code> male<code class="o">&lt;</code>br <code class="o">/&gt;</code>Age<code class="o">:</code> <code class="o">21</code> years old<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Found on November  <code class="o">5</code><code class="calibre21">,</code> <code class="o">2011</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Victim died at J\
ohns Hopkins Bayview Medical Center <code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Cause<code class="o">:</code> Shooting<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">popup-note\</code><code class="s">"</code><code class="o">&gt;&lt;</code>p<code class="o">&gt;</code>O\
riginally reported <code class="kc">in</code> <code class="o">5000</code> Belair Road<code class="calibre21">;</code> later determined to be rear alley of <code class="o">4100</code> block Parkwo\
od<code class="o">&lt;/</code>p<code class="o">&gt;&lt;/</code>dd<code class="o">&gt;&lt;/</code>dl<code class="o">&gt;</code><code class="s">'</code><code class="err">"</code>
</pre></div>

</figure>

<p class="calibre2">The data set is formatted so that each homicide is presented on a single line of text. So when we read the data in with <code class="calibre21">readLines()</code>, each element of the character vector represents one homicide event. Notice that the data are riddled with HTML tags because they were scraped directly from the web site.</p>

<p class="calibre2">A few interesting features stand out: We have the latitude and longitude of where the victim was found; then thereâs the street address; the age, race, and gender of the victim; the date on which the victim was found; in which hospital the victim ultimately died; the cause of death.</p>

<h3 id="calibre_link-130" class="calibre19">
<span class="section-number">19.3 </span><code class="calibre11">grep()</code>
</h3>

<p class="calibre2">Suppose we wanted to identify the records for all the victims of shootings (as opposed
to other causes)? How could we do that? From the map we know that for each cause of death there is a different icon/flag placed on the map. In particular, they are different colors. You can see that is indicated in the dataset for shooting deaths with a <code class="calibre21">iconHomicideShooting</code> label. Perhaps we can use this aspect of the data to idenfity all of the shootings.</p>

<p class="calibre2">Here I use <code class="calibre21">grep()</code> to match the literal <code class="calibre21">iconHomicideShooting</code> into the character vector of homicides.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"iconHomicideShooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">228</code>
</pre></div>

</figure>

<p class="calibre2">Using this approach I get 228 shooting deaths. However, I notice that for some of the entries, the indicator for the homicide âflagâ is noted as <code class="calibre21">icon_homicide_shooting</code>. Itâs not uncommon over time for web site maintainers to change the names of files or update files. What happens if we now <code class="calibre21">grep()</code> on both icon names using the <code class="calibre21">|</code> operator?</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"iconHomicideShooting|icon_homicide_shooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1263</code>
</pre></div>

</figure>

<p class="calibre2">Now we have 1263 shooting deaths, which is quite a bit more. In fact, the vast majority of homicides in Baltimore are shooting deaths.</p>

<p class="calibre2">Another possible way to do this is to <code class="calibre21">grep()</code> on the cause of death field, which seems to have the format <code class="calibre21">Cause: shooting</code>. We can <code class="calibre21">grep()</code> on this literally and get</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"Cause: shooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">228</code>
</pre></div>

</figure>

<p class="calibre2">Notice that we seem to be undercounting again. This is because for some of the entries, the word âshootingâ uses a captial âSâ while other entries use a lower case âsâ. We can handle this variation by using a character class in our regular expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"Cause: [Ss]hooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1263</code>
</pre></div>

</figure>

<p class="calibre2">One thing you have to be careful of when processing text data is not not <code class="calibre21">grep()</code> things out of context. For example, suppose we just <code class="calibre21">grep()</code>-ed on the expression <code class="calibre21">[Ss]hooting</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"[Ss]hooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1265</code>
</pre></div>

</figure>

<p class="calibre2">Notice that we see to pick up 2 extra homicides this way. We can figure out which ones they are by comparing the results of the two expressions.</p>

<p class="calibre2">First we can get the indices for the first expresssion match.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> i <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"[cC]ause: [Ss]hooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>i<code class="calibre21">)</code>
 int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">1263</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="o">11</code> <code class="o">12</code> <code class="o">13</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Then we can get the indices for just matching on <code class="calibre21">[Ss]hooting</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> j <code class="o">&lt;-</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"[Ss]hooting"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>j<code class="calibre21">)</code>
 int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">1265</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">2</code> <code class="o">6</code> <code class="o">7</code> <code class="o">8</code> <code class="o">9</code> <code class="o">10</code> <code class="o">11</code> <code class="o">12</code> <code class="o">13</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Now we just need to identify which are the entries that the vectors <code class="calibre21">i</code> and <code class="calibre21">j</code> do <em class="calibre17">not</em> have in common.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">setdiff</code><code class="calibre21">(</code>i<code class="calibre21">,</code> j<code class="calibre21">)</code>
<code class="kt">integer</code><code class="calibre21">(</code><code class="o">0</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">setdiff</code><code class="calibre21">(</code>j<code class="calibre21">,</code> i<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">318</code> <code class="o">859</code>
</pre></div>

</figure>

<p class="calibre2">Here we can see that the index vector <code class="calibre21">j</code> has two entries that are not in <code class="calibre21">i</code>: entries 318, 859. We can take a look at these entries directly to see what makes them different.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> homicides<code class="calibre21">[</code><code class="o">859</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"</code><code class="err">39.33743900000, -76.66316500000, icon_homicide_bluntforce, 'p914', '&lt;dl&gt;&lt;dt&gt;&lt;a href=\</code><code class="s">"</code>htt\
p<code class="o">://</code>essentials.baltimoresun.com<code class="o">/</code>micro_sun<code class="o">/</code>homicides<code class="o">/</code>victim<code class="o">/</code><code class="o">914</code><code class="o">/</code>steven<code class="o">-</code>harris\<code class="s">"</code><code class="err">&gt;Steven Harris&lt;/\</code>
a<code class="o">&gt;&lt;/</code>dt<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">address\</code><code class="s">"</code><code class="o">&gt;</code><code class="o">4200</code> Pimlico Road<code class="o">&lt;</code>br <code class="o">/&gt;</code>Baltimore<code class="calibre21">,</code> MD <code class="o">21215</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Race<code class="o">:</code> Black<code class="o">&lt;</code>br\
 <code class="o">/&gt;</code>Gender<code class="o">:</code> male<code class="o">&lt;</code>br <code class="o">/&gt;</code>Age<code class="o">:</code> <code class="o">38</code> years old<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Found on July <code class="o">29</code><code class="calibre21">,</code> <code class="o">2010</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Victim died at S\
cene<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Cause<code class="o">:</code> Blunt Force<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">popup-note\</code><code class="s">"</code><code class="o">&gt;&lt;</code>p<code class="o">&gt;</code>Harris was found dead July <code class="o">22</code> \
and ruled a shooting victim<code class="calibre21">;</code> an autopsy subsequently showed that he had not been shot<code class="calibre21">,</code><code class="kc">...</code><code class="o">&lt;/</code>dd<code class="o">&gt;</code>\
<code class="o">&lt;/</code>dl<code class="o">&gt;</code><code class="s">'</code><code class="err">"</code>
</pre></div>

</figure>

<p class="calibre2">Here we can see that the word âshootingâ appears in the narrative text that accompanies the data, but the ultimate cause of death was in fact blunt force. </p>

<aside class="calibre30">
  <p class="calibre2">When developing a regular expression to extract entries from a large dataset, itâs important that you understand the formatting of the dataset well enough so that you can develop a specific expression that doesnât accidentally grep data out of context.</p>

</aside>

<p class="calibre2">Sometimes we want to identify elements of a character vector that match a pattern, but instead of returning their indices we want the actual values that satisfy the match. For example, we may want to identify all of the states in the United States whose names start with âNewâ.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"^New"</code><code class="calibre21">,</code> state.name<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">29</code> <code class="o">30</code> <code class="o">31</code> <code class="o">32</code>
</pre></div>

</figure>

<p class="calibre2">This gives us the indices into the <code class="calibre21">state.name</code> variable that match, but setting <code class="calibre21">value = TRUE</code> returns the actual elements of the character vector that match.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">grep</code><code class="calibre21">(</code><code class="s">"^New"</code><code class="calibre21">,</code> state.name<code class="calibre21">,</code> value <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"New Hampshire"</code> <code class="s">"New Jersey"</code>    <code class="s">"New Mexico"</code>    <code class="s">"New York"</code>     
</pre></div>

</figure>

<h3 id="calibre_link-131" class="calibre19">
<span class="section-number">19.4 </span><code class="calibre11">grepl()</code>
</h3>

<p class="calibre2">The function <code class="calibre21">grepl()</code> works much like <code class="calibre21">grep()</code> except that it differs in its return value. <code class="calibre21">grepl()</code> returns a logical vector indicating which element of a character vector contains the match. For example, suppose we want to know which states in the United States begin with word âNewâ. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> g <code class="o">&lt;-</code> <code class="kp">grepl</code><code class="calibre21">(</code><code class="s">"^New"</code><code class="calibre21">,</code> state.name<code class="calibre21">)</code>
<code class="o">&gt;</code> g
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="calibre21">[</code><code class="o">13</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="calibre21">[</code><code class="o">25</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="calibre21">[</code><code class="o">37</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="calibre21">[</code><code class="o">49</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
<code class="o">&gt;</code> state.name<code class="calibre21">[</code>g<code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"New Hampshire"</code> <code class="s">"New Jersey"</code>    <code class="s">"New Mexico"</code>    <code class="s">"New York"</code>     
</pre></div>

</figure>

<p class="calibre2">Here, we can see that <code class="calibre21">grepl()</code> returns a logical vector that can be used to subset the original <code class="calibre21">state.name</code> vector.</p>

<h3 id="calibre_link-132" class="calibre19">
<span class="section-number">19.5 </span><code class="calibre11">regexpr()</code>
</h3>

<p class="calibre2">Both the <code class="calibre21">grep()</code> and the <code class="calibre21">grepl()</code> functions have some limitations. In particular, both functions tell you which strings in a character vector match a certain pattern but they donât tell you exactly where the match occurs or what the match is for a more complicated regular expression. </p>

<p class="calibre2">The <code class="calibre21">regexpr()</code> function gives you the (a) index into each string where the match begins and the (b) length of the match for that string. <code class="calibre21">regexpr()</code> only gives you the <em class="calibre17">first</em> match of the string (reading left to right). <code class="calibre21">gregexpr()</code> will give you <em class="calibre17">all</em> of the matches in a given string if there are is more than one match.</p>

<p class="calibre2">In our Baltimore City homicides dataset, we might be interested in finding the date on which each victim was found. Taking a look at the dataset</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"</code><code class="err">39.311024, -76.674227, iconHomicideShooting, 'p2', '&lt;dl&gt;&lt;dt&gt;Leon Nelson&lt;/dt&gt;&lt;dd class=\</code><code class="s">"</code>a\
ddress\<code class="s">"</code><code class="err">&gt;3400 Clifton Ave.&lt;br /&gt;Baltimore, MD 21216&lt;/dd&gt;&lt;dd&gt;black male, 17 years old&lt;/dd&gt;&lt;dd&gt;F\</code>
ound on January <code class="o">1</code><code class="calibre21">,</code> <code class="o">2007</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Victim died at Shock Trauma<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Cause<code class="o">:</code> shooting<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;/</code>dl<code class="o">&gt;</code><code class="s">'</code><code class="err">\</code>
<code class="s">"</code>
</pre></div>

</figure>

<p class="calibre2">it seems that we might be able to just <code class="calibre21">grep</code> on the word âFoundâ. However, the word âfoundâ may be found elsewhere in the entry, such as in this entry, where the word âfoundâ appears in the narrative text at the end.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> homicides<code class="calibre21">[</code><code class="o">954</code><code class="calibre21">]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"</code><code class="err">39.30677400000, -76.59891100000, icon_homicide_shooting, 'p816', '&lt;dl&gt;&lt;dt&gt;&lt;a href=\</code><code class="s">"</code>http<code class="o">:</code>\
<code class="o">//</code>essentials.baltimoresun.com<code class="o">/</code>micro_sun<code class="o">/</code>homicides<code class="o">/</code>victim<code class="o">/</code><code class="o">816</code><code class="o">/</code>kenly<code class="o">-</code>wheeler\<code class="s">"</code><code class="err">&gt;Kenly Wheeler&lt;/a&gt;\</code>
<code class="o">&lt;/</code>dt<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">address\</code><code class="s">"</code><code class="o">&gt;</code><code class="o">1400</code> N Caroline St<code class="o">&lt;</code>br <code class="o">/&gt;</code>Baltimore<code class="calibre21">,</code> MD <code class="o">21213</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Race<code class="o">:</code> Black<code class="o">&lt;</code>br \
<code class="o">/&gt;</code>Gender<code class="o">:</code> male<code class="o">&lt;</code>br <code class="o">/&gt;</code>Age<code class="o">:</code> <code class="o">29</code> years old<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Found on March  <code class="o">3</code><code class="calibre21">,</code> <code class="o">2010</code><code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Victim died at S\
cene<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd<code class="o">&gt;</code>Cause<code class="o">:</code> Shooting<code class="o">&lt;/</code>dd<code class="o">&gt;&lt;</code>dd class<code class="o">=</code>\<code class="s">"</code><code class="err">popup-note\</code><code class="s">"</code><code class="o">&gt;&lt;</code>p<code class="o">&gt;</code>Wheeler\\<code class="s">'</code><code class="err">s body was&nbsp;found o\</code><code class="s"></code>
<code class="s">n the grounds of Dr. Bernard Harris Sr.&nbsp;Elementary School&lt;/p&gt;&lt;/dd&gt;&lt;/dl&gt;'"</code>
</pre></div>

</figure>

<p class="calibre2">But we can see that the date is typically preceded by âFound onâ and is surrounded by <code class="calibre21">&lt;dd&gt;&lt;/dd&gt;</code> tags, so letâs use the pattern <code class="calibre21">&lt;dd&gt;[F|f]ound(.*)&lt;/dd&gt;</code> and see what it brings up.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">regexpr</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound(.*)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">])</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">177</code> <code class="o">178</code> <code class="o">188</code> <code class="o">189</code> <code class="o">178</code> <code class="o">182</code> <code class="o">178</code> <code class="o">187</code> <code class="o">182</code> <code class="o">183</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"match.length"</code><code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">93</code> <code class="o">86</code> <code class="o">89</code> <code class="o">90</code> <code class="o">89</code> <code class="o">84</code> <code class="o">85</code> <code class="o">84</code> <code class="o">88</code> <code class="o">84</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"index.type"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"chars"</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"useBytes"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">We can use the <code class="calibre21">substr()</code> function to extract the first match in the first string.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">substr</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">],</code> <code class="o">177</code><code class="calibre21">,</code> <code class="o">177</code> <code class="o">+</code> <code class="o">93</code> <code class="o">-</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"</code><code class="err">&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;&lt;dd&gt;Victim died at Shock Trauma&lt;/dd&gt;&lt;dd&gt;Cause: shooting&lt;\</code><code class="s"></code>
<code class="s">/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">Immediately, we can see that the regular expression picked up too much information. This is because the previous pattern was too greedy and matched too much of the string. We need to use the <code class="calibre21">?</code> metacharacter to make the regular expression âlazyâ so that it stops at the <em class="calibre17">first</em> <code class="calibre21">&lt;/dd&gt;</code> tag.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">regexpr</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound(.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">])</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">177</code> <code class="o">178</code> <code class="o">188</code> <code class="o">189</code> <code class="o">178</code> <code class="o">182</code> <code class="o">178</code> <code class="o">187</code> <code class="o">182</code> <code class="o">183</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"match.length"</code><code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code> <code class="o">33</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"index.type"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"chars"</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"useBytes"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">Now when we look at the substrings indicated by the <code class="calibre21">regexpr()</code> output, we get</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">substr</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">],</code> <code class="o">177</code><code class="calibre21">,</code> <code class="o">177</code> <code class="o">+</code> <code class="o">33</code> <code class="o">-</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">While itâs straightforward to take the output of <code class="calibre21">regexpr()</code> and feed it into <code class="calibre21">substr()</code> to get the matches out of the original data, one handy function is <code class="calibre21">regmatches()</code> which extracts the matches in the strings for you without you having to use <code class="calibre21">substr()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> <code class="kp">regexpr</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound(.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">])</code>
<code class="o">&gt;</code> <code class="kp">regmatches</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">],</code> r<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code>
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 3, 2007&lt;/dd&gt;"</code>
<code class="calibre21">[</code><code class="o">5</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<h3 id="calibre_link-133" class="calibre19">
<span class="section-number">19.6 </span><code class="calibre11">sub()</code> and <code class="calibre11">gsub()</code>
</h3>

<p class="calibre2">Sometimes we need to clean things up or modify strings by matching a pattern and replacing it with something else. For example, how can we extract the date from this string?</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">substr</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">],</code> <code class="o">177</code><code class="calibre21">,</code> <code class="o">177</code> <code class="o">+</code> <code class="o">33</code> <code class="o">-</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">We want to strip out the stuff surrounding the âJanuary 1, 2007â portion. We can do that by matching on the text that comes before and after it using the <code class="calibre21">|</code> operator and then replacing it with the empty string.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">sub</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on |&lt;/dd&gt;"</code><code class="calibre21">,</code> <code class="s">""</code><code class="calibre21">,</code> x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"January 1, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">Notice that the <code class="calibre21">sub()</code> function found the first match (at the beginning of the string) and replaced it and then stopped. However, there was another match at the end of the string that we also wanted to replace. To get both matches, we need the <code class="calibre21">gsub()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">gsub</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on |&lt;/dd&gt;"</code><code class="calibre21">,</code> <code class="s">""</code><code class="calibre21">,</code> x<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"January 1, 2007"</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">sub() and </code>gsub()` functions can take vector arguments so we donât have to process each string one by one.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> <code class="kp">regexpr</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound(.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">])</code>
<code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="kp">regmatches</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">],</code> r<code class="calibre21">)</code>
<code class="o">&gt;</code> m
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code>
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 3, 2007&lt;/dd&gt;"</code>
<code class="calibre21">[</code><code class="o">5</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code>
<code class="o">&gt;</code> d <code class="o">&lt;-</code> <code class="kp">gsub</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on |&lt;/dd&gt;"</code><code class="calibre21">,</code> <code class="s">""</code><code class="calibre21">,</code> m<code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Nice and clean</code>
<code class="o">&gt;</code> d
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"January 1, 2007"</code> <code class="s">"January 2, 2007"</code> <code class="s">"January 2, 2007"</code> <code class="s">"January 3, 2007"</code>
<code class="calibre21">[</code><code class="o">5</code><code class="calibre21">]</code> <code class="s">"January 5, 2007"</code>
</pre></div>

</figure>

<p class="calibre2">Finally, it may be useful to convert these strings to the <code class="calibre21">Date</code> class so that we can do some date-related computations.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">as.Date</code><code class="calibre21">(</code>d<code class="calibre21">,</code> <code class="s">"%B %d, %Y"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"2007-01-01"</code> <code class="s">"2007-01-02"</code> <code class="s">"2007-01-02"</code> <code class="s">"2007-01-03"</code> <code class="s">"2007-01-05"</code>
</pre></div>

</figure>

<h3 id="calibre_link-134" class="calibre19">
<span class="section-number">19.7 </span><code class="calibre11">regexec()</code>
</h3>

<p class="calibre2">The <code class="calibre21">regexec()</code> function works like <code class="calibre21">regexpr()</code> except it gives you the indices
for parenthesized sub-expressions. For example, take a look at the following expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">regexec</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on (.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">])</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">177</code> <code class="o">190</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"match.length"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">33</code> <code class="o">15</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"index.type"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"chars"</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"useBytes"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">Notice first that the regular expression itself has a portion in parentheses <code class="calibre21">()</code>. That is the portion of the expression that I presume will contain the date. In the output, youâll notice that there are two indices and two âmatch.lengthâ values. The first index tells you where the overall match begins (character 177) and the second index tells you where the expression in the parentheses begins (character 190).</p>

<p class="calibre2">By contrast, if we only use the <code class="calibre21">regexpr()</code> function, we get</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">regexec</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on .*?&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">])</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">177</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"match.length"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">33</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"index.type"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"chars"</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"useBytes"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">We can use the <code class="calibre21">substr()</code> function to demonstrate which parts of a strings are matched by the <code class="calibre21">regexec()</code> function.</p>

<p class="calibre2">Hereâs the output for <code class="calibre21">regexec()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">regexec</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on (.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">])</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">177</code> <code class="o">190</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"match.length"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">33</code> <code class="o">15</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"index.type"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"chars"</code>
<code class="kp">attr</code><code class="calibre21">(,</code><code class="s">"useBytes"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">Hereâs the overall expression match.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">substr</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">],</code> <code class="o">177</code><code class="calibre21">,</code> <code class="o">177</code> <code class="o">+</code> <code class="o">33</code> <code class="o">-</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">And hereâs the parenthesized sub-expression.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">substr</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">],</code> <code class="o">190</code><code class="calibre21">,</code> <code class="o">190</code> <code class="o">+</code> <code class="o">15</code> <code class="o">-</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"January 1, 2007"</code>
</pre></div>

</figure>

<p class="calibre2">All this can be done much more easily with the <code class="calibre21">regmatches()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> <code class="kp">regexec</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on (.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">])</code>
<code class="o">&gt;</code> <code class="kp">regmatches</code><code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">],</code> r<code class="calibre21">)</code>
<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code> <code class="s">"January 1, 2007"</code>                  

<code class="calibre21">[[</code><code class="o">2</code><code class="calibre21">]]</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"January 2, 2007"</code>                  
</pre></div>

</figure>

<p class="calibre2">Notice that <code class="calibre21">regmatches()</code> returns a list in this case, where each element of the list contains two strings: the overall match and the parenthesized sub-expression.</p>

<p class="calibre2">As an example, we can make a plot of monthly homicide counts. First we need a regular expression to capture the dates.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> <code class="kp">regexec</code><code class="calibre21">(</code><code class="s">"&lt;dd&gt;[F|f]ound on (.*?)&lt;/dd&gt;"</code><code class="calibre21">,</code> homicides<code class="calibre21">)</code>
<code class="o">&gt;</code> m <code class="o">&lt;-</code> <code class="kp">regmatches</code><code class="calibre21">(</code>homicides<code class="calibre21">,</code> r<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Then we can loop through the list returned by <code class="calibre21">regmatches()</code> and extract the second element of each (the parenthesized sub-expression).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> dates <code class="o">&lt;-</code> <code class="kp">sapply</code><code class="calibre21">(</code>m<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> x<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">])</code>
</pre></div>

</figure>

<p class="calibre2">Finally, we can convert the date strings into the <code class="calibre21">Date</code> class and make a histogram of the counts.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> dates <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code>dates<code class="calibre21">,</code> <code class="s">"%B %d, %Y"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> hist<code class="calibre21">(</code>dates<code class="calibre21">,</code> <code class="s">"month"</code><code class="calibre21">,</code> freq <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> main <code class="o">=</code> <code class="s">"Monthly Homicides in Baltimore"</code><code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000030.png" alt="plot of chunk unnamed-chunk-35" class="calibre31" />
    <figcaption class="calibre32">plot of chunk unnamed-chunk-35</figcaption>
  </figure>
</div>


<p class="calibre2">We can see from the picture that homicides do not occur uniformly throughout the year and appear to have some seasonality to them.</p>

<h3 id="calibre_link-135" class="calibre19">
<span class="section-number">19.8 </span>The <code class="calibre11">stringr</code> Package</h3>

<p class="calibre2">The <code class="calibre21">stringr</code> package is part of the <a href="https://www.tidyverse.org">tidyverse</a> collection of packages and wraps they underlying <code class="calibre21">stringi</code> package in a series of convenience functions. Some of the complexity of using the base R regular expression functions is usefully hidden by the <code class="calibre21">stringr</code> functions. In addition, the <code class="calibre21">stringr</code> functions provide a more rational interface to regular expressions with more consistency in the arguments and argument ordering.</p>

<p class="calibre2">Given what we have discussed so far, there is a fairly straightforward mapping from the base R functions to the <code class="calibre21">stringr</code> functions. In general, for the <code class="calibre21">stringr</code> functions, the data are the first argument and the regular expression is the second argument, with optional arguments afterwards.</p>

<p class="calibre2"><code class="calibre21">str_subset()</code> is much like <code class="calibre21">grep(value = TRUE)</code> and returns a character vector of strings that contain a given match.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>stringr<code class="calibre21">)</code>
<code class="o">&gt;</code> g <code class="o">&lt;-</code> str_subset<code class="calibre21">(</code>homicides<code class="calibre21">,</code> <code class="s">"iconHomicideShooting"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">length</code><code class="calibre21">(</code>g<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">228</code>
</pre></div>

</figure>

<p class="calibre2"><code class="calibre21">str_detect()</code> is essentially equivalent <code class="calibre21">grepl()</code>.</p>

<p class="calibre2"><code class="calibre21">str_extract()</code> plays the role of <code class="calibre21">regexpr()</code> and <code class="calibre21">regmatches()</code>, extracting the matches from the output.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str_extract<code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">],</code> <code class="s">"&lt;dd&gt;[F|f]ound(.*?)&lt;/dd&gt;"</code><code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code>
 <code class="calibre21">[</code><code class="o">3</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 3, 2007&lt;/dd&gt;"</code>
 <code class="calibre21">[</code><code class="o">5</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 7, 2007&lt;/dd&gt;"</code>
 <code class="calibre21">[</code><code class="o">9</code><code class="calibre21">]</code> <code class="s">"&lt;dd&gt;Found on January 8, 2007&lt;/dd&gt;"</code> <code class="s">"&lt;dd&gt;Found on January 8, 2007&lt;/dd&gt;"</code>
</pre></div>

</figure>

<p class="calibre2">Finally, <code class="calibre21">str_match()</code> does the job of <code class="calibre21">regexec()</code> by provide a matrix containing the parenthesized sub-expressions.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str_match<code class="calibre21">(</code>homicides<code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">],</code> <code class="s">"&lt;dd&gt;[F|f]ound on (.*?)&lt;/dd&gt;"</code><code class="calibre21">)</code>
     <code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">]</code>                                <code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">]</code>             
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">,]</code> <code class="s">"&lt;dd&gt;Found on January 1, 2007&lt;/dd&gt;"</code> <code class="s">"January 1, 2007"</code>
<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">,]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"January 2, 2007"</code>
<code class="calibre21">[</code><code class="o">3</code><code class="calibre21">,]</code> <code class="s">"&lt;dd&gt;Found on January 2, 2007&lt;/dd&gt;"</code> <code class="s">"January 2, 2007"</code>
<code class="calibre21">[</code><code class="o">4</code><code class="calibre21">,]</code> <code class="s">"&lt;dd&gt;Found on January 3, 2007&lt;/dd&gt;"</code> <code class="s">"January 3, 2007"</code>
<code class="calibre21">[</code><code class="o">5</code><code class="calibre21">,]</code> <code class="s">"&lt;dd&gt;Found on January 5, 2007&lt;/dd&gt;"</code> <code class="s">"January 5, 2007"</code>
</pre></div>

</figure>

<p class="calibre2">Note how the second column of the output contains the values of the parenthesized sub-expressions. We could now obtain these values by extracting the second column of the matrix. If there had been more parenthesized sub-expressions, there would have been more columns in the output matrix.</p>

<h3 id="calibre_link-136" class="calibre19">
<span class="section-number">19.9 </span>Summary</h3>

<p class="calibre2">The primary R functions for dealing with regular expressions are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">grep()</code>, <code class="calibre21">grepl()</code>: Search for matches of a regular expression/pattern in a
character vector</li>
  <li class="calibre14">
<code class="calibre21">regexpr()</code>, <code class="calibre21">gregexpr(): Search a character vector for regular expression matches and
return the indices where the match begins; useful in conjunction
with </code>regmatches()`</li>
  <li class="calibre14">
<code class="calibre21">sub()</code>, <code class="calibre21">gsub()</code>: Search a character vector for regular expression matches and
replace that match with another string</li>
  <li class="calibre14">
<code class="calibre21">regexec()</code>: Gives you indices of parethensized sub-expressions.</li>
  <li class="calibre14">The <code class="calibre21">stringr</code> package provides a series of functions implementing much of the regular expression functionality in R but with a more consistent and rationalized interface.</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-15">
<div class="calibre5">
<h2 id="calibre_link-137" class="calibre15">
<span class="section-number">20. </span>Debugging</h2>

<h3 id="calibre_link-138" class="calibre19">
<span class="section-number">20.1 </span>Somethingâs Wrong!</h3>

<p class="calibre2"><a href="https://youtu.be/LHQxbRInyyc">Watch a video of this section</a> (note that this video differs slightly from the material presented here)</p>

<p class="calibre2">R has a number of ways to indicate to you that somethingâs not right. There are different levels of indication that can be used, ranging from mere notification to fatal error. Executing any function in R may result in the following <em class="calibre17">conditions</em>.</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">message</code>: A generic notification/diagnostic message produced by the <code class="calibre21">message()</code> function; execution of the function continues</li>
  <li class="calibre14">
<code class="calibre21">warning</code>: An indication that something is wrong but not necessarily fatal; execution of the function continues. Warnings are generated by the <code class="calibre21">warning()</code> function</li>
  <li class="calibre14">
<code class="calibre21">error</code>: An indication that a fatal problem has occurred and execution of the function stops. Errors are produced by the <code class="calibre21">stop()</code> function.</li>
  <li class="calibre14">
<code class="calibre21">condition</code>: A generic concept for indicating that something unexpected has occurred; programmers can create their own custom conditions if they want.</li>
</ul>

<p class="calibre2">Here is an example of a warning that you might receive in the course of using R.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">log</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">)</code>
Warning <code class="kc">in</code> <code class="kp">log</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">)</code><code class="o">:</code> NaNs produced
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">NaN</code>
</pre></div>

</figure>

<p class="calibre2">This warning lets you know that taking the log of a negative number results in a <code class="calibre21">NaN</code> value because you canât take the log of negative numbers. Nevertheless, R doesnât give an error, because it has a useful value that it can return, the <code class="calibre21">NaN</code> value. The warning is just there to let you know that something unexpected happen. Depending on what you are programming, you may have intentionally taken the log of a negative number in order to move on to another section of code.</p>

<p class="calibre2">Here is another function that is designed to print a message to the console depending on the nature of its input.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">0</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is greater than zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">else</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is less than or equal to zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">invisible</code><code class="calibre21">(</code>x<code class="calibre21">)</code>        
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">This function is simple&mdash;it prints a message telling you whether <code class="calibre21">x</code> is greater than zero or less than or equal to zero. It also returns its input <em class="calibre17">invisibly</em>, which is a common practice with âprintâ functions. Returning an object invisibly means that the return value does not get auto-printed when the function is called.</p>

<p class="calibre2">Take a hard look at the function above and see if you can identify any bugs or problems.</p>

<p class="calibre2">We can execute the function as follows.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage<code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"x is greater than zero"</code>
</pre></div>

</figure>

<p class="calibre2">The function seems to work fine at this point. No errors, warnings, or messages.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage<code class="calibre21">(</code><code class="kc">NA</code><code class="calibre21">)</code>
Error <code class="kc">in</code> <code class="kc">if</code> <code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">0</code><code class="calibre21">)</code> <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is greater than zero"</code><code class="calibre21">)</code> <code class="kc">else</code> <code class="kp">print</code><code class="calibre21">(</code><code class="s">"</code><code class="err">x is less than or equal to zer\</code><code class="s"></code>
<code class="s">o"</code><code class="calibre21">)</code><code class="o">:</code> missing value where <code class="kc">TRUE</code><code class="o">/</code><code class="kc">FALSE</code> needed
</pre></div>

</figure>

<p class="calibre2">What happened?</p>

<p class="calibre2">Well, the first thing the function does is test if <code class="calibre21">x &gt; 0</code>. But you canât do that test if <code class="calibre21">x</code> is a <code class="calibre21">NA</code> or <code class="calibre21">NaN</code> value. R doesnât know what to do in this case so it stops with a fatal error.</p>

<p class="calibre2">We can fix this problem by anticipating the possibility of <code class="calibre21">NA</code> values and checking to see if the input is <code class="calibre21">NA</code> with the <code class="calibre21">is.na()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage2 <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code><code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">))</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is a missing value!"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kc">else</code> <code class="kc">if</code><code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">0</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is greater than zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">else</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is less than or equal to zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">invisible</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Now we can run the following.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage2<code class="calibre21">(</code><code class="kc">NA</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"x is a missing value!"</code>
</pre></div>

</figure>

<p class="calibre2">And all is fine.</p>

<p class="calibre2">Now what about the following situation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> <code class="kp">log</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code>
Warning <code class="kc">in</code> <code class="kp">log</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code><code class="o">:</code> NaNs produced
<code class="o">&gt;</code> printmessage2<code class="calibre21">(</code>x<code class="calibre21">)</code>
Warning <code class="kc">in</code> <code class="kc">if</code> <code class="calibre21">(</code><code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">))</code> <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is a missing value!"</code><code class="calibre21">)</code> <code class="kc">else</code> <code class="kc">if</code> <code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">0</code><code class="calibre21">)</code> <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x</code>
<code class="s">is greater than zero"</code><code class="calibre21">)</code> <code class="kc">else</code> <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is less than or equal to zero"</code><code class="calibre21">)</code><code class="o">:</code> the
condition has length <code class="o">&gt;</code> <code class="o">1</code> and only the first element will be used
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"x is a missing value!"</code>
</pre></div>

</figure>

<p class="calibre2">Now what?? Why are we getting this warning? The warning says âthe condition has length &gt; 1 and only the first element will be usedâ. </p>

<p class="calibre2">The problem here is that I passed <code class="calibre21">printmessage2()</code> a vector <code class="calibre21">x</code> that was of length 2 rather then length 1. Inside the body of <code class="calibre21">printmessage2()</code> the expression <code class="calibre21">is.na(x)</code> returns a vector that is tested in the <code class="calibre21">if</code> statement. However, <code class="calibre21">if</code> cannot take vector arguments so you get a warning. The fundamental problem here is that <code class="calibre21">printmessage2()</code> is not <em class="calibre17">vectorized</em>.</p>

<p class="calibre2">We can solve this problem two ways. One is by simply not allowing vector arguments. The other way is to vectorize the <code class="calibre21">printmessage2()</code> function to allow it to take vector arguments.</p>

<p class="calibre2">For the first way, we simply need to check the length of the input.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage3 <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code><code class="kp">length</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="o">&gt;</code> <code class="o">1L</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="kp">stop</code><code class="calibre21">(</code><code class="s">"'x' has length &gt; 1"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code><code class="kp">is.na</code><code class="calibre21">(</code>x<code class="calibre21">))</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is a missing value!"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kc">else</code> <code class="kc">if</code><code class="calibre21">(</code>x <code class="o">&gt;</code> <code class="o">0</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is greater than zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">else</code>
<code class="o">+</code>                 <code class="kp">print</code><code class="calibre21">(</code><code class="s">"x is less than or equal to zero"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">invisible</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Now when we pass <code class="calibre21">printmessage3()</code> a vector we should get an error.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage3<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">)</code>
Error <code class="kc">in</code> printmessage3<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">2</code><code class="calibre21">)</code><code class="o">:</code> <code class="s">'x'</code> has length <code class="o">&gt;</code> <code class="o">1</code>
</pre></div>

</figure>

<p class="calibre2">Vectorizing the function can be accomplished easily with the <code class="calibre21">Vectorize()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> printmessage4 <code class="o">&lt;-</code> <code class="kp">Vectorize</code><code class="calibre21">(</code>printmessage2<code class="calibre21">)</code>
<code class="o">&gt;</code> out <code class="o">&lt;-</code> printmessage4<code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="o">-1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">))</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"x is less than or equal to zero"</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"x is greater than zero"</code>
</pre></div>

</figure>

<p class="calibre2">You can see now that the correct messages are printed without any warning or error. Note that I stored the return value of <code class="calibre21">printmessage4()</code> in a separate R object called <code class="calibre21">out</code>. This is because when I use the <code class="calibre21">Vectorize()</code> function it no longer preserves the invisibility of the return value.</p>

<h3 id="calibre_link-139" class="calibre19">
<span class="section-number">20.2 </span>Figuring Out Whatâs Wrong</h3>

<p class="calibre2">The primary task of debugging any R code is correctly diagnosing what the problem is. When diagnosing a problem with your code (or somebody elseâs), itâs important first understand what you were expecting to occur. Then you need to idenfity what <em class="calibre17">did</em> occur and how did it deviate from your expectations. Some basic questions you need to ask are</p>

<ul class="calibre20">
  <li class="calibre14">What was your input? How did you call the function?</li>
  <li class="calibre14">What were you expecting? Output, messages, other results? </li>
  <li class="calibre14">What did you get?</li>
  <li class="calibre14">How does what you get differ from what you were expecting? </li>
  <li class="calibre14">Were your expectations correct in the first place?</li>
  <li class="calibre14">Can you reproduce the problem (exactly)?</li>
</ul>

<p class="calibre2">Being able to answer these questions is important not just for your own sake, but in situations where you may need to ask someone else for help with debugging the problem. Seasoned programmers will be asking you these exact questions.</p>

<h3 id="calibre_link-140" class="calibre19">
<span class="section-number">20.3 </span>Debugging Tools in R</h3>

<p class="calibre2">
  <a href="https://youtu.be/h9rs6-Cwwto">Watch a video of this section</a>
</p>

<p class="calibre2">R provides a number of tools to help you with debugging your code. The primary tools for debugging functions in R are</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">traceback()</code>: prints out the function call stack after an error occurs; does nothing if thereâs no error</li>
  <li class="calibre14">
<code class="calibre21">debug()</code>: flags a function for âdebugâ mode which allows you to step through execution of a function one line at a time</li>
  <li class="calibre14">
<code class="calibre21">browser()</code>: suspends the execution of a function wherever it is called and puts the function in debug mode</li>
  <li class="calibre14">
<code class="calibre21">trace()</code>: allows you to insert debugging code into a function a specific places </li>
  <li class="calibre14">
<code class="calibre21">recover()</code>: allows you to modify the error behavior so that you can browse the function call stack</li>
</ul>

<p class="calibre2">These functions are interactive tools specifically designed to allow you to pick through a function. Thereâs also the more blunt technique of inserting <code class="calibre21">print()</code> or <code class="calibre21">cat()</code> statements in the function.</p>

<h3 id="calibre_link-141" class="calibre19">
<span class="section-number">20.4 </span>Using <code class="calibre11">traceback()</code>
</h3>

<p class="calibre2">
  <a href="https://youtu.be/VT9ZxCp6o-I">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">traceback()</code> function prints out the <em class="calibre17">function call stack</em> after an error has occurred. The function call stack is the sequence of functions that was called before the error occurred. </p>

<p class="calibre2">For example, you may have a function <code class="calibre21">a()</code> which subsequently calls function <code class="calibre21">b()</code> which calls <code class="calibre21">c()</code> and then <code class="calibre21">d()</code>. If an error occurs, it may not be immediately clear in which function the error occurred. The <code class="calibre21">traceback()</code> function shows you how many levels deep you were when the error occurred.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">mean</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
Error <code class="kc">in</code> <code class="kp">mean</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="o">:</code> object <code class="s">'x'</code> not found
<code class="o">&gt;</code> <code class="kp">traceback</code><code class="calibre21">()</code>
<code class="o">1</code><code class="o">:</code> <code class="kp">mean</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
</pre></div>

</figure>
<p class="calibre2">Here, itâs clear that the error occurred inside the <code class="calibre21">mean()</code> function because the object <code class="calibre21">x</code> does not exist. </p>

<p class="calibre2">The <code class="calibre21">traceback()</code> function must be called immediately after an error occurs. Once another function is called, you lose the traceback.</p>

<p class="calibre2">Here is a slightly more complicated example using the <code class="calibre21">lm()</code> function for linear modeling.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> lm<code class="calibre21">(</code>y <code class="o">~</code> x<code class="calibre21">)</code>
Error <code class="kc">in</code> <code class="kp">eval</code><code class="calibre21">(</code>expr<code class="calibre21">,</code> envir<code class="calibre21">,</code> enclos<code class="calibre21">)</code> <code class="o">:</code> object âyâ not found
<code class="o">&gt;</code> <code class="kp">traceback</code><code class="calibre21">()</code>
<code class="o">7</code><code class="o">:</code> <code class="kp">eval</code><code class="calibre21">(</code>expr<code class="calibre21">,</code> envir<code class="calibre21">,</code> enclos<code class="calibre21">)</code>
<code class="o">6</code><code class="o">:</code> <code class="kp">eval</code><code class="calibre21">(</code>predvars<code class="calibre21">,</code> data<code class="calibre21">,</code> env<code class="calibre21">)</code>
<code class="o">5</code><code class="o">:</code> model.frame.default<code class="calibre21">(</code>formula <code class="o">=</code> y <code class="o">~</code> x<code class="calibre21">,</code> drop.unused.levels <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">4</code><code class="o">:</code> model.frame<code class="calibre21">(</code>formula <code class="o">=</code> y <code class="o">~</code> x<code class="calibre21">,</code> drop.unused.levels <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">3</code><code class="o">:</code> <code class="kp">eval</code><code class="calibre21">(</code>expr<code class="calibre21">,</code> envir<code class="calibre21">,</code> enclos<code class="calibre21">)</code>
<code class="o">2</code><code class="o">:</code> <code class="kp">eval</code><code class="calibre21">(</code>mf<code class="calibre21">,</code> <code class="kp">parent.frame</code><code class="calibre21">())</code>
<code class="o">1</code><code class="o">:</code> lm<code class="calibre21">(</code>y <code class="o">~</code> x<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">You can see now that the error did not get thrown until the 7th level of the function call stack, in which case the <code class="calibre21">eval()</code> function tried to evaluate the formula <code class="calibre21">y ~ x</code> and realized the object <code class="calibre21">y</code> did not exist.</p>

<p class="calibre2">Looking at the traceback is useful for figuring out roughly where an error occurred but itâs not useful for more detailed debugging. For that you might turn to the <code class="calibre21">debug()</code> function.</p>

<h3 id="calibre_link-142" class="calibre19">
<span class="section-number">20.5 </span>Using <code class="calibre11">debug()</code>
</h3>

<p class="calibre2">The <code class="calibre21">debug()</code> function initiates an interactive debugger (also known as the âbrowserâ in R) for a function. With the debugger, you can step through an R function one expression at a time to pinpoint exactly where an error occurs.</p>

<p class="calibre2">The <code class="calibre21">debug()</code> function takes a function as its first argument. Here is an example of debugging the <code class="calibre21">lm()</code> function. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">debug</code><code class="calibre21">(</code>lm<code class="calibre21">)</code>      <code class="c">## Flag the 'lm()' function for interactive debugging</code>
<code class="o">&gt;</code> lm<code class="calibre21">(</code>y <code class="o">~</code> x<code class="calibre21">)</code>
debugging <code class="kp">in</code><code class="o">:</code> lm<code class="calibre21">(</code>y <code class="o">~</code> x<code class="calibre21">)</code>
<code class="kp">debug</code><code class="o">:</code> <code class="calibre21">{</code>
    ret.x <code class="o">&lt;-</code> x
    ret.y <code class="o">&lt;-</code> y
    cl <code class="o">&lt;-</code> <code class="kp">match.call</code><code class="calibre21">()</code>
    <code class="kc">...</code>
    <code class="kc">if</code> <code class="calibre21">(</code><code class="o">!</code><code class="kp">qr</code><code class="calibre21">)</code>
        z<code class="o">$</code>qr <code class="o">&lt;-</code> <code class="kc">NULL</code> 
    z
<code class="calibre21">}</code> 
Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code>
</pre></div>

</figure>

<p class="calibre2">Now, every time you call the <code class="calibre21">lm()</code> function it will launch the interactive debugger. To turn this behavior off you need to call the <code class="calibre21">undebug()</code> function.</p>

<p class="calibre2">The debugger calls the browser at the very top level of the function body. From there you can step through each expression in the body. There are a few special commands you can call in the browser:</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">n</code> executes the current expression and moves to the next expression</li>
  <li class="calibre14">
<code class="calibre21">c</code> continues execution of the function and does not stop until either an error or the function exits</li>
  <li class="calibre14">
<code class="calibre21">Q</code> quits the browser</li>
</ul>

<p class="calibre2">Hereâs an example of a browser session with the <code class="calibre21">lm()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code> n   <code class="c">## Evalute this expression and move to the next one</code>
<code class="kp">debug</code><code class="o">:</code> ret.x <code class="o">&lt;-</code> x
Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code> n
<code class="kp">debug</code><code class="o">:</code> ret.y <code class="o">&lt;-</code> y
Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code> n
<code class="kp">debug</code><code class="o">:</code> cl <code class="o">&lt;-</code> <code class="kp">match.call</code><code class="calibre21">()</code>
Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code> n
<code class="kp">debug</code><code class="o">:</code> mf <code class="o">&lt;-</code> <code class="kp">match.call</code><code class="calibre21">(</code>expand.dots <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
Browse<code class="calibre21">[</code><code class="o">2</code><code class="calibre21">]</code><code class="o">&gt;</code> n
<code class="kp">debug</code><code class="o">:</code> m <code class="o">&lt;-</code> <code class="kp">match</code><code class="calibre21">(</code><code class="kt">c</code><code class="calibre21">(</code><code class="s">"formula"</code><code class="calibre21">,</code> <code class="s">"data"</code><code class="calibre21">,</code> <code class="s">"subset"</code><code class="calibre21">,</code> <code class="s">"weights"</code><code class="calibre21">,</code> <code class="s">"na.action"</code><code class="calibre21">,</code>
    <code class="s">"offset"</code><code class="calibre21">),</code> <code class="kp">names</code><code class="calibre21">(</code>mf<code class="calibre21">),</code> <code class="o">0L</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">While you are in the browser you can execute any other R function that might be available to you in a regular session. In particular, you can use <code class="calibre21">ls()</code> to see what is in your current environment (the function environment) and <code class="calibre21">print()</code> to print out the values of R objects in the function environment.</p>

<p class="calibre2">You can turn off interactive debugging with the <code class="calibre21">undebug()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="kp">undebug</code><code class="calibre21">(</code>lm<code class="calibre21">)</code>    <code class="c">## Unflag the 'lm()' function for debugging</code>
</pre></div>

</figure>

<h3 id="calibre_link-143" class="calibre19">
<span class="section-number">20.6 </span>Using <code class="calibre11">recover()</code>
</h3>

<p class="calibre2">The <code class="calibre21">recover()</code> function can be used to modify the error behavior of R when an error occurs. Normally, when an error occurs in a function, R will print out an error message, exit out of the function, and return you to your workspace to await further commands. </p>

<p class="calibre2">With <code class="calibre21">recover()</code> you can tell R that when an error occurs, it should halt execution at the exact point at which the error occurred. That can give you the opportunity to poke around in the environment in which the error occurred. This can be useful to see if there are any R objects or data that have been corrupted or mistakenly modified.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">options</code><code class="calibre21">(</code>error <code class="o">=</code> recover<code class="calibre21">)</code>    <code class="c">## Change default R error behavior</code>
<code class="o">&gt;</code> read.csv<code class="calibre21">(</code><code class="s">"nosuchfile"</code><code class="calibre21">)</code>      <code class="c">## This code doesn't work</code>
Error <code class="kc">in</code> <code class="kp">file</code><code class="calibre21">(</code><code class="kp">file</code><code class="calibre21">,</code> <code class="s">"rt"</code><code class="calibre21">)</code> <code class="o">:</code> cannot open the connection
In addition<code class="o">:</code> Warning <code class="kp">message</code><code class="o">:</code>
In <code class="kp">file</code><code class="calibre21">(</code><code class="kp">file</code><code class="calibre21">,</code> <code class="s">"rt"</code><code class="calibre21">)</code> <code class="o">:</code>
  cannot open file ânosuchfileâ<code class="o">:</code> No such file or directory
  
Enter a frame number<code class="calibre21">,</code> or <code class="o">0</code> to exit

<code class="o">1</code><code class="o">:</code> read.csv<code class="calibre21">(</code><code class="s">"nosuchfile"</code><code class="calibre21">)</code>
<code class="o">2</code><code class="o">:</code> read.table<code class="calibre21">(</code>file <code class="o">=</code> <code class="kp">file</code><code class="calibre21">,</code> header <code class="o">=</code> header<code class="calibre21">,</code> sep <code class="o">=</code> sep<code class="calibre21">,</code> quote <code class="o">=</code> <code class="kp">quote</code><code class="calibre21">,</code> dec <code class="o">=</code>
<code class="o">3</code><code class="o">:</code> <code class="kp">file</code><code class="calibre21">(</code><code class="kp">file</code><code class="calibre21">,</code> <code class="s">"rt"</code><code class="calibre21">)</code>

Selection<code class="o">:</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">recover()</code> function will first print out the function call stack when an error occurrs. Then, you can choose to jump around the call stack and investigate the problem. When you choose a frame number, you will be put in the browser (just like the interactive debugger triggered with <code class="calibre21">debug()</code>) and will have the ability to poke around.</p>

<h3 id="calibre_link-144" class="calibre19">
<span class="section-number">20.7 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">There are three main indications of a problem/condition: <code class="calibre21">message</code>, <code class="calibre21">warning</code>, <code class="calibre21">error</code>; only an <code class="calibre21">error</code> is fatal</li>
  <li class="calibre14">When analyzing a function with a problem, make sure you can reproduce the problem, clearly state your expectations and how the output differs from your expectation</li>
  <li class="calibre14">Interactive debugging tools <code class="calibre21">traceback</code>, <code class="calibre21">debug</code>, <code class="calibre21">browser</code>, <code class="calibre21">trace</code>, and <code class="calibre21">recover</code> can be used to find problematic code in functions</li>
  <li class="calibre14">Debugging tools are not a substitute for thinking!</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-174">
<div class="calibre5">
<h2 id="calibre_link-145" class="calibre15">
<span class="section-number">21. </span>Profiling R Code</h2>

<blockquote class="calibre18">
  <p class="calibre2">Letâs solve the problem but letâs not make it worse by guessing. &mdash;<em class="calibre17">Gene Kranz, Apollo 13 Lead Flight Director</em></p>
</blockquote>

<p class="calibre2">
  <a href="https://youtu.be/pHFgb12uG5s">Watch a video of this section</a>
</p>

<p class="calibre2">R comes with a profiler to help you optimize your code and improve its performance. In generall, itâs usually a bad idea to focus on optimizing your code at the very beginning of development. Rather, in the beginning itâs better to focus on translating your ideas into code and writing code thatâs coherent and readable. The problem is that heavily optimized code tends to be obscure and difficult to read, making it harder to debug and revise. Better to get all the bugs out first, then focus on optimizing.</p>

<p class="calibre2">Of course, when it comes to optimizing code, the question is what should you optimize? Well, clearly should optimize the parts of your code that are running slowly, but how do we know what parts those are?</p>

<p class="calibre2">This is what the profiler is for. Profiling is a systematic way to examine how much time is spent in  different parts of a program. </p>

<p class="calibre2">Sometimes profiling becomes necessary as a project grows and layers of code are placed on top of each other. Often you might write some code that runs fine once. But then later, you might put that same code in a big loop that runs 1,000 times. Now the original code that took 1 second to run is taking 1,000 seconds to run! Getting that little piece of original code to run faster will help the entire loop.</p>

<p class="calibre2">Itâs tempting to think you just <em class="calibre17">know</em> where the bottlenecks in your code are. I mean, after all, you write it! But trust me, I canât tell you how many times Iâve been surprised at where exactly my code is spending all its time. The reality is that <em class="calibre17">profiling is better than guessing</em>. Better to collect some data than to go on hunches alone. Ultimately, getting the biggest impact on speeding up code depends on knowing where
the code spends most of its time. This cannot be done without some sort of rigorous performance analysis or profiling.</p>

<blockquote class="calibre18">
  <p class="calibre2">We should forget about small efficiencies, say about 97% of the time: premature optimization is the root of all evil
&mdash;<em class="calibre17">Donald Knuth</em></p>
</blockquote>

<p class="calibre2">The basic principles of optimizing your code are:</p>

<ul class="calibre20">
  <li class="calibre14">Design first, then optimize</li>
  <li class="calibre14">Remember: Premature optimization is the root of all evil</li>
  <li class="calibre14">Measure (collect data), donât guess. </li>
  <li class="calibre14">If youâre going to be scientist, you need to apply the same principles here!</li>
</ul>

<h3 id="calibre_link-146" class="calibre19">
<span class="section-number">21.1 </span>Using <code class="calibre11">system.time()</code>
</h3>

<p class="calibre2">They <code class="calibre21">system.time()</code> function takes an arbitrary R expression as input (can be wrapped in curly  braces) and returns the amount of time taken to evaluate the expression. The <code class="calibre21">system.time()</code> function computes the time (in seconds) needed to execute an expression and if thereâs an error, gives the time until the error occurred. The function returns an object of class <code class="calibre21">proc_time</code> which contains two useful bits of information:</p>

<ul class="calibre20">
  <li class="calibre14">
<em class="calibre17">user time</em>: time charged to the CPU(s) for this expression</li>
  <li class="calibre14">
<em class="calibre17">elapsed time</em>: âwall clockâ time, the amount of time that passes for <em class="calibre17">you</em> as youâre sitting there</li>
</ul>

<p class="calibre2">Usually, the user time and elapsed time are relatively close, for straight computing tasks. But there are a few situations where the two can diverge, sometimes dramatically. The elapsed time may be <em class="calibre17">greater than</em> the user time if the CPU spends a lot of time waiting around. This commonly happens if your R expression involes some input or output, which depends on the activity of the file system and the disk (or the Internet, if using a network connection).</p>

<p class="calibre2">The elapsed time may be <em class="calibre17">smaller than</em> the user time if your machine has multiple cores/processors (and is capable of using them). For example, multi-threaded BLAS libraries (vecLib/Accelerate, ATLAS, ACML, MKL) can greatly speed up linear algebra calculations and are commonly installed on even desktop systems these days. Also, parallel processing done via something like the <code class="calibre21">parallell</code> package can make the elapsed time smaller than the user time. When you have multiple processors/cores/machines working in parallel, the amount of time that the collection of CPUs spends working on a problem is the same as with a single CPU, but because they are operating in parallel, there is a savings in elapsed time.</p>

<p class="calibre2">Hereâs an example of where the elapsed time is greater than the user time.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="c">## Elapsed time &gt; user time</code>
<code class="kp">system.time</code><code class="calibre21">(</code><code class="kp">readLines</code><code class="calibre21">(</code><code class="s">"http://www.jhsph.edu"</code><code class="calibre21">))</code>
   user  system elapsed 
  <code class="o">0.004</code>   <code class="o">0.002</code>   <code class="o">0.431</code> 
</pre></div>

</figure>
<p class="calibre2">Most of the time in this expression is spent waiting for the connection to the web server and waiting for the data to travel back to my computer. This doesnât involve the CPU and so the CPU simply waits around for things to get done. Hence, the user time is small.</p>

<p class="calibre2">In this example, the elapsed time is smaller than the user time.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="c">## Elapsed time &lt; user time</code>
<code class="o">&gt;</code> hilbert <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>n<code class="calibre21">)</code> <code class="calibre21">{</code> 
<code class="o">+</code>         i <code class="o">&lt;-</code> <code class="o">1</code><code class="o">:</code>n
<code class="o">+</code>         <code class="o">1</code> <code class="o">/</code> <code class="kp">outer</code><code class="calibre21">(</code>i <code class="o">-</code> <code class="o">1</code><code class="calibre21">,</code> i<code class="calibre21">,</code> <code class="s">"+"</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">}</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> hilbert<code class="calibre21">(</code><code class="o">1000</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">system.time</code><code class="calibre21">(</code><code class="kp">svd</code><code class="calibre21">(</code>x<code class="calibre21">))</code>
   user  system elapsed 
  <code class="o">1.035</code>   <code class="o">0.255</code>   <code class="o">0.462</code> 
</pre></div>

</figure>

<p class="calibre2">In this case I ran a singular value decomposition on the matrix in <code class="calibre21">x</code>, which is a common linear algebra procedure. Because my computer is able to split the work across multiple processors, the elapsed time is about half the user time.</p>

<h3 id="calibre_link-147" class="calibre19">
<span class="section-number">21.2 </span>Timing Longer Expressions</h3>

<p class="calibre2">You can time longer expressions by wrapping them in curly braces within the call to <code class="calibre21">system.time()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">system.time</code><code class="calibre21">({</code>
<code class="o">+</code>         n <code class="o">&lt;-</code> <code class="o">1000</code>
<code class="o">+</code>         r <code class="o">&lt;-</code> <code class="kt">numeric</code><code class="calibre21">(</code>n<code class="calibre21">)</code>
<code class="o">+</code>         <code class="kc">for</code><code class="calibre21">(</code>i <code class="kc">in</code> <code class="o">1</code><code class="o">:</code>n<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>                 x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code>n<code class="calibre21">)</code>
<code class="o">+</code>                 r<code class="calibre21">[</code>i<code class="calibre21">]</code> <code class="o">&lt;-</code> <code class="kp">mean</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">}</code>
<code class="o">+</code> <code class="calibre21">})</code>
   user  system elapsed 
  <code class="o">0.075</code>   <code class="o">0.002</code>   <code class="o">0.078</code> 
</pre></div>

</figure>

<p class="calibre2">If your expression is getting pretty long (more than 2 or 3 lines), it might be better to either break it into smaller pieces or to use the profiler. The problem is that if the expression is too long, you wonât be able to identify which part of the code is causing the bottleneck.</p>

<h3 id="calibre_link-148" class="calibre19">
<span class="section-number">21.3 </span>The R Profiler</h3>

<p class="calibre2">
  <a href="https://youtu.be/BZVcMPtlJ4A">Watch a video of this section</a>
</p>

<p class="calibre2">Using <code class="calibre21">system.time()</code> allows you to test certain functions or code blocks to see if they are taking excessive amounts of time. However, this approach assumes that you already know where the problem is and can call <code class="calibre21">system.time()</code> on it that piece of code. What if you donât know where to start? </p>

<p class="calibre2">This is where the profiler comes in handy. The <code class="calibre21">Rprof()</code> function starts the profiler in R. Note that R must be compiled with profiler support (but this is usually the case). In conjunction with <code class="calibre21">Rprof()</code>, we will use the <code class="calibre21">summaryRprof()</code> function which summarizes the output from <code class="calibre21">Rprof()</code> (otherwise itâs not really readable).
Note that you should NOT use <code class="calibre21">system.time()</code> and <code class="calibre21">Rprof()</code> together, or you will be sad.</p>

<p class="calibre2"><code class="calibre21">Rprof()</code> keeps track of the function call stack at regularly sampled intervals and tabulates how much time is spent inside each function. By default, the profiler samples the function call stack every 0.02 seconds. This means that if your code runs very quickly (say, under 0.02 seconds), the profiler is not useful. But of your code runs that fast, you probably donât need the profiler.</p>

<p class="calibre2">The profiler is started by calling the <code class="calibre21">Rprof()</code> function.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> Rprof<code class="calibre21">()</code>    <code class="c">## Turn on the profiler</code>
</pre></div>

</figure>

<p class="calibre2">You donât need any other arguments. By default it will write its output to a file called <code class="calibre21">Rprof.out</code>. You can specify the name of the output file if you donât want to use this default.</p>

<p class="calibre2">Once you call the <code class="calibre21">Rprof()</code> function, everything that you do from then on will be measured by the profiler. Therefore, you usually only want to run a single R function or expression once you turn on the profiler and then immediately turn it off. The reason is that if you mix too many function calls together when running the profiler, all of the results will be mixed together and you wonât be able to sort out where the bottlenecks are. In reality, I usually only run a single function with the profiler on.</p>

<p class="calibre2">The profiler can be turned off by passing <code class="calibre21">NULL</code> to <code class="calibre21">Rprof()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> Rprof<code class="calibre21">(</code><code class="kc">NULL</code><code class="calibre21">)</code>    <code class="c">## Turn off the profiler</code>
</pre></div>

</figure>

<p class="calibre2">The raw output from the profiler looks something like this. Here Iâm calling the <code class="calibre21">lm()</code> function on some data with the profiler running.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="c">## lm(y ~ x)</code>

sample.interval<code class="o">=</code><code class="o">10000</code>
<code class="s">"list"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"list"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"list"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"list"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"na.omit"</code> <code class="s">"model.frame.default"</code> <code class="s">"model.frame"</code> <code class="s">"eval"</code> <code class="s">"eval"</code> <code class="s">"lm"</code> 
<code class="s">"lm.fit"</code> <code class="s">"lm"</code> 
<code class="s">"lm.fit"</code> <code class="s">"lm"</code> 
<code class="s">"lm.fit"</code> <code class="s">"lm"</code> 
</pre></div>

</figure>

<p class="calibre2">At each line of the output, the profiler writes out the function call stack. For example, on the very first line of the output you can see that the code is 8 levels deep in the call stack. This is where you need the <code class="calibre21">summaryRprof()</code> function to help you interpret this data.</p>

<h3 id="calibre_link-149" class="calibre19">
<span class="section-number">21.4 </span>Using <code class="calibre11">summaryRprof()</code>
</h3>

<p class="calibre2">The <code class="calibre21">summaryRprof()</code> function tabulates the R profiler output and calculates how much time is spent in which function. There are two methods for normalizing the data.</p>

<ul class="calibre20">
  <li class="calibre14">âby.totalâ divides the time spend in each function by the total run time</li>
  <li class="calibre14">âby.selfâ does the same as âby.totalâ but first subtracts out time spent in functions above the current function in the call stack. I personally find this output to be much more useful.</li>
</ul>

<p class="calibre2">Here is what <code class="calibre21">summaryRprof()</code> reports in the âby.totalâ output.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">$</code>by.total
                        total.time total.pct self.time self.pct
<code class="s">"lm"</code>                          <code class="o">7.41</code>    <code class="o">100.00</code>      <code class="o">0.30</code>     <code class="o">4.05</code>
<code class="s">"lm.fit"</code>                      <code class="o">3.50</code>     <code class="o">47.23</code>      <code class="o">2.99</code>    <code class="o">40.35</code>
<code class="s">"model.frame.default"</code>         <code class="o">2.24</code>     <code class="o">30.23</code>      <code class="o">0.12</code>     <code class="o">1.62</code>
<code class="s">"eval"</code>                        <code class="o">2.24</code>     <code class="o">30.23</code>      <code class="o">0.00</code>     <code class="o">0.00</code>
<code class="s">"model.frame"</code>                 <code class="o">2.24</code>     <code class="o">30.23</code>      <code class="o">0.00</code>     <code class="o">0.00</code>
<code class="s">"na.omit"</code>                     <code class="o">1.54</code>     <code class="o">20.78</code>      <code class="o">0.24</code>     <code class="o">3.24</code>
<code class="s">"na.omit.data.frame"</code>          <code class="o">1.30</code>     <code class="o">17.54</code>      <code class="o">0.49</code>     <code class="o">6.61</code>
<code class="s">"lapply"</code>                      <code class="o">1.04</code>     <code class="o">14.04</code>      <code class="o">0.00</code>     <code class="o">0.00</code>
<code class="s">"[.data.frame"</code>                <code class="o">1.03</code>     <code class="o">13.90</code>      <code class="o">0.79</code>    <code class="o">10.66</code>
<code class="s">"["</code>                           <code class="o">1.03</code>     <code class="o">13.90</code>      <code class="o">0.00</code>     <code class="o">0.00</code>
<code class="s">"as.list.data.frame"</code>          <code class="o">0.82</code>     <code class="o">11.07</code>      <code class="o">0.82</code>    <code class="o">11.07</code>
<code class="s">"as.list"</code>                     <code class="o">0.82</code>     <code class="o">11.07</code>      <code class="o">0.00</code>     <code class="o">0.00</code>
</pre></div>

</figure>

<p class="calibre2">Because <code class="calibre21">lm()</code> is the function that I called from the command line, of course 100% of the time is spent somewhere in that function. However, what this doesnât show is that if <code class="calibre21">lm()</code> immediately calls another function (like <code class="calibre21">lm.fit()</code>, which does most of the heavy lifting), then in reality, most of the time is spent in <em class="calibre17">that</em> function, rather than in the top-level <code class="calibre21">lm()</code> function.</p>

<p class="calibre2">The âby.selfâ output corrects for this discrepancy.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">$</code>by.self
                        self.time self.pct total.time total.pct
<code class="s">"lm.fit"</code>                     <code class="o">2.99</code>    <code class="o">40.35</code>       <code class="o">3.50</code>     <code class="o">47.23</code>
<code class="s">"as.list.data.frame"</code>         <code class="o">0.82</code>    <code class="o">11.07</code>       <code class="o">0.82</code>     <code class="o">11.07</code>
<code class="s">"[.data.frame"</code>               <code class="o">0.79</code>    <code class="o">10.66</code>       <code class="o">1.03</code>     <code class="o">13.90</code>
<code class="s">"structure"</code>                  <code class="o">0.73</code>     <code class="o">9.85</code>       <code class="o">0.73</code>      <code class="o">9.85</code>
<code class="s">"na.omit.data.frame"</code>         <code class="o">0.49</code>     <code class="o">6.61</code>       <code class="o">1.30</code>     <code class="o">17.54</code>
<code class="s">"list"</code>                       <code class="o">0.46</code>     <code class="o">6.21</code>       <code class="o">0.46</code>      <code class="o">6.21</code>
<code class="s">"lm"</code>                         <code class="o">0.30</code>     <code class="o">4.05</code>       <code class="o">7.41</code>    <code class="o">100.00</code>
<code class="s">"model.matrix.default"</code>       <code class="o">0.27</code>     <code class="o">3.64</code>       <code class="o">0.79</code>     <code class="o">10.66</code>
<code class="s">"na.omit"</code>                    <code class="o">0.24</code>     <code class="o">3.24</code>       <code class="o">1.54</code>     <code class="o">20.78</code>
<code class="s">"as.character"</code>               <code class="o">0.18</code>     <code class="o">2.43</code>       <code class="o">0.18</code>      <code class="o">2.43</code>
<code class="s">"model.frame.default"</code>        <code class="o">0.12</code>     <code class="o">1.62</code>       <code class="o">2.24</code>     <code class="o">30.23</code>
<code class="s">"anyDuplicated.default"</code>      <code class="o">0.02</code>     <code class="o">0.27</code>       <code class="o">0.02</code>      <code class="o">0.27</code>
</pre></div>

</figure>

<p class="calibre2">Now you can see that only about 4% of the runtime is spent in the actual <code class="calibre21">lm()</code> function, whereas over 40% of the time is spent in <code class="calibre21">lm.fit()</code>. In this case, this is no surprise since the <code class="calibre21">lm.fit()</code> function is the function that actually fits the linear model. </p>

<p class="calibre2">You can see that a reasonable amount of time is spent in functions not necessarily associated with linear modeling (i.e. <code class="calibre21">as.list.data.frame</code>, <code class="calibre21">[.data.frame</code>). This is because the <code class="calibre21">lm()</code> function does a bit of pre-processing and checking before it actually fits the model. This is common with modeling functions&mdash;the preprocessing and checking is useful to see if there are any errors. But those two functions take up over 1.5 seconds of runtime. What if you want to fit this model 10,000 times? Youâre going to be spending a lot of time in preprocessing and checking.</p>

<p class="calibre2">The final bit of output that <code class="calibre21">summaryRprof()</code> provides is the sampling interval and the total runtime.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">$</code>sample.interval
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.02</code>

<code class="o">$</code>sampling.time
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">7.41</code>
</pre></div>

</figure>

<h3 id="calibre_link-150" class="calibre19">
<span class="section-number">21.5 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">Rprof()</code> runs the profiler for performance of analysis of R code</li>
  <li class="calibre14">
<code class="calibre21">summaryRprof()</code> summarizes the output of <code class="calibre21">Rprof()</code> and gives
percent of time spent in each function (with two types of
normalization)</li>
  <li class="calibre14">Good to break your code into functions so that the profiler can give
useful information about where time is being spent</li>
  <li class="calibre14">C or Fortran code is not profiled</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-179">
<div class="calibre5">
<h2 id="calibre_link-151" class="calibre15">
<span class="section-number">22. </span>Simulation</h2>

<h3 id="calibre_link-152" class="calibre19">
<span class="section-number">22.1 </span>Generating Random Numbers</h3>

<p class="calibre2">
  <a href="https://youtu.be/tzz4flrajr0">Watch a video of this section</a>
</p>

<p class="calibre2">Simulation is an important (and big) topic for both statistics and for a variety of other areas where there is a need to introduce randomness. Sometimes you want to implement a statistical procedure that requires random number generation or sampling (i.e. Markov chain Monte Carlo, the bootstrap, random forests, bagging) and sometimes you want to simulate a system and random number generators can be used to model random inputs.</p>

<p class="calibre2">R comes with a set of pseuodo-random number generators that allow you to simulate from well-known probability distributions like the Normal, Poisson, and binomial. Some example functions for probability distributions in R</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">rnorm</code>: generate random Normal variates with a given mean and standard deviation</li>
  <li class="calibre14">
<code class="calibre21">dnorm</code>: evaluate the Normal probability density (with a given mean/SD) at a point (or vector of points)</li>
  <li class="calibre14">
<code class="calibre21">pnorm</code>: evaluate the cumulative distribution function for a Normal distribution </li>
  <li class="calibre14">
<code class="calibre21">rpois</code>: generate random Poisson variates with a given rate</li>
</ul>

<p class="calibre2">For each probability distribution there are typically four functions available that start with a ârâ, âdâ, âpâ, and âqâ. The ârâ function is the one that actually simulates randon numbers from that distribution. The other functions are prefixed with a</p>

<ul class="calibre20">
  <li class="calibre14">
<code class="calibre21">d</code> for density</li>
  <li class="calibre14">
<code class="calibre21">r</code> for random number generation </li>
  <li class="calibre14">
<code class="calibre21">p</code> for cumulative distribution</li>
  <li class="calibre14">
<code class="calibre21">q</code> for quantile function (inverse cumulative distribution)</li>
</ul>

<p class="calibre2">If youâre only interested in simulating random numbers, then you will likely only need the ârâ functions and not the others. However, if you intend to simulate from arbitrary probability distributions using something like rejection sampling, then you will need the other functions too.</p>

<p class="calibre2">Probably the most common probability distribution to work with the is the Normal distribution (also known as the Gaussian). Working with the Normal distributions requires using these four functions</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>dnorm<code class="calibre21">(</code>x<code class="calibre21">,</code> mean <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sd <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> log <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
pnorm<code class="calibre21">(</code><code class="kp">q</code><code class="calibre21">,</code> mean <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sd <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> lower.tail <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> log.p <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
qnorm<code class="calibre21">(</code>p<code class="calibre21">,</code> mean <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sd <code class="o">=</code> <code class="o">1</code><code class="calibre21">,</code> lower.tail <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">,</code> log.p <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>
rnorm<code class="calibre21">(</code>n<code class="calibre21">,</code> mean <code class="o">=</code> <code class="o">0</code><code class="calibre21">,</code> sd <code class="o">=</code> <code class="o">1</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Here we simulate standard Normal random numbers with mean 0 and standard deviation 1.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Simulate standard Normal random numbers</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">)</code>   
<code class="o">&gt;</code> x
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">0.01874617</code> <code class="o">-0.18425254</code> <code class="o">-1.37133055</code> <code class="o">-0.59916772</code>  <code class="o">0.29454513</code>  <code class="o">0.38979430</code>
 <code class="calibre21">[</code><code class="o">7</code><code class="calibre21">]</code> <code class="o">-1.20807618</code> <code class="o">-0.36367602</code> <code class="o">-1.62667268</code> <code class="o">-0.25647839</code>
</pre></div>

</figure>

<p class="calibre2">We can modify the default parameters to simulate numbers with mean 20 and standard deviation 2.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">20</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code> 
<code class="o">&gt;</code> x
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">22.20356</code> <code class="o">21.51156</code> <code class="o">19.52353</code> <code class="o">21.97489</code> <code class="o">21.48278</code> <code class="o">20.17869</code> <code class="o">18.09011</code> <code class="o">19.60970</code>
 <code class="calibre21">[</code><code class="o">9</code><code class="calibre21">]</code> <code class="o">21.85104</code> <code class="o">20.96596</code>
<code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>x<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max. 
  <code class="o">18.09</code>   <code class="o">19.75</code>   <code class="o">21.22</code>   <code class="o">20.74</code>   <code class="o">21.77</code>   <code class="o">22.20</code> 
</pre></div>

</figure>

<p class="calibre2">If you wanted to know what was the probability of a random Normal variable of being less than, say, 2, you could use the <code class="calibre21">pnorm()</code> function to do that calculation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> pnorm<code class="calibre21">(</code><code class="o">2</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.9772499</code>
</pre></div>

</figure>

<p class="calibre2">You never know when that calculation will come in handy.</p>

<h3 id="calibre_link-153" class="calibre19">
<span class="section-number">22.2 </span>Setting the random number seed</h3>

<p class="calibre2">When simulating any random numbers it is essential to set the <em class="calibre17">random number seed</em>. Setting the random number seed with <code class="calibre21">set.seed()</code> ensures reproducibility of the sequence of random numbers.</p>

<p class="calibre2">For example, I can generate 5 Normal random numbers with <code class="calibre21">rnorm()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> rnorm<code class="calibre21">(</code><code class="o">5</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.6264538</code>  <code class="o">0.1836433</code> <code class="o">-0.8356286</code>  <code class="o">1.5952808</code>  <code class="o">0.3295078</code>
</pre></div>

</figure>

<p class="calibre2">Note that if I call <code class="calibre21">rnorm()</code> again I will of course get a different set of 5 random numbers.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> rnorm<code class="calibre21">(</code><code class="o">5</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.8204684</code>  <code class="o">0.4874291</code>  <code class="o">0.7383247</code>  <code class="o">0.5757814</code> <code class="o">-0.3053884</code>
</pre></div>

</figure>

<p class="calibre2">If I want to reproduce the original set of random numbers, I can just reset the seed with <code class="calibre21">set.seed()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> rnorm<code class="calibre21">(</code><code class="o">5</code><code class="calibre21">)</code>    <code class="c">## Same as before</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">-0.6264538</code>  <code class="o">0.1836433</code> <code class="o">-0.8356286</code>  <code class="o">1.5952808</code>  <code class="o">0.3295078</code>
</pre></div>

</figure>

<p class="calibre2">In general, you should <strong class="calibre16">always set the random number seed when conducting a simulation!</strong> Otherwise, you will not be able to reconstruct the exact numbers that you produced in an analysis.</p>

<p class="calibre2">It is possible to generate random numbers from other probability distributions like the Poisson. The Poisson distribution is commonly used to model data that come in the form of counts. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> rpois<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">)</code>    <code class="c">## Counts with a mean of 1</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0</code> <code class="o">0</code> <code class="o">1</code> <code class="o">1</code> <code class="o">2</code> <code class="o">1</code> <code class="o">1</code> <code class="o">4</code> <code class="o">1</code> <code class="o">2</code>
<code class="o">&gt;</code> rpois<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>    <code class="c">## Counts with a mean of 2</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">4</code> <code class="o">1</code> <code class="o">2</code> <code class="o">0</code> <code class="o">1</code> <code class="o">1</code> <code class="o">0</code> <code class="o">1</code> <code class="o">4</code> <code class="o">1</code>
<code class="o">&gt;</code> rpois<code class="calibre21">(</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">20</code><code class="calibre21">)</code>   <code class="c">## Counts with a mean of 20</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">19</code> <code class="o">19</code> <code class="o">24</code> <code class="o">23</code> <code class="o">22</code> <code class="o">24</code> <code class="o">23</code> <code class="o">20</code> <code class="o">11</code> <code class="o">22</code>
</pre></div>

</figure>

<h3 id="calibre_link-154" class="calibre19">
<span class="section-number">22.3 </span>Simulating a Linear Model</h3>

<p class="calibre2">
  <a href="https://youtu.be/p7kSSSsv4ms">Watch a video of this section</a>
</p>

<p class="calibre2">Simulating random numbers is useful but sometimes we want to simulate values that come from a specific <em class="calibre17">model</em>. For that we need to specify the model and then simulate from it using the functions described above.</p>

<p class="calibre2">Suppose we want to simulate from the following linear model</p>

<img src="images/000002.png" alt="y = \beta_0 + \beta_1 x + \varepsilon" class="block-equation" />

<p class="calibre2">where <img src="images/000016.png" alt="\varepsilon\sim\mathcal{N}(0,2^2)" class="inline-equation" width="97" />. Assume <img src="images/000028.png" alt="x\sim\mathcal{N}(0,1^2)" class="inline-equation" width="99" />, <img src="images/000006.png" alt="\beta_0=0.5" class="inline-equation" width="64" /> and <img src="images/000019.png" alt="\beta_1=2" class="inline-equation" width="50" />. The variable <code class="calibre21">x</code> might represent an important predictor of the outcome <code class="calibre21">y</code>. Hereâs how we could do that in R.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Always set your seed!</code>
<code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">20</code><code class="calibre21">)</code>             
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Simulate predictor variable</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">)</code>          
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Simulate the error term</code>
<code class="o">&gt;</code> e <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">0</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>    
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Compute the outcome via the model</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">0.5</code> <code class="o">+</code> <code class="o">2</code> <code class="o">*</code> x <code class="o">+</code> e     
<code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>y<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max. 
<code class="o">-6.4084</code> <code class="o">-1.5402</code>  <code class="o">0.6789</code>  <code class="o">0.6893</code>  <code class="o">2.9303</code>  <code class="o">6.5052</code> 
</pre></div>

</figure>

<p class="calibre2">We can plot the results of the model simulation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> plot<code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000013.png" alt="plot of chunk Linear Model" class="calibre31" />
    <figcaption class="calibre32">plot of chunk Linear Model</figcaption>
  </figure>
</div>


<p class="calibre2">What if we wanted to simulate a predictor variable <code class="calibre21">x</code> that is binary instead of having a Normal distribution. We can use the <code class="calibre21">rbinom()</code> function to simulate binary random variables.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">10</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> rbinom<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">,</code> <code class="o">0.5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>x<code class="calibre21">)</code>    <code class="c">## 'x' is now 0s and 1s</code>
 int <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">100</code><code class="calibre21">]</code> <code class="o">1</code> <code class="o">0</code> <code class="o">0</code> <code class="o">1</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">0</code> <code class="o">1</code> <code class="o">0</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Then we can procede with the rest of the model as before.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> e <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="o">0</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">)</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="o">0.5</code> <code class="o">+</code> <code class="o">2</code> <code class="o">*</code> x <code class="o">+</code> e
<code class="o">&gt;</code> plot<code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000031.png" alt="plot of chunk Linear Model Binary" class="calibre31" />
    <figcaption class="calibre32">plot of chunk Linear Model Binary</figcaption>
  </figure>
</div>


<p class="calibre2">We can also simulate from <em class="calibre17">generalized linear model</em> where the errors are no longer from a Normal distribution but come from some other distribution. For examples, suppose we want to simulate from a Poisson log-linear model where</p>

<img src="images/000033.png" alt="Y \sim Poisson(\mu)" class="block-equation1" />

<img src="images/000010.png" alt="\log \mu = \beta_0 + \beta_1 x" class="block-equation1" />

<p class="calibre2">and <img src="images/000023.png" alt="\beta_0=0.5" class="inline-equation" width="64" /> and <img src="images/000003.png" alt="\beta_1=0.3" class="inline-equation" width="64" />. We need to use the <code class="calibre21">rpois()</code> function for this</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Simulate the predictor variable as before</code>
<code class="o">&gt;</code> x <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">)</code>    
</pre></div>

</figure>

<p class="calibre2">Now we need to compute the log mean of the model and then exponentiate it to get the mean to pass to <code class="calibre21">rpois()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> log.mu <code class="o">&lt;-</code> <code class="o">0.5</code> <code class="o">+</code> <code class="o">0.3</code> <code class="o">*</code> x
<code class="o">&gt;</code> y <code class="o">&lt;-</code> rpois<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">,</code> <code class="kp">exp</code><code class="calibre21">(</code>log.mu<code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>y<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max. 
   <code class="o">0.00</code>    <code class="o">1.00</code>    <code class="o">1.00</code>    <code class="o">1.55</code>    <code class="o">2.00</code>    <code class="o">6.00</code> 
<code class="o">&gt;</code> plot<code class="calibre21">(</code>x<code class="calibre21">,</code> y<code class="calibre21">)</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000014.png" alt="plot of chunk Poisson Log-Linear Model" class="calibre31" />
    <figcaption class="calibre32">plot of chunk Poisson Log-Linear Model</figcaption>
  </figure>
</div>


<p class="calibre2">You can build arbitrarily complex models like this by simulating more predictors or making transformations of those predictors (e.g. squaring, log transformations, etc.).</p>

<h3 id="calibre_link-155" class="calibre19">
<span class="section-number">22.4 </span>Random Sampling</h3>

<p class="calibre2">
  <a href="https://youtu.be/-7GA10KWDJg">Watch a video of this section</a>
</p>

<p class="calibre2">The <code class="calibre21">sample()</code> function draws randomly from a specified set of (scalar) objects allowing you to sample from arbitrary distributions of numbers.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">9</code> <code class="o">4</code> <code class="o">7</code> <code class="o">1</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">2</code> <code class="o">7</code> <code class="o">3</code> <code class="o">6</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Doesn't have to be numbers</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="kc">letters</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">)</code>    
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"r"</code> <code class="s">"s"</code> <code class="s">"a"</code> <code class="s">"u"</code> <code class="s">"w"</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Do a random permutation</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">)</code>          
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">10</code>  <code class="o">6</code>  <code class="o">9</code>  <code class="o">2</code>  <code class="o">1</code>  <code class="o">5</code>  <code class="o">8</code>  <code class="o">4</code>  <code class="o">3</code>  <code class="o">7</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">5</code> <code class="o">10</code>  <code class="o">2</code>  <code class="o">8</code>  <code class="o">6</code>  <code class="o">1</code>  <code class="o">4</code>  <code class="o">3</code>  <code class="o">9</code>  <code class="o">7</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Sample w/replacement</code>
<code class="o">&gt;</code> <code class="kp">sample</code><code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> replace <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>  
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code>  <code class="o">3</code>  <code class="o">6</code> <code class="o">10</code> <code class="o">10</code>  <code class="o">6</code>  <code class="o">4</code>  <code class="o">4</code> <code class="o">10</code>  <code class="o">9</code>  <code class="o">7</code>
</pre></div>

</figure>

<p class="calibre2">To sample more complicated things, such as rows from a data frame or a list, you can sample the indices into an object rather than the elements of the object itself.</p>

<p class="calibre2">Hereâs how you can sample rows from a data frame.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>datasets<code class="calibre21">)</code>
<code class="o">&gt;</code> data<code class="calibre21">(</code>airquality<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>airquality<code class="calibre21">)</code>
  Ozone Solar.R Wind Temp Month Day
<code class="o">1</code>    <code class="o">41</code>     <code class="o">190</code>  <code class="o">7.4</code>   <code class="o">67</code>     <code class="o">5</code>   <code class="o">1</code>
<code class="o">2</code>    <code class="o">36</code>     <code class="o">118</code>  <code class="o">8.0</code>   <code class="o">72</code>     <code class="o">5</code>   <code class="o">2</code>
<code class="o">3</code>    <code class="o">12</code>     <code class="o">149</code> <code class="o">12.6</code>   <code class="o">74</code>     <code class="o">5</code>   <code class="o">3</code>
<code class="o">4</code>    <code class="o">18</code>     <code class="o">313</code> <code class="o">11.5</code>   <code class="o">62</code>     <code class="o">5</code>   <code class="o">4</code>
<code class="o">5</code>    <code class="kc">NA</code>      <code class="kc">NA</code> <code class="o">14.3</code>   <code class="o">56</code>     <code class="o">5</code>   <code class="o">5</code>
<code class="o">6</code>    <code class="o">28</code>      <code class="kc">NA</code> <code class="o">14.9</code>   <code class="o">66</code>     <code class="o">5</code>   <code class="o">6</code>
</pre></div>

</figure>

<p class="calibre2">Now we just need to create the index vector indexing the rows of the data frame and sample directly from that index vector.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">20</code><code class="calibre21">)</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Create index vector</code>
<code class="o">&gt;</code> idx <code class="o">&lt;-</code> <code class="kp">seq_len</code><code class="calibre21">(</code><code class="kp">nrow</code><code class="calibre21">(</code>airquality<code class="calibre21">))</code>    
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Sample from the index vector</code>
<code class="o">&gt;</code> samp <code class="o">&lt;-</code> <code class="kp">sample</code><code class="calibre21">(</code>idx<code class="calibre21">,</code> <code class="o">6</code><code class="calibre21">)</code>              
<code class="o">&gt;</code> airquality<code class="calibre21">[</code>samp<code class="calibre21">,</code> <code class="calibre21">]</code>
    Ozone Solar.R Wind Temp Month Day
<code class="o">107</code>    <code class="kc">NA</code>      <code class="o">64</code> <code class="o">11.5</code>   <code class="o">79</code>     <code class="o">8</code>  <code class="o">15</code>
<code class="o">120</code>    <code class="o">76</code>     <code class="o">203</code>  <code class="o">9.7</code>   <code class="o">97</code>     <code class="o">8</code>  <code class="o">28</code>
<code class="o">130</code>    <code class="o">20</code>     <code class="o">252</code> <code class="o">10.9</code>   <code class="o">80</code>     <code class="o">9</code>   <code class="o">7</code>
<code class="o">98</code>     <code class="o">66</code>      <code class="kc">NA</code>  <code class="o">4.6</code>   <code class="o">87</code>     <code class="o">8</code>   <code class="o">6</code>
<code class="o">29</code>     <code class="o">45</code>     <code class="o">252</code> <code class="o">14.9</code>   <code class="o">81</code>     <code class="o">5</code>  <code class="o">29</code>
<code class="o">45</code>     <code class="kc">NA</code>     <code class="o">332</code> <code class="o">13.8</code>   <code class="o">80</code>     <code class="o">6</code>  <code class="o">14</code>
</pre></div>

</figure>

<p class="calibre2">Other more complex objects can be sampled in this way, as long as thereâs a way to index the sub-elements of the object.</p>

<h3 id="calibre_link-156" class="calibre19">
<span class="section-number">22.5 </span>Summary</h3>

<ul class="calibre20">
  <li class="calibre14">Drawing samples from specific probability distributions can be done with ârâ functions</li>
  <li class="calibre14">Standard distributions are built in: Normal, Poisson, Binomial, Exponential, Gamma, etc.</li>
  <li class="calibre14">The <code class="calibre21">sample()</code> function can be used to draw random samples from arbitrary vectors</li>
  <li class="calibre14">Setting the random number generator seed via <code class="calibre21">set.seed()</code> is critical for reproducibility</li>
</ul>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-175">
<div class="calibre5">
<h2 id="calibre_link-157" class="calibre15">
<span class="section-number">23. </span>Data Analysis Case Study: Changes in Fine Particle Air Pollution in the U.S.</h2>

<p class="calibre2">This chapter presents an example data analysis looking at changes in fine particulate matter (PM) air pollution in the United States using the Environmental Protection Agencies freely available national monitoring data. The purpose of the chapter is to just show how the various tools that we have covered in this book can be used to read, manipulate, and summarize data so that you can develop statistical evidence for relevant real-world questions. </p>

<p class="calibre2">
  <a href="https://youtu.be/VE-6bQvyfTQ">Watch a video of this chapter</a>
</p>

<h3 id="calibre_link-158" class="calibre19">
<span class="section-number">23.1 </span>Synopsis</h3>

<p class="calibre2">In this chapter we aim to describe the changes in fine particle (PM2.5) outdoor air pollution in the United States between the years 1999 and 2012. Our overall hypothesis is that outdoor PM2.5 has decreased on average across the U.S. due to nationwide regulatory requirements arising from the Clean Air Act. To investigate this hypothesis, we obtained PM2.5 data from the U.S. Environmental Protection Agency which is collected from monitors sited across the U.S. We specifically obtained data for the years 1999 and 2012 (the most recent complete year available). From these data, we found that, on average across the U.S., levels of PM2.5 have decreased between 1999 and 2012. At one individual monitor, we found that levels have decreased and that the variability of PM2.5 has decreased. Most individual states also experienced decreases in PM2.5, although some states saw increases.</p>

<h3 id="calibre_link-159" class="calibre19">
<span class="section-number">23.2 </span>Loading and Processing the Raw Data</h3>

<p class="calibre2">From the <a href="http://aqsdr1.epa.gov/aqsweb/aqstmp/airdata/download_files.html">EPA Air Quality System</a> we obtained data on fine particulate matter air pollution (PM2.5) that is monitored across the U.S. as part of the nationwide PM monitoring network. We obtained the files for the years 1999 and 2012.</p>

<h4 id="calibre_link-189" class="calibre19">Reading in the 1999 data</h4>

<p class="calibre2">We first read in the 1999 data from the raw text file included in the zip archive. The data is a delimited file were fields are delimited with the <code class="calibre21">|</code> character and missing values are coded as blank fields. We skip some commented lines in the beginning of the file and initially we do not read the header data.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> pm0 <code class="o">&lt;-</code> read.table<code class="calibre21">(</code><code class="s">"pm25_data/RD_501_88101_1999-0.txt"</code><code class="calibre21">,</code> comment.char <code class="o">=</code> <code class="s">"#"</code><code class="calibre21">,</code> header <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> s\
ep <code class="o">=</code> <code class="s">"|"</code><code class="calibre21">,</code> na.strings <code class="o">=</code> <code class="s">""</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">After reading in the 1999 we check the first few rows (there are 117,421) rows in this dataset. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">dim</code><code class="calibre21">(</code>pm0<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">117421</code>     <code class="o">28</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>pm0<code class="calibre21">[,</code> <code class="o">1</code><code class="o">:</code><code class="o">13</code><code class="calibre21">])</code>
  V1 V2 V3 V4 V5    V6 V7 V8  V9 V10      V11   V12    V13
<code class="o">1</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990103</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code>     <code class="kc">NA</code>
<code class="o">2</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990106</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code>     <code class="kc">NA</code>
<code class="o">3</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990109</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code>     <code class="kc">NA</code>
<code class="o">4</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990112</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code>  <code class="o">8.841</code>
<code class="o">5</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990115</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code> <code class="o">14.920</code>
<code class="o">6</code> RD  I  <code class="o">1</code> <code class="o">27</code>  <code class="o">1</code> <code class="o">88101</code>  <code class="o">1</code>  <code class="o">7</code> <code class="o">105</code> <code class="o">120</code> <code class="o">19990118</code> <code class="o">00</code><code class="o">:</code><code class="o">00</code>  <code class="o">3.878</code>
</pre></div>

</figure>

<p class="calibre2">We then attach the column headers to the dataset and make sure that they are properly formated for R data frames.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> cnames <code class="o">&lt;-</code> <code class="kp">readLines</code><code class="calibre21">(</code><code class="s">"pm25_data/RD_501_88101_1999-0.txt"</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> cnames <code class="o">&lt;-</code> <code class="kp">strsplit</code><code class="calibre21">(</code>cnames<code class="calibre21">,</code> <code class="s">"|"</code><code class="calibre21">,</code> fixed <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="c">## Ensure names are properly formatted</code>
<code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>pm0<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kp">make.names</code><code class="calibre21">(</code>cnames<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]])</code>  
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>pm0<code class="calibre21">[,</code> <code class="o">1</code><code class="o">:</code><code class="o">13</code><code class="calibre21">])</code>
  X..RD Action.Code State.Code County.Code Site.ID Parameter POC
<code class="o">1</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
<code class="o">2</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
<code class="o">3</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
<code class="o">4</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
<code class="o">5</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
<code class="o">6</code>    RD           I          <code class="o">1</code>          <code class="o">27</code>       <code class="o">1</code>     <code class="o">88101</code>   <code class="o">1</code>
  Sample.Duration Unit Method     Date Start.Time Sample.Value
<code class="o">1</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990103</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>           <code class="kc">NA</code>
<code class="o">2</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990106</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>           <code class="kc">NA</code>
<code class="o">3</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990109</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>           <code class="kc">NA</code>
<code class="o">4</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990112</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>        <code class="o">8.841</code>
<code class="o">5</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990115</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>       <code class="o">14.920</code>
<code class="o">6</code>               <code class="o">7</code>  <code class="o">105</code>    <code class="o">120</code> <code class="o">19990118</code>      <code class="o">00</code><code class="o">:</code><code class="o">00</code>        <code class="o">3.878</code>
</pre></div>

</figure>

<p class="calibre2">The column we are interested in is the <code class="calibre21">Sample.Value</code> column which contains the PM2.5 measurements. Here we extract that column and print a brief summary.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> x0 <code class="o">&lt;-</code> pm0<code class="o">$</code>Sample.Value
<code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>x0<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max.    <code class="kc">NA</code><code class="s">'</code><code class="err">s </code>
   <code class="o">0.00</code>    <code class="o">7.20</code>   <code class="o">11.50</code>   <code class="o">13.74</code>   <code class="o">17.90</code>  <code class="o">157.10</code>   <code class="o">13217</code> 
</pre></div>

</figure>

<p class="calibre2">Missing values are a common problem with environmental data and so we check to se what proportion of the observations are missing (i.e. coded as <code class="calibre21">NA</code>).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">mean</code><code class="calibre21">(</code><code class="kp">is.na</code><code class="calibre21">(</code>x0<code class="calibre21">))</code>  <code class="c">## Are missing values important here?</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.1125608</code>
</pre></div>

</figure>

<p class="calibre2">Because the proportion of missing values is relatively low (0.1125608), we choose to ignore missing values for now.</p>

<h4 id="calibre_link-190" class="calibre19">Reading in the 2012 data</h4>

<p class="calibre2">We then read in the 2012 data in the same manner in which we read the 1999 data (the data files are in the same format). </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> pm1 <code class="o">&lt;-</code> read.table<code class="calibre21">(</code><code class="s">"pm25_data/RD_501_88101_2012-0.txt"</code><code class="calibre21">,</code> comment.char <code class="o">=</code> <code class="s">"#"</code><code class="calibre21">,</code> 
<code class="o">+</code>                   header <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">"|"</code><code class="calibre21">,</code> na.strings <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> nrow <code class="o">=</code> <code class="o">1304290</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">We also set the column names (they are the same as the 1999 dataset) and extract the <code class="calibre21">Sample.Value</code> column from this dataset.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">names</code><code class="calibre21">(</code>pm1<code class="calibre21">)</code> <code class="o">&lt;-</code> <code class="kp">make.names</code><code class="calibre21">(</code>cnames<code class="calibre21">[[</code><code class="o">1</code><code class="calibre21">]])</code>
<code class="o">&gt;</code> x1 <code class="o">&lt;-</code> pm1<code class="o">$</code>Sample.Value
</pre></div>

</figure>

<h3 id="calibre_link-160" class="calibre19">
<span class="section-number">23.3 </span>Results</h3>

<h4 id="calibre_link-191" class="calibre19">Entire U.S. analysis</h4>

<p class="calibre2">In order to show aggregate changes in PM across the entire monitoring network, we can make boxplots of all monitor values in 1999 and 2012. Here, we take the log of the PM values to adjust for the skew in the data.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> boxplot<code class="calibre21">(</code><code class="kp">log2</code><code class="calibre21">(</code>x0<code class="calibre21">),</code> <code class="kp">log2</code><code class="calibre21">(</code>x1<code class="calibre21">))</code>
Warning <code class="kc">in</code> boxplot.default<code class="calibre21">(</code><code class="kp">log2</code><code class="calibre21">(</code>x0<code class="calibre21">),</code> <code class="kp">log2</code><code class="calibre21">(</code>x1<code class="calibre21">))</code><code class="o">:</code> NaNs produced
Warning <code class="kc">in</code> bplt<code class="calibre21">(</code>at<code class="calibre21">[</code>i<code class="calibre21">],</code> wid <code class="o">=</code> width<code class="calibre21">[</code>i<code class="calibre21">],</code> stats <code class="o">=</code> z<code class="o">$</code>stats<code class="calibre21">[,</code> i<code class="calibre21">],</code> out <code class="o">=</code> z<code class="o">$</code>out<code class="calibre21">[</code>z<code class="o">$</code>group
<code class="o">==</code> <code class="o">:</code> Outlier <code class="calibre21">(</code><code class="o">-</code><code class="kc">Inf</code><code class="calibre21">)</code> <code class="kc">in</code> boxplot <code class="o">1</code> is not drawn
Warning <code class="kc">in</code> bplt<code class="calibre21">(</code>at<code class="calibre21">[</code>i<code class="calibre21">],</code> wid <code class="o">=</code> width<code class="calibre21">[</code>i<code class="calibre21">],</code> stats <code class="o">=</code> z<code class="o">$</code>stats<code class="calibre21">[,</code> i<code class="calibre21">],</code> out <code class="o">=</code> z<code class="o">$</code>out<code class="calibre21">[</code>z<code class="o">$</code>group
<code class="o">==</code> <code class="o">:</code> Outlier <code class="calibre21">(</code><code class="o">-</code><code class="kc">Inf</code><code class="calibre21">)</code> <code class="kc">in</code> boxplot <code class="o">2</code> is not drawn
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000004.png" alt="plot of chunk unnamed-chunk-5" class="calibre31" />
    <figcaption class="calibre32">plot of chunk unnamed-chunk-5</figcaption>
  </figure>
</div>


<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>x0<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max.    <code class="kc">NA</code><code class="s">'s </code>
<code class="s">   0.00    7.20   11.50   13.74   17.90  157.10   13217 </code>
<code class="s">&gt; summary(x1)</code>
<code class="s">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA'</code>s 
 <code class="o">-10.00</code>    <code class="o">4.00</code>    <code class="o">7.63</code>    <code class="o">9.14</code>   <code class="o">12.00</code>  <code class="o">908.97</code>   <code class="o">73133</code> 
</pre></div>

</figure>

<p class="calibre2">Interestingly, from the summary of <code class="calibre21">x1</code> it appears there are some negative values of PM, which in general should not occur. We can investigate that somewhat to see if there is anything we should worry about.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> negative <code class="o">&lt;-</code> x1 <code class="o">&lt;</code> <code class="o">0</code>
<code class="o">&gt;</code> <code class="kp">mean</code><code class="calibre21">(</code>negative<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kp">T</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">0.0215034</code>
</pre></div>

</figure>

<p class="calibre2">There is a relatively small proportion of values that are negative, which is perhaps reassuring. In order to investigate this a step further we can extract the date of each measurement from the original data frame. The idea here is that perhaps negative values occur more often in some parts of the year than other parts. However, the original data are formatted as character strings so we convert them to Râs <code class="calibre21">Date</code> format for easier manipulation.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> dates <code class="o">&lt;-</code> pm1<code class="o">$</code>Date
<code class="o">&gt;</code> dates <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="kp">as.character</code><code class="calibre21">(</code>dates<code class="calibre21">),</code> <code class="s">"%Y%m%d"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">We can then extract the month from each of the dates with negative values and attempt to identify when negative values occur most often.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> missing.months <code class="o">&lt;-</code> <code class="kp">month.name</code><code class="calibre21">[</code><code class="kp">as.POSIXlt</code><code class="calibre21">(</code>dates<code class="calibre21">)</code><code class="o">$</code>mon <code class="o">+</code> <code class="o">1</code><code class="calibre21">]</code>
<code class="o">&gt;</code> tab <code class="o">&lt;-</code> <code class="kp">table</code><code class="calibre21">(</code><code class="kp">factor</code><code class="calibre21">(</code>missing.months<code class="calibre21">,</code> levels <code class="o">=</code> <code class="kp">month.name</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">round</code><code class="calibre21">(</code><code class="o">100</code> <code class="o">*</code> tab <code class="o">/</code> <code class="kp">sum</code><code class="calibre21">(</code>tab<code class="calibre21">))</code>

  January  February     March     April       May      June      July    August 
       <code class="o">15</code>        <code class="o">13</code>        <code class="o">15</code>        <code class="o">13</code>        <code class="o">14</code>        <code class="o">13</code>         <code class="o">8</code>         <code class="o">6</code> 
September   October  November  December 
        <code class="o">3</code>         <code class="o">0</code>         <code class="o">0</code>         <code class="o">0</code> 
</pre></div>

</figure>

<p class="calibre2">From the table above it appears that bulk of the negative values occur in the first six months of the year (January&ndash;June). However, beyond that simple observation, it is not clear why the negative values occur. That said, given the relatively low proportion of negative values, we will ignore them for now.</p>

<h4 id="calibre_link-192" class="calibre19">Changes in PM levels at an individual monitor</h4>

<p class="calibre2">So far we have examined the change in PM levels on average across the country. One issue with the previous analysis is that the monitoring network could have changed in the time period between 1999 and 2012. So if for some reason in 2012 there are more monitors concentrated in cleaner parts of the country than there were in 1999, it might appear the PM levels decreased when in fact they didnât. In this section we will focus on a single monitor in New York State to see if PM levels <em class="calibre17">at that monitor</em> decreased from 1999 to 2012. </p>

<p class="calibre2">Our first task is to identify a monitor in New York State that has data in 1999 and 2012 (not all monitors operated during both time periods). First we subset the data frames to only include data from New York (<code class="calibre21">State.Code == 36</code>) and only include the <code class="calibre21">County.Code</code> and the <code class="calibre21">Site.ID</code> (i.e. monitor number) variables.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> site0 <code class="o">&lt;-</code> <code class="kp">unique</code><code class="calibre21">(</code><code class="kp">subset</code><code class="calibre21">(</code>pm0<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code><code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code>County.Code<code class="calibre21">,</code> Site.ID<code class="calibre21">)))</code>
<code class="o">&gt;</code> site1 <code class="o">&lt;-</code> <code class="kp">unique</code><code class="calibre21">(</code><code class="kp">subset</code><code class="calibre21">(</code>pm1<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code><code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code>County.Code<code class="calibre21">,</code> Site.ID<code class="calibre21">)))</code>
</pre></div>

</figure>

<p class="calibre2">Then we create a new variable that combines the county code and the site ID into a single string.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> site0 <code class="o">&lt;-</code> <code class="kp">paste</code><code class="calibre21">(</code>site0<code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">],</code> site0<code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">],</code> sep <code class="o">=</code> <code class="s">"."</code><code class="calibre21">)</code>
<code class="o">&gt;</code> site1 <code class="o">&lt;-</code> <code class="kp">paste</code><code class="calibre21">(</code>site1<code class="calibre21">[,</code><code class="o">1</code><code class="calibre21">],</code> site1<code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">],</code> sep <code class="o">=</code> <code class="s">"."</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>site0<code class="calibre21">)</code>
 chr <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">33</code><code class="calibre21">]</code> <code class="s">"1.5"</code> <code class="s">"1.12"</code> <code class="s">"5.73"</code> <code class="s">"5.80"</code> <code class="s">"5.83"</code> <code class="s">"5.110"</code> <code class="s">"13.11"</code> <code class="s">"27.1004"</code> <code class="kc">...</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>site1<code class="calibre21">)</code>
 chr <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">18</code><code class="calibre21">]</code> <code class="s">"1.5"</code> <code class="s">"1.12"</code> <code class="s">"5.80"</code> <code class="s">"5.133"</code> <code class="s">"13.11"</code> <code class="s">"29.5"</code> <code class="s">"31.3"</code> <code class="s">"47.122"</code> <code class="kc">...</code>
</pre></div>

</figure>

<p class="calibre2">Finaly, we want the intersection between the sites present in 1999 and 2012 so that we might choose a monitor that has data in both periods.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> both <code class="o">&lt;-</code> <code class="kp">intersect</code><code class="calibre21">(</code>site0<code class="calibre21">,</code> site1<code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">print</code><code class="calibre21">(</code>both<code class="calibre21">)</code>
 <code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"1.5"</code>     <code class="s">"1.12"</code>    <code class="s">"5.80"</code>    <code class="s">"13.11"</code>   <code class="s">"29.5"</code>    <code class="s">"31.3"</code>    <code class="s">"63.2008"</code>
 <code class="calibre21">[</code><code class="o">8</code><code class="calibre21">]</code> <code class="s">"67.1015"</code> <code class="s">"85.55"</code>   <code class="s">"101.3"</code>  
</pre></div>

</figure>

<p class="calibre2">Here (above) we can see that there are 10 monitors that were operating in both time periods. However, rather than choose one at random, it might best to choose one that had a reasonable amount of data in each year.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Find how many observations available at each monitor</code>
<code class="o">&gt;</code> pm0<code class="o">$</code>county.site <code class="o">&lt;-</code> <code class="kp">with</code><code class="calibre21">(</code>pm0<code class="calibre21">,</code> <code class="kp">paste</code><code class="calibre21">(</code>County.Code<code class="calibre21">,</code> Site.ID<code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">"."</code><code class="calibre21">))</code>
<code class="o">&gt;</code> pm1<code class="o">$</code>county.site <code class="o">&lt;-</code> <code class="kp">with</code><code class="calibre21">(</code>pm1<code class="calibre21">,</code> <code class="kp">paste</code><code class="calibre21">(</code>County.Code<code class="calibre21">,</code> Site.ID<code class="calibre21">,</code> sep <code class="o">=</code> <code class="s">"."</code><code class="calibre21">))</code>
<code class="o">&gt;</code> cnt0 <code class="o">&lt;-</code> <code class="kp">subset</code><code class="calibre21">(</code>pm0<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code> <code class="o">&amp;</code> county.site <code class="o">%in%</code> both<code class="calibre21">)</code>
<code class="o">&gt;</code> cnt1 <code class="o">&lt;-</code> <code class="kp">subset</code><code class="calibre21">(</code>pm1<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code> <code class="o">&amp;</code> county.site <code class="o">%in%</code> both<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Now that we have subsetted the original data frames to only include the data from the monitors that overlap between 1999 and 2012, we can split the data frames and count the number of observations at each monitor to see which ones have the most observations.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## 1999</code>
<code class="o">&gt;</code> <code class="kp">sapply</code><code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">(</code>cnt0<code class="calibre21">,</code> cnt0<code class="o">$</code>county.site<code class="calibre21">),</code> <code class="kp">nrow</code><code class="calibre21">)</code>  
   <code class="o">1.12</code>     <code class="o">1.5</code>   <code class="o">101.3</code>   <code class="o">13.11</code>    <code class="o">29.5</code>    <code class="o">31.3</code>    <code class="o">5.80</code> <code class="o">63.2008</code> <code class="o">67.1015</code>   <code class="o">85.55</code> 
     <code class="o">61</code>     <code class="o">122</code>     <code class="o">152</code>      <code class="o">61</code>      <code class="o">61</code>     <code class="o">183</code>      <code class="o">61</code>     <code class="o">122</code>     <code class="o">122</code>       <code class="o">7</code> 
<code class="o">&gt;</code> <code class="c">## 2012</code>
<code class="o">&gt;</code> <code class="kp">sapply</code><code class="calibre21">(</code><code class="kp">split</code><code class="calibre21">(</code>cnt1<code class="calibre21">,</code> cnt1<code class="o">$</code>county.site<code class="calibre21">),</code> <code class="kp">nrow</code><code class="calibre21">)</code>  
   <code class="o">1.12</code>     <code class="o">1.5</code>   <code class="o">101.3</code>   <code class="o">13.11</code>    <code class="o">29.5</code>    <code class="o">31.3</code>    <code class="o">5.80</code> <code class="o">63.2008</code> <code class="o">67.1015</code>   <code class="o">85.55</code> 
     <code class="o">31</code>      <code class="o">64</code>      <code class="o">31</code>      <code class="o">31</code>      <code class="o">33</code>      <code class="o">15</code>      <code class="o">31</code>      <code class="o">30</code>      <code class="o">31</code>      <code class="o">31</code> 
</pre></div>

</figure>

<p class="calibre2">A number of monitors seem suitable from the output, but we will focus here on County 63 and site ID 2008. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> both.county <code class="o">&lt;-</code> <code class="o">63</code>
<code class="o">&gt;</code> both.id <code class="o">&lt;-</code> <code class="o">2008</code>
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Choose county 63 and side ID 2008</code>
<code class="o">&gt;</code> pm1sub <code class="o">&lt;-</code> <code class="kp">subset</code><code class="calibre21">(</code>pm1<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code> <code class="o">&amp;</code> County.Code <code class="o">==</code> both.county <code class="o">&amp;</code> Site.ID <code class="o">==</code> both.id<code class="calibre21">)</code>
<code class="o">&gt;</code> pm0sub <code class="o">&lt;-</code> <code class="kp">subset</code><code class="calibre21">(</code>pm0<code class="calibre21">,</code> State.Code <code class="o">==</code> <code class="o">36</code> <code class="o">&amp;</code> County.Code <code class="o">==</code> both.county <code class="o">&amp;</code> Site.ID <code class="o">==</code> both.id<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Now we plot the time series data of PM for the monitor in both years.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> dates1 <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="kp">as.character</code><code class="calibre21">(</code>pm1sub<code class="o">$</code>Date<code class="calibre21">),</code> <code class="s">"%Y%m%d"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x1sub <code class="o">&lt;-</code> pm1sub<code class="o">$</code>Sample.Value
<code class="o">&gt;</code> dates0 <code class="o">&lt;-</code> <code class="kp">as.Date</code><code class="calibre21">(</code><code class="kp">as.character</code><code class="calibre21">(</code>pm0sub<code class="o">$</code>Date<code class="calibre21">),</code> <code class="s">"%Y%m%d"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> x0sub <code class="o">&lt;-</code> pm0sub<code class="o">$</code>Sample.Value
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Find global range</code>
<code class="o">&gt;</code> rng <code class="o">&lt;-</code> <code class="kp">range</code><code class="calibre21">(</code>x0sub<code class="calibre21">,</code> x1sub<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kp">T</code><code class="calibre21">)</code>
<code class="o">&gt;</code> par<code class="calibre21">(</code>mfrow <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> mar <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">4</code><code class="calibre21">,</code> <code class="o">5</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">))</code>
<code class="o">&gt;</code> plot<code class="calibre21">(</code>dates0<code class="calibre21">,</code> x0sub<code class="calibre21">,</code> pch <code class="o">=</code> <code class="o">20</code><code class="calibre21">,</code> ylim <code class="o">=</code> rng<code class="calibre21">,</code> xlab <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> ylab <code class="o">=</code> <code class="kp">expression</code><code class="calibre21">(</code>PM<code class="calibre21">[</code><code class="o">2.5</code><code class="calibre21">]</code> <code class="o">*</code> <code class="s">" ("</code> <code class="o">*</code> mu <code class="o">*</code>\
 g<code class="o">/</code>m<code class="o">^</code><code class="o">3</code> <code class="o">*</code> <code class="s">")"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> abline<code class="calibre21">(</code>h <code class="o">=</code> median<code class="calibre21">(</code>x0sub<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kp">T</code><code class="calibre21">))</code>
<code class="o">&gt;</code> plot<code class="calibre21">(</code>dates1<code class="calibre21">,</code> x1sub<code class="calibre21">,</code> pch <code class="o">=</code> <code class="o">20</code><code class="calibre21">,</code> ylim <code class="o">=</code> rng<code class="calibre21">,</code> xlab <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> ylab <code class="o">=</code> <code class="kp">expression</code><code class="calibre21">(</code>PM<code class="calibre21">[</code><code class="o">2.5</code><code class="calibre21">]</code> <code class="o">*</code> <code class="s">" ("</code> <code class="o">*</code> mu <code class="o">*</code>\
 g<code class="o">/</code>m<code class="o">^</code><code class="o">3</code> <code class="o">*</code> <code class="s">")"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> abline<code class="calibre21">(</code>h <code class="o">=</code> median<code class="calibre21">(</code>x1sub<code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kp">T</code><code class="calibre21">))</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000000.png" alt="plot of chunk unnamed-chunk-12" class="calibre31" />
    <figcaption class="calibre32">plot of chunk unnamed-chunk-12</figcaption>
  </figure>
</div>


<p class="calibre2">From the plot above, we can that median levels of PM (horizontal solid line) have decreased a little from 10.45 in 1999 to 8.29 in 2012. However, perhaps more interesting is that the variation (spread) in the PM values in 2012 is much smaller than it was in 1999. This suggest that not only are median levels of PM lower in 2012, but that there are fewer large spikes from day to day. One issue with the data here is that the 1999 data are from July through December while the 2012 data are recorded in January through April. It would have been better if weâd had full-year data for both years as there could be some seasonal confounding going on.</p>

<h4 id="calibre_link-193" class="calibre19">Changes in state-wide PM levels</h4>

<p class="calibre2">Although ambient air quality standards are set at the federal level in the U.S. and hence affect the entire country, the actual reduction and management of PM is left to the individual states. States that are not âin attainmentâ have to develop a plan to reduce PM so that that the are in attainment (eventually). Therefore, it might be useful to examine changes in PM at the state level. This analysis falls somewhere in between looking at the entire country all at once and looking at an individual monitor.</p>

<p class="calibre2">What we do here is calculate the mean of PM for each state in 1999 and 2012.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## 1999</code>
<code class="o">&gt;</code> mn0 <code class="o">&lt;-</code> <code class="kp">with</code><code class="calibre21">(</code>pm0<code class="calibre21">,</code> <code class="kp">tapply</code><code class="calibre21">(</code>Sample.Value<code class="calibre21">,</code> State.Code<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">))</code>  
<code class="o">&gt;</code> <code class="c">## 2012</code>
<code class="o">&gt;</code> mn1 <code class="o">&lt;-</code> <code class="kp">with</code><code class="calibre21">(</code>pm1<code class="calibre21">,</code> <code class="kp">tapply</code><code class="calibre21">(</code>Sample.Value<code class="calibre21">,</code> State.Code<code class="calibre21">,</code> <code class="kp">mean</code><code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">))</code>  
<code class="o">&gt;</code> 
<code class="o">&gt;</code> <code class="c">## Make separate data frames for states / years</code>
<code class="o">&gt;</code> d0 <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>state <code class="o">=</code> <code class="kp">names</code><code class="calibre21">(</code>mn0<code class="calibre21">),</code> mean <code class="o">=</code> mn0<code class="calibre21">)</code>
<code class="o">&gt;</code> d1 <code class="o">&lt;-</code> <code class="kt">data.frame</code><code class="calibre21">(</code>state <code class="o">=</code> <code class="kp">names</code><code class="calibre21">(</code>mn1<code class="calibre21">),</code> mean <code class="o">=</code> mn1<code class="calibre21">)</code>
<code class="o">&gt;</code> mrg <code class="o">&lt;-</code> <code class="kp">merge</code><code class="calibre21">(</code>d0<code class="calibre21">,</code> d1<code class="calibre21">,</code> by <code class="o">=</code> <code class="s">"state"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">head</code><code class="calibre21">(</code>mrg<code class="calibre21">)</code>
  state    mean.x    mean.y
<code class="o">1</code>     <code class="o">1</code> <code class="o">19.956391</code> <code class="o">10.126190</code>
<code class="o">2</code>    <code class="o">10</code> <code class="o">14.492895</code> <code class="o">11.236059</code>
<code class="o">3</code>    <code class="o">11</code> <code class="o">15.786507</code> <code class="o">11.991697</code>
<code class="o">4</code>    <code class="o">12</code> <code class="o">11.137139</code>  <code class="o">8.239690</code>
<code class="o">5</code>    <code class="o">13</code> <code class="o">19.943240</code> <code class="o">11.321364</code>
<code class="o">6</code>    <code class="o">15</code>  <code class="o">4.861821</code>  <code class="o">8.749336</code>
</pre></div>

</figure>

<p class="calibre2">Now make a plot that shows the 1999 state-wide means in one âcolumnâ and the 2012 state-wide means in another columns. We then draw a line connecting the means for each year in the same state to highlight the trend.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> par<code class="calibre21">(</code>mfrow <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">1</code><code class="calibre21">))</code>
<code class="o">&gt;</code> rng <code class="o">&lt;-</code> <code class="kp">range</code><code class="calibre21">(</code>mrg<code class="calibre21">[,</code><code class="o">2</code><code class="calibre21">],</code> mrg<code class="calibre21">[,</code><code class="o">3</code><code class="calibre21">])</code>
<code class="o">&gt;</code> <code class="kp">with</code><code class="calibre21">(</code>mrg<code class="calibre21">,</code> plot<code class="calibre21">(</code><code class="kp">rep</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">52</code><code class="calibre21">),</code> mrg<code class="calibre21">[,</code> <code class="o">2</code><code class="calibre21">],</code> xlim <code class="o">=</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">.5</code><code class="calibre21">,</code> <code class="o">2.5</code><code class="calibre21">),</code> ylim <code class="o">=</code> rng<code class="calibre21">,</code> xaxt <code class="o">=</code> <code class="s">"n"</code><code class="calibre21">,</code> xlab <code class="o">=</code> <code class="s">""</code><code class="calibre21">,</code> y\
lab <code class="o">=</code> <code class="s">"State-wide Mean PM"</code><code class="calibre21">))</code>
<code class="o">&gt;</code> <code class="kp">with</code><code class="calibre21">(</code>mrg<code class="calibre21">,</code> points<code class="calibre21">(</code><code class="kp">rep</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">52</code><code class="calibre21">),</code> mrg<code class="calibre21">[,</code> <code class="o">3</code><code class="calibre21">]))</code>
<code class="o">&gt;</code> segments<code class="calibre21">(</code><code class="kp">rep</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">52</code><code class="calibre21">),</code> mrg<code class="calibre21">[,</code> <code class="o">2</code><code class="calibre21">],</code> <code class="kp">rep</code><code class="calibre21">(</code><code class="o">2</code><code class="calibre21">,</code> <code class="o">52</code><code class="calibre21">),</code> mrg<code class="calibre21">[,</code> <code class="o">3</code><code class="calibre21">])</code>
<code class="o">&gt;</code> axis<code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">,</code> <code class="o">2</code><code class="calibre21">),</code> <code class="kt">c</code><code class="calibre21">(</code><code class="s">"1999"</code><code class="calibre21">,</code> <code class="s">"2012"</code><code class="calibre21">))</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image1">
    <img src="images/000001.png" alt="plot of chunk unnamed-chunk-14" class="calibre31" />
    <figcaption class="calibre32">plot of chunk unnamed-chunk-14</figcaption>
  </figure>
</div>


<p class="calibre2">From the plot above we can see that many states have decreased the average PM levels from 1999 to 2012 (although a few states actually increased their levels).</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-2">
<div class="calibre5">
<h2 id="calibre_link-161" class="calibre15">
<span class="section-number">24. </span>Parallel Computation</h2>

<p class="calibre2">Many computations in R can be made faster by the use of parallel computation. Generally, parallel computation is the simultaneous execution of different pieces of a larger computation across multiple computing processors or cores. The basic idea is that if you can execute a computation in <img src="images/000017.png" alt="X" class="inline-equation" width="15" /> seconds on a single processor, then you should be able to execute it in <img src="images/000029.png" alt="X/n" class="inline-equation" width="34" /> seconds on <img src="images/000007.png" alt="n" class="inline-equation" width="10" /> processors. Such a speed-up is generally not possible because of overhead and various barriers to splitting up a problem into <img src="images/000020.png" alt="n" class="inline-equation" width="10" /> pieces, but it is often possible to come close in simple problems. </p>

<p class="calibre2">It used to be that parallel computation was squarely in the domain of âhigh-performance computingâ, where expensive machines were linked together via high-speed networking to create large clusters of computers. In those kinds of settings, it was important to have sophisticated software to manage the communication of data between different computers in the cluster. Parallel computing in that setting was a highly tuned, and carefully customized operation and not something you could just saunter into.</p>

<p class="calibre2">These days though, almost all computers contain multiple processors or cores on them. Even Appleâs iPhone 6S comes with a <a href="https://en.wikipedia.org/wiki/Apple_A9">dual-core CPU</a> as part of its A9 system-on-a-chip. Getting access to a âclusterâ of CPUs, in this case all built into the same computer, is much easier than it used to be and this has opened the door to parallel computing for a wide range of people.</p>

<p class="calibre2">In this chapter, we will discuss some of the basic funtionality in R for executing parallel computations. In particular, we will focus on functions that can be used on <em class="calibre17">multi-core</em> computers, which these days is almost all computers. It is possible to do more traditional parallel computing via the network-of-workstations style of computing, but we will not discuss that here.</p>

<h3 id="calibre_link-162" class="calibre19">
<span class="section-number">24.1 </span>Hidden Parallelism</h3>

<p class="calibre2">You may be computing in parallel without even knowing it! These days, many computational libraries have built-in parallelism that can be used behind the scenes. Usually, this kind of âhidden parallelismâ will generally not affect you and will improve you computational efficiency. However, itâs usually a good idea that you know itâs going on (even in the background) because it may affect other work you are doing on the machine. Also, certain shared computing environments may have rules about how many cores/CPUs you are allowed to use and if a function fires off multiple parallel jobs, it may cause a problem for others sharing the system with you.</p>

<h4 id="calibre_link-194" class="calibre19">Parallel BLAS</h4>

<p class="calibre2">A common example in R is the use of linear algebra functions. Some versions of R that you use may be linked to on optimized Basic Linear Algebra Subroutines (BLAS) library. Such libraries are custom coded for specific CPUs/chipsets to take advantage of the architecture of the chip. Itâs important to realize that while R can do linear algebra out of the box, its default BLAS library is a <em class="calibre17">reference implementation</em> that is not necessarily optimized to any particular chipset. </p>

<p class="calibre2">When possible, itâs always a good idea to install an optimized BLAS on your system because it can dramatically improve the performance of those kinds of computations. Part of the increase in performance comes from the customization of the code to a particular chipset while part of it comes from the multi-threading that many libraries use to parallelize their computations. </p>

<p class="calibre2">For example, below I simulate a matrix <code class="calibre21">X</code> of 1 million observations by 100 predictors and generate an outcome <code class="calibre21">y</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> X <code class="o">&lt;-</code> <code class="kt">matrix</code><code class="calibre21">(</code>rnorm<code class="calibre21">(</code><code class="o">1e6</code> <code class="o">*</code> <code class="o">100</code><code class="calibre21">),</code> <code class="o">1e6</code><code class="calibre21">,</code> <code class="o">100</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">dim</code><code class="calibre21">(</code>X<code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">1000000</code>     <code class="o">100</code>
<code class="o">&gt;</code> b <code class="o">&lt;-</code> rnorm<code class="calibre21">(</code><code class="o">100</code><code class="calibre21">)</code>
<code class="o">&gt;</code> y <code class="o">&lt;-</code> <code class="kp">drop</code><code class="calibre21">(</code>X <code class="o">%*%</code> b<code class="calibre21">)</code> <code class="o">+</code> rnorm<code class="calibre21">(</code><code class="o">1e6</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Then I compute the least squares estimates of the linear regression coefficents when regressing the response <code class="calibre21">y</code> on the predictor matrix <code class="calibre21">X</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">system.time</code><code class="calibre21">(</code>b <code class="o">&lt;-</code> <code class="kp">solve</code><code class="calibre21">(</code><code class="kp">crossprod</code><code class="calibre21">(</code>X<code class="calibre21">),</code> <code class="kp">crossprod</code><code class="calibre21">(</code>X<code class="calibre21">,</code> y<code class="calibre21">)))</code>
   user  system elapsed 
  <code class="o">0.854</code>   <code class="o">0.002</code>   <code class="o">0.448</code> 
</pre></div>

</figure>

<p class="calibre2">Here, you can see that the <code class="calibre21">user</code> time is just under 1 second while the <code class="calibre21">elapsed</code> time is about half that. Here, the key task, matrix inversion, was handled by the optimized BLAS and was computed in parallel so that the elapsed time was less than the user or CPU time. In this case, I was using a Mac that was linked to Appleâs Accelerate framework which contains an optimized BLAS.</p>

<p class="calibre2">Hereâs a summary of some of the optimized BLAS libraries out there:</p>

<ul class="calibre20">
  <li class="calibre14">The <a href="http://developer.amd.com/tools-and-sdks/archive/amd-core-math-library-acml/">AMD Core Math Library</a> (ACML) is built for AMD chips and contains a full set of BLAS and LAPACK routines. The library is closed-source and is maintained/released by AMD.</li>
  <li class="calibre14">The <a href="https://software.intel.com/en-us/intel-mkl">Intel Math Kernel</a> is an analogous optimized library for Intel-based chips</li>
  <li class="calibre14">The <a href="https://developer.apple.com/library/tvos/documentation/Accelerate/Reference/AccelerateFWRef/index.html">Accelerate framework</a> on the Mac contains an optimized BLAS built by Apple.</li>
  <li class="calibre14">The <a href="http://math-atlas.sourceforge.net">Automatically Tuned Linear Algebra Software</a> (ATLAS) library is a special âadaptiveâ software package that is designed to be compiled on the computer where it will be used. As part of the build process, the library extracts detailed CPU information and optimizes the code as it goes along. The ATLAS library is hence a generic package that can be built on a wider array of CPUs.</li>
</ul>

<p class="calibre2">Detailed instructions on how to use R with optimized BLAS libraries can be found in the <a href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html#BLAS">R Installation and Administration</a> manual. In some cases, you may need to build R from the sources in order to link it with the optimized BLAS library.</p>

<h3 id="calibre_link-163" class="calibre19">
<span class="section-number">24.2 </span>Embarrassing Parallelism</h3>

<p class="calibre2">Many problems in statistics and data science can be executed in an âembarrassingly parallelâ way, whereby multiple independent pieces of a problem are executed simultaneously because the different pieces of the problem never really have to communicate with each other (except perhaps at the end when all the results are assembled). Despite the name, thereâs nothing really âembarrassingâ about taking advantage of the structure of the problem and using it speed up your computation. In fact, embarrassingly parallel computation is a common paradigm in statistics and data science.</p>

<aside class="calibre30">
  <p class="calibre2">In general, it is NOT a good idea to use the functions described in this chapter with graphical user interfaces (GUIs) because, to summarize the help page for <code class="calibre21">mclapply()</code>, bad things can happen. That said, the functions in the <code class="calibre21">parallel</code> package seem two work okay in RStudio.</p>

</aside>

<p class="calibre2">The basic mode of an embarrassingly parallel operation can be seen with the <code class="calibre21">lapply()</code> function, which we have reviewed in a <a href="#calibre_link-3">previous chapter</a>. Recall that the <code class="calibre21">lapply()</code> function has two arguments:</p>

<ol class="calibre13">
  <li class="calibre14">A list, or an object that can be coerced to a list.</li>
  <li class="calibre14">A function to be applied to each element of the list</li>
</ol>

<p class="calibre2">Finally, recall that <code class="calibre21">lapply()</code> always returns a list whose length is equal to the length of the input list. </p>

<p class="calibre2">The <code class="calibre21">lapply()</code> function works much like a loop&ndash;it cycles through each element of the list and applies the supplied function to that element. While <code class="calibre21">lapply()</code> is applying your function to a list element, the other elements of the list are justâ¦sitting around in memory. Note that in the description of <code class="calibre21">lapply()</code> above, thereâs no mention of the different elements of the list communicating with each other, and the function being applied to a given list element does not need to know about other list elements. </p>

<p class="calibre2">Just about any operation that is handled by the <code class="calibre21">lapply()</code> function can be parallelized. This approach is analogous to the <a href="https://en.wikipedia.org/wiki/MapReduce">âmap-reduceâ</a> approach in large-scale cluster systems. The idea is that a list object can be split across multiple cores of a processor and then the function can be applied to each subset of the list object on each of the cores. Conceptually, the steps in the parallel procedure are</p>

<ol class="calibre13">
  <li class="calibre14">Split list <code class="calibre21">X</code> across multiple cores </li>
  <li class="calibre14">Copy the supplied function (and associated environment) to each of the cores </li>
  <li class="calibre14">Apply the supplied function to each subset of the list <code class="calibre21">X</code> on each of the cores in parallel</li>
  <li class="calibre14">Assemble the results of all the function evaluations into a single list and return</li>
</ol>

<p class="calibre2">The differences between the many packages/functions in R essentially come down to how each of these steps are implemented. In this chapter we will cover the <code class="calibre21">parallel</code> package, which has a few implementations of this paradigm. The goal of the functions in this package (and in other related packages) is to abstract the complexities of the implemetation so that the R user is presented a relatively clean interface for doing computations.</p>

<h3 id="calibre_link-164" class="calibre19">
<span class="section-number">24.3 </span>The Parallel Package</h3>

<p class="calibre2">The <code class="calibre21">parallel</code> package which comes with your R installation. It represents a combining of two historical packages&ndash;the <code class="calibre21">multicore</code> and <code class="calibre21">snow</code> packages, and the functions in <code class="calibre21">parallel</code> have overlapping names with those older packages. For our purposes, itâs not necessary to know anything about the <code class="calibre21">multicore</code> or <code class="calibre21">snow</code> packages, but long-time users of R may remember them from back in the day.</p>

<p class="calibre2">The <code class="calibre21">mclapply()</code> function essentially parallelizes calls to <code class="calibre21">lapply()</code>. The first two arguments to <code class="calibre21">mclapply()</code> are exactly the same as they are for <code class="calibre21">lapply()</code>. However, <code class="calibre21">mclapply()</code> has further arguments (that must be named), the most important of which is the <code class="calibre21">mc.cores</code> argument which you can use to specify the number of processors/cores you want to split the computation across. For example, if your machine has 4 cores on it, you might specify <code class="calibre21">mc.cores = 4</code> to break your parallelize your operation across 4 cores (although this may not be the best idea if you are running other operations in the background besides R).</p>

<p class="calibre2">The <code class="calibre21">mclapply()</code> function (and related <code class="calibre21">mc*</code> functions) works via the fork mechanism on Unix-style operating systems. Briefly, your R session is the main process and when you call a function like <code class="calibre21">mclapply()</code>, you fork a series of sub-processes that operate independently from the main process (although they share a few low-level features). These sub-processes then execute your function on their subsets of the data, presumably on separate cores of your CPU. Once the computation is complete, each sub-process returns its results and then the sub-process is killed. The <code class="calibre21">parallel</code> package manages the logistics of forking the sub-processes and handling them once theyâve finished.</p>

<aside class="calibre30">
  <p class="calibre2">Because of the use of the fork mechanism, the <code class="calibre21">mc*</code> functions are generally not available to users of the Windows operating system.</p>

</aside>

<p class="calibre2">The first thing you might want to check with the <code class="calibre21">parallel</code> package is if your computer in fact has multiple cores that you can take advantage of.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>parallel<code class="calibre21">)</code>
<code class="o">&gt;</code> detectCores<code class="calibre21">()</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">16</code>
</pre></div>

</figure>

<p class="calibre2">The computer on which this is being written is a circa 2016 MacBook Pro (with Touch Bar) with 2 physical CPUs. However, because each core allows for hyperthreading, each core is presented as 2 separate cores, allowing for 4 âlogicalâ cores. This is what <code class="calibre21">detectCores()</code> returns. On some systems you can call <code class="calibre21">detectCores(logical = FALSE)</code> to return the number of physical cores.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> detectCores<code class="calibre21">(</code><code class="kt">logical</code> <code class="o">=</code> <code class="kc">FALSE</code><code class="calibre21">)</code>  <code class="c">## Same answer as before on some systems?</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="o">8</code>
</pre></div>

</figure>

<p class="calibre2">In general, the information from <code class="calibre21">detectCores()</code> should be used cautiously as obtaining this kind of information from Unix-like operating systems is not always reliable. If you are going down this road, itâs best if you get to know your hardware better in order to have an understanding of how many CPUs/cores are available to you.</p>

<h4 id="calibre_link-195" class="calibre19">
  <code class="calibre11">mclapply()</code>
</h4>

<p class="calibre2">The simplest application of the <code class="calibre21">parallel</code> package is via the <code class="calibre21">mclapply()</code> function, which conceptually splits what might be a call to <code class="calibre21">lapply()</code> across multiple cores. Just to show how the function works, Iâll run some code that splits a job across 10 cores and then just sleeps for 10 seconds.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">10</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kp">Sys.sleep</code><code class="calibre21">(</code><code class="o">10</code><code class="calibre21">)</code>  <code class="c">## Do nothing for 10 seconds</code>
<code class="o">+</code> <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">10</code><code class="calibre21">)</code>      <code class="c">## Split this job across 10 cores</code>
</pre></div>

</figure>

<p class="calibre2">While this âjobâ was running, I took a screen shot of the system activity monitor (âtopâ). Hereâs what it looks like on Mac OS X.</p>


<div class="figure-wrapper">
  <figure class="image2">
    <img src="images/000008.png" alt="Multiple sub-processes spawned by `mclapply()`" class="calibre31" />
    <figcaption class="calibre32">Multiple sub-processes spawned by <code class="calibre21">mclapply()</code></figcaption>
  </figure>
</div>


<p class="calibre2">In case you are not used to viewing this output, each row of the table is an application or process running on your computer. You can see that there are 11 rows where the COMMAND is labelled <code class="calibre21">rsession</code>. One of these is my primary R session (being run through RStudio), and the other 10 are the sub-processes spawned by the <code class="calibre21">mclapply()</code> function. </p>

<p class="calibre2">We will use as a second (slightly more realistic) example processing data from multiple files. Often this is something that can be easily parallelized.</p>

<p class="calibre2">Here we have data on ambient concentrations of sulfate particulate matter (PM) and nitrate PM from 332 monitors around the United States. First, we can read in the data via a simple call to <code class="calibre21">lapply()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> infiles <code class="o">&lt;-</code> <code class="kp">dir</code><code class="calibre21">(</code><code class="s">"specdata"</code><code class="calibre21">,</code> full.names <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">&gt;</code> specdata <code class="o">&lt;-</code> <code class="kp">lapply</code><code class="calibre21">(</code>infiles<code class="calibre21">,</code> read.csv<code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">Now, <code class="calibre21">specdata</code> is a list of data frames, with each data frame corresponding to each of the 332 monitors in the dataset.</p>

<p class="calibre2">One thing we might want to do is compute a summary statistic across each of the monitors. For example, we might want to compute the 90th percentile of sulfate for each of the monitors. This can easily be implemented as a serial call to <code class="calibre21">lapply()</code>.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> s <code class="o">&lt;-</code> <code class="kp">system.time</code><code class="calibre21">({</code>
<code class="o">+</code>         mn <code class="o">&lt;-</code> <code class="kp">lapply</code><code class="calibre21">(</code>specdata<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>df<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>                 quantile<code class="calibre21">(</code>df<code class="o">$</code>sulfate<code class="calibre21">,</code> <code class="o">0.9</code><code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">})</code>
<code class="o">+</code> <code class="calibre21">})</code>
<code class="o">&gt;</code> s
   user  system elapsed 
  <code class="o">0.055</code>   <code class="o">0.000</code>   <code class="o">0.055</code> 
</pre></div>

</figure>

<p class="calibre2">Note that in the <code class="calibre21">system.time()</code> output, the <code class="calibre21">user</code> time (0.055 seconds) and the <code class="calibre21">elapsed</code> time (0.055 seconds) are roughly the same, which is what we would expect because there was no parallelization.</p>

<p class="calibre2">The equivalent call using <code class="calibre21">mclapply()</code> would be</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> s <code class="o">&lt;-</code> <code class="kp">system.time</code><code class="calibre21">({</code>
<code class="o">+</code>         mn <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code>specdata<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>df<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>                 quantile<code class="calibre21">(</code>df<code class="o">$</code>sulfate<code class="calibre21">,</code> <code class="o">0.9</code><code class="calibre21">,</code> na.rm <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">})</code>
<code class="o">&gt;</code> s
   user  system elapsed 
  <code class="o">0.003</code>   <code class="o">0.004</code>   <code class="o">0.031</code> 
</pre></div>

</figure>

<p class="calibre2">Youâll notice that the the <code class="calibre21">elapsed</code> time is now less than the <code class="calibre21">user</code> time. However, in general, the <code class="calibre21">elapsed</code> time will not be 1/4th of the <code class="calibre21">user</code> time, which is what we might expect with 4 cores if there were a perfect performance gain from parallelization. </p>

<p class="calibre2">R keeps track of how much time is spent in the main process and how much is spent in any child processes.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> s<code class="calibre21">[</code><code class="s">"user.self"</code><code class="calibre21">]</code>  <code class="c">## Main process</code>
user.self 
    <code class="o">0.003</code> 
<code class="o">&gt;</code> s<code class="calibre21">[</code><code class="s">"user.child"</code><code class="calibre21">]</code> <code class="c">## Child processes</code>
user.child 
         <code class="o">0</code> 
</pre></div>

</figure>

<p class="calibre2">In the call to <code class="calibre21">mclapply()</code> you can see that virtually all of the <code class="calibre21">user</code> time is spent in the child processes. The total <code class="calibre21">user</code> time is the sum of the <code class="calibre21">self</code> and <code class="calibre21">child</code> times. </p>

<p class="calibre2">In some cases it is possible for the parallelized version of an R expression to actually be <em class="calibre17">slower</em> than the serial version. This can occur if there is substantial overhead in creating the child processes. For example, time must be spent copying information over to the child processes and communicating the results back to the parent process. However, for most substantial computations, there will be some benefit in parallelization.</p>

<aside class="calibre30">
  <p class="calibre2">One advantage of serial computations is that it allows you to better keep a handle on how much <strong class="calibre16">memory</strong> your R job is using. When executing parallel jobs via <code class="calibre21">mclapply()</code> itâs important to pre-calculate how much memory <em class="calibre17">all</em> of the processes will require and make sure this is less than the total amount of memory on your computer.</p>

</aside>

<p class="calibre2">The <code class="calibre21">mclapply()</code> function is useful for iterating over a single list or list-like object. If you have to iterate over multiple objects together, you can use <code class="calibre21">mcmapply()</code>, which is the the multi-core equivalent of the <code class="calibre21">mapply()</code> function.</p>

<h4 id="calibre_link-196" class="calibre19">Error Handling</h4>

<p class="calibre2">When either <code class="calibre21">mclapply()</code> or <code class="calibre21">mcmapply()</code> are called, the functions supplied will be run in the sub-process while effectively being wrapped in a call to <code class="calibre21">try()</code>. This allows for one of the sub-processes to fail without disrupting the entire call to <code class="calibre21">mclapply()</code>, possibly causing you to lose much of your work. If one sub-process fails, it may be that all of the others work just fine and produce good results.</p>

<p class="calibre2">This error handling behavior is a significant difference from the usual call to <code class="calibre21">lapply()</code>. With <code class="calibre21">lapply()</code>, if the supplied function fails on one component of the list, the entire function call to <code class="calibre21">lapply()</code> fails and you only get an error as a result.</p>

<p class="calibre2">With <code class="calibre21">mclapply()</code>, when a sub-process fails, the return value for that sub-process will be an R object that inherits from the class <code class="calibre21">"try-error"</code>, which is something you can test with the <code class="calibre21">inherits()</code> function. Conceptually, each child process is executed with the <code class="calibre21">try()</code> function wrapped around it. The code below deliberately causes an error in the 3 element of the list.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         <code class="kc">if</code><code class="calibre21">(</code>i <code class="o">==</code> <code class="o">3L</code><code class="calibre21">)</code>
<code class="o">+</code>                 <code class="kp">stop</code><code class="calibre21">(</code><code class="s">"error in this process!"</code><code class="calibre21">)</code>
<code class="o">+</code>         <code class="kp">else</code>
<code class="o">+</code>                 <code class="kc">return</code><code class="calibre21">(</code><code class="s">"success!"</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">5</code><code class="calibre21">)</code>
Warning <code class="kc">in</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code><code class="o">:</code> scheduled core <code class="o">3</code> encountered error <code class="kp">in</code>
user code<code class="calibre21">,</code> all values of the job will be affected
</pre></div>

</figure>

<p class="calibre2">Here we see there was a warning but no error in the running of the above code. We can check the return value.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> str<code class="calibre21">(</code>r<code class="calibre21">)</code>
List of <code class="o">5</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> <code class="s">'try-error'</code> chr <code class="s">"Error in FUN(X[[i]], ...) : error in this process!\n"</code>
  <code class="o">..</code><code class="o">-</code> <code class="kp">attr</code><code class="calibre21">(</code><code class="o">*</code><code class="calibre21">,</code> <code class="s">"condition"</code><code class="calibre21">)</code><code class="o">=</code>List of <code class="o">2</code>
  <code class="o">..</code> <code class="o">..</code><code class="o">$</code> <code class="kp">message</code><code class="o">:</code> chr <code class="s">"error in this process!"</code>
  <code class="o">..</code> <code class="o">..</code><code class="o">$</code> call   <code class="o">:</code> language FUN<code class="calibre21">(</code>X<code class="calibre21">[[</code>i<code class="calibre21">]],</code> <code class="kc">...</code><code class="calibre21">)</code>
  <code class="o">..</code> <code class="o">..</code><code class="o">-</code> <code class="kp">attr</code><code class="calibre21">(</code><code class="o">*</code><code class="calibre21">,</code> <code class="s">"class"</code><code class="calibre21">)</code><code class="o">=</code> chr <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="s">"simpleError"</code> <code class="s">"error"</code> <code class="s">"condition"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
</pre></div>

</figure>

<p class="calibre2">Note that the 3rd list element in <code class="calibre21">r</code> is different.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">class</code><code class="calibre21">(</code>r<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]])</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="s">"try-error"</code>
<code class="o">&gt;</code> <code class="kp">inherits</code><code class="calibre21">(</code>r<code class="calibre21">[[</code><code class="o">3</code><code class="calibre21">]],</code> <code class="s">"try-error"</code><code class="calibre21">)</code>
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">TRUE</code>
</pre></div>

</figure>

<p class="calibre2">When running code where there may be errors in some of the sub-processes, itâs useful to check afterwards to see if there are any errors in the output received.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> bad <code class="o">&lt;-</code> <code class="kp">sapply</code><code class="calibre21">(</code>r<code class="calibre21">,</code> <code class="kp">inherits</code><code class="calibre21">,</code> what <code class="o">=</code> <code class="s">"try-error"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> bad
<code class="calibre21">[</code><code class="o">1</code><code class="calibre21">]</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>  <code class="kc">TRUE</code> <code class="kc">FALSE</code> <code class="kc">FALSE</code>
</pre></div>

</figure>

<p class="calibre2">You can subsequently subset your return object to only keep the âgoodâ elements.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r.good <code class="o">&lt;-</code> r<code class="calibre21">[</code><code class="o">!</code>bad<code class="calibre21">]</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>r.good<code class="calibre21">)</code>
List of <code class="o">4</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
 <code class="o">$</code> <code class="o">:</code> chr <code class="s">"success!"</code>
</pre></div>

</figure>

<h3 id="calibre_link-165" class="calibre19">
<span class="section-number">24.4 </span>Example: Bootstrapping a Statistic</h3>

<p class="calibre2">One technique that is commonly used to assess the variability of a statistic is the bootstrap. Briefly, the bootstrap technique resamples the original dataset with replacement to create pseudo-datasets that are similar to, but slightly perturbed from, the original dataset. This technique is particularly useful when the statistic in question does not have a readily accessible formula for its standard error.</p>

<p class="calibre2">One example of a statistic for which the bootstrap is useful is the median. Here, we plot the histogram of some of the sulfate particulate matter data from the previous example.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> dat <code class="o">&lt;-</code> read.csv<code class="calibre21">(</code><code class="s">"specdata/001.csv"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> sulf <code class="o">&lt;-</code> dat<code class="o">$</code>sulfate
<code class="o">&gt;</code> sulf <code class="o">&lt;-</code> sulf<code class="calibre21">[</code><code class="o">!</code><code class="kp">is.na</code><code class="calibre21">(</code>sulf<code class="calibre21">)]</code>     <code class="c">## Remove missing values</code>
<code class="o">&gt;</code> hist<code class="calibre21">(</code>sulf<code class="calibre21">,</code> xlab <code class="o">=</code> <code class="kp">expression</code><code class="calibre21">(</code><code class="s">"Sulfate PM ("</code> <code class="o">*</code> mu <code class="o">*</code> g<code class="o">/</code>m<code class="o">^</code><code class="o">3</code> <code class="o">*</code> <code class="s">")"</code><code class="calibre21">))</code>
</pre></div>

</figure>


<div class="figure-wrapper">
  <figure class="image">
    <img src="images/000021.png" alt="plot of chunk unnamed-chunk-14" class="calibre31" />
    <figcaption class="calibre32">plot of chunk unnamed-chunk-14</figcaption>
  </figure>
</div>


<p class="calibre2">We can see from the histogram that the distribution of sulfate is skewed to the right. Therefore, it would seem that the median might be a better summary of the distribution than the mean.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">summary</code><code class="calibre21">(</code>sulf<code class="calibre21">)</code>
   Min. <code class="o">1</code>st Qu.  Median    Mean <code class="o">3</code>rd Qu.    Max. 
  <code class="o">0.613</code>   <code class="o">2.210</code>   <code class="o">2.870</code>   <code class="o">3.881</code>   <code class="o">4.730</code>  <code class="o">19.100</code> 
</pre></div>

</figure>

<p class="calibre2">How can we construct confidence interval for the median of sulfate for this monitor? The bootstrap is simple procedure that can work well. Hereâs how we might do it in the usual (non-parallel) way.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> <code class="kp">replicate</code><code class="calibre21">(</code><code class="o">5000</code><code class="calibre21">,</code> <code class="calibre21">{</code>
<code class="o">+</code>         xnew <code class="o">&lt;-</code> <code class="kp">sample</code><code class="calibre21">(</code>sulf<code class="calibre21">,</code> replace <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         median<code class="calibre21">(</code>xnew<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">})</code>
</pre></div>

</figure>

<p class="calibre2">A 95% confidence interval would then take the 2.5th and 97.5th percentiles of this distribution (this is known as the percentile method).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> quantile<code class="calibre21">(</code>med.boot<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">0.025</code><code class="calibre21">,</code> <code class="o">0.975</code><code class="calibre21">))</code>
 <code class="o">2.5</code><code class="o">% 97.5%</code> 
 <code class="o">2.70</code>  <code class="o">3.47</code> 
</pre></div>

</figure>

<p class="calibre2">How could be done in parallel? We could simply wrap the expression passed to <code class="calibre21">replicate()</code> in a function and pass it to <code class="calibre21">mclapply()</code>. However, one thing we need to be careful of is generating random numbers.</p>

<h4 id="calibre_link-197" class="calibre19">Generating Random Numbers</h4>

<p class="calibre2">Generating random numbers in a parallel environment warrants caution because itâs possible to create a situation where each of the sub-processes are all generating the <em class="calibre17">exact same random numbers</em>. For the most part, the <code class="calibre21">mc*</code> functions do their best to avoid this.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> r <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         rnorm<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">5</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>r<code class="calibre21">)</code>
List of <code class="o">5</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">-0.0746</code> <code class="o">0.4021</code> <code class="o">-0.7643</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">3.256</code> <code class="o">0.943</code> <code class="o">-1.435</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">2.528</code> <code class="o">2.191</code> <code class="o">0.828</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">0.885</code> <code class="o">1.542</code> <code class="o">-0.244</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">-1.876</code> <code class="o">-0.26</code> <code class="o">0.187</code>
</pre></div>

</figure>

<p class="calibre2">However, the above expression is not <strong class="calibre16">reproducible</strong> because the next time you run it, you will get a different set of random numbers. You cannot simply call <code class="calibre21">set.seed()</code> before running the expression as you might in a non-parallel version of the code. </p>

<p class="calibre2">The <code class="calibre21">parallel</code> package provides a way to reproducibly generate random numbers in a parallel environment via the âLâEcuyer-CMRGâ random number generator. Note that this is not the default random number generator so you will have to set it explicitly.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="c">## Reproducible random numbers</code>
<code class="o">&gt;</code> <code class="kp">RNGkind</code><code class="calibre21">(</code><code class="s">"L'Ecuyer-CMRG"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> r <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         rnorm<code class="calibre21">(</code><code class="o">3</code><code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="o">&gt;</code> str<code class="calibre21">(</code>r<code class="calibre21">)</code>
List of <code class="o">5</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">-0.485</code> <code class="o">-0.626</code> <code class="o">-0.873</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">-1.86</code> <code class="o">-1.825</code> <code class="o">-0.995</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">1.177</code> <code class="o">1.472</code> <code class="o">-0.988</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">0.984</code> <code class="o">1.291</code> <code class="o">0.459</code>
 <code class="o">$</code> <code class="o">:</code> num <code class="calibre21">[</code><code class="o">1</code><code class="o">:</code><code class="o">3</code><code class="calibre21">]</code> <code class="o">1.43</code> <code class="o">-1.137</code> <code class="o">0.844</code>
</pre></div>

</figure>

<p class="calibre2">Running the above code twice will generate the same random numbers in each of the sub-processes.</p>

<p class="calibre2">Now we can run our parallel bootstrap in a reproducible way.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kp">RNGkind</code><code class="calibre21">(</code><code class="s">"L'Ecuyer-CMRG"</code><code class="calibre21">)</code>
<code class="o">&gt;</code> <code class="kp">set.seed</code><code class="calibre21">(</code><code class="o">1</code><code class="calibre21">)</code>
<code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> mclapply<code class="calibre21">(</code><code class="o">1</code><code class="o">:</code><code class="o">5000</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         xnew <code class="o">&lt;-</code> <code class="kp">sample</code><code class="calibre21">(</code>sulf<code class="calibre21">,</code> replace <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         median<code class="calibre21">(</code>xnew<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">},</code> mc.cores <code class="o">=</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> <code class="kp">unlist</code><code class="calibre21">(</code>med.boot<code class="calibre21">)</code>  <code class="c">## Collapse list into vector</code>
<code class="o">&gt;</code> quantile<code class="calibre21">(</code>med.boot<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">0.025</code><code class="calibre21">,</code> <code class="o">0.975</code><code class="calibre21">))</code>
   <code class="o">2.5</code><code class="o">%   97.5%</code> 
<code class="o">2.70000</code> <code class="o">3.46025</code> 
</pre></div>

</figure>

<aside class="calibre30">
  <p class="calibre2">Although Iâve rarely seen it done in practice (including in my own code), itâs a good idea to explicitly set the random number generator via <code class="calibre21">RNGkind()</code>, in addition to setting the seed with <code class="calibre21">set.seed()</code>. This way, you can be sure that the appropriate random number generator is being used every time and your code will be reproducible even on a system where the default generator has been changed.</p>

</aside>

<h4 id="calibre_link-198" class="calibre19">Using the <code class="calibre11">boot</code> package</h4>

<p class="calibre2">For bootstrapping in particular, you can use the <code class="calibre21">boot</code> package to do most of the work and the key <code class="calibre21">boot</code> function has an option to do the work in parallel.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> <code class="kc">library</code><code class="calibre21">(</code>boot<code class="calibre21">)</code>
<code class="o">&gt;</code> b <code class="o">&lt;-</code> boot<code class="calibre21">(</code>sulf<code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">,</code> i<code class="calibre21">)</code> median<code class="calibre21">(</code>x<code class="calibre21">[</code>i<code class="calibre21">]),</code> R <code class="o">=</code> <code class="o">5000</code><code class="calibre21">,</code> parallel <code class="o">=</code> <code class="s">"multicore"</code><code class="calibre21">,</code> ncpus <code class="o">=</code> <code class="o">4</code><code class="calibre21">)</code>
<code class="o">&gt;</code> boot.ci<code class="calibre21">(</code>b<code class="calibre21">,</code> type <code class="o">=</code> <code class="s">"perc"</code><code class="calibre21">)</code>
BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on <code class="o">5000</code> bootstrap replicates

CALL <code class="o">:</code> 
boot.ci<code class="calibre21">(</code>boot.out <code class="o">=</code> b<code class="calibre21">,</code> type <code class="o">=</code> <code class="s">"perc"</code><code class="calibre21">)</code>

Intervals <code class="o">:</code> 
Level     Percentile     
<code class="o">95</code>%   <code class="calibre21">(</code> <code class="o">2.70</code><code class="calibre21">,</code>  <code class="o">3.47</code> <code class="calibre21">)</code>  
Calculations and Intervals on Original Scale
</pre></div>

</figure>

<h3 id="calibre_link-166" class="calibre19">
<span class="section-number">24.5 </span>Building a Socket Cluster</h3>

<p class="calibre2">Using the forking mechanism on your computer is one way to execute parallel computation but itâs not the only way that the <code class="calibre21">parallel</code> package offers. Another way to build a âclusterâ using the multiple cores on your computer is via <em class="calibre17">sockets</em>. A <a href="https://en.wikipedia.org/wiki/Network_socket">socket</a> is simply a mechanism with which multiple processes or applications running on your computer (or different computers, for that matter) can communicate with each other. With parallel computation, data and results need to be passed back and forth between the parent and child processes and sockets can be used for that purpose.</p>

<p class="calibre2">Building a socket cluster is simple to do in R with the <code class="calibre21">makeCluster()</code> function. Here Iâm initializing a cluster with 4 components.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> cl <code class="o">&lt;-</code> makeCluster<code class="calibre21">(</code><code class="o">4</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">The <code class="calibre21">cl</code> object is an abstraction of the entire cluster and is what weâll use to indicate to the various cluster functions that we want to do parallel computation.</p>

<aside class="calibre30">
  <p class="calibre2">Youâll notice that the <code class="calibre21">makeCluster()</code> function has a <code class="calibre21">type</code> argument that allows for different types of clusters beyond using sockets (although the default is a socket cluster). We will not discuss these other options here.</p>

</aside>

<p class="calibre2">To do an <code class="calibre21">lapply()</code> operation over a socket cluster we can use the <code class="calibre21">parLapply()</code> function. For example, we can use <code class="calibre21">parLapply()</code> to run our median bootstrap example described above.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> parLapply<code class="calibre21">(</code>cl<code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">5000</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         xnew <code class="o">&lt;-</code> <code class="kp">sample</code><code class="calibre21">(</code>sulf<code class="calibre21">,</code> replace <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         median<code class="calibre21">(</code>xnew<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">})</code>
Error <code class="kc">in</code> checkForRemoteErrors<code class="calibre21">(</code>val<code class="calibre21">)</code><code class="o">:</code> <code class="o">4</code> nodes produced errors<code class="calibre21">;</code> first error<code class="o">:</code> object <code class="s">'sulf'</code> not fo\
und
</pre></div>

</figure>

<p class="calibre2">Youâll notice, unfortunately, that thereâs an error in running this code. The reason is that while we have loaded the sulfate data into our R session, the data is not available to the independent child processes that have been spawned by the <code class="calibre21">makeCluster()</code> function. The data, and any other information that the child process will need to execute your code, needs to be <strong class="calibre16">exported</strong> to the child process from the parent process via the <code class="calibre21">clusterExport()</code> function. The need to export data is a key difference in behavior between the âmulticoreâ approach and the âsocketâ approach.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> clusterExport<code class="calibre21">(</code>cl<code class="calibre21">,</code> <code class="s">"sulf"</code><code class="calibre21">)</code>
</pre></div>

</figure>

<p class="calibre2">The second argument to <code class="calibre21">clusterExport()</code> is a character vector, and so you can export an arbitrary number of R objects to the child processes. You should be judicious in choosing what you export simply because each R object will be replicated in each of the child processes, and hence take up memory on your computer.</p>

<p class="calibre2">Once the data have been exported to the child processes, we can run our bootstrap code again.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> parLapply<code class="calibre21">(</code>cl<code class="calibre21">,</code> <code class="o">1</code><code class="o">:</code><code class="o">5000</code><code class="calibre21">,</code> <code class="kc">function</code><code class="calibre21">(</code>i<code class="calibre21">)</code> <code class="calibre21">{</code>
<code class="o">+</code>         xnew <code class="o">&lt;-</code> <code class="kp">sample</code><code class="calibre21">(</code>sulf<code class="calibre21">,</code> replace <code class="o">=</code> <code class="kc">TRUE</code><code class="calibre21">)</code>
<code class="o">+</code>         median<code class="calibre21">(</code>xnew<code class="calibre21">)</code>
<code class="o">+</code> <code class="calibre21">})</code>
<code class="o">&gt;</code> med.boot <code class="o">&lt;-</code> <code class="kp">unlist</code><code class="calibre21">(</code>med.boot<code class="calibre21">)</code>  <code class="c">## Collapse list into vector</code>
<code class="o">&gt;</code> quantile<code class="calibre21">(</code>med.boot<code class="calibre21">,</code> <code class="kt">c</code><code class="calibre21">(</code><code class="o">0.025</code><code class="calibre21">,</code> <code class="o">0.975</code><code class="calibre21">))</code>
 <code class="o">2.5</code><code class="o">% 97.5%</code> 
 <code class="o">2.68</code>  <code class="o">3.47</code> 
</pre></div>

</figure>

<p class="calibre2">Once youâve finished working with your cluster, itâs good to clean up and stop the cluster child processes (quitting R will also stop all of the child processes).</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code><code class="o">&gt;</code> stopCluster<code class="calibre21">(</code>cl<code class="calibre21">)</code>
</pre></div>

</figure>

<h3 id="calibre_link-167" class="calibre19">
<span class="section-number">24.6 </span>Summary</h3>

<p class="calibre2">In this chapter we reviewed two different approaches to executing parallel computations in R. Both approaches used the <code class="calibre21">parallel</code> package, which comes with your installation of R. The âmulticoreâ approach, which makes use of the <code class="calibre21">mclapply()</code> function is perhaps the simplest and can be implemented on just about any multi-core system (which nowadays is any system). The âsocketâ approach is a bit more general and can be implemented on systems where the fork-ing mechanism is not available. The approach used in the âsocketâ type cluster can also be extended to other parallel cluster management systems which unfortunately are outside the scope of this book. </p>

<p class="calibre2">In general, using parallel computation can speed up âembarrassingly parallelâ computations, typically with little additional effort. However, itâs important to remember that splitting a computation across <img src="images/000034.png" alt="N" class="inline-equation" width="15" /> processors usually does not result in a <img src="images/000011.png" alt="N" class="inline-equation" width="15" />-times speed up of your computation. This is because there is some overhead involved with initiating the sub-processes and copying the data over to those processes.</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-16">
<div class="calibre5">
<h2 id="calibre_link-168" class="calibre15">
<span class="section-number">25. </span>Why I Indent My Code 8 Spaces</h2>

<p class="calibre2">At the Use R! 2018 meeting in Brisbane, Australia, Jenny Bryan gave a
wonderful talk about âCode Smells and Feelsâ (I recommend you <a href="https://youtu.be/7oyiPBjLAWY">watch a
video of that talk</a>). Her talk covers
various ways to detect when your code âsmellsâ and how to fix those
smells through refactoring. While there is quite a bit of literature on
this with respect to other programming languages, itâs not well-covered
with respect to R.</p>

<p class="calibre2">As mentioned previously in this book, my general indenting policy for R
code is to use 8 spaces per indent. In my experience, people tend to
find this a rather extreme indentation policy, with maybe 4 spaces being
at the outer limit of what they could imagine. But Iâve been using 8
spaces for a long time now and Iâve found that it has a number of
benefits.</p>

<p class="calibre2">First off, I did not make up the 8 space indent. I got it from the
<a href="https://www.kernel.org/doc/Documentation/process/coding-style.rst">Linux kernal coding style
document</a>.
Chapter 1 says:</p>

<blockquote class="calibre18">
  <p class="calibre2">Tabs are 8 characters, and thus indentations are also 8 characters.
There are heretic movements that try to make indentations 4 (or even
2!) characters deep, and that is akin to trying to define the value of
PI to be 3.</p>
</blockquote>

<p class="calibre2">Iâve found the Linux kernal coding style to be pretty useful for my R
programming, but a lot of it is C-specific and so not relevant.
Nevertheless, itâs worth a quick peruse.</p>

<p class="calibre2">Personally, Iâve found 8 spaces is good for my aging eyes. I think my
rule is that the appropriate number of spaces of indentation is
proportional to the square of my age (Iâm still working on that model
though). At this point, code with a 2 space indent is indistinguishable
from flush left.</p>

<p class="calibre2">Before going on, I have to emphasize that the 8 space indent cannot
exist in isolation. It has to be coupled with a right-hand side limit of
80 columns. Otherwise, you could just indent yourself off to infinity
and there would be no consequences. An 80 column limit forces you to
keep your code within reasonable limits. Also, if someone ever needs to
read your code on a PDP/11 youâll be A-okay.</p>

<p class="calibre2">Most importantly though, Iâve found that the 8 space indent serves as a
kind of early warning system for âsmellyâ code. Jenny gave some smelly
examples in her talk and I thought Iâd reproduce them here. This first
example, as Jenny describes, suffers from not using the available class
predicate functions to test for ânumericâ or âintegerâ. Hereâs the
example with a 2 space indent.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>bizarro <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
  <code class="kc">if</code> <code class="calibre21">(</code><code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"numeric"</code> <code class="o">||</code> <code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"integer"</code><code class="calibre21">)</code> <code class="calibre21">{</code>
    <code class="o">-</code>x
  <code class="calibre21">}</code> <code class="kc">else</code> <code class="kc">if</code> <code class="calibre21">(</code><code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"logical"</code><code class="calibre21">)</code> <code class="calibre21">{</code>
    <code class="o">!</code>x
  <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code> 
    <code class="kp">stop</code><code class="calibre21">(</code><code class="kc">...</code><code class="calibre21">)</code> 
  <code class="calibre21">}</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">That first <code class="calibre21">if</code> state sticks out a little bit because itâs rather long.
Better code might use the <code class="calibre21">is.numeric()</code> and <code class="calibre21">is.integer()</code> functions.</p>

<p class="calibre2">Hereâs the same example with an 8 space indent.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>bizarro <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>x<code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="kc">if</code> <code class="calibre21">(</code><code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"numeric"</code> <code class="o">||</code> <code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"integer"</code><code class="calibre21">)</code> <code class="calibre21">{</code>
                <code class="o">-</code>x
        <code class="calibre21">}</code> <code class="kc">else</code> <code class="kc">if</code> <code class="calibre21">(</code><code class="kp">class</code><code class="calibre21">(</code>x<code class="calibre21">)[[</code><code class="o">1</code><code class="calibre21">]]</code> <code class="o">==</code> <code class="s">"logical"</code><code class="calibre21">)</code> <code class="calibre21">{</code>
                <code class="o">!</code>x
        <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code> 
                <code class="kp">stop</code><code class="calibre21">(</code><code class="kc">...</code><code class="calibre21">)</code> 
        <code class="calibre21">}</code>
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Although, itâs not egregious, that first line is pushing up against the
80 column limit on the right-hand side. You might not do anything about
it in this case, but the purpose of the indenting system is to at least
trigger a reaction.</p>

<p class="calibre2">The next example from Jennyâs talk is a bit more obvious. Here she gives
a lesson in excessive <code class="calibre21">if-else</code> statements. The original code with 2
space indent is here.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>get_some_data <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>config<code class="calibre21">,</code> outfile<code class="calibre21">)</code> <code class="calibre21">{</code>
  <code class="kc">if</code> <code class="calibre21">(</code>config_ok<code class="calibre21">(</code>config<code class="calibre21">))</code> <code class="calibre21">{</code>
    <code class="kc">if</code> <code class="calibre21">(</code>can_write<code class="calibre21">(</code>outfile<code class="calibre21">))</code> <code class="calibre21">{</code>
      <code class="kc">if</code> <code class="calibre21">(</code>can_open_network_connection<code class="calibre21">(</code>config<code class="calibre21">))</code> <code class="calibre21">{</code>
        data <code class="o">&lt;-</code> parse_something_from_network<code class="calibre21">()</code>
        <code class="kc">if</code><code class="calibre21">(</code>makes_sense<code class="calibre21">(</code>data<code class="calibre21">))</code> <code class="calibre21">{</code>
          data <code class="o">&lt;-</code> beautify<code class="calibre21">(</code>data<code class="calibre21">)</code>
          write_it<code class="calibre21">(</code>data<code class="calibre21">,</code> outfile<code class="calibre21">)</code>
          <code class="kc">return</code><code class="calibre21">(</code><code class="kc">TRUE</code><code class="calibre21">)</code>
        <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
          <code class="kc">return</code><code class="calibre21">(</code><code class="kc">FALSE</code><code class="calibre21">)</code>
        <code class="calibre21">}</code>
      <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
        <code class="kp">stop</code><code class="calibre21">(</code><code class="s">"Can't access network"</code><code class="calibre21">)</code>
      <code class="calibre21">}</code>
    <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
      <code class="c">## uhm. What was this else for again?</code>
    <code class="calibre21">}</code>
  <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
    <code class="c">## maybe, some bad news about ... the config?</code>
  <code class="calibre21">}</code> 
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Now, itâs fair to say that this code already looks a bit smelly
(fishy?), but itâs maybe passable from a visual standpoint. Letâs take a
look at it with 8 space indents.</p>

<figure class="code" dir="ltr">
<div class="highlight"><pre class="calibre22"><code class="calibre21"></code>get_some_data <code class="o">&lt;-</code> <code class="kc">function</code><code class="calibre21">(</code>config<code class="calibre21">,</code> outfile<code class="calibre21">)</code> <code class="calibre21">{</code>
        <code class="kc">if</code> <code class="calibre21">(</code>config_ok<code class="calibre21">(</code>config<code class="calibre21">))</code> <code class="calibre21">{</code>
                <code class="kc">if</code> <code class="calibre21">(</code>can_write<code class="calibre21">(</code>outfile<code class="calibre21">))</code> <code class="calibre21">{</code>
                        <code class="kc">if</code> <code class="calibre21">(</code>can_open_network_connection<code class="calibre21">(</code>config<code class="calibre21">))</code> <code class="calibre21">{</code>
                                data <code class="o">&lt;-</code> parse_something_from_network<code class="calibre21">()</code>
                                <code class="kc">if</code><code class="calibre21">(</code>makes_sense<code class="calibre21">(</code>data<code class="calibre21">))</code> <code class="calibre21">{</code>
                                        data <code class="o">&lt;-</code> beautify<code class="calibre21">(</code>data<code class="calibre21">)</code>
                                        write_it<code class="calibre21">(</code>data<code class="calibre21">,</code> outfile<code class="calibre21">)</code>
                                        <code class="kc">return</code><code class="calibre21">(</code><code class="kc">TRUE</code><code class="calibre21">)</code>
                                <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
                                        <code class="kc">return</code><code class="calibre21">(</code><code class="kc">FALSE</code><code class="calibre21">)</code>
                                <code class="calibre21">}</code>
                        <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
                                <code class="kp">stop</code><code class="calibre21">(</code><code class="s">"Can't access network"</code><code class="calibre21">)</code>
                        <code class="calibre21">}</code>
                <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
                        <code class="c">## uhm. What was this else for again?</code>
                <code class="calibre21">}</code>
        <code class="calibre21">}</code> <code class="kc">else</code> <code class="calibre21">{</code>
                <code class="c">## maybe, some bad news about ... the config?</code>
        <code class="calibre21">}</code> 
<code class="calibre21">}</code>
</pre></div>

</figure>

<p class="calibre2">Now the code looks downright absurd, practically crying out for
refactoring, and rightly so! The five levels of nesting will be
unreadable as soon as you blink your eyes.</p>

<p class="calibre2">Thatâs basically it. Iâve found zero downsides to using an 8 space
indent and a number of upsides, including cleaner, more modular code.
Because the visual indicator penalizes against lots of indenting, you
are usually forced to write out separate functions to handle different
tasks rather than go one more level in. This not only has the benefit of
being modular, but itâs also useful for things like profiling (it can be
very uninformative to profile a single monolithic function).</p>



</div>
</div>


<div dir="ltr" class="calibre" id="calibre_link-180">
<div class="calibre5">
<h2 id="calibre_link-169" class="calibre15">
<span class="section-number">26. </span>About the Author</h2>

<p class="calibre2"><strong class="calibre16">Roger D. Peng</strong> is a Professor of Biostatistics at the
Johns Hopkins Bloomberg School of Public Health. He is also a
Co-Founder of the <a href="http://www.coursera.org/specialization/jhudatascience/1">Johns Hopkins Data Science
Specialization</a>,
which has enrolled over 1.5 million students, the <a href="https://www.coursera.org/specializations/executive-data-science">Johns Hopkins
Executive Data Science
Specialization</a>,
the <a href="http://simplystatistics.org/">Simply Statistics blog</a> where he
writes about statistics and data science for the general public, and
the <a href="http://nssdeviations.com/">Not So Standard Deviations</a>
podcast. Roger can be found on Twitter and GitHub under the user name
<a href="https://twitter.com/rdpeng">@rdpeng</a>.</p>

</div>
</div>


</body></html>
